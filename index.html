<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="-1">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miami Beach Resort v18.2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #1a1f2e; min-height: 100vh; color: #fff; }
        
        /* Top Bar - Always sticky */
        .top-bar { background: #141824; border-bottom: 1px solid rgba(255,255,255,0.08); position: sticky; top: 0; z-index: 200; padding: 12px 16px; }
        
        /* Controls Section - Scrolls away */
        .controls-section { background: #141824; padding: 16px; padding-top: 8px; }
        
        /* Stats Row - 5 items */
        .stats-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 14px; }
        .stat-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 14px 8px; text-align: center; }
        .stat-num { font-size: 26px; font-weight: 700; }
        .stat-label { font-size: 9px; color: rgba(255,255,255,0.5); margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Search Button - 1.5x bigger */
        .search-btn { display: flex; align-items: center; gap: 10px; padding: 14px 24px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; color: rgba(255,255,255,0.7); cursor: pointer; font-size: 15px; font-weight: 500; transition: all 0.2s; }
        .search-btn:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: #10b981; }
        
        /* Tabs - Full width stretched */
        .tabs-row { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 16px; justify-content: center; }
        .nav-btn { padding: 14px 20px; border-radius: 12px; font-size: 14px; font-weight: 600; border: none; cursor: pointer; transition: all 0.3s; background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.7); white-space: nowrap; text-align: center; border: 1px solid rgba(255,255,255,0.08); }
        .nav-btn:hover { background: rgba(255,255,255,0.12); color: #fff; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .nav-btn.active { background: linear-gradient(145deg, #10b981, #059669); color: white; box-shadow: 0 4px 16px rgba(16,185,129,0.4); border-color: transparent; }
        
        /* Date controls - Centered */
        .date-controls { display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 10px; }
        .day-btn { padding: 9px 14px; border-radius: 8px; font-size: 13px; font-weight: 600; border: none; cursor: pointer; background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.6); }
        .day-btn:hover { background: rgba(255,255,255,0.1); }
        .day-btn.active { background: #10b981; color: white; }
        .date-input { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 9px 12px; color: #fff; font-size: 13px; }
        
        /* Sticky Date Header - sticks below top bar */
        .date-header-wrapper { position: sticky; top: 62px; z-index: 150; background: #1a1f2e; padding: 12px 16px; margin-left: 0; border-top: 3px solid #10b981; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .date-header-inner { display: flex; gap: 6px; margin-left: 140px; }
        .date-cell { flex: 1; min-width: 100px; text-align: center; padding: 10px 6px; background: rgba(255,255,255,0.05); border-radius: 10px; }
        .date-cell.today { background: #10b981; }
        .date-day { font-size: 12px; font-weight: 500; color: rgba(255,255,255,0.7); }
        .date-num { font-size: 20px; font-weight: 700; margin-top: 2px; }
        
        /* Calendar Container */
        .cal-container { padding: 0 16px 100px; overflow-x: auto; }
        
        /* Floor Header */
        .floor-header { display: inline-flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.05); padding: 10px 18px; border-radius: 10px; margin: 12px 0 10px 0; }
        
        /* Room Row */
        .room-row { display: flex; gap: 6px; margin-bottom: 6px; }
        
        /* Room Label */
        .room-label { min-width: 134px; max-width: 134px; background: #232a3b; border-radius: 10px; padding: 12px; display: flex; flex-direction: column; justify-content: center; }
        .room-num { font-size: 22px; font-weight: 700; }
        .room-type { font-size: 10px; color: rgba(255,255,255,0.5); margin-top: 3px; line-height: 1.2; }
        .room-cap { font-size: 10px; color: rgba(255,255,255,0.4); margin-top: 2px; }
        
        /* Status Card - Responsive */
        .status-card { flex: 1; min-width: 100px; min-height: 80px; border-radius: 10px; padding: 10px; position: relative; cursor: pointer; transition: all 0.15s; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .status-card:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        
        /* Only 2 colors: Green (available) and Red (booked) */
        .card-available { background: linear-gradient(145deg, #22c55e 0%, #16a34a 100%); }
        .card-booked { background: linear-gradient(145deg, #ef4444 0%, #dc2626 100%); }
        .card-selected { box-shadow: 0 0 0 3px #fff, 0 0 0 6px #10b981 !important; }
        
        .status-text { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .guest-name { font-size: 11px; font-weight: 500; margin-top: 4px; opacity: 0.9; }
        
        .info-btn { position: absolute; top: 6px; right: 6px; width: 20px; height: 20px; background: rgba(255,255,255,0.25); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; border: none; color: white; z-index: 5; }
        .info-btn:hover { background: rgba(255,255,255,0.4); }
        
        /* Today Tab - View Selector */
        .view-selector { display: flex; gap: 8px; margin-bottom: 16px; justify-content: center; }
        .view-btn { padding: 10px 20px; border-radius: 8px; font-size: 13px; font-weight: 500; border: 2px solid rgba(255,255,255,0.1); cursor: pointer; background: transparent; color: rgba(255,255,255,0.6); transition: all 0.2s; }
        .view-btn:hover { border-color: rgba(255,255,255,0.3); color: #fff; }
        .view-btn.active { background: #10b981; border-color: #10b981; color: white; }
        
        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 16px; }
        .modal { background: #1a1f2e; border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 24px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-close { background: none; border: none; color: rgba(255,255,255,0.5); font-size: 28px; cursor: pointer; }
        
        .info-section { background: rgba(255,255,255,0.03); border-radius: 10px; padding: 14px; margin-bottom: 12px; }
        .info-label { font-size: 10px; color: rgba(255,255,255,0.4); text-transform: uppercase; margin-bottom: 4px; }
        .info-value { font-size: 15px; font-weight: 600; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        /* Search */
        .search-input { width: 100%; padding: 14px 18px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; color: #fff; font-size: 15px; }
        .search-input:focus { outline: none; border-color: #10b981; }
        .search-result { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; padding: 14px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; }
        .search-result:hover { background: rgba(255,255,255,0.08); border-color: #10b981; }
        
        /* Search & Book */
        .date-search-row { display: flex; gap: 12px; flex-wrap: wrap; align-items: end; justify-content: center; margin-bottom: 20px; }
        .date-field { display: flex; flex-direction: column; gap: 6px; cursor: pointer; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 10px; border: 1px solid rgba(255,255,255,0.08); transition: all 0.2s; }
        .date-field label { font-size: 12px; color: rgba(255,255,255,0.5); pointer-events: none; }
        .date-field:hover { background: rgba(255,255,255,0.08); border-color: rgba(16,185,129,0.4); }
        .group-selector { padding: 10px 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; font-size: 14px; }
        
        /* Requests */
        .request-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 14px; margin-bottom: 12px; }
        .request-select { width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; margin-top: 10px; }
        .request-note { width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; margin-top: 8px; resize: none; }
        .request-btn { padding: 10px 20px; background: #10b981; border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .request-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-top: 8px; font-size: 13px; }
        .request-pending { border-left: 3px solid #f59e0b; }
        .request-done { border-left: 3px solid #10b981; }
        .done-btn { padding: 6px 12px; background: #10b981; border: none; border-radius: 6px; color: white; font-size: 11px; cursor: pointer; }
        .request-count { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; }
        .request-count.pending { background: rgba(245,158,11,0.2); color: #f59e0b; }
        .request-count.done { background: rgba(34,197,94,0.2); color: #22c55e; }
        
        /* Housekeeping */
        .hk-section { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 16px; }
        .hk-card { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 10px; margin-bottom: 8px; }
        .hk-makeup { background: linear-gradient(135deg, #0ea5e9, #0284c7); }
        .hk-dirty { background: linear-gradient(135deg, #f97316, #ea580c); }
        .hk-turnover { background: linear-gradient(135deg, #9333ea 0%, #9333ea 50%, #2563eb 50%, #2563eb 100%); }
        
        /* Movement */
        .mv-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .mv-btn { width: 40px; height: 40px; border-radius: 8px; border: none; cursor: pointer; font-size: 16px; }
        .mv-btn-pending { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.6); }
        .mv-btn-pending:hover { background: #10b981; color: white; }
        .mv-btn-done { background: #10b981; color: white; }
        
        .mobile-select { width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; }
        .loader { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: #10b981; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .version-tag { position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.5); padding: 4px 10px; border-radius: 4px; font-size: 10px; color: rgba(255,255,255,0.5); z-index: 9999; }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 4px; }
        
        @media (max-width: 1200px) {
            .status-card { min-width: 90px; min-height: 70px; }
            .date-cell { min-width: 90px; }
        }
        @media (max-width: 900px) {
            .stats-row { gap: 6px; }
            .stat-card { padding: 10px 4px; }
            .stat-num { font-size: 20px; }
            .tabs-row { gap: 8px; }
        }
        @media (max-width: 768px) {
            .stat-num { font-size: 16px; }
            .stat-label { font-size: 7px; }
            .tabs-row { gap: 6px; }
            .nav-btn { padding: 12px 16px; font-size: 13px; }
            .status-card { min-width: 80px; min-height: 65px; padding: 8px; }
            .room-label { min-width: 100px; max-width: 100px; }
            .date-cell { min-width: 80px; }
            .date-header-inner { margin-left: 106px; }
            .search-btn { padding: 10px 16px; font-size: 13px; }
            .date-header-wrapper { top: 56px; }
        }

        /* Today view hover effects */
        .today-group { 
            transition: all 0.3s ease; 
            border-radius: 16px; 
            padding: 16px; 
            margin-bottom: 20px;
            border: 2px solid transparent;
        }
        .today-group:hover { 
            background: rgba(59, 130, 246, 0.1); 
            border-color: rgba(59, 130, 246, 0.4);
            box-shadow: 0 4px 24px rgba(59, 130, 246, 0.25);
        }
        .today-group:hover .floor-header { 
            background: rgba(59, 130, 246, 0.3) !important; 
            transform: scale(1.02);
        }

        /* Star dust trail animation */
        .stardust {
            position: fixed;
            pointer-events: none;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: radial-gradient(circle, #fff 0%, #10b981 50%, transparent 70%);
            animation: stardust-fade 1s ease-out forwards;
            z-index: 9999;
            box-shadow: 0 0 6px #10b981, 0 0 10px #10b981;
        }
        @keyframes stardust-fade {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0); opacity: 0; }
        }
    </style>
</head>
<body>
<div id="root"></div>
<div class="version-tag">v18.2</div>
<script type="text/babel">
const {useState, useEffect, useMemo, useCallback} = React;

const PROXY = "https://beds24-proxy-1006186358018.us-central1.run.app";
const PROPERTY = 279646;

const getBDDate = (offset = 0) => {
    const now = new Date();
    now.setDate(now.getDate() + offset);
    return now.toLocaleDateString('en-CA');
};

const getBDTime = () => {
    return new Date().toLocaleTimeString("en-US", {hour: "2-digit", minute: "2-digit", hour12: true});
};

const formatDate = (d) => new Date(d+"T12:00:00").toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"});
const shortDay = (d) => new Date(d+"T12:00:00").toLocaleDateString("en-US",{weekday:"short"});
const dayNum = (d) => new Date(d+"T12:00:00").getDate();

const ROOMS = [
    {id:583459, name:"Royal Sea View Couple", short:"Royal Sea View", max:2, units:[{id:1,n:"601"},{id:2,n:"602"},{id:3,n:"603"},{id:4,n:"604"}]},
    {id:583466, name:"Premium Sea View Couple", short:"Premium Sea View", max:2, units:[{id:1,n:"401"},{id:2,n:"404"},{id:3,n:"501"},{id:4,n:"504"}]},
    {id:583467, name:"Deluxe Bay View Couple", short:"Deluxe Bay View", max:2, units:[{id:1,n:"402"},{id:2,n:"403"},{id:3,n:"502"},{id:4,n:"503"}]},
    {id:583468, name:"Deluxe Hill View Couple", short:"Deluxe Hill View", max:2, units:[{id:1,n:"201"},{id:2,n:"204"},{id:3,n:"207"},{id:4,n:"301"},{id:5,n:"304"},{id:6,n:"307"},{id:7,n:"407"},{id:8,n:"507"}]},
    {id:583469, name:"Deluxe Urban View Couple", short:"Deluxe Urban View", max:2, units:[{id:1,n:"101"},{id:2,n:"102"},{id:3,n:"103"},{id:4,n:"104"},{id:5,n:"107"},{id:6,n:"202"},{id:7,n:"203"},{id:8,n:"302"},{id:9,n:"303"}]},
    {id:583470, name:"Premium Sea View Family", short:"Premium Sea Family", max:4, units:[{id:1,n:"405"},{id:2,n:"406"},{id:3,n:"408"},{id:4,n:"505"},{id:5,n:"506"},{id:6,n:"508"},{id:7,n:"606"}]},
    {id:583471, name:"Deluxe Hill View Family", short:"Deluxe Hill Family", max:4, units:[{id:1,n:"205"},{id:2,n:"206"},{id:3,n:"208"},{id:4,n:"305"},{id:5,n:"306"},{id:6,n:"308"}]},
    {id:583472, name:"Deluxe Urban View Family", short:"Deluxe Urban Family", max:4, units:[{id:1,n:"105"},{id:2,n:"106"},{id:3,n:"108"}]}
];

const getFloor = (n) => Math.floor(parseInt(n) / 100);
const FLOORS = [1, 2, 3, 4, 5, 6];
const floorName = (f) => f === 1 ? "1st" : f === 2 ? "2nd" : f === 3 ? "3rd" : f + "th";

const getRoomInfo = (roomId, unitId) => {
    const r = ROOMS.find(x => x.id === roomId);
    const u = r?.units.find(x => x.id === unitId);
    return {room: r, unit: u, num: u?.n || "?"};
};

const STORAGE_KEY = "miami_checkin_v2";
const REQUEST_KEY = "miami_requests_v2";
const loadStatus = () => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); } catch { return {}; } };
const saveStatus = (d) => localStorage.setItem(STORAGE_KEY, JSON.stringify(d));
const loadRequests = () => { try { return JSON.parse(localStorage.getItem(REQUEST_KEY) || "[]"); } catch { return []; } };
const saveRequests = (d) => localStorage.setItem(REQUEST_KEY, JSON.stringify(d));

const REQUEST_TYPES = ["Room Service", "Water Bottle", "Room Clean", "Towel Request", "Bedsheet Change", "Toiletries", "Extra Pillow", "AC/Heating Issue", "Maintenance", "Other"];

function App() {
    const [tab, setTab] = useState("today");
    const [calDays, setCalDays] = useState(7);
    const [startDate, setStartDate] = useState(getBDDate());
    const [bookings, setBookings] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState("");
    const [selected, setSelected] = useState([]);
    const [multiBookCheckIn, setMultiBookCheckIn] = useState(getBDDate());
    const [multiBookCheckOut, setMultiBookCheckOut] = useState(getBDDate(1));
    const [showBookModal, setShowBookModal] = useState(false);
    const [showInfoModal, setShowInfoModal] = useState(null);
    const [showSearchModal, setShowSearchModal] = useState(false);
    const [time, setTime] = useState(getBDTime());
    const [checkStatus, setCheckStatus] = useState(loadStatus());
    const [requests, setRequests] = useState(loadRequests());
    const [searchQuery, setSearchQuery] = useState("");
    const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
    const [searchCheckIn, setSearchCheckIn] = useState(getBDDate());
    const [searchCheckOut, setSearchCheckOut] = useState(getBDDate(1));
    const checkoutRef = React.useRef(null);
    const checkinRef = React.useRef(null);
    const calendarDateRef = React.useRef(null);
    const [searchGroupBy, setSearchGroupBy] = useState("floor");
    
    const handleCheckInChange = (e) => {
        const newCheckIn = e.target.value;
        setSearchCheckIn(newCheckIn);
        // Auto-set checkout to next day
        const nextDay = new Date(newCheckIn + "T12:00:00");
        nextDay.setDate(nextDay.getDate() + 1);
        setSearchCheckOut(nextDay.toLocaleDateString('en-CA'));
        // Auto-focus checkout picker after short delay
        setTimeout(() => {
            if (checkoutRef.current) {
                checkoutRef.current.showPicker();
            }
        }, 100);
    };
    const [todayViewBy, setTodayViewBy] = useState("floor");
    const [hkDay, setHkDay] = useState("today");
    const [hkTab, setHkTab] = useState("tasks");
    const [calendarViewBy, setCalendarViewBy] = useState("floor");

    const today = getBDDate();

    useEffect(() => {
        const h = () => setIsMobile(window.innerWidth < 768);
        window.addEventListener('resize', h);
        return () => window.removeEventListener('resize', h);
    }, []);

    useEffect(() => { const t = setInterval(() => setTime(getBDTime()), 60000); return () => clearInterval(t); }, []);

    const allRooms = useMemo(() => {
        let arr = [];
        ROOMS.forEach(r => r.units.forEach(u => arr.push({room: r, unit: u, floor: getFloor(u.n)})));
        return arr.sort((a,b) => parseInt(a.unit.n) - parseInt(b.unit.n));
    }, []);

    const roomsByFloor = useMemo(() => {
        const g = {};
        FLOORS.forEach(f => g[f] = []);
        allRooms.forEach(r => g[r.floor]?.push(r));
        return g;
    }, [allRooms]);

    const fetchData = useCallback(async () => {
        setLoading(true);
        setError("");
        try {
            const res = await fetch(`${PROXY}?endpoint=bookings&propertyId=${PROPERTY}&departureFrom=${getBDDate(-7)}`);
            const data = await res.json();
            if (data.success) setBookings(data.data.filter(b => b.status !== "cancelled"));
            else setError(data.error || "Error");
        } catch(e) { setError(e.message); }
        setLoading(false);
    }, []);

    useEffect(() => { fetchData(); const i = setInterval(fetchData, 120000); return () => clearInterval(i); }, [fetchData]);

    const getBooking = useCallback((roomId, unitId, d) => bookings.find(b => b.roomId === roomId && b.unitId === unitId && d >= b.arrival && d < b.departure), [bookings]);
    const getCheckout = useCallback((roomId, unitId, d) => bookings.find(b => b.roomId === roomId && b.unitId === unitId && b.departure === d), [bookings]);
    const getCheckin = useCallback((roomId, unitId, d) => bookings.find(b => b.roomId === roomId && b.unitId === unitId && b.arrival === d), [bookings]);

    const getDays = useCallback((count) => {
        const days = [];
        const start = new Date(startDate + "T12:00:00");
        for (let i = 0; i < count; i++) {
            const d = new Date(start);
            d.setDate(d.getDate() + i);
            days.push(d.toLocaleDateString('en-CA'));
        }
        return days;
    }, [startDate]);

    const days = useMemo(() => getDays(calDays), [getDays, calDays]);

    const toggleSelect = (room, unit, date) => {
        const unitKey = `${room.id}-${unit.id}`;
        setSelected(s => {
            const existing = s.find(x => x.unitKey === unitKey);
            if (existing) {
                // Unit already selected
                if (existing.checkIn === date) {
                    // Clicking check-in date = deselect this unit
                    return s.filter(x => x.unitKey !== unitKey);
                } else if (date > existing.checkIn) {
                    // Clicking a later date = set checkout to day AFTER clicked date
                    const nextDay = new Date(date + "T12:00:00");
                    nextDay.setDate(nextDay.getDate() + 1);
                    return s.map(x => x.unitKey === unitKey ? {...x, checkOut: nextDay.toLocaleDateString('en-CA')} : x);
                } else {
                    // Clicking earlier date = move check-in here, keep checkout
                    return s.map(x => x.unitKey === unitKey ? {...x, checkIn: date} : x);
                }
            } else {
                // New unit - check-in = clicked date, check-out = next day
                const nextDay = new Date(date + "T12:00:00");
                nextDay.setDate(nextDay.getDate() + 1);
                return [...s, {
                    unitKey,
                    room,
                    unit,
                    checkIn: date,
                    checkOut: nextDay.toLocaleDateString('en-CA')
                }];
            }
        });
    };

    const toggle = (id, type) => {
        const ns = {...checkStatus};
        const key = type === "in" ? "checkedin" : "checkedout";
        ns[id] = ns[id] === key ? null : key;
        if (!ns[id]) delete ns[id];
        setCheckStatus(ns);
        saveStatus(ns);
    };

    const addRequest = (roomNum, guestName, bookingId, requestType, note) => {
        const newReq = { id: Date.now(), roomNum, guestName, bookingId, requestType, note, timestamp: new Date().toISOString(), done: false };
        const updated = [newReq, ...requests];
        setRequests(updated);
        saveRequests(updated);
    };

    const markRequestDone = (id) => {
        const updated = requests.map(r => r.id === id ? {...r, done: true, doneAt: new Date().toISOString()} : r);
        setRequests(updated);
        saveRequests(updated);
    };

    const getRequestCounts = (bookingId) => {
        const bookingRequests = requests.filter(r => r.bookingId === bookingId);
        return { total: bookingRequests.length, pending: bookingRequests.filter(r => !r.done).length, done: bookingRequests.filter(r => r.done).length };
    };

    const stats = useMemo(() => {
        let occ=0, avail=0, cin=0, cout=0;
        allRooms.forEach(({room, unit}) => getBooking(room.id, unit.id, today) ? occ++ : avail++);
        bookings.forEach(b => { if(b.arrival === today) cin++; if(b.departure === today) cout++; });
        return {total: allRooms.length, occ, avail, cin, cout};
    }, [allRooms, bookings, getBooking, today]);

    const tomorrow = getBDDate(1);
    
    const getHKData = useCallback((targetDate) => {
        const checkin = [], checkout = [], stayover = [], turnover = [];
        allRooms.forEach(({room, unit}) => {
            const co = bookings.find(b => b.roomId === room.id && b.unitId === unit.id && b.departure === targetDate);
            const ci = bookings.find(b => b.roomId === room.id && b.unitId === unit.id && b.arrival === targetDate);
            const stay = bookings.find(b => b.roomId === room.id && b.unitId === unit.id && b.arrival < targetDate && b.departure > targetDate);
            if (co && ci) turnover.push({room, unit, out: co, in: ci});
            else if (co) checkout.push({room, unit, booking: co});
            else if (ci) checkin.push({room, unit, booking: ci});
            else if (stay) stayover.push({room, unit, booking: stay});
        });
        return {checkin, checkout, stayover, turnover};
    }, [allRooms, bookings]);
    
    const housekeepingToday = useMemo(() => getHKData(today), [getHKData, today]);
    const housekeepingTomorrow = useMemo(() => getHKData(tomorrow), [getHKData, tomorrow]);
    
    // Keep old housekeeping for backwards compat
    const housekeeping = useMemo(() => {
        const makeup = [], dirty = [], turnover = [];
        allRooms.forEach(({room, unit}) => {
            const co = getCheckout(room.id, unit.id, today);
            const ci = getCheckin(room.id, unit.id, today);
            const stay = bookings.find(b => b.roomId === room.id && b.unitId === unit.id && b.arrival < today && b.departure > today);
            if (co && ci) turnover.push({room, unit, out: co, in: ci});
            else if (co && !ci) dirty.push({room, unit, booking: co});
            else if (stay) makeup.push({room, unit, booking: stay});
        });
        return {makeup, dirty, turnover};
    }, [allRooms, bookings, getCheckout, getCheckin, today]);
    
    const handleRequestDone = (reqId, isDenied) => {
        const staffInput = document.getElementById("staff-" + reqId);
        const staffName = staffInput ? staffInput.value : "Housekeeping";
        const updated = requests.map(r => r.id === reqId ? {...r, done: true, denied: isDenied, doneAt: new Date().toISOString(), doneBy: staffName || "Housekeeping"} : r);
        setRequests(updated);
        saveRequests(updated);
    };

    const movements = useMemo(() => {
        const todayIn = bookings.filter(b => b.arrival === today);
        const todayOut = bookings.filter(b => b.departure === today);
        return {
            pendingIn: todayIn.filter(b => checkStatus[b.id] !== "checkedin"),
            doneIn: todayIn.filter(b => checkStatus[b.id] === "checkedin"),
            pendingOut: todayOut.filter(b => checkStatus[b.id] !== "checkedout"),
            doneOut: todayOut.filter(b => checkStatus[b.id] === "checkedout")
        };
    }, [bookings, checkStatus, today]);

    const currentGuests = useMemo(() => {
        return bookings.filter(b => b.arrival <= today && b.departure > today).map(b => {
            const {room, unit, num} = getRoomInfo(b.roomId, b.unitId);
            return {...b, room, unit, num};
        }).sort((a,b) => parseInt(a.num) - parseInt(b.num));
    }, [bookings, today]);

    const globalSearchResults = useMemo(() => {
        if (!searchQuery.trim()) return [];
        const q = searchQuery.toLowerCase();
        return bookings.filter(b => 
            b.id?.toString().includes(q) || b.firstName?.toLowerCase().includes(q) || 
            b.lastName?.toLowerCase().includes(q) || b.email?.toLowerCase().includes(q) || 
            b.mobile?.includes(q) || getRoomInfo(b.roomId, b.unitId).num.includes(q)
        ).slice(0, 15);
    }, [bookings, searchQuery]);

    const availableRooms = useMemo(() => {
        if (!searchCheckIn || !searchCheckOut) return [];
        return allRooms.filter(({room, unit}) => {
            const hasConflict = bookings.some(b => b.roomId === room.id && b.unitId === unit.id && b.arrival < searchCheckOut && b.departure > searchCheckIn);
            return !hasConflict;
        });
    }, [allRooms, bookings, searchCheckIn, searchCheckOut]);

    const getMultiUnitInfo = (booking) => {
        if (!booking.masterId) return null;
        const related = bookings.filter(b => b.masterId === booking.masterId || b.id === booking.masterId);
        if (related.length <= 1) return null;
        const totalAmount = related.reduce((sum, b) => sum + (parseFloat(b.price) || 0), 0);
        const totalPaid = related.reduce((sum, b) => sum + (parseFloat(b.paid) || 0), 0);
        return { count: related.length, rooms: related.map(b => getRoomInfo(b.roomId, b.unitId).num), totalAmount, totalPaid, totalDue: totalAmount - totalPaid };
    };

    const tabs = [
        {id: "today", label: "üìÖ Today"},
        {id: "calendar", label: "üìÜ Calendar"},
        {id: "searchbook", label: "üîç Search & Book"},
        {id: "requests", label: "üõéÔ∏è Requests"},
        {id: "housekeeping", label: "üßπ Housekeeping"},
        {id: "movements", label: "‚ÜîÔ∏è Movements"},
        {id: "accounting", label: "üí∞ Accounting"},
        {id: "dashboard", label: "üìä Dashboard"}
    ];

    const StatusCard = ({room, unit, date, showGuestName = true}) => {
        const booking = getBooking(room.id, unit.id, date);
        const checkout = getCheckout(room.id, unit.id, date);
        const checkin = getCheckin(room.id, unit.id, date);
        const unitKey = `${room.id}-${unit.id}`;
        const unitSelection = selected.find(x => x.unitKey === unitKey);
        const isCheckInDate = unitSelection && date === unitSelection.checkIn;
        const isInRange = unitSelection && date > unitSelection.checkIn && date < unitSelection.checkOut;
        const isBooked = booking || checkout || checkin;
        const cardClass = isBooked ? "card-booked" : "card-available";
        const displayBooking = checkin || booking || checkout;
        // Can click if: not booked OR (unit is selected and we're clicking to adjust checkout)
        const canClick = !isBooked || (unitSelection && !isBooked);
        
        const handleClick = () => {
            if (isBooked) return;
            toggleSelect(room, unit, date);
        };
        
        // Visual styles for selection
        let selectionStyle = {};
        if (isCheckInDate) {
            selectionStyle = {boxShadow: '0 0 0 3px #22c55e', background: 'rgba(34,197,94,0.4)'};
        } else if (isInRange) {
            selectionStyle = {background: 'rgba(34,197,94,0.25)', borderColor: 'rgba(34,197,94,0.5)'};
        }
        
        return (
            <div className={`status-card ${cardClass}`} onClick={handleClick} style={{...selectionStyle, cursor: isBooked ? 'not-allowed' : 'pointer'}}>
                {isBooked && displayBooking && <button className="info-btn" onClick={(e) => {e.stopPropagation(); setShowInfoModal(displayBooking);}}>‚Ñπ</button>}
                {isCheckInDate && <div style={{position: 'absolute', top: '-8px', left: '50%', transform: 'translateX(-50%)', background: '#22c55e', padding: '2px 8px', borderRadius: '4px', fontSize: '9px', fontWeight: '700'}}>IN</div>}
                <div className="status-text">{isBooked ? "Booked" : "Available"}</div>
                {showGuestName && isBooked && displayBooking && <div className="guest-name">{displayBooking.firstName}</div>}
            </div>
        );
    };

    // Star dust effect
    const createStardust = (e) => {
        const dust = document.createElement('div');
        dust.className = 'stardust';
        dust.style.left = (e.clientX - 4) + 'px';
        dust.style.top = (e.clientY - 4) + 'px';
        dust.style.background = `radial-gradient(circle, #fff 0%, ${['#10b981', '#3b82f6', '#a855f7', '#f59e0b', '#ef4444'][Math.floor(Math.random() * 5)]} 50%, transparent 70%)`;
        document.body.appendChild(dust);
        setTimeout(() => dust.remove(), 1000);
    };

    const CalendarView = ({groupBy}) => {
        const groups = groupBy === "floor" 
            ? FLOORS.map(f => ({key: f, title: `üè¢ ${floorName(f)} Floor`, rooms: roomsByFloor[f] || [], count: (roomsByFloor[f] || []).length}))
            : ROOMS.map(r => ({key: r.id, title: r.name, rooms: r.units.map(u => ({room: r, unit: u})), count: r.units.length}));
        return (
            <>
                {/* Sticky Date Header */}
                <div className="date-header-wrapper">
                    <div className="date-header-inner">
                        {days.map(d => <div key={d} className={`date-cell ${d === today ? 'today' : ''}`}><div className="date-day">{shortDay(d)}</div><div className="date-num">{dayNum(d)}</div></div>)}
                    </div>
                </div>
                <div className="cal-container" onMouseMove={createStardust}>
                    {groups.map(group => {
                        if (!group.rooms.length) return null;
                        return (
                            <div key={group.key}>
                                <div className="floor-header"><span style={{fontWeight: 600}}>{group.title}</span><span style={{color: 'rgba(255,255,255,0.5)', fontSize: 13}}>{group.count} rooms</span></div>
                                {group.rooms.map(({room, unit}) => (
                                    <div key={`${room.id}-${unit.id}`} className="room-row">
                                        <div className="room-label"><div className="room-num">{unit.n}</div><div className="room-type">{room.short}</div><div className="room-cap">üë§ {room.max}A</div></div>
                                        {days.map(d => <StatusCard key={d} room={room} unit={unit} date={d}/>)}
                                    </div>
                                ))}
                            </div>
                        );
                    })}
                </div>
            </>
        );
    };

    const TodayView = () => {
        const groups = todayViewBy === "floor" 
            ? FLOORS.map(f => ({key: f, title: `${floorName(f)} Floor`, rooms: roomsByFloor[f] || []}))
            : ROOMS.map(r => ({key: r.id, title: r.short, rooms: r.units.map(u => ({room: r, unit: u}))}));
        
        return (
            <div style={{padding: '16px', maxWidth: '1200px', margin: '0 auto'}}>
                {/* Room Grid Section */}
                <div style={{background: 'rgba(255,255,255,0.02)', borderRadius: '20px', padding: '20px', border: '1px solid rgba(255,255,255,0.05)'}}>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px', flexWrap: 'wrap', gap: '12px'}}>
                        <h3 style={{fontSize: '18px', fontWeight: '600'}}>üìÖ Today - {formatDate(today)}</h3>
                        <div className="view-selector" style={{marginBottom: '0'}}>
                            <button className={`view-btn ${todayViewBy === 'floor' ? 'active' : ''}`} onClick={() => setTodayViewBy('floor')}>üè¢ By Floor</button>
                            <button className={`view-btn ${todayViewBy === 'category' ? 'active' : ''}`} onClick={() => setTodayViewBy('category')}>üìÅ By Category</button>
                        </div>
                    </div>
                    
                    {groups.map(group => {
                        if (!group.rooms.length) return null;
                        const groupOcc = group.rooms.filter(({room, unit}) => getBooking(room.id, unit.id, today)).length;
                        return (
                            <div key={group.key} className="today-group">
                                <div style={{textAlign: 'center', marginBottom: '12px'}}>
                                    <div className="floor-header" style={{display: 'inline-flex'}}>
                                        <span style={{fontWeight: 600}}>{group.title}</span>
                                        <span style={{color: '#22c55e', fontSize: 13}}>{group.rooms.length - groupOcc} free</span>
                                        <span style={{color: '#ef4444', fontSize: 13}}>{groupOcc} occupied</span>
                                    </div>
                                </div>
                                <div style={{display: 'flex', flexWrap: 'wrap', gap: '10px', justifyContent: 'center'}}>
                                    {group.rooms.map(({room, unit}) => {
                                        const booking = getBooking(room.id, unit.id, today);
                                        const isBooked = !!booking;
                                        const isCheckIn = booking?.arrival === today;
                                        const isCheckOut = bookings.find(b => b.roomId === room.id && b.unitId === unit.id && b.departure === today);
                                        return (
                                            <div key={`${room.id}-${unit.id}`} onClick={() => booking && setShowInfoModal(booking)} 
                                                style={{
                                                    background: isBooked ? 'linear-gradient(145deg, #ef4444, #dc2626)' : 'linear-gradient(145deg, #22c55e, #16a34a)', 
                                                    borderRadius: '12px', 
                                                    padding: '12px 16px', 
                                                    cursor: isBooked ? 'pointer' : 'default', 
                                                    textAlign: 'center',
                                                    minWidth: '90px',
                                                    position: 'relative',
                                                    border: isCheckIn ? '2px solid #3b82f6' : isCheckOut ? '2px solid #a855f7' : '2px solid transparent'
                                                }}>
                                                {(isCheckIn || isCheckOut) && (
                                                    <div style={{display: 'flex', gap: '4px', justifyContent: 'center', marginBottom: '6px'}}>
                                                        {isCheckIn && <div style={{background: '#3b82f6', borderRadius: '4px', padding: '2px 6px', fontSize: '9px', fontWeight: '700'}}>IN</div>}
                                                        {isCheckOut && <div style={{background: '#a855f7', borderRadius: '4px', padding: '2px 6px', fontSize: '9px', fontWeight: '700'}}>OUT</div>}
                                                    </div>
                                                )}
                                                <div style={{fontSize: '24px', fontWeight: '700'}}>{unit.n}</div>
                                                <div style={{fontSize: '10px', fontWeight: '600', marginTop: '2px', opacity: 0.9}}>{isBooked ? 'OCCUPIED' : 'AVAILABLE'}</div>
                                                {isBooked && <div style={{fontSize: '11px', marginTop: '4px', fontWeight: '500'}}>{booking.firstName}</div>}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        );
                    })}
                </div>
            </div>
        );
    };

    return (
        <div style={{minHeight: '100vh', paddingBottom: '100px'}}>
            {/* Top Bar - Always Sticky */}
            <div className="top-bar">
                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '10px'}}>
                    <div>
                        <h1 style={{fontSize: '18px', fontWeight: '700'}}>üè® Miami Beach Resort</h1>
                        <p style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', marginTop: '2px'}}>Cox's Bazar ‚Ä¢ {formatDate(today)}, {time} <span style={{background: 'rgba(34,197,94,0.3)', padding: '2px 6px', borderRadius: '4px', marginLeft: '6px', fontSize: '10px', color: '#22c55e'}}>Local Time</span></p>
                    </div>
                    <div style={{display: 'flex', gap: '8px', alignItems: 'center'}}>
                        <button className="search-btn" onClick={() => setShowSearchModal(true)}>üîç Search Guest</button>
                        <button onClick={fetchData} disabled={loading} style={{padding: '14px 20px', background: '#10b981', border: 'none', borderRadius: '10px', color: 'white', fontWeight: '600', cursor: 'pointer', fontSize: '14px'}}>{loading ? '‚è≥' : 'üîÑ'}</button>
                    </div>
                </div>
            </div>

            {/* Controls Section - Scrolls Away */}
            <div className="controls-section">
                <div className="stats-row">
                    <div className="stat-card"><div className="stat-num">{stats.total}</div><div className="stat-label">Total</div></div>
                    <div className="stat-card"><div className="stat-num" style={{color: '#22c55e'}}>{stats.avail}</div><div className="stat-label">Available</div></div>
                    <div className="stat-card"><div className="stat-num" style={{color: '#ef4444'}}>{stats.occ}</div><div className="stat-label">Occupied</div></div>
                    <div className="stat-card"><div className="stat-num" style={{color: '#3b82f6'}}>{stats.cin}</div><div className="stat-label">Check-in</div></div>
                    <div className="stat-card"><div className="stat-num" style={{color: '#a855f7'}}>{stats.cout}</div><div className="stat-label">Check-out</div></div>
                </div>
                {isMobile ? (
                    <select value={tab} onChange={e => setTab(e.target.value)} className="mobile-select" style={{marginBottom: '12px'}}>
                        {tabs.map(t => <option key={t.id} value={t.id}>{t.label}</option>)}
                    </select>
                ) : (
                    <div className="tabs-row">{tabs.map(t => <button key={t.id} onClick={() => setTab(t.id)} className={`nav-btn ${tab === t.id ? 'active' : ''}`}>{t.label}</button>)}</div>
                )}
                {tab === "calendar" && (
                    <div className="date-controls">
                        <div onClick={() => calendarDateRef.current?.showPicker()} style={{cursor: 'pointer'}}><input ref={calendarDateRef} type="date" value={startDate} onChange={e => setStartDate(e.target.value)} className="date-input" style={{cursor: 'pointer'}}/></div>
                        <button onClick={() => setStartDate(getBDDate())} className={`day-btn ${startDate === getBDDate() ? 'active' : ''}`}>Today</button>
                        <span style={{color: 'rgba(255,255,255,0.2)'}}>|</span>
                        {[3, 7, 15, 30].map(d => <button key={d} onClick={() => setCalDays(d)} className={`day-btn ${calDays === d ? 'active' : ''}`}>{d}d</button>)}
                    </div>
                )}
            </div>

            {error && <div style={{margin: '16px', padding: '12px', background: 'rgba(239,68,68,0.15)', border: '1px solid #ef4444', borderRadius: '8px', color: '#ef4444', fontSize: '13px'}}>{error}</div>}
            {loading && <div style={{display: 'flex', justifyContent: 'center', padding: '50px'}}><div className="loader"></div></div>}

            {!loading && (
                <>
                    {tab === "today" && <TodayView/>}
                    
                    {tab === "calendar" && (
                        <>
                            <div className="view-selector" style={{marginBottom: '12px'}}>
                                <button className={`view-btn ${calendarViewBy === 'floor' ? 'active' : ''}`} onClick={() => setCalendarViewBy('floor')}>üè¢ By Floor</button>
                                <button className={`view-btn ${calendarViewBy === 'category' ? 'active' : ''}`} onClick={() => setCalendarViewBy('category')}>üìÅ By Category</button>
                            </div>
                            <CalendarView groupBy={calendarViewBy}/>
                        </>
                    )}

                    {tab === "searchbook" && (
                        <div style={{padding: '16px'}}>
                            <h2 style={{fontSize: '18px', fontWeight: '600', marginBottom: '16px', textAlign: 'center'}}>üîç Search & Book</h2>
                            <div className="date-search-row">
                                <div className="date-field" onClick={() => checkinRef.current?.showPicker()}><label>Check-in</label><input ref={checkinRef} type="date" value={searchCheckIn} onChange={handleCheckInChange} className="date-input" style={{cursor: 'pointer'}}/></div>
                                <div className="date-field" onClick={() => checkoutRef.current?.showPicker()}><label>Check-out</label><input ref={checkoutRef} type="date" value={searchCheckOut} min={searchCheckIn} onChange={e => setSearchCheckOut(e.target.value)} className="date-input" style={{cursor: 'pointer'}}/></div>
                                <div className="date-field"><label>Group By</label><select value={searchGroupBy} onChange={e => setSearchGroupBy(e.target.value)} className="group-selector"><option value="floor">By Floor</option><option value="category">By Category</option></select></div>
                            </div>
                            <h3 style={{fontSize: '15px', fontWeight: '600', marginBottom: '12px', color: '#22c55e', textAlign: 'center'}}>‚úì Available: {availableRooms.length} rooms</h3>
                            {(() => {
                                const groups = searchGroupBy === "floor"
                                    ? FLOORS.map(f => ({key: f, title: `üè¢ ${floorName(f)} Floor`, rooms: availableRooms.filter(r => r.floor === f)}))
                                    : ROOMS.map(r => ({key: r.id, title: r.name, rooms: availableRooms.filter(ar => ar.room.id === r.id)}));
                                return groups.map(group => {
                                    if (!group.rooms.length) return null;
                                    return (
                                        <div key={group.key} className="today-group">
                                            <div style={{textAlign: 'center', marginBottom: '12px'}}><div className="floor-header" style={{display: 'inline-flex'}}><span style={{fontWeight: 600}}>{group.title}</span><span style={{color: 'rgba(255,255,255,0.5)', fontSize: 13}}>{group.rooms.length} available</span></div></div>
                                            <div style={{display: 'flex', flexWrap: 'wrap', gap: '12px', justifyContent: 'center'}}>
                                                {group.rooms.map(({room, unit}) => {
                                                    const isSelected = selected.find(x => x.unitKey === `${room.id}-${unit.id}`);
                                                    return (
                                                        <div key={`${room.id}-${unit.id}`} onClick={() => {
                                                            const unitKey = `${room.id}-${unit.id}`;
                                                            if (isSelected) setSelected(selected.filter(x => x.unitKey !== unitKey));
                                                            else setSelected([...selected, {unitKey, room, unit, checkIn: searchCheckIn, checkOut: searchCheckOut}]);
                                                        }} style={{background: isSelected ? 'linear-gradient(145deg, #22c55e, #16a34a)' : 'rgba(255,255,255,0.03)', border: isSelected ? '2px solid #fff' : '1px solid rgba(255,255,255,0.1)', borderRadius: '12px', padding: '14px', cursor: 'pointer'}}>
                                                            <div style={{fontSize: '22px', fontWeight: '700'}}>{unit.n}</div>
                                                            <div style={{fontSize: '10px', color: 'rgba(255,255,255,0.5)', marginTop: '4px'}}>{room.short}</div>
                                                            <div style={{fontSize: '10px', color: 'rgba(255,255,255,0.4)'}}>üë§ {room.max}A</div>
                                                            {isSelected && <div style={{marginTop: '6px', fontSize: '10px', fontWeight: '600', color: '#fff'}}>‚úì Selected</div>}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    );
                                });
                            })()}
                            {selected.length > 0 && (
                                <div style={{marginTop: '24px', padding: '16px', background: 'rgba(34,197,94,0.1)', border: '1px solid rgba(34,197,94,0.3)', borderRadius: '12px'}}>
                                    <h4 style={{marginBottom: '12px', textAlign: 'center'}}>Selected: {selected.length} room(s)</h4>
                                    <div style={{display: 'flex', flexDirection: 'column', gap: '8px', marginBottom: '16px'}}>
                                        {selected.map(s => {
                                            const nights = Math.max(1, Math.ceil((new Date(s.checkOut) - new Date(s.checkIn)) / (1000 * 60 * 60 * 24)));
                                            return (
                                                <div key={s.unitKey} style={{display: 'flex', alignItems: 'center', gap: '10px', padding: '10px 14px', background: 'rgba(34,197,94,0.15)', border: '1px solid rgba(34,197,94,0.3)', borderRadius: '10px', flexWrap: 'wrap'}}>
                                                    <span style={{fontSize: '16px', fontWeight: '700', color: '#22c55e', minWidth: '40px'}}>{s.unit.n}</span>
                                                    <input type="date" value={s.checkIn} onChange={e => setSelected(selected.map(x => x.unitKey === s.unitKey ? {...x, checkIn: e.target.value} : x))} style={{padding: '6px 10px', background: 'rgba(255,255,255,0.1)', border: '1px solid rgba(255,255,255,0.2)', borderRadius: '6px', color: '#fff', fontSize: '12px'}}/>
                                                    <span style={{color: 'rgba(255,255,255,0.5)'}}>‚Üí</span>
                                                    <input type="date" value={s.checkOut} min={s.checkIn} onChange={e => setSelected(selected.map(x => x.unitKey === s.unitKey ? {...x, checkOut: e.target.value} : x))} style={{padding: '6px 10px', background: 'rgba(255,255,255,0.1)', border: '1px solid rgba(255,255,255,0.2)', borderRadius: '6px', color: '#fff', fontSize: '12px'}}/>
                                                    <span style={{fontSize: '12px', color: 'rgba(255,255,255,0.6)', padding: '4px 8px', background: 'rgba(255,255,255,0.1)', borderRadius: '4px'}}>{nights}N</span>
                                                    <button onClick={() => setSelected(selected.filter(x => x.unitKey !== s.unitKey))} style={{marginLeft: 'auto', background: 'none', border: 'none', color: '#ef4444', cursor: 'pointer', fontSize: '16px', padding: '0 6px'}}>√ó</button>
                                                </div>
                                            );
                                        })}
                                    </div>
                                    <div style={{display: 'flex', gap: '12px', justifyContent: 'center'}}>
                                        <button onClick={() => setShowBookModal(true)} style={{padding: '14px 30px', background: '#22c55e', border: 'none', borderRadius: '10px', color: 'white', fontWeight: '700', cursor: 'pointer', fontSize: '15px'}}>üìù Book {selected.length} Room(s)</button>
                                        <button onClick={() => setSelected([])} style={{padding: '14px 20px', background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '10px', color: 'white', cursor: 'pointer'}}>Clear</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {tab === "requests" && (
                        <div style={{padding: '16px'}}>
                            <h2 style={{fontSize: '18px', fontWeight: '600', marginBottom: '16px'}}>üõéÔ∏è Guest Requests</h2>
                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(320px, 1fr))', gap: '20px'}}>
                                <div>
                                    <h3 style={{fontSize: '14px', fontWeight: '600', marginBottom: '12px', color: '#22c55e'}}>üìã Current Guests ({currentGuests.length})</h3>
                                    {currentGuests.map(guest => <GuestRequestCard key={guest.id} guest={guest} onAddRequest={addRequest} requestCounts={getRequestCounts(guest.id)}/>)}
                                    {!currentGuests.length && <div style={{color: 'rgba(255,255,255,0.4)', textAlign: 'center', padding: '20px'}}>No guests</div>}
                                </div>
                                <div>
                                    <h3 style={{fontSize: '14px', fontWeight: '600', marginBottom: '12px', color: '#f59e0b'}}>‚è≥ Pending ({requests.filter(r => !r.done).length})</h3>
                                    {requests.filter(r => !r.done).map(req => (
                                        <div key={req.id} className="request-item request-pending">
                                            <div><div style={{fontWeight: '600'}}>{req.roomNum} - {req.guestName}</div><div style={{fontSize: '12px', color: 'rgba(255,255,255,0.6)'}}>{req.requestType}</div>{req.note && <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.4)'}}>Note: {req.note}</div>}<div style={{fontSize: '10px', color: 'rgba(255,255,255,0.3)', marginTop: '4px'}}>{new Date(req.timestamp).toLocaleTimeString()}</div></div>
                                            <button className="done-btn" onClick={() => markRequestDone(req.id)}>‚úì Done</button>
                                        </div>
                                    ))}
                                    {!requests.filter(r => !r.done).length && <div style={{color: 'rgba(255,255,255,0.4)', padding: '20px', textAlign: 'center'}}>No pending</div>}
                                </div>
                                <div>
                                    <h3 style={{fontSize: '14px', fontWeight: '600', marginBottom: '12px', color: '#22c55e'}}>‚úÖ Completed</h3>
                                    {requests.filter(r => r.done).slice(0, 15).map(req => (
                                        <div key={req.id} className="request-item request-done"><div><div style={{fontWeight: '600'}}>{req.roomNum} - {req.requestType}</div><div style={{fontSize: '10px', color: 'rgba(255,255,255,0.4)'}}>Done: {new Date(req.doneAt).toLocaleString()}</div></div><span style={{color: '#22c55e'}}>‚úì</span></div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {tab === "housekeeping" && (() => {
                        const hkData = hkDay === "today" ? housekeepingToday : housekeepingTomorrow;
                        const hkDate = hkDay === "today" ? today : tomorrow;
                        const pendingReqs = requests.filter(r => !r.done);
                        const todayCompleted = requests.filter(r => r.done && r.doneAt && new Date(r.doneAt).toDateString() === new Date().toDateString());
                        
                        return (
                            <div style={{padding: '16px', maxWidth: '1200px', margin: '0 auto'}}>
                                <h2 style={{fontSize: '20px', fontWeight: '700', marginBottom: '16px', textAlign: 'center'}}>üßπ Housekeeping</h2>
                                
                                {/* Sub-tabs */}
                                <div className="view-selector" style={{marginBottom: '20px', justifyContent: 'center'}}>
                                    <button className={`view-btn ${hkTab === 'tasks' ? 'active' : ''}`} onClick={() => setHkTab('tasks')}>üìã Tasks & Requests {pendingReqs.length > 0 && <span style={{background: '#ef4444', padding: '2px 8px', borderRadius: '10px', fontSize: '11px', marginLeft: '6px'}}>{pendingReqs.length}</span>}</button>
                                    <button className={`view-btn ${hkTab === 'rooms' ? 'active' : ''}`} onClick={() => setHkTab('rooms')}>üè® Room Status</button>
                                </div>
                                
                                {/* Room Status Tab */}
                                {hkTab === 'rooms' && (
                                    <>
                                        {/* Today/Tomorrow Toggle */}
                                        <div className="view-selector" style={{marginBottom: '16px', justifyContent: 'center'}}>
                                            <button className={`view-btn ${hkDay === 'today' ? 'active' : ''}`} onClick={() => setHkDay('today')}>üìÖ Today</button>
                                            <button className={`view-btn ${hkDay === 'tomorrow' ? 'active' : ''}`} onClick={() => setHkDay('tomorrow')}>üìÜ Tomorrow</button>
                                        </div>
                                        <p style={{color: 'rgba(255,255,255,0.5)', marginBottom: '20px', textAlign: 'center'}}>{formatDate(hkDate)}</p>
                                        
                                        {/* Stats */}
                                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(120px, 1fr))', gap: '12px', marginBottom: '24px'}}>
                                            <div style={{background: 'rgba(59,130,246,0.15)', border: '1px solid rgba(59,130,246,0.3)', borderRadius: '12px', padding: '16px', textAlign: 'center'}}><div style={{fontSize: '28px', fontWeight: '700', color: '#3b82f6'}}>{hkData.checkin.length}</div><div style={{fontSize: '11px', color: 'rgba(255,255,255,0.6)'}}>Check-in</div></div>
                                            <div style={{background: 'rgba(168,85,247,0.15)', border: '1px solid rgba(168,85,247,0.3)', borderRadius: '12px', padding: '16px', textAlign: 'center'}}><div style={{fontSize: '28px', fontWeight: '700', color: '#a855f7'}}>{hkData.checkout.length}</div><div style={{fontSize: '11px', color: 'rgba(255,255,255,0.6)'}}>Check-out</div></div>
                                            <div style={{background: 'rgba(14,165,233,0.15)', border: '1px solid rgba(14,165,233,0.3)', borderRadius: '12px', padding: '16px', textAlign: 'center'}}><div style={{fontSize: '28px', fontWeight: '700', color: '#0ea5e9'}}>{hkData.stayover.length}</div><div style={{fontSize: '11px', color: 'rgba(255,255,255,0.6)'}}>Stay Over</div></div>
                                            <div style={{background: 'rgba(249,115,22,0.15)', border: '1px solid rgba(249,115,22,0.3)', borderRadius: '12px', padding: '16px', textAlign: 'center'}}><div style={{fontSize: '28px', fontWeight: '700', color: '#f97316'}}>{hkData.turnover.length}</div><div style={{fontSize: '11px', color: 'rgba(255,255,255,0.6)'}}>Turnover</div></div>
                                        </div>
                                
                                {/* Room Cards */}
                                <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(180px, 1fr))', gap: '14px', marginBottom: '32px'}}>
                                    {hkData.checkin.map(({room, unit, booking}) => (
                                        <div key={`ci-${unit.n}`} style={{background: 'rgba(59,130,246,0.1)', border: '2px solid rgba(59,130,246,0.4)', borderRadius: '14px', padding: '14px', position: 'relative'}}>
                                            <div style={{position: 'absolute', top: '-10px', left: '14px', background: '#3b82f6', padding: '2px 10px', borderRadius: '10px', fontSize: '10px', fontWeight: '700'}}>üîµ IN</div>
                                            <div style={{fontSize: '28px', fontWeight: '700', color: '#3b82f6', marginTop: '6px'}}>{unit.n}</div>
                                            <div style={{fontSize: '14px', fontWeight: '600'}}>{booking.firstName}</div>
                                            <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)'}}>{room.short}</div>
                                        </div>
                                    ))}
                                    {hkData.checkout.map(({room, unit, booking}) => (
                                        <div key={`co-${unit.n}`} style={{background: 'rgba(168,85,247,0.1)', border: '2px solid rgba(168,85,247,0.4)', borderRadius: '14px', padding: '14px', position: 'relative'}}>
                                            <div style={{position: 'absolute', top: '-10px', left: '14px', background: '#a855f7', padding: '2px 10px', borderRadius: '10px', fontSize: '10px', fontWeight: '700'}}>üü£ OUT</div>
                                            <div style={{fontSize: '28px', fontWeight: '700', color: '#a855f7', marginTop: '6px'}}>{unit.n}</div>
                                            <div style={{fontSize: '14px', fontWeight: '600'}}>{booking.firstName}</div>
                                            <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)'}}>{room.short}</div>
                                        </div>
                                    ))}
                                    {hkData.stayover.map(({room, unit, booking}) => (
                                        <div key={`so-${unit.n}`} style={{background: 'rgba(14,165,233,0.1)', border: '2px solid rgba(14,165,233,0.4)', borderRadius: '14px', padding: '14px', position: 'relative'}}>
                                            <div style={{position: 'absolute', top: '-10px', left: '14px', background: '#0ea5e9', padding: '2px 10px', borderRadius: '10px', fontSize: '10px', fontWeight: '700'}}>üîµ STAY</div>
                                            <div style={{fontSize: '28px', fontWeight: '700', color: '#0ea5e9', marginTop: '6px'}}>{unit.n}</div>
                                            <div style={{fontSize: '14px', fontWeight: '600'}}>{booking.firstName}</div>
                                            <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)'}}>{room.short}</div>
                                        </div>
                                    ))}
                                    {hkData.turnover.map(({room, unit, out, in: ci}) => (
                                        <div key={`to-${unit.n}`} style={{background: 'rgba(249,115,22,0.1)', border: '2px solid rgba(249,115,22,0.4)', borderRadius: '14px', padding: '14px', position: 'relative'}}>
                                            <div style={{position: 'absolute', top: '-10px', left: '14px', background: '#f97316', padding: '2px 10px', borderRadius: '10px', fontSize: '10px', fontWeight: '700'}}>üü† TURN</div>
                                            <div style={{fontSize: '28px', fontWeight: '700', color: '#f97316', marginTop: '6px'}}>{unit.n}</div>
                                            <div style={{fontSize: '12px', color: '#a855f7'}}>‚¨Ü {out.firstName}</div>
                                            <div style={{fontSize: '14px', fontWeight: '600', color: '#3b82f6'}}>‚¨á {ci.firstName}</div>
                                        </div>
                                    ))}
                                </div>
                                
                                        {(hkData.checkin.length + hkData.checkout.length + hkData.stayover.length + hkData.turnover.length) === 0 && <div style={{textAlign: 'center', padding: '30px', color: 'rgba(255,255,255,0.4)'}}>No room tasks for this day</div>}
                                    </>
                                )}
                                
                                {/* Tasks & Requests Tab */}
                                {hkTab === 'tasks' && (
                                    <div style={{background: 'rgba(255,255,255,0.02)', borderRadius: '16px', padding: '20px', border: '1px solid rgba(255,255,255,0.08)'}}>
                                    <h3 style={{fontSize: '18px', fontWeight: '700', marginBottom: '16px'}}>üõéÔ∏è Guest Requests {pendingReqs.length > 0 && <span style={{background: '#ef4444', padding: '4px 12px', borderRadius: '12px', fontSize: '13px', marginLeft: '8px'}}>{pendingReqs.length} pending</span>}</h3>
                                    
                                    <h4 style={{fontSize: '14px', color: '#f59e0b', marginBottom: '12px'}}>‚è≥ Pending</h4>
                                    {pendingReqs.length === 0 ? <div style={{color: 'rgba(255,255,255,0.4)', textAlign: 'center', padding: '20px'}}>No pending requests</div> : (
                                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))', gap: '12px', marginBottom: '24px'}}>
                                            {pendingReqs.map(req => (
                                                <div key={req.id} style={{background: 'rgba(249,115,22,0.1)', border: '1px solid rgba(249,115,22,0.3)', borderRadius: '12px', padding: '14px'}}>
                                                    <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '10px'}}>
                                                        <div><div style={{fontSize: '20px', fontWeight: '700', color: '#f59e0b'}}>{req.roomNum}</div><div style={{fontSize: '13px', fontWeight: '600'}}>{req.guestName}</div></div>
                                                        <div style={{background: '#f59e0b', padding: '4px 10px', borderRadius: '8px', fontSize: '11px', fontWeight: '700', height: 'fit-content'}}>{req.requestType}</div>
                                                    </div>
                                                    {req.note && <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.6)', marginBottom: '10px', padding: '8px', background: 'rgba(0,0,0,0.2)', borderRadius: '6px'}}>{req.note}</div>}
                                                    <div style={{fontSize: '10px', color: 'rgba(255,255,255,0.4)', marginBottom: '10px'}}>Requested: {new Date(req.timestamp).toLocaleString()}</div>
                                                    <input id={"staff-" + req.id} placeholder="Enter staff name" defaultValue="" style={{width: '100%', padding: '10px', marginBottom: '10px', background: 'rgba(255,255,255,0.1)', border: '1px solid rgba(255,255,255,0.2)', borderRadius: '8px', color: '#fff', fontSize: '13px', boxSizing: 'border-box'}}/>
                                                    <div style={{display: 'flex', gap: '8px'}}>
                                                        <button onClick={() => handleRequestDone(req.id, false)} style={{flex: 1, padding: '10px', background: 'linear-gradient(145deg, #22c55e, #16a34a)', border: 'none', borderRadius: '8px', color: '#fff', fontWeight: '700', cursor: 'pointer', fontSize: '13px'}}>‚úì Done</button>
                                                        <button onClick={() => handleRequestDone(req.id, true)} style={{flex: 1, padding: '10px', background: 'linear-gradient(145deg, #ef4444, #dc2626)', border: 'none', borderRadius: '8px', color: '#fff', fontWeight: '700', cursor: 'pointer', fontSize: '13px'}}>‚úï Deny</button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    
                                    <h4 style={{fontSize: '14px', color: '#22c55e', marginBottom: '12px', marginTop: '20px'}}>‚úì Completed Today ({todayCompleted.length})</h4>
                                    {todayCompleted.length === 0 ? <div style={{color: 'rgba(255,255,255,0.4)', textAlign: 'center', padding: '20px'}}>No completed requests today</div> : (
                                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(250px, 1fr))', gap: '10px'}}>
                                            {todayCompleted.map(req => (
                                                <div key={req.id} style={{background: req.denied ? 'rgba(239,68,68,0.1)' : 'rgba(34,197,94,0.1)', border: '1px solid ' + (req.denied ? 'rgba(239,68,68,0.3)' : 'rgba(34,197,94,0.3)'), borderRadius: '10px', padding: '12px', display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                                    <div><div style={{fontWeight: '600'}}>{req.roomNum} - {req.requestType}</div><div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)'}}>By: {req.doneBy || 'Staff'}</div><div style={{fontSize: '10px', color: 'rgba(255,255,255,0.4)'}}>{new Date(req.doneAt).toLocaleTimeString()}</div></div>
                                                    <div style={{color: req.denied ? '#ef4444' : '#22c55e', fontWeight: '700', fontSize: '14px'}}>{req.denied ? '‚úï' : '‚úì'}</div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    </div>
                                )}
                            </div>
                        );
                    })()}

                    {tab === "movements" && (
                        <div style={{padding: '16px'}}>
                            <h2 style={{fontSize: '18px', fontWeight: '600', marginBottom: '16px'}}>‚ÜîÔ∏è Movements - {formatDate(today)}</h2>
                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: '14px'}}>
                                <div className="hk-section">
                                    <h3 style={{color: '#3b82f6', marginBottom: '10px', fontSize: '13px'}}>‚¨áÔ∏è Pending In ({movements.pendingIn.length})</h3>
                                    {movements.pendingIn.map(b => { const {num} = getRoomInfo(b.roomId, b.unitId); const counts = getRequestCounts(b.id); return (
                                        <div key={b.id} className="mv-card"><div><div style={{fontWeight: '600'}}>{b.firstName} <span style={{color: 'rgba(255,255,255,0.5)'}}>#{num}</span></div>{counts.total > 0 && <div style={{marginTop: '4px'}}>{counts.pending > 0 && <span className="request-count pending">‚è≥ {counts.pending}</span>} {counts.done > 0 && <span className="request-count done">‚úì {counts.done}</span>}</div>}</div><button className="mv-btn mv-btn-pending" onClick={() => toggle(b.id, "in")}>‚úì</button></div>
                                    ); })}
                                    {!movements.pendingIn.length && <div style={{color: 'rgba(255,255,255,0.4)', textAlign: 'center', padding: '20px'}}>None</div>}
                                </div>
                                <div className="hk-section">
                                    <h3 style={{color: '#22c55e', marginBottom: '10px', fontSize: '13px'}}>‚úÖ Checked-in ({movements.doneIn.length})</h3>
                                    {movements.doneIn.map(b => { const {num} = getRoomInfo(b.roomId, b.unitId); const counts = getRequestCounts(b.id); return (
                                        <div key={b.id} className="mv-card"><div><div style={{fontWeight: '600'}}>{b.firstName} <span style={{color: 'rgba(255,255,255,0.5)'}}>#{num}</span></div>{counts.total > 0 && <div style={{marginTop: '4px'}}>{counts.pending > 0 && <span className="request-count pending">‚è≥ {counts.pending}</span>} {counts.done > 0 && <span className="request-count done">‚úì {counts.done}</span>}</div>}</div><button className="mv-btn mv-btn-done" onClick={() => toggle(b.id, "in")}>‚Ü©</button></div>
                                    ); })}
                                    {!movements.doneIn.length && <div style={{color: 'rgba(255,255,255,0.4)', textAlign: 'center', padding: '20px'}}>None</div>}
                                </div>
                                <div className="hk-section">
                                    <h3 style={{color: '#a855f7', marginBottom: '10px', fontSize: '13px'}}>‚¨ÜÔ∏è Pending Out ({movements.pendingOut.length})</h3>
                                    {movements.pendingOut.map(b => { const {num} = getRoomInfo(b.roomId, b.unitId); const counts = getRequestCounts(b.id); return (
                                        <div key={b.id} className="mv-card"><div><div style={{fontWeight: '600'}}>{b.firstName} <span style={{color: 'rgba(255,255,255,0.5)'}}>#{num}</span></div>{counts.total > 0 && <div style={{marginTop: '4px'}}>{counts.pending > 0 && <span className="request-count pending">‚è≥ {counts.pending}</span>} {counts.done > 0 && <span className="request-count done">‚úì {counts.done}</span>}</div>}</div><button className="mv-btn mv-btn-pending" onClick={() => toggle(b.id, "out")}>‚úì</button></div>
                                    ); })}
                                    {!movements.pendingOut.length && <div style={{color: 'rgba(255,255,255,0.4)', textAlign: 'center', padding: '20px'}}>None</div>}
                                </div>
                                <div className="hk-section">
                                    <h3 style={{color: '#f59e0b', marginBottom: '10px', fontSize: '13px'}}>üëã Checked-out ({movements.doneOut.length})</h3>
                                    {movements.doneOut.map(b => { const {num} = getRoomInfo(b.roomId, b.unitId); const counts = getRequestCounts(b.id); return (
                                        <div key={b.id} className="mv-card"><div><div style={{fontWeight: '600'}}>{b.firstName} <span style={{color: 'rgba(255,255,255,0.5)'}}>#{num}</span></div>{counts.total > 0 && <div style={{marginTop: '4px'}}>{counts.pending > 0 && <span className="request-count pending">‚è≥ {counts.pending}</span>} {counts.done > 0 && <span className="request-count done">‚úì {counts.done}</span>}</div>}</div><button className="mv-btn mv-btn-done" onClick={() => toggle(b.id, "out")}>‚Ü©</button></div>
                                    ); })}
                                    {!movements.doneOut.length && <div style={{color: 'rgba(255,255,255,0.4)', textAlign: 'center', padding: '20px'}}>None</div>}
                                </div>
                            </div>
                        </div>
                    )}

                    {tab === "accounting" && (() => {
                        const [accDateFrom, setAccDateFrom] = useState(getBDDate(-30));
                        const [accDateTo, setAccDateTo] = useState(getBDDate(30));
                        const [accFilter, setAccFilter] = useState("all"); // all, paid, partial, unpaid
                        const [accSearch, setAccSearch] = useState("");
                        const [quickPayId, setQuickPayId] = useState(null);
                        const [quickPayAmount, setQuickPayAmount] = useState("");
                        const [saving, setSaving] = useState(false);
                        
                        // Filter bookings by date range
                        const filteredBookings = bookings.filter(b => {
                            if (b.arrival < accDateFrom || b.arrival > accDateTo) return false;
                            const price = parseFloat(b.price) || 0;
                            const paid = parseFloat(b.paid) || 0;
                            const due = price - paid;
                            if (accFilter === "paid" && due > 0) return false;
                            if (accFilter === "unpaid" && paid > 0) return false;
                            if (accFilter === "partial" && (paid === 0 || due === 0)) return false;
                            if (accSearch && !b.firstName?.toLowerCase().includes(accSearch.toLowerCase()) && !b.mobile?.includes(accSearch)) return false;
                            return true;
                        }).sort((a, b) => new Date(b.arrival) - new Date(a.arrival));
                        
                        // Calculate totals
                        const totals = filteredBookings.reduce((acc, b) => {
                            const price = parseFloat(b.price) || 0;
                            const paid = parseFloat(b.paid) || 0;
                            acc.revenue += price;
                            acc.paid += paid;
                            acc.due += (price - paid);
                            if (price - paid <= 0) acc.fullyPaid++;
                            else if (paid > 0) acc.partial++;
                            else acc.unpaid++;
                            return acc;
                        }, {revenue: 0, paid: 0, due: 0, fullyPaid: 0, partial: 0, unpaid: 0});
                        
                        const collectionRate = totals.revenue > 0 ? Math.round((totals.paid / totals.revenue) * 100) : 0;
                        
                        const handleQuickPay = async (bookingId, amount, currentPaid) => {
                            setSaving(true);
                            try {
                                const newPaid = parseFloat(currentPaid || 0) + parseFloat(amount || 0);
                                const res = await fetch(PROXY + "?endpoint=bookings&action=write", {
                                    method: "POST",
                                    headers: {"Content-Type": "application/json"},
                                    body: JSON.stringify([{id: bookingId, paid: newPaid.toString()}])
                                });
                                const result = await res.json();
                                if (Array.isArray(result) ? result[0]?.success : result.success) {
                                    fetchData();
                                    setQuickPayId(null);
                                    setQuickPayAmount("");
                                }
                            } catch(e) { alert("Error: " + e.message); }
                            setSaving(false);
                        };
                        
                        const markFullyPaid = async (b) => {
                            const due = (parseFloat(b.price) || 0) - (parseFloat(b.paid) || 0);
                            if (due <= 0) return;
                            await handleQuickPay(b.id, due, b.paid);
                        };
                        
                        return (
                            <div style={{padding: '16px'}}>
                                <h2 style={{fontSize: '18px', fontWeight: '600', marginBottom: '16px'}}>üí∞ Accounting</h2>
                                
                                {/* Summary Cards */}
                                <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(140px, 1fr))', gap: '12px', marginBottom: '20px'}}>
                                    <div style={{background: 'linear-gradient(145deg, rgba(59,130,246,0.2), rgba(59,130,246,0.05))', border: '1px solid rgba(59,130,246,0.3)', borderRadius: '12px', padding: '16px', textAlign: 'center'}}>
                                        <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', marginBottom: '4px'}}>Total Revenue</div>
                                        <div style={{fontSize: '22px', fontWeight: '700', color: '#3b82f6'}}>‡ß≥{totals.revenue.toLocaleString()}</div>
                                    </div>
                                    <div style={{background: 'linear-gradient(145deg, rgba(34,197,94,0.2), rgba(34,197,94,0.05))', border: '1px solid rgba(34,197,94,0.3)', borderRadius: '12px', padding: '16px', textAlign: 'center'}}>
                                        <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', marginBottom: '4px'}}>Collected</div>
                                        <div style={{fontSize: '22px', fontWeight: '700', color: '#22c55e'}}>‡ß≥{totals.paid.toLocaleString()}</div>
                                    </div>
                                    <div style={{background: 'linear-gradient(145deg, rgba(239,68,68,0.2), rgba(239,68,68,0.05))', border: '1px solid rgba(239,68,68,0.3)', borderRadius: '12px', padding: '16px', textAlign: 'center'}}>
                                        <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', marginBottom: '4px'}}>Outstanding</div>
                                        <div style={{fontSize: '22px', fontWeight: '700', color: '#ef4444'}}>‡ß≥{totals.due.toLocaleString()}</div>
                                    </div>
                                    <div style={{background: 'linear-gradient(145deg, rgba(168,85,247,0.2), rgba(168,85,247,0.05))', border: '1px solid rgba(168,85,247,0.3)', borderRadius: '12px', padding: '16px', textAlign: 'center'}}>
                                        <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', marginBottom: '4px'}}>Collection Rate</div>
                                        <div style={{fontSize: '22px', fontWeight: '700', color: '#a855f7'}}>{collectionRate}%</div>
                                    </div>
                                </div>
                                
                                {/* Filters */}
                                <div style={{display: 'flex', flexWrap: 'wrap', gap: '10px', marginBottom: '16px', alignItems: 'center'}}>
                                    <input type="date" value={accDateFrom} onChange={e => setAccDateFrom(e.target.value)} style={{padding: '8px 12px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: '#fff', fontSize: '13px'}}/>
                                    <span style={{color: 'rgba(255,255,255,0.4)'}}>‚Üí</span>
                                    <input type="date" value={accDateTo} onChange={e => setAccDateTo(e.target.value)} style={{padding: '8px 12px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: '#fff', fontSize: '13px'}}/>
                                    <select value={accFilter} onChange={e => setAccFilter(e.target.value)} style={{padding: '8px 12px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: '#fff', fontSize: '13px'}}>
                                        <option value="all">All ({filteredBookings.length})</option>
                                        <option value="paid">‚úÖ Paid ({totals.fullyPaid})</option>
                                        <option value="partial">‚ö†Ô∏è Partial ({totals.partial})</option>
                                        <option value="unpaid">‚ùå Unpaid ({totals.unpaid})</option>
                                    </select>
                                    <input type="text" placeholder="üîç Search guest..." value={accSearch} onChange={e => setAccSearch(e.target.value)} style={{flex: 1, minWidth: '150px', padding: '8px 12px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: '#fff', fontSize: '13px'}}/>
                                </div>
                                
                                {/* Status Summary */}
                                <div style={{display: 'flex', gap: '8px', marginBottom: '16px'}}>
                                    <span style={{padding: '4px 10px', background: 'rgba(34,197,94,0.15)', border: '1px solid rgba(34,197,94,0.3)', borderRadius: '20px', fontSize: '12px', color: '#22c55e'}}>‚úÖ {totals.fullyPaid} Paid</span>
                                    <span style={{padding: '4px 10px', background: 'rgba(249,115,22,0.15)', border: '1px solid rgba(249,115,22,0.3)', borderRadius: '20px', fontSize: '12px', color: '#f97316'}}>‚ö†Ô∏è {totals.partial} Partial</span>
                                    <span style={{padding: '4px 10px', background: 'rgba(239,68,68,0.15)', border: '1px solid rgba(239,68,68,0.3)', borderRadius: '20px', fontSize: '12px', color: '#ef4444'}}>‚ùå {totals.unpaid} Unpaid</span>
                                </div>
                                
                                {/* Bookings List */}
                                <div style={{display: 'flex', flexDirection: 'column', gap: '8px', maxHeight: '50vh', overflowY: 'auto'}}>
                                    {filteredBookings.map(b => {
                                        const {num, room} = getRoomInfo(b.roomId, b.unitId);
                                        const price = parseFloat(b.price) || 0;
                                        const paid = parseFloat(b.paid) || 0;
                                        const due = price - paid;
                                        const status = due <= 0 ? 'paid' : paid > 0 ? 'partial' : 'unpaid';
                                        const statusColors = {paid: '#22c55e', partial: '#f97316', unpaid: '#ef4444'};
                                        const statusIcons = {paid: '‚úÖ', partial: '‚ö†Ô∏è', unpaid: '‚ùå'};
                                        
                                        return (
                                            <div key={b.id} style={{background: 'rgba(255,255,255,0.03)', border: '1px solid rgba(255,255,255,0.08)', borderRadius: '12px', padding: '14px', borderLeft: \`4px solid \${statusColors[status]}\`}}>
                                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', flexWrap: 'wrap', gap: '10px'}}>
                                                    <div style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
                                                        <div style={{width: '50px', height: '50px', background: 'linear-gradient(135deg, #22c55e, #16a34a)', borderRadius: '10px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '18px', fontWeight: '700'}}>{num}</div>
                                                        <div>
                                                            <div style={{fontWeight: '600', fontSize: '15px'}}>{b.firstName} {b.lastName}</div>
                                                            <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.5)'}}>{room?.short}</div>
                                                            <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.4)', marginTop: '2px'}}>{formatDate(b.arrival)} ‚Üí {formatDate(b.departure)}</div>
                                                        </div>
                                                    </div>
                                                    <div style={{textAlign: 'right'}}>
                                                        <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.5)'}}>Total: ‡ß≥{price.toLocaleString()}</div>
                                                        <div style={{fontSize: '12px', color: '#22c55e'}}>Paid: ‡ß≥{paid.toLocaleString()}</div>
                                                        <div style={{fontSize: '16px', fontWeight: '700', color: statusColors[status], marginTop: '2px'}}>{statusIcons[status]} Due: ‡ß≥{due.toLocaleString()}</div>
                                                    </div>
                                                </div>
                                                
                                                {/* Quick Pay Section */}
                                                {due > 0 && (
                                                    <div style={{marginTop: '12px', paddingTop: '12px', borderTop: '1px solid rgba(255,255,255,0.08)'}}>
                                                        {quickPayId === b.id ? (
                                                            <div style={{display: 'flex', gap: '8px', alignItems: 'center', flexWrap: 'wrap'}}>
                                                                <input type="number" placeholder="Amount" value={quickPayAmount} onChange={e => setQuickPayAmount(e.target.value)} style={{width: '120px', padding: '8px 12px', background: 'rgba(255,255,255,0.08)', border: '1px solid rgba(255,255,255,0.15)', borderRadius: '6px', color: '#fff', fontSize: '14px'}}/>
                                                                <button onClick={() => handleQuickPay(b.id, quickPayAmount, b.paid)} disabled={saving || !quickPayAmount} style={{padding: '8px 16px', background: '#22c55e', border: 'none', borderRadius: '6px', color: '#fff', fontWeight: '600', cursor: 'pointer', fontSize: '13px', opacity: saving || !quickPayAmount ? 0.5 : 1}}>{saving ? '‚è≥' : 'üíæ Save'}</button>
                                                                <button onClick={() => {setQuickPayId(null); setQuickPayAmount("");}} style={{padding: '8px 12px', background: 'rgba(239,68,68,0.2)', border: 'none', borderRadius: '6px', color: '#ef4444', cursor: 'pointer', fontSize: '13px'}}>‚úï</button>
                                                            </div>
                                                        ) : (
                                                            <div style={{display: 'flex', gap: '8px'}}>
                                                                <button onClick={() => {setQuickPayId(b.id); setQuickPayAmount(due.toString());}} style={{padding: '6px 12px', background: 'rgba(34,197,94,0.15)', border: '1px solid rgba(34,197,94,0.3)', borderRadius: '6px', color: '#22c55e', cursor: 'pointer', fontSize: '12px'}}>üíµ Add Payment</button>
                                                                <button onClick={() => markFullyPaid(b)} style={{padding: '6px 12px', background: 'rgba(59,130,246,0.15)', border: '1px solid rgba(59,130,246,0.3)', borderRadius: '6px', color: '#3b82f6', cursor: 'pointer', fontSize: '12px'}}>‚úÖ Mark Paid (‡ß≥{due.toLocaleString()})</button>
                                                                <button onClick={() => setShowInfoModal(b)} style={{padding: '6px 12px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '6px', color: 'rgba(255,255,255,0.7)', cursor: 'pointer', fontSize: '12px'}}>‚ÑπÔ∏è Details</button>
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                                {due <= 0 && (
                                                    <div style={{marginTop: '12px', paddingTop: '12px', borderTop: '1px solid rgba(255,255,255,0.08)'}}>
                                                        <button onClick={() => setShowInfoModal(b)} style={{padding: '6px 12px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '6px', color: 'rgba(255,255,255,0.7)', cursor: 'pointer', fontSize: '12px'}}>‚ÑπÔ∏è View Details</button>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                    {filteredBookings.length === 0 && (
                                        <div style={{textAlign: 'center', padding: '40px', color: 'rgba(255,255,255,0.4)'}}>No bookings found for this period</div>
                                    )}
                                </div>
                            </div>
                        );
                    })()}

                    {tab === "dashboard" && (
                        <div style={{padding: '16px'}}>
                            <h2 style={{fontSize: '18px', fontWeight: '600', marginBottom: '16px'}}>üìä Dashboard</h2>
                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '16px'}}>
                                <div className="hk-section">
                                    <h3 style={{marginBottom: '14px', fontSize: '14px'}}>By Room Type</h3>
                                    {ROOMS.map(r => { const booked = r.units.filter(u => getBooking(r.id, u.id, today)).length; const pct = Math.round(booked / r.units.length * 100); return (<div key={r.id} style={{marginBottom: '12px'}}><div style={{display: 'flex', justifyContent: 'space-between', fontSize: '12px', marginBottom: '4px'}}><span>{r.short}</span><span style={{color: 'rgba(255,255,255,0.5)'}}>{booked}/{r.units.length}</span></div><div style={{height: '8px', background: 'rgba(255,255,255,0.1)', borderRadius: '4px', overflow: 'hidden'}}><div style={{height: '100%', width: pct+'%', background: pct > 70 ? '#ef4444' : '#22c55e', borderRadius: '4px'}}></div></div></div>); })}
                                </div>
                                <div className="hk-section">
                                    <h3 style={{marginBottom: '14px', fontSize: '14px'}}>By Floor</h3>
                                    <div style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '10px'}}>
                                        {FLOORS.map(f => { const rooms = roomsByFloor[f] || []; const booked = rooms.filter(({room, unit}) => getBooking(room.id, unit.id, today)).length; const pct = rooms.length ? Math.round(booked / rooms.length * 100) : 0; return (<div key={f} style={{background: 'rgba(255,255,255,0.05)', borderRadius: '10px', padding: '14px', textAlign: 'center'}}><div style={{color: 'rgba(255,255,255,0.5)', fontSize: '11px'}}>Floor {f}</div><div style={{fontSize: '26px', fontWeight: '700', color: pct > 70 ? '#ef4444' : '#22c55e'}}>{pct}%</div><div style={{fontSize: '11px', color: 'rgba(255,255,255,0.4)'}}>{booked}/{rooms.length}</div></div>); })}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </>
            )}

            {selected.length > 0 && tab !== "searchbook" && (() => {
                const totalNights = selected.reduce((sum, s) => {
                    const n = Math.max(1, Math.ceil((new Date(s.checkOut) - new Date(s.checkIn)) / (1000 * 60 * 60 * 24)));
                    return sum + n;
                }, 0);
                return (
                    <div style={{position: 'fixed', bottom: '20px', left: '16px', right: '16px', zIndex: 1000, maxWidth: '650px', margin: '0 auto', padding: '16px', background: 'linear-gradient(145deg, #1e293b, #0f172a)', borderRadius: '16px', boxShadow: '0 10px 40px rgba(0,0,0,0.5)', border: '1px solid rgba(255,255,255,0.1)'}}>
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px'}}>
                            <div style={{fontSize: '14px', fontWeight: '600'}}>üì¶ {selected.length} Room(s) Selected</div>
                            <button onClick={() => setSelected([])} style={{background: 'rgba(239,68,68,0.2)', border: '1px solid rgba(239,68,68,0.4)', borderRadius: '6px', padding: '5px 10px', color: '#ef4444', fontSize: '11px', cursor: 'pointer'}}>‚úï Clear All</button>
                        </div>
                        <div style={{maxHeight: '150px', overflowY: 'auto', marginBottom: '12px'}}>
                            {selected.map(s => {
                                const nights = Math.max(1, Math.ceil((new Date(s.checkOut) - new Date(s.checkIn)) / (1000 * 60 * 60 * 24)));
                                return (
                                    <div key={s.unitKey} style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '8px 12px', background: 'rgba(34,197,94,0.1)', border: '1px solid rgba(34,197,94,0.3)', borderRadius: '8px', marginBottom: '6px'}}>
                                        <div style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                                            <span style={{fontSize: '18px', fontWeight: '700', color: '#22c55e'}}>{s.unit.n}</span>
                                            <span style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)'}}>{s.room.short}</span>
                                        </div>
                                        <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                                            <span style={{fontSize: '11px', color: 'rgba(255,255,255,0.7)'}}>{s.checkIn.slice(8)}-{s.checkIn.slice(5,7)} ‚Üí {s.checkOut.slice(8)}-{s.checkOut.slice(5,7)}</span>
                                            <span style={{padding: '2px 8px', background: 'rgba(59,130,246,0.3)', borderRadius: '4px', fontSize: '10px', fontWeight: '600', color: '#3b82f6'}}>{nights}N</span>
                                            <button onClick={() => setSelected(selected.filter(x => x.unitKey !== s.unitKey))} style={{background: 'none', border: 'none', color: '#ef4444', cursor: 'pointer', fontSize: '14px', padding: '0 4px'}}>√ó</button>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', marginBottom: '10px', textAlign: 'center'}}>üí° Click another date on same unit to change check-out</div>
                        <button onClick={() => setShowBookModal(true)} style={{width: '100%', padding: '14px', background: 'linear-gradient(135deg, #22c55e, #16a34a)', border: 'none', borderRadius: '10px', color: 'white', fontWeight: '700', fontSize: '14px', cursor: 'pointer', boxShadow: '0 6px 20px rgba(34,197,94,0.4)'}}>‚ûï Book {selected.length} Room(s) ‚Ä¢ {totalNights} Total Night{totalNights > 1 ? 's' : ''}</button>
                    </div>
                );
            })()}

            {showSearchModal && (
                <div className="modal-overlay" onClick={() => setShowSearchModal(false)}>
                    <div className="modal" onClick={e => e.stopPropagation()} style={{maxWidth: '550px'}}>
                        <div className="modal-header"><h3 style={{fontSize: '18px', fontWeight: '700'}}>üîç Search Guest</h3><button className="modal-close" onClick={() => setShowSearchModal(false)}>√ó</button></div>
                        <input type="text" placeholder="Search by ID, phone, email, or name..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} className="search-input" autoFocus/>
                        <div style={{marginTop: '16px', maxHeight: '400px', overflowY: 'auto'}}>
                            {globalSearchResults.map(b => { const {num, room} = getRoomInfo(b.roomId, b.unitId); return (<div key={b.id} className="search-result" onClick={() => {setShowInfoModal(b); setShowSearchModal(false);}}><div style={{display: 'flex', justifyContent: 'space-between'}}><div><div style={{fontWeight: '600'}}>{b.firstName} {b.lastName}</div><div style={{fontSize: '12px', color: 'rgba(255,255,255,0.5)'}}>{room?.name}</div><div style={{fontSize: '11px', color: 'rgba(255,255,255,0.4)'}}>üìû {b.mobile || 'N/A'} ‚Ä¢ ID: {b.id}</div></div><div style={{textAlign: 'right'}}><div style={{fontWeight: '700', color: '#22c55e', fontSize: '18px'}}>{num}</div><div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)'}}>{formatDate(b.arrival)}</div></div></div></div>); })}
                            {searchQuery && !globalSearchResults.length && <div style={{textAlign: 'center', color: 'rgba(255,255,255,0.4)', padding: '30px'}}>No results</div>}
                            {!searchQuery && <div style={{textAlign: 'center', color: 'rgba(255,255,255,0.4)', padding: '30px'}}>Type to search...</div>}
                        </div>
                    </div>
                </div>
            )}

            {showInfoModal && <InfoModal booking={showInfoModal} onClose={() => setShowInfoModal(null)} getMultiUnitInfo={getMultiUnitInfo} getRequestCounts={getRequestCounts} requests={requests} onUpdate={() => {fetchData(); setShowInfoModal(null);}}/>}
            {showBookModal && <BookingModal selected={selected} checkIn={tab === "searchbook" ? searchCheckIn : multiBookCheckIn} checkOut={tab === "searchbook" ? searchCheckOut : multiBookCheckOut} onClose={() => {setShowBookModal(false); setSelected([]); fetchData();}}/>}
        </div>
    );
}

function GuestRequestCard({guest, onAddRequest, requestCounts}) {
    const [requestType, setRequestType] = useState("");
    const [note, setNote] = useState("");
    const [expanded, setExpanded] = useState(false);
    const handleSubmit = () => { if (!requestType) return; onAddRequest(guest.num, guest.firstName, guest.id, requestType, note); setRequestType(""); setNote(""); setExpanded(false); };
    return (
        <div className="request-card">
            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                <div>
                    <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                        <span style={{fontSize: '18px', fontWeight: '700', color: '#22c55e'}}>{guest.num}</span>
                        {requestCounts.total > 0 && <span style={{fontSize: '11px'}}>{requestCounts.pending > 0 && <span className="request-count pending">‚è≥ {requestCounts.pending}</span>}{requestCounts.done > 0 && <span className="request-count done" style={{marginLeft: '4px'}}>‚úì {requestCounts.done}</span>}</span>}
                    </div>
                    <div style={{fontWeight: '600', marginTop: '2px'}}>{guest.firstName}</div>
                </div>
                <button onClick={() => setExpanded(!expanded)} style={{padding: '8px 14px', background: expanded ? 'rgba(255,255,255,0.1)' : '#22c55e', border: 'none', borderRadius: '8px', color: 'white', fontWeight: '600', cursor: 'pointer', fontSize: '12px'}}>{expanded ? '‚úï' : '+ Request'}</button>
            </div>
            {expanded && (<div style={{marginTop: '12px'}}><select value={requestType} onChange={e => setRequestType(e.target.value)} className="request-select"><option value="">Select...</option>{REQUEST_TYPES.map(t => <option key={t} value={t}>{t}</option>)}</select><textarea value={note} onChange={e => setNote(e.target.value)} placeholder="Note..." className="request-note" rows={2}/><button onClick={handleSubmit} disabled={!requestType} className="request-btn" style={{opacity: requestType ? 1 : 0.5}}>Submit</button></div>)}
        </div>
    );
}

function InfoModal({booking, onClose, getMultiUnitInfo, getRequestCounts, requests, onUpdate}) {
    const {num, room} = getRoomInfo(booking.roomId, booking.unitId);
    const multiUnit = getMultiUnitInfo(booking);
    const price = parseFloat(booking.price) || 0, paid = parseFloat(booking.paid) || 0, due = price - paid;
    const counts = getRequestCounts(booking.id);
    const bookingRequests = requests.filter(r => r.bookingId === booking.id);
    
    const [editMode, setEditMode] = useState(null); // 'guest', 'dates', 'payment'
    const [saving, setSaving] = useState(false);
    const [form, setForm] = useState({
        firstName: booking.firstName || '',
        lastName: booking.lastName || '',
        mobile: booking.mobile || '',
        email: booking.email || '',
        nid: booking.custom4 || '',
        dob: booking.custom5 || '',
        arrival: booking.arrival || '',
        departure: booking.departure || '',
        price: price.toString(),
        paid: paid.toString()
    });
    
    const inputStyle = {width: '100%', padding: '10px', background: 'rgba(255,255,255,0.08)', border: '1px solid rgba(255,255,255,0.15)', borderRadius: '6px', color: '#fff', fontSize: '14px'};
    
    const saveChanges = async (fields) => {
        setSaving(true);
        try {
            const updateData = {id: booking.id};
            fields.forEach(f => {
                if (f === 'nid') updateData.custom4 = form.nid;
                else if (f === 'dob') updateData.custom5 = form.dob;
                else updateData[f] = form[f];
            });
            
            console.log("Updating booking:", updateData);
            const res = await fetch(PROXY + "?endpoint=bookings&action=write", {
                method: "POST", 
                headers: {"Content-Type": "application/json"}, 
                body: JSON.stringify([updateData])
            });
            const result = await res.json();
            console.log("Update response:", result);
            
            const success = Array.isArray(result) ? result[0]?.success : result.success;
            if (success) {
                setEditMode(null);
                if (onUpdate) onUpdate();
            } else {
                alert("Update failed: " + JSON.stringify(result));
            }
        } catch(e) {
            console.error("Update error:", e);
            alert("Error: " + e.message);
        }
        setSaving(false);
    };
    
    return (
        <div className="modal-overlay" onClick={onClose}>
            <div className="modal" onClick={e => e.stopPropagation()} style={{maxHeight: '90vh', overflowY: 'auto'}}>
                <div className="modal-header"><h3 style={{fontSize: '18px', fontWeight: '700'}}>‚ÑπÔ∏è Booking Details</h3><button className="modal-close" onClick={onClose}>√ó</button></div>
                
                {/* Room & Guest Header */}
                <div style={{display: 'flex', alignItems: 'center', gap: '16px', marginBottom: '20px'}}>
                    <div style={{width: '70px', height: '70px', background: 'linear-gradient(135deg, #22c55e, #16a34a)', borderRadius: '12px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '28px', fontWeight: '700'}}>{num}</div>
                    <div style={{flex: 1}}>
                        <div style={{fontSize: '20px', fontWeight: '700'}}>{booking.firstName} {booking.lastName}</div>
                        <div style={{color: 'rgba(255,255,255,0.5)', fontSize: '13px'}}>{room?.name}</div>
                        <div style={{color: 'rgba(255,255,255,0.4)', fontSize: '12px'}}>ID: {booking.id}</div>
                    </div>
                </div>
                
                {/* Guest Info Section */}
                <div className="info-section" style={{position: 'relative'}}>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px'}}>
                        <div className="info-label">üë§ Guest Info</div>
                        <button onClick={() => setEditMode(editMode === 'guest' ? null : 'guest')} style={{background: editMode === 'guest' ? 'rgba(239,68,68,0.2)' : 'rgba(59,130,246,0.2)', border: 'none', borderRadius: '6px', padding: '6px 12px', color: editMode === 'guest' ? '#ef4444' : '#3b82f6', cursor: 'pointer', fontSize: '12px', fontWeight: '600'}}>{editMode === 'guest' ? '‚úï Cancel' : '‚úèÔ∏è Edit'}</button>
                    </div>
                    {editMode === 'guest' ? (
                        <div style={{display: 'flex', flexDirection: 'column', gap: '10px'}}>
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px'}}>
                                <input value={form.firstName} onChange={e => setForm({...form, firstName: e.target.value})} placeholder="First Name" style={inputStyle}/>
                                <input value={form.lastName} onChange={e => setForm({...form, lastName: e.target.value})} placeholder="Last Name" style={inputStyle}/>
                            </div>
                            <input value={form.mobile} onChange={e => setForm({...form, mobile: e.target.value})} placeholder="Phone" style={inputStyle}/>
                            <input value={form.email} onChange={e => setForm({...form, email: e.target.value})} placeholder="Email" style={inputStyle}/>
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px'}}>
                                <input value={form.nid} onChange={e => setForm({...form, nid: e.target.value})} placeholder="NID" style={inputStyle}/>
                                <input value={form.dob} onChange={e => setForm({...form, dob: e.target.value})} placeholder="DOB" style={inputStyle}/>
                            </div>
                            <button onClick={() => saveChanges(['firstName', 'lastName', 'mobile', 'email', 'nid', 'dob'])} disabled={saving} style={{padding: '12px', background: '#22c55e', border: 'none', borderRadius: '8px', color: '#fff', fontWeight: '700', cursor: 'pointer', opacity: saving ? 0.6 : 1}}>{saving ? '‚è≥ Saving...' : 'üíæ Save Guest Info'}</button>
                        </div>
                    ) : (
                        <div>
                            <div className="info-value" style={{marginBottom: '6px'}}>{booking.firstName} {booking.lastName}</div>
                            <div style={{fontSize: '13px', color: 'rgba(255,255,255,0.6)'}}>üìû {booking.mobile || 'No phone'}</div>
                            {booking.email && booking.email !== 'default' && <div style={{fontSize: '13px', color: 'rgba(255,255,255,0.5)', marginTop: '4px'}}>‚úâÔ∏è {booking.email}</div>}
                            {booking.custom4 && booking.custom4 !== 'default' && <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.4)', marginTop: '4px'}}>ü™™ NID: {booking.custom4}</div>}
                            {booking.custom5 && booking.custom5 !== 'default' && <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.4)', marginTop: '2px'}}>üéÇ DOB: {booking.custom5}</div>}
                        </div>
                    )}
                </div>
                
                {/* Dates Section */}
                <div className="info-section">
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px'}}>
                        <div className="info-label">üìÖ Stay Dates</div>
                        <button onClick={() => setEditMode(editMode === 'dates' ? null : 'dates')} style={{background: editMode === 'dates' ? 'rgba(239,68,68,0.2)' : 'rgba(59,130,246,0.2)', border: 'none', borderRadius: '6px', padding: '6px 12px', color: editMode === 'dates' ? '#ef4444' : '#3b82f6', cursor: 'pointer', fontSize: '12px', fontWeight: '600'}}>{editMode === 'dates' ? '‚úï Cancel' : '‚úèÔ∏è Edit'}</button>
                    </div>
                    {editMode === 'dates' ? (
                        <div style={{display: 'flex', flexDirection: 'column', gap: '10px'}}>
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px'}}>
                                <div><label style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', display: 'block', marginBottom: '4px'}}>Check-in</label><input type="date" value={form.arrival} onChange={e => setForm({...form, arrival: e.target.value})} style={inputStyle}/></div>
                                <div><label style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', display: 'block', marginBottom: '4px'}}>Check-out</label><input type="date" value={form.departure} min={form.arrival} onChange={e => setForm({...form, departure: e.target.value})} style={inputStyle}/></div>
                            </div>
                            <button onClick={() => saveChanges(['arrival', 'departure'])} disabled={saving} style={{padding: '12px', background: '#22c55e', border: 'none', borderRadius: '8px', color: '#fff', fontWeight: '700', cursor: 'pointer', opacity: saving ? 0.6 : 1}}>{saving ? '‚è≥ Saving...' : 'üíæ Save Dates'}</button>
                        </div>
                    ) : (
                        <div className="info-grid">
                            <div><div className="info-label">Check-in</div><div className="info-value">{formatDate(booking.arrival)}</div></div>
                            <div><div className="info-label">Check-out</div><div className="info-value">{formatDate(booking.departure)}</div></div>
                        </div>
                    )}
                </div>
                
                {/* Payment Section */}
                <div className="info-section">
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px'}}>
                        <div className="info-label">üí∞ Payment</div>
                        <button onClick={() => setEditMode(editMode === 'payment' ? null : 'payment')} style={{background: editMode === 'payment' ? 'rgba(239,68,68,0.2)' : 'rgba(59,130,246,0.2)', border: 'none', borderRadius: '6px', padding: '6px 12px', color: editMode === 'payment' ? '#ef4444' : '#3b82f6', cursor: 'pointer', fontSize: '12px', fontWeight: '600'}}>{editMode === 'payment' ? '‚úï Cancel' : '‚úèÔ∏è Edit'}</button>
                    </div>
                    {editMode === 'payment' ? (
                        <div style={{display: 'flex', flexDirection: 'column', gap: '10px'}}>
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px'}}>
                                <div><label style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', display: 'block', marginBottom: '4px'}}>Total Price (‡ß≥)</label><input type="number" value={form.price} onChange={e => setForm({...form, price: e.target.value})} style={inputStyle}/></div>
                                <div><label style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', display: 'block', marginBottom: '4px'}}>Paid (‡ß≥)</label><input type="number" value={form.paid} onChange={e => setForm({...form, paid: e.target.value})} style={inputStyle}/></div>
                            </div>
                            <div style={{padding: '10px', background: 'rgba(255,255,255,0.05)', borderRadius: '6px', textAlign: 'center'}}>
                                <span style={{fontSize: '12px', color: 'rgba(255,255,255,0.5)'}}>Due: </span>
                                <span style={{fontSize: '18px', fontWeight: '700', color: (parseFloat(form.price) - parseFloat(form.paid)) > 0 ? '#ef4444' : '#22c55e'}}>‡ß≥{(parseFloat(form.price || 0) - parseFloat(form.paid || 0)).toLocaleString()}</span>
                            </div>
                            <button onClick={() => saveChanges(['price', 'paid'])} disabled={saving} style={{padding: '12px', background: '#22c55e', border: 'none', borderRadius: '8px', color: '#fff', fontWeight: '700', cursor: 'pointer', opacity: saving ? 0.6 : 1}}>{saving ? '‚è≥ Saving...' : 'üíæ Save Payment'}</button>
                        </div>
                    ) : (
                        <>
                            <div className="info-grid" style={{marginTop: '8px'}}>
                                <div><div className="info-label">Total</div><div className="info-value">‡ß≥{price.toLocaleString()}</div></div>
                                <div><div className="info-label">Paid</div><div className="info-value" style={{color: '#22c55e'}}>‡ß≥{paid.toLocaleString()}</div></div>
                            </div>
                            <div style={{marginTop: '12px', padding: '12px', background: due > 0 ? 'rgba(239,68,68,0.15)' : 'rgba(34,197,94,0.15)', borderRadius: '8px', textAlign: 'center'}}>
                                <div className="info-label">Due</div>
                                <div style={{fontSize: '28px', fontWeight: '700', color: due > 0 ? '#ef4444' : '#22c55e'}}>‡ß≥{due.toLocaleString()}</div>
                            </div>
                        </>
                    )}
                </div>
                
                {/* Requests Section */}
                {counts.total > 0 && (
                    <div className="info-section">
                        <div className="info-label">üõéÔ∏è Requests ({counts.total})</div>
                        <div style={{display: 'flex', gap: '8px', marginTop: '8px'}}>{counts.pending > 0 && <span className="request-count pending" style={{padding: '4px 10px'}}>‚è≥ {counts.pending} Pending</span>}{counts.done > 0 && <span className="request-count done" style={{padding: '4px 10px'}}>‚úì {counts.done} Done</span>}</div>
                        <div style={{marginTop: '10px', maxHeight: '150px', overflowY: 'auto'}}>
                            {bookingRequests.map(r => (<div key={r.id} style={{padding: '8px', background: 'rgba(255,255,255,0.03)', borderRadius: '6px', marginBottom: '6px', fontSize: '12px', borderLeft: r.done ? '3px solid #22c55e' : '3px solid #f59e0b'}}><div style={{fontWeight: '600'}}>{r.requestType}</div>{r.note && <div style={{color: 'rgba(255,255,255,0.5)', marginTop: '2px'}}>{r.note}</div>}<div style={{color: 'rgba(255,255,255,0.4)', marginTop: '4px'}}>{r.done ? `‚úì Done ${new Date(r.doneAt).toLocaleTimeString()}` : `‚è≥ ${new Date(r.timestamp).toLocaleTimeString()}`}</div></div>))}
                        </div>
                    </div>
                )}
                
                {/* Multi-Unit Info */}
                {multiUnit && (<div className="info-section" style={{background: 'rgba(59,130,246,0.1)', border: '1px solid rgba(59,130,246,0.3)'}}><div className="info-label" style={{color: '#3b82f6'}}>üîó Multi-Room ({multiUnit.count})</div><div style={{fontSize: '13px', marginTop: '6px'}}>Rooms: {multiUnit.rooms.join(", ")}</div><div style={{marginTop: '10px', padding: '10px', background: 'rgba(0,0,0,0.2)', borderRadius: '8px', textAlign: 'center'}}><div className="info-label">Total Due</div><div style={{fontSize: '24px', fontWeight: '700', color: multiUnit.totalDue > 0 ? '#ef4444' : '#22c55e'}}>‡ß≥{multiUnit.totalDue.toLocaleString()}</div></div></div>)}
            </div>
        </div>
    );
}

function BookingModal({selected, checkIn, checkOut, onClose}) {
    const hasIndividualDates = selected.length > 0 && selected[0].checkIn;
    const defaultCheckIn = hasIndividualDates ? selected[0].checkIn : (checkIn || getBDDate());
    const defaultCheckOut = hasIndividualDates ? selected[0].checkOut : (checkOut || getBDDate(1));
    const [form, setForm] = useState({guests: [{name: ""}], phones: [""], email: "", nid: "", dob: "", checkIn: defaultCheckIn, checkOut: defaultCheckOut});
    const [status, setStatus] = useState("");
    const add = (f) => form[f].length < 3 && setForm({...form, [f]: [...form[f], f === 'guests' ? {name: ""} : ""]});
    const upd = (f, i, v) => { const a = [...form[f]]; f === 'guests' ? a[i].name = v : a[i] = v; setForm({...form, [f]: a}); };
    const rem = (f, i) => form[f].length > 1 && setForm({...form, [f]: form[f].filter((_, idx) => idx !== i)});
    const submit = async (e) => {
        e.preventDefault(); setStatus("loading");
        try {
            const names = form.guests.map(g => g.name).filter(Boolean).join(", ");
            const phones = form.phones.filter(Boolean).join(", ");
            const groupId = "GRP" + Date.now(); // Link multi-unit bookings
            
            // Create booking data for each selected unit with its own dates
            const data = selected.map(s => ({
                propertyId: PROPERTY, 
                roomId: s.room.id, 
                unitId: s.unit.id, 
                arrival: s.checkIn || form.checkIn, 
                departure: s.checkOut || form.checkOut, 
                numAdult: s.room.max || 2, 
                numChild: 0, 
                status: "confirmed", 
                firstName: names, 
                email: form.email || "guest@miami.com", 
                mobile: phones, 
                custom4: form.nid || "", 
                custom5: form.dob || "", 
                referer: "miami_frontdesk",
                groupId: selected.length > 1 ? groupId : undefined
            }));
            
            console.log("Booking data to send:", JSON.stringify(data, null, 2));
            
            const res = await fetch(PROXY + "?endpoint=bookings&action=write", {method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify(data)});
            const result = await res.json();
            console.log("Beds24 response:", result);
            
            // API returns array of results - check if all succeeded
            const isArray = Array.isArray(result);
            const allSuccess = isArray ? result.every(r => r.success) : result.success;
            const errors = isArray ? result.filter(r => !r.success).map(r => r.error || "Unknown error") : [];
            
            if (allSuccess) { 
                setStatus("success"); 
                setTimeout(onClose, 1500); 
            } else {
                const errorMsg = errors.length ? errors.join(", ") : (result.error || JSON.stringify(result));
                setStatus("error: " + errorMsg);
            }
        } catch(e) { 
            console.error("Booking error:", e);
            setStatus("error: " + e.message); 
        }
    };
    if (status === "success") return (<div className="modal-overlay"><div className="modal" style={{textAlign: 'center', padding: '50px'}}><div style={{fontSize: '56px', marginBottom: '16px'}}>‚úÖ</div><div style={{fontSize: '20px', fontWeight: '700'}}>Booking Created!</div></div></div>);
    const inputStyle = {width: '100%', padding: '12px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: '#fff', fontSize: '14px'};
    return (
        <div className="modal-overlay">
            <div className="modal">
                <div className="modal-header"><h3 style={{fontSize: '18px', fontWeight: '700'}}>‚ûï New Booking</h3><button className="modal-close" onClick={onClose}>√ó</button></div>
                <div style={{marginBottom: '20px'}}>
                    {selected.map(s => {
                        const nights = s.checkIn ? Math.max(1, Math.ceil((new Date(s.checkOut) - new Date(s.checkIn)) / (1000 * 60 * 60 * 24))) : null;
                        return (
                            <div key={s.unitKey || s.key} style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '8px 12px', background: 'rgba(34,197,94,0.15)', border: '1px solid rgba(34,197,94,0.3)', borderRadius: '8px', marginBottom: '6px'}}>
                                <span style={{fontSize: '16px', fontWeight: '700', color: '#22c55e'}}>{s.unit.n}</span>
                                {s.checkIn && <span style={{fontSize: '12px', color: 'rgba(255,255,255,0.7)'}}>{s.checkIn.slice(8)}-{s.checkIn.slice(5,7)} ‚Üí {s.checkOut.slice(8)}-{s.checkOut.slice(5,7)} ({nights}N)</span>}
                            </div>
                        );
                    })}
                </div>
                <form onSubmit={submit}>
                    {!hasIndividualDates && <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '16px'}}><div><label style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', display: 'block', marginBottom: '4px'}}>Check-in</label><input type="date" required value={form.checkIn} onChange={e => setForm({...form, checkIn: e.target.value})} style={inputStyle}/></div><div><label style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', display: 'block', marginBottom: '4px'}}>Check-out</label><input type="date" required min={form.checkIn} value={form.checkOut} onChange={e => setForm({...form, checkOut: e.target.value})} style={inputStyle}/></div></div>}
                    <div style={{marginBottom: '16px'}}><div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '6px'}}><label style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)'}}>Guests *</label>{form.guests.length < 3 && <button type="button" onClick={() => add('guests')} style={{background: 'none', border: 'none', color: '#22c55e', fontSize: '11px', cursor: 'pointer'}}>+ Add</button>}</div>{form.guests.map((g, i) => (<div key={i} style={{display: 'flex', gap: '8px', marginBottom: '8px'}}><input type="text" required value={g.name} onChange={e => upd('guests', i, e.target.value)} placeholder={`Guest ${i+1}`} style={{...inputStyle, flex: 1}}/>{form.guests.length > 1 && <button type="button" onClick={() => rem('guests', i)} style={{background: 'none', border: 'none', color: '#ef4444', fontSize: '18px', cursor: 'pointer'}}>√ó</button>}</div>))}</div>
                    <div style={{marginBottom: '16px'}}><div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '6px'}}><label style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)'}}>Phone *</label>{form.phones.length < 3 && <button type="button" onClick={() => add('phones')} style={{background: 'none', border: 'none', color: '#22c55e', fontSize: '11px', cursor: 'pointer'}}>+ Add</button>}</div>{form.phones.map((p, i) => (<div key={i} style={{display: 'flex', gap: '8px', marginBottom: '8px'}}><input type="tel" required value={p} onChange={e => upd('phones', i, e.target.value)} placeholder={`Phone ${i+1}`} style={{...inputStyle, flex: 1}}/>{form.phones.length > 1 && <button type="button" onClick={() => rem('phones', i)} style={{background: 'none', border: 'none', color: '#ef4444', fontSize: '18px', cursor: 'pointer'}}>√ó</button>}</div>))}</div>
                    <input type="email" value={form.email} onChange={e => setForm({...form, email: e.target.value})} placeholder="Email (optional)" style={{...inputStyle, marginBottom: '12px'}}/>
                    <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '16px'}}><input type="text" value={form.nid} onChange={e => setForm({...form, nid: e.target.value})} placeholder="NID" style={inputStyle}/><input type="text" value={form.dob} onChange={e => setForm({...form, dob: e.target.value})} placeholder="DOB" style={inputStyle}/></div>
                    {status.startsWith("error") && <div style={{padding: '10px', background: 'rgba(239,68,68,0.15)', border: '1px solid #ef4444', borderRadius: '8px', color: '#ef4444', fontSize: '12px', marginBottom: '14px'}}>{status}</div>}
                    <div style={{display: 'flex', gap: '12px'}}><button type="button" onClick={onClose} style={{flex: 1, padding: '12px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: '#fff', fontWeight: '600', cursor: 'pointer'}}>Cancel</button><button type="submit" disabled={status === "loading"} style={{flex: 1, padding: '12px', background: '#22c55e', border: 'none', borderRadius: '8px', color: 'white', fontWeight: '700', cursor: 'pointer', opacity: status === "loading" ? 0.6 : 1}}>{status === "loading" ? "..." : "Book"}</button></div>
                </form>
            </div>
        </div>
    );
}

ReactDOM.render(<App/>, document.getElementById("root"));
</script>
</body>
</html>
