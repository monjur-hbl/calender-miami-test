<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="-1">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miami Beach Resort v27</title>
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <!-- Firebase SDK for real-time notifications -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <!-- Note: Modular files available in js/ and css/ folders for reference -->
    <!-- For production with ES modules, migrate to Vite build system -->
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #1E293B; min-height: 100vh; color: #fff; }
        
        /* Top Bar - Always sticky */
        .top-bar { background: #141824; border-bottom: 1px solid rgba(255,255,255,0.08); position: sticky; top: 0; z-index: 200; padding: 12px 16px; }
        
        /* Controls Section - Scrolls away */
        .controls-section { background: #141824; padding: 16px; padding-top: 8px; }
        
        /* Tabs Wrapper - Sticky below top bar */
        .tabs-wrapper { position: sticky; top: 58px; z-index: 150; background: #141824; padding: 12px 16px 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.08); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        
        /* Stats Row - 5 items */
        .stats-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 14px; }
        .stat-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 14px 8px; text-align: center; }
        .stat-num { font-size: 26px; font-weight: 700; }
        .stat-label { font-size: 9px; color: rgba(255,255,255,0.5); margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Search Button - 1.5x bigger */
        .search-btn { display: flex; align-items: center; gap: 10px; padding: 14px 24px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; color: rgba(255,255,255,0.7); cursor: pointer; font-size: 15px; font-weight: 500; transition: all 0.2s; }
        .search-btn:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: #2D6A6A; }
        
        /* Tabs - Full width stretched */
        .tabs-row { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 16px; justify-content: center; }
        .nav-btn { padding: 14px 20px; border-radius: 12px; font-size: 14px; font-weight: 600; border: none; cursor: pointer; transition: all 0.3s; background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.7); white-space: nowrap; text-align: center; border: 1px solid rgba(255,255,255,0.08); }
        .nav-btn:hover { background: rgba(255,255,255,0.12); color: #fff; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .nav-btn.active { background: linear-gradient(145deg, #2D6A6A, #059669); color: white; box-shadow: 0 4px 16px rgba(45,106,106,0.4); border-color: transparent; }
        
        /* Date controls - Centered */
        .date-controls { display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 10px; }
        .day-btn { padding: 9px 14px; border-radius: 8px; font-size: 13px; font-weight: 600; border: none; cursor: pointer; background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.6); }
        .day-btn:hover { background: rgba(255,255,255,0.1); }
        .day-btn.active { background: #2D6A6A; color: white; }
        .date-input { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 9px 12px; color: #fff; font-size: 13px; }
        
        /* Sticky Date Header - sticks below tabs-wrapper (top-bar 58px + tabs-wrapper ~170px) */
        .date-header-wrapper { position: sticky; top: 228px; z-index: 140; background: #1E293B; padding: 12px 16px; border-top: 3px solid #2D6A6A; box-shadow: 0 4px 12px rgba(0,0,0,0.3); overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; }
        .date-header-wrapper::-webkit-scrollbar { display: none; }
        .date-header-inner { display: flex; gap: 6px; padding-left: 140px; }
        .date-cell { flex: 1; min-width: 80px; text-align: center; padding: 10px 6px; background: rgba(255,255,255,0.05); border-radius: 10px; }
        .date-cell.today { background: #2D6A6A; }
        .date-day { font-size: 12px; font-weight: 500; color: rgba(255,255,255,0.7); }
        .date-num { font-size: 20px; font-weight: 700; margin-top: 2px; }

        /* Occupancy Summary Row - Sticky below dates */
        .occupancy-row-wrapper { position: sticky; top: 318px; z-index: 139; background: #1E293B; padding: 8px 16px 8px; overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; }
        .occupancy-row-wrapper::-webkit-scrollbar { display: none; }
        .occupancy-row-inner { display: flex; gap: 6px; padding-left: 140px; }
        .occupancy-cell { flex: 1; min-width: 80px; text-align: center; padding: 6px 4px; background: rgba(255,255,255,0.03); border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); }
        .occupancy-cell .occ-available { font-size: 14px; font-weight: 700; color: #10b981; }
        .occupancy-cell .occ-occupied { font-size: 10px; color: rgba(255,255,255,0.5); margin-top: 2px; }
        .occupancy-cell.full { background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.3); }
        .occupancy-cell.full .occ-available { color: #ef4444; }
        .occupancy-cell.low { background: rgba(245,158,11,0.1); border-color: rgba(245,158,11,0.2); }
        .occupancy-cell.low .occ-available { color: #f59e0b; }

        /* Calendar Container */
        .cal-container { padding: 0 16px 100px; overflow-x: auto; }
        
        /* Floor Header */
        .floor-header { display: inline-flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.05); padding: 10px 18px; border-radius: 10px; margin: 12px 0 10px 0; }
        
        /* Room Row */
        .room-row { display: flex; gap: 6px; margin-bottom: 6px; }
        
        /* Room Label */
        .room-label { min-width: 134px; max-width: 134px; background: #232a3b; border-radius: 10px; padding: 12px; display: flex; flex-direction: column; justify-content: center; }
        .room-num { font-size: 22px; font-weight: 700; }
        .room-type { font-size: 10px; color: rgba(255,255,255,0.5); margin-top: 3px; line-height: 1.2; }
        .room-cap { font-size: 10px; color: rgba(255,255,255,0.4); margin-top: 2px; }
        
        /* Status Card - Responsive to fill available space */
        .status-card { flex: 1; min-width: 80px; min-height: 80px; border-radius: 10px; padding: 10px; position: relative; cursor: pointer; transition: all 0.15s; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .status-card:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        
        /* Only 2 colors: Green (available) and Red (booked) */
        .card-available { background: linear-gradient(145deg, #2D6A6A 0%, #245858 100%); }
        .card-booked { background: linear-gradient(145deg, #ef4444 0%, #dc2626 100%); }
        .card-request { background: linear-gradient(145deg, #f59e0b 0%, #d97706 100%); }
        .card-cancelled { background: linear-gradient(145deg, #6b7280 0%, #4b5563 100%); opacity: 0.6; }
        .card-new { background: linear-gradient(145deg, #3b82f6 0%, #2563eb 100%); }
        .card-black { background: linear-gradient(145deg, #1f2937 0%, #111827 100%); border: 2px solid #374151; }
        .card-inquiry { background: linear-gradient(145deg, #a855f7 0%, #7c3aed 100%); }
        .card-selected-preview { background: linear-gradient(145deg, #ef4444 0%, #dc2626 100%); box-shadow: 0 0 0 3px rgba(239,68,68,0.5); animation: pulse-selection 1.5s ease-in-out infinite; }
        .card-ready-checkin { background: linear-gradient(145deg, #10b981 0%, #059669 100%); box-shadow: 0 0 0 2px rgba(16,185,129,0.4); animation: pulse-ready 2s ease-in-out infinite; }
        .card-checkout-pending { background: linear-gradient(145deg, #D4A853 0%, #B8942F 100%); box-shadow: 0 0 0 2px rgba(212,168,83,0.4); }
        .card-overbooking { background: linear-gradient(145deg, #dc2626 0%, #991b1b 100%); box-shadow: 0 0 0 3px rgba(220,38,38,0.6); animation: pulse-overbooking 0.8s ease-in-out infinite; }
        @keyframes pulse-overbooking { 0%, 100% { box-shadow: 0 0 0 3px rgba(220,38,38,0.6); } 50% { box-shadow: 0 0 0 5px rgba(220,38,38,0.4), 0 0 15px rgba(220,38,38,0.3); } }
        @keyframes pulse-selection { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        @keyframes pulse-ready { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        @keyframes pulse-dot { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.3); opacity: 0.7; } }
        .card-selected { box-shadow: 0 0 0 3px #fff, 0 0 0 6px #2D6A6A !important; }
        
        .status-text { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .guest-name { font-size: 11px; font-weight: 500; margin-top: 4px; opacity: 0.9; }
        
        .info-btn { position: absolute; top: 6px; right: 6px; width: 20px; height: 20px; background: rgba(255,255,255,0.25); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; border: none; color: white; z-index: 5; }
        .info-btn:hover { background: rgba(255,255,255,0.4); }
        
        /* Today Tab - View Selector */
        .view-selector { display: flex; gap: 8px; margin-bottom: 16px; justify-content: center; }
        .view-btn { padding: 10px 20px; border-radius: 8px; font-size: 13px; font-weight: 500; border: 2px solid rgba(255,255,255,0.1); cursor: pointer; background: transparent; color: rgba(255,255,255,0.6); transition: all 0.2s; }
        .view-btn:hover { border-color: rgba(255,255,255,0.3); color: #fff; }
        .view-btn.active { background: #2D6A6A; border-color: #2D6A6A; color: white; }
        
        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 16px; }
        .modal { background: linear-gradient(180deg, #1a2636 0%, #162030 100%); border: 1px solid rgba(255,255,255,0.12); border-radius: 20px; padding: 28px; width: 100%; max-width: 520px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.5); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-close { background: none; border: none; color: rgba(255,255,255,0.5); font-size: 28px; cursor: pointer; }
        
        .info-section { background: rgba(255,255,255,0.03); border-radius: 10px; padding: 14px; margin-bottom: 12px; }
        .info-label { font-size: 10px; color: rgba(255,255,255,0.4); text-transform: uppercase; margin-bottom: 4px; }
        .info-value { font-size: 15px; font-weight: 600; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        /* Search */
        .search-input { width: 100%; padding: 14px 18px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; color: #fff; font-size: 15px; }
        .search-input:focus { outline: none; border-color: #2D6A6A; }
        .search-result { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; padding: 14px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; }
        .search-result:hover { background: rgba(255,255,255,0.08); border-color: #2D6A6A; }
        
        /* Search & Book */
        .date-search-row { display: flex; gap: 12px; flex-wrap: wrap; align-items: end; justify-content: center; margin-bottom: 20px; }
        .date-field { display: flex; flex-direction: column; gap: 6px; cursor: pointer; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 10px; border: 1px solid rgba(255,255,255,0.08); transition: all 0.2s; }
        .date-field label { font-size: 12px; color: rgba(255,255,255,0.5); pointer-events: none; }
        .date-field:hover { background: rgba(255,255,255,0.08); border-color: rgba(45,106,106,0.4); }
        .group-selector { padding: 10px 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; font-size: 14px; }
        
        /* Requests */
        .request-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 14px; margin-bottom: 12px; }
        .request-select { width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; margin-top: 10px; }
        .request-note { width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; margin-top: 8px; resize: none; }
        .request-btn { padding: 10px 20px; background: #2D6A6A; border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .request-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-top: 8px; font-size: 13px; }
        .request-pending { border-left: 3px solid #f59e0b; }
        .request-done { border-left: 3px solid #2D6A6A; }
        .done-btn { padding: 6px 12px; background: #2D6A6A; border: none; border-radius: 6px; color: white; font-size: 11px; cursor: pointer; }
        .request-count { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; }
        .request-count.pending { background: rgba(245,158,11,0.2); color: #f59e0b; }
        .request-count.done { background: rgba(45,106,106,0.2); color: #2D6A6A; }
        
        /* Housekeeping */
        .hk-section { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 16px; }
        .hk-card { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 10px; margin-bottom: 8px; }
        .hk-makeup { background: linear-gradient(135deg, #0ea5e9, #0284c7); }
        .hk-dirty { background: linear-gradient(135deg, #f97316, #ea580c); }
        .hk-turnover { background: linear-gradient(135deg, #9333ea 0%, #9333ea 50%, #2563eb 50%, #2563eb 100%); }
        
        /* Movement */
        .mv-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .mv-btn { width: 40px; height: 40px; border-radius: 8px; border: none; cursor: pointer; font-size: 16px; }
        .mv-btn-pending { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.6); }
        .mv-btn-pending:hover { background: #2D6A6A; color: white; }
        .mv-btn-done { background: #2D6A6A; color: white; }
        
        .mobile-select { width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; }
        .loader { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: #2D6A6A; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .version-tag { position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.5); padding: 4px 10px; border-radius: 4px; font-size: 10px; color: rgba(255,255,255,0.5); z-index: 9999; }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 4px; }
        
        @media (max-width: 1200px) {
            .status-card { min-width: 90px; min-height: 70px; }
            .date-cell { min-width: 90px; }
            .occupancy-cell { min-width: 90px; }
        }
        @media (max-width: 900px) {
            .stats-row { gap: 6px; }
            .stat-card { padding: 10px 4px; }
            .stat-num { font-size: 20px; }
            .tabs-row { gap: 8px; }
        }
        @media (max-width: 768px) {
            .stat-num { font-size: 16px; }
            .stat-label { font-size: 7px; }
            .tabs-row { gap: 6px; }
            .nav-btn { padding: 12px 16px; font-size: 13px; }
            .status-card { flex: 1; min-width: 70px; min-height: 65px; padding: 8px; }
            .room-label { min-width: 100px; max-width: 100px; }
            .date-cell { flex: 1; min-width: 70px; }
            .occupancy-cell { min-width: 70px; }
            .occupancy-cell .occ-available { font-size: 12px; }
            .occupancy-cell .occ-occupied { font-size: 9px; }
            .date-header-inner { padding-left: 106px; }
            .occupancy-row-inner { padding-left: 106px; }
            .search-btn { padding: 10px 16px; font-size: 13px; }
            .date-header-wrapper { top: 218px; }
            .occupancy-row-wrapper { top: 303px; }
        }

        /* Today view hover effects */
        .today-group { 
            transition: all 0.3s ease; 
            border-radius: 16px; 
            padding: 16px; 
            margin-bottom: 20px;
            border: 2px solid transparent;
        }
        .today-group:hover { 
            background: rgba(59, 130, 246, 0.1); 
            border-color: rgba(59, 130, 246, 0.4);
            box-shadow: 0 4px 24px rgba(59, 130, 246, 0.25);
        }
        .today-group:hover .floor-header { 
            background: rgba(59, 130, 246, 0.3) !important; 
            transform: scale(1.02);
        }

        /* Star dust trail animation */
        .stardust {
            position: fixed;
            pointer-events: none;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: radial-gradient(circle, #fff 0%, #2D6A6A 50%, transparent 70%);
            animation: stardust-fade 1s ease-out forwards;
            z-index: 9999;
            box-shadow: 0 0 6px #2D6A6A, 0 0 10px #2D6A6A;
        }
        @keyframes stardust-fade {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0); opacity: 0; }
        }
    </style>
</head>
<body>
<div id="root"></div>
<div class="version-tag">v28.0-guest-pricing</div>
<script type="text/babel">
const {useState, useEffect, useMemo, useCallback} = React;

// Password Protection Configuration
const PASSWORD_ENABLED = true; // Set to false to disable password
const PASSWORD = "110248";
const SESSION_DURATION = 6 * 60 * 60 * 1000; // 6 hours in milliseconds
const SESSION_KEY = "miami_dashboard_session";

function isSessionValid() {
    if (!PASSWORD_ENABLED) return true;
    const session = localStorage.getItem(SESSION_KEY);
    if (!session) return false;
    const sessionTime = parseInt(session);
    const now = Date.now();
    return (now - sessionTime) < SESSION_DURATION;
}

function createSession() {
    localStorage.setItem(SESSION_KEY, Date.now().toString());
}

function PasswordScreen({onSuccess}) {
    const [password, setPassword] = React.useState("");
    const [error, setError] = React.useState("");
    const [shake, setShake] = React.useState(false);
    
    const handleSubmit = (e) => {
        e.preventDefault();
        if (password === PASSWORD) {
            createSession();
            onSuccess();
        } else {
            setError("Incorrect password");
            setShake(true);
            setTimeout(() => setShake(false), 500);
            setPassword("");
        }
    };
    
    return (
        <div style={{
            position: 'fixed',
            inset: 0,
            background: 'linear-gradient(135deg, #1E293B 0%, #0f172a 100%)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 9999
        }}>
            <div style={{
                background: 'rgba(255,255,255,0.05)',
                border: '1px solid rgba(255,255,255,0.1)',
                borderRadius: '20px',
                padding: '40px',
                width: '100%',
                maxWidth: '400px',
                textAlign: 'center',
                animation: shake ? 'shake 0.5s' : 'none'
            }}>
                <div style={{fontSize: '60px', marginBottom: '20px'}}>üîê</div>
                <h1 style={{fontSize: '24px', fontWeight: '700', marginBottom: '8px', color: '#fff'}}>Miami Beach Resort</h1>
                <p style={{color: 'rgba(255,255,255,0.5)', marginBottom: '30px', fontSize: '14px'}}>Enter password to access dashboard</p>
                
                <form onSubmit={handleSubmit}>
                    <input
                        type="password"
                        value={password}
                        onChange={(e) => {setPassword(e.target.value); setError("");}}
                        placeholder="Enter password"
                        autoFocus
                        style={{
                            width: '100%',
                            padding: '16px 20px',
                            fontSize: '18px',
                            background: 'rgba(255,255,255,0.08)',
                            border: error ? '2px solid #ef4444' : '2px solid rgba(255,255,255,0.1)',
                            borderRadius: '12px',
                            color: '#fff',
                            textAlign: 'center',
                            letterSpacing: '8px',
                            marginBottom: '16px',
                            outline: 'none'
                        }}
                    />
                    {error && <p style={{color: '#ef4444', fontSize: '14px', marginBottom: '16px'}}>{error}</p>}
                    <button
                        type="submit"
                        style={{
                            width: '100%',
                            padding: '16px',
                            fontSize: '16px',
                            fontWeight: '700',
                            background: 'linear-gradient(135deg, #2D6A6A, #245858)',
                            border: 'none',
                            borderRadius: '12px',
                            color: '#fff',
                            cursor: 'pointer'
                        }}
                    >
                        Unlock Dashboard
                    </button>
                </form>
            </div>
            <style>
                {`@keyframes shake {
                    0%, 100% { transform: translateX(0); }
                    25% { transform: translateX(-10px); }
                    75% { transform: translateX(10px); }
                }`}
            </style>
        </div>
    );
}



const PROXY = "https://miami-api-1006186358018.us-central1.run.app";
const PROPERTY = 279646;
const NOTIFICATIONS_API = "https://miami-api-1006186358018.us-central1.run.app/notifications";

// Initialize Firebase for real-time notifications
const firebaseConfig = {
    apiKey: "AIzaSyCwBP9GdR7ceBLFPmfHoULqGnzFhL5lUto",
    authDomain: "beds24-483408.firebaseapp.com",
    projectId: "beds24-483408",
    storageBucket: "beds24-483408.appspot.com",
    messagingSenderId: "1006186358018",
    appId: "1:1006186358018:web:realtime"
};

// Initialize Firebase (check if already initialized)
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const firestoreDb = firebase.firestore();

// Bangladesh Timezone (GMT+6) - All date/time operations use this
const BD_TIMEZONE = 'Asia/Dhaka';

const getBDDate = (offset = 0) => {
    // Get current date in Bangladesh timezone
    const now = new Date();
    const bdNow = new Date(now.toLocaleString('en-US', { timeZone: BD_TIMEZONE }));
    bdNow.setDate(bdNow.getDate() + offset);
    return bdNow.toLocaleDateString('en-CA'); // Returns YYYY-MM-DD format
};

const getBDTime = () => {
    return new Date().toLocaleTimeString("en-US", {timeZone: BD_TIMEZONE, hour: "2-digit", minute: "2-digit", hour12: true});
};

// Get current datetime string in BD timezone (for timestamps)
const getBDTimestamp = () => {
    return new Date().toLocaleString('en-US', { timeZone: BD_TIMEZONE });
};

const formatDate = (d) => new Date(d+"T12:00:00").toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"});
const shortDay = (d) => new Date(d+"T12:00:00").toLocaleDateString("en-US",{weekday:"short"});
const dayNum = (d) => new Date(d+"T12:00:00").getDate();

const ROOMS = [
    {id:583459, name:"Royal Sea View Couple", short:"Royal Sea View", max:2, units:[{id:1,n:"601"},{id:2,n:"602"},{id:3,n:"603"},{id:4,n:"604"}]},
    {id:583466, name:"Premium Sea View Couple", short:"Premium Sea View", max:2, units:[{id:1,n:"401"},{id:2,n:"404"},{id:3,n:"501"},{id:4,n:"504"}]},
    {id:583467, name:"Deluxe Bay View Couple", short:"Deluxe Bay View", max:2, units:[{id:1,n:"402"},{id:2,n:"403"},{id:3,n:"502"},{id:4,n:"503"}]},
    {id:583468, name:"Deluxe Hill View Couple", short:"Deluxe Hill View", max:2, units:[{id:1,n:"201"},{id:2,n:"204"},{id:3,n:"207"},{id:4,n:"301"},{id:5,n:"304"},{id:6,n:"307"},{id:7,n:"407"},{id:8,n:"507"}]},
    {id:583469, name:"Deluxe Urban View Couple", short:"Deluxe Urban View", max:2, units:[{id:1,n:"101"},{id:2,n:"102"},{id:3,n:"103"},{id:4,n:"104"},{id:5,n:"107"},{id:6,n:"202"},{id:7,n:"203"},{id:8,n:"302"},{id:9,n:"303"}]},
    {id:583470, name:"Premium Sea View Family", short:"Premium Sea Family", max:4, units:[{id:1,n:"405"},{id:2,n:"406"},{id:3,n:"408"},{id:4,n:"505"},{id:5,n:"506"},{id:6,n:"508"},{id:7,n:"606"}]},
    {id:583471, name:"Deluxe Hill View Family", short:"Deluxe Hill Family", max:4, units:[{id:1,n:"205"},{id:2,n:"206"},{id:3,n:"208"},{id:4,n:"305"},{id:5,n:"306"},{id:6,n:"308"}]},
    {id:583472, name:"Deluxe Urban View Family", short:"Deluxe Urban Family", max:4, units:[{id:1,n:"105"},{id:2,n:"106"},{id:3,n:"108"}]}
];

const getFloor = (n) => Math.floor(parseInt(n) / 100);
const FLOORS = [1, 2, 3, 4, 5, 6];
const floorName = (f) => f === 1 ? "1st" : f === 2 ? "2nd" : f === 3 ? "3rd" : f + "th";

// TOTAL AVAILABLE ROOMS (TAR) - Fetched dynamically from API
// Admin can change this when rooms go under maintenance
// DO NOT hardcode - always use the dynamic value from state

const getRoomInfo = (roomId, unitId) => {
    const r = ROOMS.find(x => x.id === roomId);
    const u = r?.units.find(x => x.id === unitId);
    return {room: r, unit: u, num: u?.n || "?"};
};

const STORAGE_KEY = "miami_checkin_v2";
const REQUEST_KEY = "miami_requests_v2";
const ROOM_STATUS_KEY = "miami_room_status_v1";
const loadStatus = () => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); } catch { return {}; } };
const saveStatus = (d) => localStorage.setItem(STORAGE_KEY, JSON.stringify(d));
const loadRequests = () => { try { return JSON.parse(localStorage.getItem(REQUEST_KEY) || "[]"); } catch { return []; } };
const saveRequests = (d) => localStorage.setItem(REQUEST_KEY, JSON.stringify(d));
const loadRoomStatuses = () => { try { return JSON.parse(localStorage.getItem(ROOM_STATUS_KEY) || "{}"); } catch { return {}; } };
const saveRoomStatuses = (d) => localStorage.setItem(ROOM_STATUS_KEY, JSON.stringify(d));
const saveFloorStaffAssign = (d) => localStorage.setItem("miami_floor_staff_v1", JSON.stringify(d));

const ROOM_STATUS_OPTIONS = [
    {key: "Clean", label: "‚ú® Clean", color: "#22c55e", bg: "rgba(34,197,94,0.15)", border: "rgba(34,197,94,0.4)"},
    {key: "Dirty", label: "üßπ Dirty", color: "#f97316", bg: "rgba(249,115,22,0.15)", border: "rgba(249,115,22,0.4)"},
    {key: "Ready", label: "üîë Ready to Check-In", color: "#2D6A6A", bg: "rgba(45,106,106,0.15)", border: "rgba(45,106,106,0.4)"},
    {key: "DND", label: "üö´ Do Not Disturb", color: "#a855f7", bg: "rgba(168,85,247,0.15)", border: "rgba(168,85,247,0.4)"},
    {key: "Inspection", label: "üîç Inspection Required", color: "#eab308", bg: "rgba(234,179,8,0.15)", border: "rgba(234,179,8,0.4)"},
    {key: "Maintenance", label: "üîß Maintenance", color: "#ef4444", bg: "rgba(239,68,68,0.15)", border: "rgba(239,68,68,0.4)"},
    {key: "Repair", label: "üõ†Ô∏è Under Repair", color: "#dc2626", bg: "rgba(220,38,38,0.15)", border: "rgba(220,38,38,0.4)"},
    {key: "NoService", label: "‚õî No Service", color: "#6b7280", bg: "rgba(107,114,128,0.15)", border: "rgba(107,114,128,0.4)"}
];

const REQUEST_TYPES = ["Room Service", "Water Bottle", "Room Clean", "Towel Request", "Bedsheet Change", "Toiletries", "Extra Pillow", "AC/Heating Issue", "Maintenance", "Other"];

function App() {
    const [tab, setTab] = useState(() => {
        const saved = localStorage.getItem('miami_current_user');
        if (saved) {
            try {
                const user = JSON.parse(saved);
                if (user && user.role === 'hk_manager') return 'housekeeping';
                if (user && user.role === 'hk_team') return 'housekeeping';
                if (user && user.role === 'accounting') return 'accounting';
            } catch (e) {}
        }
        return 'today';
    });
    const [calDays, setCalDays] = useState(7);
    const [startDate, setStartDate] = useState(getBDDate());
    const [bookings, setBookings] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState("");
    const [totalRooms, setTotalRooms] = useState(45); // Dynamic room count from API (default 45)
    const [realtimeStatus, setRealtimeStatus] = useState("connecting"); // "connected", "disconnected", "connecting"
    const [lastNotification, setLastNotification] = useState(null);
    const notificationUnsubscribeRef = React.useRef(null);
    const [selected, setSelected] = useState([]);
    const [multiBookCheckIn, setMultiBookCheckIn] = useState(getBDDate());
    const [multiBookCheckOut, setMultiBookCheckOut] = useState(getBDDate(1));
    const [showBookModal, setShowBookModal] = useState(false);
    const [showInfoModal, setShowInfoModal] = useState(null);
    const [showSearchModal, setShowSearchModal] = useState(false);
    const [time, setTime] = useState(getBDTime());
    const [checkStatus, setCheckStatus] = useState(loadStatus());
    const [requests, setRequests] = useState(loadRequests());
    const [searchQuery, setSearchQuery] = useState("");
    const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
    const [isEditing, setIsEditing] = useState(false); // Pause auto-refresh when editing
    const isEditingRef = React.useRef(false); // Ref to check in interval without re-triggering
    const [searchCheckIn, setSearchCheckIn] = useState(getBDDate());
    const [searchCheckOut, setSearchCheckOut] = useState(getBDDate(1));
    const checkoutRef = React.useRef(null);
    const checkinRef = React.useRef(null);
    const calendarDateRef = React.useRef(null);
    const [searchGroupBy, setSearchGroupBy] = useState("floor");
    
    const handleCheckInChange = (e) => {
        const newCheckIn = e.target.value;
        setSearchCheckIn(newCheckIn);
        // Auto-set checkout to next day
        const nextDay = new Date(newCheckIn + "T12:00:00");
        nextDay.setDate(nextDay.getDate() + 1);
        setSearchCheckOut(nextDay.toLocaleDateString('en-CA'));
        // Auto-focus checkout picker after short delay
        setTimeout(() => {
            if (checkoutRef.current) {
                checkoutRef.current.showPicker();
            }
        }, 100);
    };
    const [todayViewBy, setTodayViewBy] = useState("overview");
    const [overviewDate, setOverviewDate] = useState(getBDDate());
    const overviewDateRef = React.useRef(null);
    const [hkDay, setHkDay] = useState("today");
    const [hkTab, setHkTab] = useState("mywork"); // dashboard, rooms, tasks, inspections, maintenance, inventory, lostfound, staff, reports
    const [hkMaintenanceTab, setHkMaintenanceTab] = useState("issues"); // issues, new, preventive
    const [hkInventoryTab, setHkInventoryTab] = useState("linen"); // linen, amenities, requests
    const [hkLostFoundTab, setHkLostFoundTab] = useState("register"); // register, search, inventory
    const [hkStaffTab, setHkStaffTab] = useState("mywork"); // mywork, supplies, completed
    
    // Staff workflow states
    const [selectedCleaningRoom, setSelectedCleaningRoom] = useState(null);
    const [cleaningProgress, setCleaningProgress] = useState(() => { try { return JSON.parse(localStorage.getItem("miami_cleaning_progress_v1") || "{}"); } catch { return {}; } });
    const saveCleaningProgress = (d) => { setCleaningProgress(d); localStorage.setItem("miami_cleaning_progress_v1", JSON.stringify(d)); };
    
    // Completed room logs
    const [completedRooms, setCompletedRooms] = useState(() => { try { return JSON.parse(localStorage.getItem("miami_completed_rooms_v1") || "[]"); } catch { return []; } });
    const saveCompletedRooms = (d) => { setCompletedRooms(d); localStorage.setItem("miami_completed_rooms_v1", JSON.stringify(d)); };
    
    // Room category configurations (Admin defines amenities/linens per room type)
    const DEFAULT_ROOM_CONFIGS = {
        'Standard King': { beds: 1, bedType: 'King', maxOccupancy: 2, amenities: { 'Soap Bar': 2, 'Shampoo': 2, 'Conditioner': 1, 'Body Lotion': 1, 'Coffee Pods': 4, 'Bottled Water': 2 }, linens: { 'King Sheet Set': 1, 'Bath Towel': 2, 'Hand Towel': 2, 'Face Towel': 2, 'Bath Mat': 1, 'Pillowcase': 2 } },
        'Standard Queen': { beds: 1, bedType: 'Queen', maxOccupancy: 2, amenities: { 'Soap Bar': 2, 'Shampoo': 2, 'Conditioner': 1, 'Body Lotion': 1, 'Coffee Pods': 4, 'Bottled Water': 2 }, linens: { 'Queen Sheet Set': 1, 'Bath Towel': 2, 'Hand Towel': 2, 'Face Towel': 2, 'Bath Mat': 1, 'Pillowcase': 2 } },
        'Double Queen': { beds: 2, bedType: 'Queen', maxOccupancy: 4, amenities: { 'Soap Bar': 4, 'Shampoo': 4, 'Conditioner': 2, 'Body Lotion': 2, 'Coffee Pods': 6, 'Bottled Water': 4 }, linens: { 'Queen Sheet Set': 2, 'Bath Towel': 4, 'Hand Towel': 4, 'Face Towel': 4, 'Bath Mat': 1, 'Pillowcase': 4 } },
        'Suite': { beds: 1, bedType: 'King', maxOccupancy: 2, amenities: { 'Soap Bar': 4, 'Shampoo': 4, 'Conditioner': 2, 'Body Lotion': 2, 'Coffee Pods': 8, 'Bottled Water': 4, 'Shower Cap': 2 }, linens: { 'King Sheet Set': 1, 'Bath Towel': 4, 'Hand Towel': 4, 'Face Towel': 4, 'Bath Mat': 2, 'Pillowcase': 4, 'Duvet Cover': 1 } }
    };
    const [roomConfigs, setRoomConfigs] = useState(() => { try { return JSON.parse(localStorage.getItem("miami_room_configs_v1") || "null") || DEFAULT_ROOM_CONFIGS; } catch { return DEFAULT_ROOM_CONFIGS; } });
    const saveRoomConfigs = (d) => { setRoomConfigs(d); localStorage.setItem("miami_room_configs_v1", JSON.stringify(d)); };
    
    // Cleaning checklists (different for Turnover vs Stayover)
    const DEFAULT_TURNOVER_CHECKLIST = ['Strip all bed linens', 'Check mattress protector', 'Make bed with fresh linens', 'Vacuum/mop floors', 'Clean bathroom thoroughly', 'Replace all towels', 'Restock amenities', 'Wipe all surfaces', 'Clean mirrors/windows', 'Empty trash bins', 'Check AC/TV working', 'Check minibar', 'Final inspection'];
    const DEFAULT_STAYOVER_CHECKLIST = ['Make bed (same linens unless requested)', 'Vacuum visible areas', 'Clean bathroom', 'Replace used towels', 'Replenish amenities', 'Empty trash', 'Wipe surfaces', 'Quick inspection'];
    const [turnoverChecklist, setTurnoverChecklist] = useState(() => { try { return JSON.parse(localStorage.getItem("miami_turnover_checklist_v1") || "null") || DEFAULT_TURNOVER_CHECKLIST; } catch { return DEFAULT_TURNOVER_CHECKLIST; } });
    const saveTurnoverChecklist = (d) => { setTurnoverChecklist(d); localStorage.setItem("miami_turnover_checklist_v1", JSON.stringify(d)); };
    const [stayoverChecklist, setStayoverChecklist] = useState(() => { try { return JSON.parse(localStorage.getItem("miami_stayover_checklist_v1") || "null") || DEFAULT_STAYOVER_CHECKLIST; } catch { return DEFAULT_STAYOVER_CHECKLIST; } });
    const saveStayoverChecklist = (d) => { setStayoverChecklist(d); localStorage.setItem("miami_stayover_checklist_v1", JSON.stringify(d)); };
    
    // Current staff member (for logging who cleaned)
    const [currentStaffName, setCurrentStaffName] = useState(() => localStorage.getItem("miami_current_staff_v1") || "");
    const saveCurrentStaffName = (n) => { setCurrentStaffName(n); localStorage.setItem("miami_current_staff_v1", n); };
    const [hkMode, setHkMode] = useState("staff"); // admin, staff
    
    // Inspections tab state (moved to top level to fix React hooks rule)
    const [selectedInspectionRoom, setSelectedInspectionRoom] = useState(null);
    const [inspectionMode, setInspectionMode] = useState('list');
    
    // Issues tab state
    const [issueFilter, setIssueFilter] = useState('open');
    const [showAddIssue, setShowAddIssue] = useState(false);
    
    // Preventive tab state
    const [showAddSchedule, setShowAddSchedule] = useState(false);
    const [preventiveFilterView, setPreventiveFilterView] = useState('due');
    
    // Lost & Found tab state
    const [lfFilter, setLfFilter] = useState('unclaimed');
    const [showAddLfItem, setShowAddLfItem] = useState(false);
    
    // Issue form state
    const [issueFormRoom, setIssueFormRoom] = useState('');
    const [issueFormCategory, setIssueFormCategory] = useState('');
    const [issueFormDesc, setIssueFormDesc] = useState('');
    const [issueFormPriority, setIssueFormPriority] = useState('medium');
    const [issueFormReporter, setIssueFormReporter] = useState('');
    
    // Lost & Found form state
    const [lfFormItem, setLfFormItem] = useState('');
    const [lfFormRoom, setLfFormRoom] = useState('');
    const [lfFormCategory, setLfFormCategory] = useState('');
    const [lfFormFoundBy, setLfFormFoundBy] = useState('');
    const [lfFormDesc, setLfFormDesc] = useState('');
    
    // Auth state
    const AUTH_API = 'https://miami-api-1006186358018.us-central1.run.app';
    const [authToken, setAuthToken] = useState(() => localStorage.getItem('miami_auth_token') || '');
    const [currentUser, setCurrentUser] = useState(() => { try { return JSON.parse(localStorage.getItem('miami_current_user') || 'null'); } catch { return null; } });
    const [showLoginModal, setShowLoginModal] = useState(false);
    const [loginError, setLoginError] = useState('');
    const [loginLoading, setLoginLoading] = useState(false);
    const [showSystemAdmin, setShowSystemAdmin] = useState(false);
    const [sysAdminOtpSent, setSysAdminOtpSent] = useState(false);
    const [sysAdminEmail, setSysAdminEmail] = useState('');
    const [sysAdminOtp, setSysAdminOtp] = useState('');
    const [sysAdminToken, setSysAdminToken] = useState(() => localStorage.getItem('miami_sysadmin_token') || '');
    const [sysAdminUsers, setSysAdminUsers] = useState([]);
    const [sysAdminSessions, setSysAdminSessions] = useState([]);
    const [sysAdminSettings, setSysAdminSettings] = useState({ killSwitch: false });
    const [sysAdminTab, setSysAdminTab] = useState('users');
    const [newUserForm, setNewUserForm] = useState({ username: '', password: '', role: 'front_desk', name: '', email: '' });
    const [isKillSwitchActive, setIsKillSwitchActive] = useState(false);
    
    // Auth helpers
    const saveAuthToken = (t) => { setAuthToken(t); localStorage.setItem('miami_auth_token', t); };
    const saveCurrentUser = (u) => { setCurrentUser(u); localStorage.setItem('miami_current_user', JSON.stringify(u)); };
    const saveSysAdminToken = (t) => { setSysAdminToken(t); localStorage.setItem('miami_sysadmin_token', t); };
    
    // Role-based access
    const ROLE_ACCESS = {
        admin: ['today', 'calendar', 'searchbook', 'requests', 'movements', 'housekeeping', 'accounting', 'dashboard', 'whatsapp'],
        front_desk: ['today', 'calendar', 'searchbook', 'requests', 'movements', 'whatsapp'],
        hk_manager: ['housekeeping'],
        hk_team: ['housekeeping'],
        accounting: ['accounting', 'whatsapp']
    };
    const canAccessTab = (tabId) => {
        if (!currentUser) return true;
        if (currentUser.role === 'admin') return true;
        return ROLE_ACCESS[currentUser.role] && ROLE_ACCESS[currentUser.role].includes(tabId);
    };
    
    // Get first allowed tab for current user
    const getDefaultTab = function() {
        if (!currentUser) return 'today';
        if (currentUser.role === 'hk_manager' || currentUser.role === 'hk_team') return 'housekeeping';
        if (currentUser.role === 'accounting') return 'accounting';
        return 'today';
    };
    
    // Check if current tab is accessible, if not use effective tab
    const effectiveTab = (currentUser && !canAccessTab(tab)) ? getDefaultTab() : tab;
    
    // Auth functions
    const handleLogin = async (username, password) => {
        setLoginLoading(true); setLoginError('');
        try {
            const res = await fetch(AUTH_API + '/auth/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || 'Login failed');
            saveAuthToken(data.token); saveCurrentUser(data.user); setShowLoginModal(false);
            // Set default tab based on role
            if (data.user.role === 'hk_manager' || data.user.role === 'hk_team') { setTab('housekeeping'); setHkTab('staff'); }
            else if (data.user.role === 'accounting') { setTab('accounting'); }
            else { setTab('today'); }
        } catch (err) { setLoginError(err.message); }
        finally { setLoginLoading(false); }
    };
    
    const handleLogout = async () => {
        try { await fetch(AUTH_API + '/auth/logout', { method: 'POST', headers: { 'Authorization': 'Bearer ' + authToken } }); } catch (e) { console.log(e); }
        saveAuthToken(''); saveCurrentUser(null); setTab('today');
    };
    
    const requestSysAdminOtp = async () => {
        try {
            const res = await fetch(AUTH_API + '/auth/admin/request-otp', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email: sysAdminEmail }) });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error);
            setSysAdminOtpSent(true);
            alert('OTP sent to your email!');
        } catch (err) { alert('Error: ' + err.message); }
    };
    
    const verifySysAdminOtp = async () => {
        try {
            const res = await fetch(AUTH_API + '/auth/admin/verify-otp', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email: sysAdminEmail, otp: sysAdminOtp }) });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error);
            saveSysAdminToken(data.token); setSysAdminOtpSent(false); setSysAdminOtp('');
            loadSysAdminData(data.token);
        } catch (err) { alert('Error: ' + err.message); }
    };
    
    const loadSysAdminData = async (token) => {
        try {
            const [usersRes, sessionsRes, settingsRes] = await Promise.all([
                fetch(AUTH_API + '/admin/users', { headers: { 'Authorization': 'Bearer ' + token } }),
                fetch(AUTH_API + '/admin/sessions', { headers: { 'Authorization': 'Bearer ' + token } }),
                fetch(AUTH_API + '/admin/settings', { headers: { 'Authorization': 'Bearer ' + token } })
            ]);
            if (usersRes.ok) setSysAdminUsers((await usersRes.json()).users || []);
            if (sessionsRes.ok) setSysAdminSessions((await sessionsRes.json()).sessions || []);
            if (settingsRes.ok) setSysAdminSettings((await settingsRes.json()).settings || { killSwitch: false });
        } catch (err) { console.error(err); }
    };
    
    const createUser = async () => {
        try {
            const res = await fetch(AUTH_API + '/admin/users', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + sysAdminToken }, body: JSON.stringify(newUserForm) });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error);
            setSysAdminUsers([...sysAdminUsers, data.user]);
            setNewUserForm({ username: '', password: '', role: 'front_desk', name: '', email: '' });
            alert('User created!');
        } catch (err) { alert('Error: ' + err.message); }
    };
    
    const deleteUser = async (userId) => {
        if (!confirm('Delete this user?')) return;
        try {
            await fetch(AUTH_API + '/admin/users/' + userId, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + sysAdminToken } });
            setSysAdminUsers(sysAdminUsers.filter(u => u.id !== userId));
        } catch (err) { alert('Error: ' + err.message); }
    };
    
    const toggleUserActive = async (user) => {
        try {
            await fetch(AUTH_API + '/admin/users/' + user.id, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + sysAdminToken }, body: JSON.stringify({ active: !user.active }) });
            setSysAdminUsers(sysAdminUsers.map(u => u.id === user.id ? {...u, active: !u.active} : u));
        } catch (err) { alert('Error: ' + err.message); }
    };
    
    const toggleKillSwitch = async () => {
        try {
            const newVal = !sysAdminSettings.killSwitch;
            await fetch(AUTH_API + '/admin/settings', { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + sysAdminToken }, body: JSON.stringify({ killSwitch: newVal }) });
            setSysAdminSettings({...sysAdminSettings, killSwitch: newVal});
            alert('Kill switch ' + (newVal ? 'ACTIVATED' : 'deactivated'));
        } catch (err) { alert('Error: ' + err.message); }
    };
    
    const forceLogoutSession = async (sessionId) => {
        try {
            await fetch(AUTH_API + '/admin/sessions/' + sessionId, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + sysAdminToken } });
            setSysAdminSessions(sysAdminSessions.filter(s => s.id !== sessionId));
        } catch (err) { alert('Error: ' + err.message); }
    };
    
    const sysAdminLogout = () => { saveSysAdminToken(''); setSysAdminUsers([]); setSysAdminSessions([]); setShowSystemAdmin(false); };
    
    const [hkAdminTab, setHkAdminTab] = useState("assignments"); // assignments, staff, requests, statuses, settings, sync
    
    // ========== ADMIN DATA STATES ==========
    // Staff list
    const [hkStaffList, setHkStaffList] = useState(() => { try { return JSON.parse(localStorage.getItem("miami_hk_staff_v2") || "[]"); } catch { return []; } });
    const saveHkStaffList = (d) => { setHkStaffList(d); localStorage.setItem("miami_hk_staff_v2", JSON.stringify(d)); };
    
    // Daily floor assignments: { "2026-01-07": { "1": ["staffId1", "staffId2"], "2": ["staffId3"] } }
    const [dailyAssignments, setDailyAssignments] = useState(() => { try { return JSON.parse(localStorage.getItem("miami_daily_assign_v1") || "{}"); } catch { return {}; } });
    const saveDailyAssignments = (d) => { setDailyAssignments(d); localStorage.setItem("miami_daily_assign_v1", JSON.stringify(d)); };
    
    // Custom request types (admin can add/remove)
    const [customRequestTypes, setCustomRequestTypes] = useState(() => { try { return JSON.parse(localStorage.getItem("miami_request_types_v1") || "[]"); } catch { return []; } });
    const saveRequestTypes = (d) => { setCustomRequestTypes(d); localStorage.setItem("miami_request_types_v1", JSON.stringify(d)); };
    // ===== INSPECTION ITEMS (Admin configurable checklist) =====
    const DEFAULT_INSPECTION_ITEMS = ['Bed properly made', 'Bathroom clean', 'Floors vacuumed', 'Trash emptied', 'Amenities stocked', 'Windows/mirrors clean', 'AC working', 'TV/remote working', 'Mini-bar checked', 'Safe empty/working'];
    const [inspectionItems, setInspectionItems] = useState(() => { try { return JSON.parse(localStorage.getItem("miami_inspection_items_v1") || "null") || DEFAULT_INSPECTION_ITEMS; } catch { return DEFAULT_INSPECTION_ITEMS; } });
    const saveInspectionItems = (d) => { setInspectionItems(d); localStorage.setItem("miami_inspection_items_v1", JSON.stringify(d)); };
    
    // ===== INSPECTIONS DATA (Room inspection records) =====
    const [inspectionRecords, setInspectionRecords] = useState(() => { try { return JSON.parse(localStorage.getItem("miami_inspections_v1") || "{}"); } catch { return {}; } });
    const saveInspectionRecords = (d) => { setInspectionRecords(d); localStorage.setItem("miami_inspections_v1", JSON.stringify(d)); };
    
    // ===== ISSUE CATEGORIES (Admin configurable) =====
    const DEFAULT_ISSUE_CATEGORIES = ['Plumbing', 'Electrical', 'AC/HVAC', 'Furniture', 'TV/Electronics', 'Door/Lock', 'Window', 'Bathroom', 'Pest Control', 'Other'];
    const [issueCategories, setIssueCategories] = useState(() => { try { return JSON.parse(localStorage.getItem("miami_issue_categories_v1") || "null") || DEFAULT_ISSUE_CATEGORIES; } catch { return DEFAULT_ISSUE_CATEGORIES; } });
    const saveIssueCategories = (d) => { setIssueCategories(d); localStorage.setItem("miami_issue_categories_v1", JSON.stringify(d)); };
    
    // ===== ISSUES DATA (Maintenance issues) =====
    const [maintenanceIssues, setMaintenanceIssues] = useState(() => { try { return JSON.parse(localStorage.getItem("miami_issues_v1") || "[]"); } catch { return []; } });
    const saveMaintenanceIssues = (d) => { setMaintenanceIssues(d); localStorage.setItem("miami_issues_v1", JSON.stringify(d)); };
    
    // ===== PREVENTIVE MAINTENANCE TYPES =====
    const DEFAULT_PREVENTIVE_TYPES = ['AC Filter Change', 'Deep Clean', 'Mattress Flip', 'Carpet Shampoo', 'Drain Clean', 'Pest Prevention', 'Window Wash', 'Paint Touch-up'];
    const [preventiveTypes, setPreventiveTypes] = useState(() => { try { return JSON.parse(localStorage.getItem("miami_preventive_types_v1") || "null") || DEFAULT_PREVENTIVE_TYPES; } catch { return DEFAULT_PREVENTIVE_TYPES; } });
    const savePreventiveTypes = (d) => { setPreventiveTypes(d); localStorage.setItem("miami_preventive_types_v1", JSON.stringify(d)); };
    
    // ===== PREVENTIVE MAINTENANCE SCHEDULE =====
    const [preventiveSchedule, setPreventiveSchedule] = useState(() => { try { return JSON.parse(localStorage.getItem("miami_preventive_v1") || "[]"); } catch { return []; } });
    const savePreventiveSchedule = (d) => { setPreventiveSchedule(d); localStorage.setItem("miami_preventive_v1", JSON.stringify(d)); };
    
    // ===== LINEN TYPES =====
    const DEFAULT_LINEN_TYPES = ['King Sheet Set', 'Queen Sheet Set', 'Twin Sheet Set', 'Bath Towel', 'Hand Towel', 'Face Towel', 'Bath Mat', 'Pillowcase', 'Duvet Cover', 'Blanket'];
    const [linenTypes, setLinenTypes] = useState(() => { try { return JSON.parse(localStorage.getItem("miami_linen_types_v1") || "null") || DEFAULT_LINEN_TYPES; } catch { return DEFAULT_LINEN_TYPES; } });
    const saveLinenTypes = (d) => { setLinenTypes(d); localStorage.setItem("miami_linen_types_v1", JSON.stringify(d)); };
    
    // ===== LINEN INVENTORY =====
    const [linenInventory, setLinenInventory] = useState(() => { try { return JSON.parse(localStorage.getItem("miami_linen_v1") || "{}"); } catch { return {}; } });
    const saveLinenInventory = (d) => { setLinenInventory(d); localStorage.setItem("miami_linen_v1", JSON.stringify(d)); };
    
    // ===== AMENITY TYPES =====
    const DEFAULT_AMENITY_TYPES = ['Soap Bar', 'Shampoo', 'Conditioner', 'Body Lotion', 'Shower Cap', 'Toothbrush Kit', 'Coffee Pods', 'Tea Bags', 'Sugar Packets', 'Bottled Water'];
    const [amenityTypes, setAmenityTypes] = useState(() => { try { return JSON.parse(localStorage.getItem("miami_amenity_types_v1") || "null") || DEFAULT_AMENITY_TYPES; } catch { return DEFAULT_AMENITY_TYPES; } });
    const saveAmenityTypes = (d) => { setAmenityTypes(d); localStorage.setItem("miami_amenity_types_v1", JSON.stringify(d)); };
    
    // ===== AMENITY INVENTORY =====
    const [amenityInventory, setAmenityInventory] = useState(() => { try { return JSON.parse(localStorage.getItem("miami_amenities_v1") || "{}"); } catch { return {}; } });
    const saveAmenityInventory = (d) => { setAmenityInventory(d); localStorage.setItem("miami_amenities_v1", JSON.stringify(d)); };
    
    // ===== LOST & FOUND CATEGORIES =====
    const DEFAULT_LF_CATEGORIES = ['Electronics', 'Clothing', 'Jewelry', 'Documents', 'Bags/Luggage', 'Personal Care', 'Kids Items', 'Other'];
    const [lfCategories, setLfCategories] = useState(() => { try { return JSON.parse(localStorage.getItem("miami_lf_categories_v1") || "null") || DEFAULT_LF_CATEGORIES; } catch { return DEFAULT_LF_CATEGORIES; } });
    const saveLfCategories = (d) => { setLfCategories(d); localStorage.setItem("miami_lf_categories_v1", JSON.stringify(d)); };
    
    // ===== LOST & FOUND ITEMS =====
    const [lostFoundItems, setLostFoundItems] = useState(() => { try { return JSON.parse(localStorage.getItem("miami_lostfound_v1") || "[]"); } catch { return []; } });
    const saveLostFoundItems = (d) => { setLostFoundItems(d); localStorage.setItem("miami_lostfound_v1", JSON.stringify(d)); };

    
    // Admin selected date for assignments
    const [adminDate, setAdminDate] = useState(today);
    
    // Merge default + custom request types
    const allRequestTypes = [...REQUEST_TYPES, ...customRequestTypes.filter(t => !REQUEST_TYPES.includes(t))];
    
    // Database sync helpers
    const HK_API = "https://beds24-proxy-1006186358018.us-central1.run.app/hk";
    const syncToServer = async (type, data) => { try { await fetch(HK_API + "/save", { method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify({type, data, timestamp: new Date().toISOString()}) }); return true; } catch(e) { console.error(e); return false; } };
    const loadFromServer = async (type) => { try { const r = await fetch(HK_API + "/load?type=" + type); if(r.ok) { const d = await r.json(); return d.data; } return null; } catch(e) { console.error(e); return null; } };
    const [floorStaffAssign, setFloorStaffAssign] = useState(() => { try { return JSON.parse(localStorage.getItem("miami_floor_staff_v1") || "{}"); } catch { return {}; } });
    const [hkRoomBoardView, setHkRoomBoardView] = useState("floor"); // floor, category
    const [hkReportsTab, setHkReportsTab] = useState("daily"); // daily, performance, trends
    const [calendarViewBy, setCalendarViewBy] = useState("floor");
    const [dashDate, setDashDate] = useState(getBDDate());
    const dashDateRef = React.useRef(null);
    const [roomStatuses, setRoomStatuses] = useState(loadRoomStatuses());
    const [roomStatusModal, setRoomStatusModal] = useState(null);

    const today = getBDDate();

    useEffect(() => {
        const h = () => setIsMobile(window.innerWidth < 768);
        window.addEventListener('resize', h);
        return () => window.removeEventListener('resize', h);
    }, []);

    useEffect(() => { const t = setInterval(() => setTime(getBDTime()), 60000); return () => clearInterval(t); }, []);

    const allRooms = useMemo(() => {
        let arr = [];
        const seen = new Set();
        ROOMS.forEach(r => r.units.forEach(u => {
            const key = `${r.id}-${u.id}`;
            if (!seen.has(key)) {
                seen.add(key);
                arr.push({room: r, unit: u, floor: getFloor(u.n)});
            }
        }));
        return arr.sort((a,b) => parseInt(a.unit.n) - parseInt(b.unit.n));
    }, []);

    const roomsByFloor = useMemo(() => {
        const g = {};
        FLOORS.forEach(f => g[f] = []);
        allRooms.forEach(r => g[r.floor]?.push(r));
        return g;
    }, [allRooms]);

    // Fetch dynamic room count from API (admin can change for maintenance)
    const fetchRoomConfig = useCallback(async () => {
        try {
            const res = await fetch(`${PROXY}/room-config`);
            const data = await res.json();
            if (data.success && data.totalRooms) {
                setTotalRooms(data.totalRooms);
                console.log(`üè® Room config: ${data.totalRooms} total rooms (source: ${data.source})`);
            }
        } catch (error) {
            console.warn('Could not fetch room config, using default:', error);
        }
    }, []);

    // Booking cache for faster loads
    const bookingCacheRef = React.useRef({ data: null, timestamp: 0 });
    const CACHE_TTL = 30000; // 30 seconds cache

    const fetchData = useCallback(async (forceRefresh = false) => {
        const now = Date.now();
        const cache = bookingCacheRef.current;

        // Use cache if valid and not forcing refresh
        if (!forceRefresh && cache.data && (now - cache.timestamp) < CACHE_TTL) {
            console.log('üì¶ Using cached bookings');
            return;
        }

        setLoading(true);
        setError("");

        try {
            console.log('üîÑ Fetching bookings...');
            const startTime = performance.now();
            const todayDate = getBDDate(0);
            let filtered = [];
            let source = 'api';

            // Use /api/calendar endpoint to fetch ALL bookings for the date range
            // This fetches arrivals AND departures for the next 45 days (covers calendar views)
            try {
                const res = await fetch(`${PROXY}/api/calendar?start=${todayDate}&days=45`);
                const data = await res.json();

                if (data.success && data.data && data.data.length > 0) {
                    filtered = data.data.filter(b => b.status !== "cancelled");
                    source = 'calendar-api';
                    console.log(`üìä Calendar API: ${data.count} bookings for ${data.dateRange?.start} to ${data.dateRange?.end}`);
                } else {
                    throw new Error('Calendar endpoint returned no data');
                }
            } catch (calErr) {
                console.log('üì° Calendar failed, trying /getBookings...', calErr.message);
                // Fallback to basic getBookings endpoint
                const res = await fetch(`${PROXY}/getBookings`);
                const data = await res.json();

                if (!data.data || data.data.length === 0) {
                    throw new Error('No bookings received from API');
                }

                filtered = data.data.filter(b => b.status !== "cancelled");
                source = 'getBookings';
            }

            // Count stats for logging
            const occupied = filtered.filter(b => b.arrival <= todayDate && b.departure > todayDate).length;
            const checkIns = filtered.filter(b => b.arrival === todayDate).length;
            const checkOuts = filtered.filter(b => b.departure === todayDate).length;

            const loadTime = Math.round(performance.now() - startTime);
            console.log(`‚úÖ [${source}] Loaded ${filtered.length} bookings in ${loadTime}ms (occupied: ${occupied}, check-ins: ${checkIns}, check-outs: ${checkOuts})`);

            // Update cache
            bookingCacheRef.current = { data: filtered, timestamp: now };

            setBookings(filtered);
        } catch(e) {
            console.error("Fetch error:", e);
            setError(e.message);

            // Try to use stale cache if available
            if (cache.data) {
                console.log('‚ö†Ô∏è Using stale cache due to error');
                setBookings(cache.data);
            }
        }
        setLoading(false);
    }, []);

    // Keep ref in sync with state
    useEffect(() => {
        isEditingRef.current = isEditing;
    }, [isEditing]);

    useEffect(() => {
        fetchData();
        fetchRoomConfig(); // Fetch dynamic room count on load

        // Set up Firestore real-time listener for booking notifications
        const setupRealtimeListener = () => {
            try {
                const unsubscribe = firestoreDb
                    .collection('booking_notifications')
                    .orderBy('receivedAt', 'desc')
                    .limit(10)
                    .onSnapshot(
                        (snapshot) => {
                            setRealtimeStatus("connected");
                            
                            // Check for new notifications
                            snapshot.docChanges().forEach((change) => {
                                if (change.type === 'added') {
                                    const data = change.doc.data();
                                    console.log('üîî New booking notification:', data);
                                    setLastNotification({
                                        id: change.doc.id,
                                        ...data,
                                        receivedAt: data.receivedAt?.toDate?.() || new Date()
                                    });
                                    
                                    // Trigger refresh when new notification arrives (force refresh to bypass cache)
                                    if (!isEditingRef.current) {
                                        console.log('üîÑ Auto-refreshing due to booking update...');
                                        fetchData(true);
                                    }
                                }
                            });
                        },
                        (error) => {
                            console.error('Realtime listener error:', error);
                            setRealtimeStatus("disconnected");
                        }
                    );
                
                notificationUnsubscribeRef.current = unsubscribe;
            } catch (error) {
                console.error('Failed to setup realtime listener:', error);
                setRealtimeStatus("disconnected");
            }
        };
        
        setupRealtimeListener();
        
        // Fallback polling every 5 minutes (force refresh to ensure fresh data)
        const i = setInterval(() => {
            if (!isEditingRef.current) fetchData(true);
        }, 300000); // 5 minutes fallback
        
        return () => {
            clearInterval(i);
            if (notificationUnsubscribeRef.current) {
                notificationUnsubscribeRef.current();
            }
        };
    }, [fetchData]);

const getBooking = useCallback((roomId, unitId, d) => { const result = bookings.find(b => b.roomId === roomId && b.unitId === unitId && d >= b.arrival && d < b.departure && b.status !== "cancelled" && b.status !== "inquiry"); if (roomId === 583468 && unitId === 8 && !window._logged507) { console.log("üîç Room 507 check:", {d, result: result ? result.firstName : "NOT FOUND", allBookings: bookings.filter(b => b.roomId === 583468 && b.unitId === 8)}); window._logged507 = true; } return result; }, [bookings]);

    // Get ALL bookings for a room/date (to detect overbookings)
    const getAllBookingsForCell = useCallback((roomId, unitId, d) => {
        return bookings.filter(b =>
            b.roomId === roomId &&
            b.unitId === unitId &&
            d >= b.arrival &&
            d < b.departure &&
            b.status !== "cancelled" &&
            b.status !== "inquiry"
        );
    }, [bookings]);

    const getCheckout = useCallback((roomId, unitId, d) => bookings.find(b => b.roomId === roomId && b.unitId === unitId && b.departure === d), [bookings]);
    const getCheckin = useCallback((roomId, unitId, d) => bookings.find(b => b.roomId === roomId && b.unitId === unitId && b.arrival === d), [bookings]);

    // ============================================================
    // UNIFIED ROOM STATUS LOGIC - Single source of truth for all tabs
    // ============================================================
    const getRoomStatus = useCallback((roomId, unitId, targetDate = today) => {
        const checkout = bookings.find(b => b.roomId === roomId && b.unitId === unitId && b.departure === targetDate);
        const checkin = bookings.find(b => b.roomId === roomId && b.unitId === unitId && b.arrival === targetDate);
        const staying = bookings.find(b => b.roomId === roomId && b.unitId === unitId && b.arrival < targetDate && b.departure > targetDate && b.status !== 'cancelled' && b.status !== 'inquiry');
        
        const isCheckedOut = checkout && checkStatus[checkout.id] === "checkedout";
        const isCheckedIn = checkin && checkStatus[checkin.id] === "checkedin";
        const isStayingCheckedIn = staying && checkStatus[staying.id] === "checkedin";
        
        // Determine room type
        const isTurnover = !!(checkout && checkin);
        const isCheckoutOnly = !!(checkout && !checkin && !staying);
        const isFreshArrival = !!(checkin && !checkout);
        const isStayover = !!(staying && !checkout && !checkin);
        
        // Calculate night number for staying guests
        let nightNum = 0, totalNights = 0;
        const activeBooking = checkin || staying;
        if (activeBooking && (isCheckedIn || isStayingCheckedIn)) {
            const arrival = new Date(activeBooking.arrival);
            const current = new Date(targetDate);
            const departure = new Date(activeBooking.departure);
            totalNights = Math.ceil((departure - arrival) / (1000 * 60 * 60 * 24));
            nightNum = Math.ceil((current - arrival) / (1000 * 60 * 60 * 24)) + 1;
        }
        
        // Unified status determination with NEW status texts
        let status, statusText, cardClass, displayGuest, canCheckin;
        
        if (isTurnover) {
            if (!isCheckedOut) {
                // Turnover: Previous guest hasn't left yet
                status = "TURNOVER_PENDING";
                statusText = "Waiting for Check-out";
                cardClass = "card-checkout-pending";
                displayGuest = checkout;
                canCheckin = false;
            } else if (!isCheckedIn) {
                // Turnover: Previous guest left, ready for new guest
                status = "TURNOVER_READY";
                statusText = "Ready for Check-in";
                cardClass = "card-ready-checkin";
                displayGuest = checkin;
                canCheckin = true;
            } else {
                // Turnover: Complete - new guest checked in
                status = "TURNOVER_COMPLETE";
                statusText = "Checked-in";
                cardClass = "card-booked";
                displayGuest = checkin;
                canCheckin = false;
            }
        } else if (isCheckoutOnly) {
            if (!isCheckedOut) {
                status = "CHECKOUT_PENDING";
                statusText = "Waiting for Check-out";
                cardClass = "card-checkout-pending";
                displayGuest = checkout;
                canCheckin = true;
            } else {
                status = "CHECKOUT_DONE";
                statusText = "Available";
                cardClass = "card-available";
                displayGuest = null;
                canCheckin = true;
            }
        } else if (isFreshArrival) {
            if (!isCheckedIn) {
                // Fresh arrival - room was empty, ready for early check-in
                status = "ARRIVING";
                statusText = "Ready for Early Check-in";
                cardClass = "card-ready-checkin";
                displayGuest = checkin;
                canCheckin = true;
            } else {
                status = "ARRIVED";
                statusText = "Checked-in";
                cardClass = "card-booked";
                displayGuest = checkin;
                canCheckin = false;
            }
        } else if (isStayover) {
            status = "STAYOVER";
            statusText = "Stay";
            cardClass = "card-booked";
            displayGuest = staying;
            canCheckin = false;
        } else {
            // No booking today
            status = "AVAILABLE";
            statusText = "Available";
            cardClass = "card-available";
            displayGuest = null;
            canCheckin = true;
        }
        
        return {
            // Status info
            status,
            statusText,
            cardClass,
            
            // Booking references
            checkout,
            checkin,
            staying,
            displayGuest,
            
            // Check status
            isCheckedOut,
            isCheckedIn,
            isStayingCheckedIn,
            
            // Room type flags
            isTurnover,
            isCheckoutOnly,
            isFreshArrival,
            isStayover,
            
            // Night calculation
            nightNum,
            totalNights,
            
            // Action permissions
            canCheckin,
            checkoutRequired: isTurnover && !isCheckedOut
        };
    }, [bookings, checkStatus, today]);

    // ============================================================

    const getDays = useCallback((count) => {
        const days = [];
        const start = new Date(startDate + "T12:00:00");
        for (let i = 0; i < count; i++) {
            const d = new Date(start);
            d.setDate(d.getDate() + i);
            days.push(d.toLocaleDateString('en-CA'));
        }
        return days;
    }, [startDate]);

    const days = useMemo(() => getDays(calDays), [getDays, calDays]);

    const toggleSelect = (room, unit, date) => {
        const unitKey = `${room.id}-${unit.id}`;
        setSelected(s => {
            const existing = s.find(x => x.unitKey === unitKey);
            if (existing) {
                // Unit already selected
                if (existing.checkIn === date) {
                    // Clicking check-in date = deselect this unit
                    return s.filter(x => x.unitKey !== unitKey);
                } else if (date > existing.checkIn) {
                    // Clicking a later date = set checkout to day AFTER clicked date
                    const nextDay = new Date(date + "T12:00:00");
                    nextDay.setDate(nextDay.getDate() + 1);
                    return s.map(x => x.unitKey === unitKey ? {...x, checkOut: nextDay.toLocaleDateString('en-CA')} : x);
                } else {
                    // Clicking earlier date = move check-in here, keep checkout
                    return s.map(x => x.unitKey === unitKey ? {...x, checkIn: date} : x);
                }
            } else {
                // New unit - check-in = clicked date, check-out = next day
                const nextDay = new Date(date + "T12:00:00");
                nextDay.setDate(nextDay.getDate() + 1);
                return [...s, {
                    unitKey,
                    room,
                    unit,
                    checkIn: date,
                    checkOut: nextDay.toLocaleDateString('en-CA')
                }];
            }
        });
    };

    const toggle = (id, type) => {
        const ns = {...checkStatus};
        const key = type === "in" ? "checkedin" : "checkedout";
        ns[id] = ns[id] === key ? null : key;
        if (!ns[id]) delete ns[id];
        setCheckStatus(ns);
        saveStatus(ns);
    };

    const addRequest = (roomNum, guestName, bookingId, requestType, note) => {
        const newReq = { id: Date.now(), roomNum, guestName, bookingId, requestType, note, timestamp: new Date().toISOString(), done: false };
        const updated = [newReq, ...requests];
        setRequests(updated);
        saveRequests(updated);
    };

    const markRequestDone = (id) => {
        const updated = requests.map(r => r.id === id ? {...r, done: true, doneAt: new Date().toISOString()} : r);
        setRequests(updated);
        saveRequests(updated);
    };

    const getRequestCounts = (bookingId) => {
        const bookingRequests = requests.filter(r => r.bookingId === bookingId);
        return { total: bookingRequests.length, pending: bookingRequests.filter(r => !r.done).length, done: bookingRequests.filter(r => r.done).length };
    };

    const stats = useMemo(() => {
        let occ=0, cin=0, cout=0;
        allRooms.forEach(({room, unit}) => getBooking(room.id, unit.id, today) ? occ++ : null);
        bookings.forEach(b => { if(b.arrival === today) cin++; if(b.departure === today) cout++; });
        // Use dynamic totalRooms from API for accurate occupancy calculations
        return {total: totalRooms, occ, avail: totalRooms - occ, cin, cout};
    }, [allRooms, bookings, getBooking, today, totalRooms]);

    const tomorrow = getBDDate(1);
    
    // Housekeeping data now uses unified getRoomStatus
    const getHKData = useCallback((targetDate) => {
        const checkin = [], checkout = [], stayover = [], turnover = [];
        allRooms.forEach(({room, unit}) => {
            const rs = getRoomStatus(room.id, unit.id, targetDate);
            
            if (rs.isTurnover) {
                turnover.push({
                    room, unit, 
                    out: rs.checkout, 
                    in: rs.checkin, 
                    outDone: rs.isCheckedOut, 
                    inDone: rs.isCheckedIn,
                    status: rs.status,
                    statusText: rs.statusText
                });
            } else if (rs.isCheckoutOnly) {
                checkout.push({
                    room, unit, 
                    booking: rs.checkout, 
                    done: rs.isCheckedOut,
                    status: rs.status,
                    statusText: rs.statusText
                });
            } else if (rs.isFreshArrival) {
                checkin.push({
                    room, unit, 
                    booking: rs.checkin, 
                    done: rs.isCheckedIn,
                    status: rs.status,
                    statusText: rs.statusText
                });
            } else if (rs.isStayover) {
                stayover.push({
                    room, unit, 
                    booking: rs.staying, 
                    checkedIn: rs.isStayingCheckedIn,
                    status: rs.status,
                    statusText: rs.statusText
                });
            }
        });
        return {checkin, checkout, stayover, turnover};
    }, [allRooms, getRoomStatus]);
    
    const housekeepingToday = useMemo(() => getHKData(today), [getHKData, today]);
    const housekeepingTomorrow = useMemo(() => getHKData(tomorrow), [getHKData, tomorrow]);
    
    // Keep old housekeeping for backwards compat
    const housekeeping = useMemo(() => {
        const makeup = [], dirty = [], turnover = [];
        allRooms.forEach(({room, unit}) => {
            const co = getCheckout(room.id, unit.id, today);
            const ci = getCheckin(room.id, unit.id, today);
            const stay = bookings.find(b => b.roomId === room.id && b.unitId === unit.id && b.arrival < today && b.departure > today);
            if (co && ci) turnover.push({room, unit, out: co, in: ci});
            else if (co && !ci) dirty.push({room, unit, booking: co});
            else if (stay) makeup.push({room, unit, booking: stay});
        });
        return {makeup, dirty, turnover};
    }, [allRooms, bookings, getCheckout, getCheckin, today]);
    
    const handleRequestDone = (reqId, isDenied) => {
        const staffInput = document.getElementById("staff-" + reqId);
        const staffName = staffInput ? staffInput.value : "Housekeeping";
        const updated = requests.map(r => r.id === reqId ? {...r, done: true, denied: isDenied, doneAt: new Date().toISOString(), doneBy: staffName || "Housekeeping"} : r);
        setRequests(updated);
        saveRequests(updated);
    };

    const updateRoomStatus = (roomNum, newStatus) => {
        const updated = {...roomStatuses, [roomNum]: {status: newStatus, updatedAt: new Date().toISOString()}};
        setRoomStatuses(updated);
        saveRoomStatuses(updated);
        setRoomStatusModal(null);
    };

    const getRoomStatusInfo = (roomNum) => {
        const saved = roomStatuses[roomNum];
        if (!saved) return ROOM_STATUS_OPTIONS[0]; // Default to Clean
        return ROOM_STATUS_OPTIONS.find(o => o.key === saved.status) || ROOM_STATUS_OPTIONS[0];
    };

    const movements = useMemo(() => {
        const todayIn = bookings.filter(b => b.arrival === today);
        const todayOut = bookings.filter(b => b.departure === today);
        return {
            pendingIn: todayIn.filter(b => checkStatus[b.id] !== "checkedin"),
            doneIn: todayIn.filter(b => checkStatus[b.id] === "checkedin"),
            pendingOut: todayOut.filter(b => checkStatus[b.id] !== "checkedout"),
            doneOut: todayOut.filter(b => checkStatus[b.id] === "checkedout")
        };
    }, [bookings, checkStatus, today]);

    const currentGuests = useMemo(() => {
        return bookings.filter(b => b.arrival <= today && b.departure > today).map(b => {
            const {room, unit, num} = getRoomInfo(b.roomId, b.unitId);
            return {...b, room, unit, num};
        }).sort((a,b) => parseInt(a.num) - parseInt(b.num));
    }, [bookings, today]);

    const globalSearchResults = useMemo(() => {
        if (!searchQuery.trim()) return [];
        const q = searchQuery.toLowerCase();
        return bookings.filter(b => 
            b.id?.toString().includes(q) || b.firstName?.toLowerCase().includes(q) || 
            b.lastName?.toLowerCase().includes(q) || b.email?.toLowerCase().includes(q) || 
            b.mobile?.includes(q) || getRoomInfo(b.roomId, b.unitId).num.includes(q)
        ).slice(0, 15);
    }, [bookings, searchQuery]);

    const availableRooms = useMemo(() => {
        if (!searchCheckIn || !searchCheckOut) return [];
        return allRooms.filter(({room, unit}) => {
            const hasConflict = bookings.some(b => b.roomId === room.id && b.unitId === unit.id && b.arrival < searchCheckOut && b.departure > searchCheckIn);
            return !hasConflict;
        });
    }, [allRooms, bookings, searchCheckIn, searchCheckOut]);

    const getMultiUnitInfo = (booking) => {
        // Use String comparison for type safety
        const masterIdStr = String(booking.masterId || booking.id);
        const related = bookings.filter(b => 
            String(b.masterId) === masterIdStr || 
            String(b.id) === masterIdStr ||
            (booking.masterId && String(b.masterId) === String(booking.masterId))
        );
        if (related.length <= 1) return null;
        const totalAmount = related.reduce((sum, b) => sum + (parseFloat(b.price) || 0), 0);
        const totalPaid = related.reduce((sum, b) => sum + (parseFloat(b.deposit) || 0), 0);
        // Find master booking for primary guest info
        const masterBooking = related.find(b => !b.masterId) || related[0];
        return { 
            count: related.length, 
            rooms: related.map(b => getRoomInfo(b.roomId, b.unitId).num),
            totalAmount, 
            totalPaid, 
            totalDue: totalAmount - totalPaid,
            masterBooking: masterBooking,
            allBookings: related
        };
    };

    const tabs = [
        {id: "today", label: "üìÖ Today"},
        {id: "calendar", label: "üìÜ Calendar"},
        {id: "searchbook", label: "üîç Search & Book"},
        {id: "requests", label: "üõéÔ∏è Requests"},
        {id: "housekeeping", label: "üßπ Housekeeping"},
        {id: "movements", label: "‚ÜîÔ∏è Movements"},
        {id: "accounting", label: "üí∞ Accounting"},
        {id: "dashboard", label: "üìä Dashboard"},
        {id: "whatsapp", label: "üí¨ WhatsApp"}
    ];

    const StatusCard = ({room, unit, date, showGuestName = true}) => {
        // Selection state
        const unitKey = `${room.id}-${unit.id}`;
        const unitSelection = selected.find(x => x.unitKey === unitKey);
        const isCheckInDate = unitSelection && date === unitSelection.checkIn;
        const isCheckOutDate = unitSelection && date === unitSelection.checkOut;
        const isInRange = unitSelection && date > unitSelection.checkIn && date < unitSelection.checkOut;
        const isSelected = isCheckInDate || isInRange || isCheckOutDate;

        // Get ALL bookings for this cell to detect overbookings
        const allBookingsForCell = getAllBookingsForCell(room.id, unit.id, date);
        const isOverbooked = allBookingsForCell.length > 1;

        // Check for booking staying tonight (arrival <= date < departure)
        const booking = getBooking(room.id, unit.id, date);

        // Only confirmed bookings block the room - cancelled/inquiry don't
        const isCancelled = booking && booking.status === "cancelled";
        const isInquiry = booking && booking.status === "inquiry";

        // Simple logic: is room ACTUALLY booked tonight?
        const isBooked = booking && !isCancelled && !isInquiry;

        // Get CSS class - BOOKED, OVERBOOKING, or Available
        const getFinalCardClass = () => {
            if (isSelected) return "card-selected-preview";
            if (isOverbooked) return "card-overbooking"; // Overbooking takes priority - needs immediate attention!
            if (isBooked) return "card-booked";
            return "card-available"; // Everything else (no booking, cancelled, inquiry) = available
        };

        // Get status text
        const getFinalStatusText = () => {
            if (isSelected) {
                if (isCheckInDate) return "CHECK-IN";
                if (isCheckOutDate) return "CHECK-OUT";
                if (isInRange) return "NIGHT STAY";
            }
            if (isOverbooked) return `OVERBOOK (${allBookingsForCell.length})`;
            if (isBooked) return "BOOKED";
            return "Available"; // Everything else = available
        };

        const finalCardClass = getFinalCardClass();
        const finalStatusText = getFinalStatusText();

        // Click handler: booked/overbooked = show info, available = select for booking
        const handleClick = () => {
            if (isBooked || isOverbooked) {
                // For overbookings, show the first booking - user can see count in the card
                setShowInfoModal(booking || allBookingsForCell[0]);
            } else {
                toggleSelect(room, unit, date);
            }
        };

        // Should we show a guest name? Only for actual bookings
        const shouldShowName = (isBooked || isOverbooked) && booking;
        // For overbooking, show multiple names
        const displayName = isOverbooked
            ? allBookingsForCell.map(b => b.firstName).join(" / ")
            : (booking ? booking.firstName : "");

        return (
            <div className={`status-card ${finalCardClass}`} onClick={handleClick} style={{cursor: 'pointer'}}>
                <div className="status-text">{finalStatusText}</div>
                {showGuestName && shouldShowName && <div className="guest-name">{displayName}</div>}
            </div>
        );
    };

    // Star dust effect
    const createStardust = (e) => {
        const dust = document.createElement('div');
        dust.className = 'stardust';
        dust.style.left = (e.clientX - 4) + 'px';
        dust.style.top = (e.clientY - 4) + 'px';
        dust.style.background = `radial-gradient(circle, #fff 0%, ${['#2D6A6A', '#2D6A6A', '#D4A853', '#f59e0b', '#ef4444'][Math.floor(Math.random() * 5)]} 50%, transparent 70%)`;
        document.body.appendChild(dust);
        setTimeout(() => dust.remove(), 1000);
    };

    const CalendarView = ({groupBy}) => {
        const groups = groupBy === "floor"
            ? FLOORS.map(f => ({key: f, title: `üè¢ ${floorName(f)} Floor`, rooms: roomsByFloor[f] || [], count: (roomsByFloor[f] || []).length}))
            : ROOMS.map(r => ({key: r.id, title: r.name, rooms: r.units.map(u => ({room: r, unit: u})), count: r.units.length}));

        // Calculate occupancy for each day
        const getOccupancyForDate = (date) => {
            const occupiedSet = new Set();
            bookings.forEach(b => {
                if (b.status === 'cancelled' || b.status === 'inquiry') return;
                if (b.arrival <= date && b.departure > date) {
                    occupiedSet.add(`${b.roomId}-${b.unitId}`);
                }
            });
            const occupied = occupiedSet.size;
            const available = totalRooms - occupied;
            return { occupied, available };
        };

        return (
            <>
                {/* Sticky Date Header */}
                <div className="date-header-wrapper">
                    <div className="date-header-inner">
                        {days.map(d => <div key={d} className={`date-cell ${d === today ? 'today' : ''}`}><div className="date-day">{shortDay(d)}</div><div className="date-num">{dayNum(d)}</div></div>)}
                    </div>
                </div>
                {/* Sticky Occupancy Summary Row */}
                <div className="occupancy-row-wrapper">
                    <div className="occupancy-row-inner">
                        {days.map(d => {
                            const { occupied, available } = getOccupancyForDate(d);
                            const cellClass = available === 0 ? 'full' : available <= 5 ? 'low' : '';
                            return (
                                <div key={d} className={`occupancy-cell ${cellClass}`}>
                                    <div className="occ-available">{available} avail</div>
                                    <div className="occ-occupied">{occupied} booked</div>
                                </div>
                            );
                        })}
                    </div>
                </div>
                <div className="cal-container" onMouseMove={createStardust}>
                    {groups.map(group => {
                        if (!group.rooms.length) return null;
                        return (
                            <div key={group.key}>
                                <div className="floor-header"><span style={{fontWeight: 600}}>{group.title}</span><span style={{color: 'rgba(255,255,255,0.5)', fontSize: 13}}>{group.count} rooms</span></div>
                                {group.rooms.map(({room, unit}) => (
                                    <div key={`${room.id}-${unit.id}`} className="room-row">
                                        <div className="room-label"><div className="room-num">{unit.n}</div><div className="room-type">{room.short}</div><div className="room-cap">üë§ {room.max}A</div></div>
                                        {days.map(d => <StatusCard key={d} room={room} unit={unit} date={d}/>)}
                                    </div>
                                ))}
                            </div>
                        );
                    })}
                </div>
            </>
        );
    };

    const TodayView = () => {
        const [dualGuestModal, setDualGuestModal] = useState(null); // {checkIn: booking, checkOut: booking, room, unit}
        
        const groups = todayViewBy === "floor" 
            ? FLOORS.map(f => ({key: f, title: `${floorName(f)} Floor`, rooms: roomsByFloor[f] || []}))
            : todayViewBy === "category"
            ? ROOMS.map(r => ({key: r.id, title: r.short, rooms: r.units.map(u => ({room: r, unit: u}))}))
            : []; // Group view handled separately
        
        // Get GROUP bookings checking in today only (linked via masterId or invoiceeId)
        const guestGroups = useMemo(() => {
            // Only get bookings checking in TODAY
            const todayCheckIns = bookings.filter(b => b.arrival === today);
            
            // First pass: identify which masterId/invoiceeId have multiple bookings
            const masterIdCounts = {};
            const invoiceeIdCounts = {};
            
            todayCheckIns.forEach(b => {
                if (b.masterId) {
                    masterIdCounts[b.masterId] = (masterIdCounts[b.masterId] || 0) + 1;
                }
                if (b.invoiceeId) {
                    invoiceeIdCounts[b.invoiceeId] = (invoiceeIdCounts[b.invoiceeId] || 0) + 1;
                }
            });
            
            // Also check ALL bookings for masterId links (some rooms might have arrived earlier)
            bookings.forEach(b => {
                if (b.masterId) {
                    masterIdCounts[b.masterId] = (masterIdCounts[b.masterId] || 0) + 1;
                }
                if (b.invoiceeId) {
                    invoiceeIdCounts[b.invoiceeId] = (invoiceeIdCounts[b.invoiceeId] || 0) + 1;
                }
            });
            
            // Count master bookings themselves (the booking whose id IS the masterId of others)
            // This ensures we count the full group even when master has masterId: null
            Object.keys(masterIdCounts).forEach(masterId => {
                const masterBookingExists = bookings.some(b => String(b.id) === String(masterId) && !b.masterId);
                if (masterBookingExists) {
                    masterIdCounts[masterId] = (masterIdCounts[masterId] || 0) + 1;
                }
            });
            
            // Group by masterId or invoiceeId (only if they have multiple bookings = actual groups)
            const groupMap = {};
            
            todayCheckIns.forEach(b => {
                // Determine the group key - prefer masterId, then invoiceeId
                let groupKey = null;
                let isRealGroup = false;
                
                if (b.masterId && masterIdCounts[b.masterId] > 1) {
                    groupKey = `master-${b.masterId}`;
                    isRealGroup = true;
                } else if (b.invoiceeId && invoiceeIdCounts[b.invoiceeId] > 1) {
                    groupKey = `invoice-${b.invoiceeId}`;
                    isRealGroup = true;
                }
                
                // Skip single bookings - only show groups
                if (!isRealGroup) return;
                
                if (!groupMap[groupKey]) {
                    groupMap[groupKey] = {
                        key: groupKey,
                        masterId: b.masterId,
                        invoiceeId: b.invoiceeId,
                        bookings: [],
                        totalRooms: 0
                    };
                }
                groupMap[groupKey].bookings.push(b);
            });
            
            // For each group, also add rooms that might have arrived on different days (same masterId/invoiceeId)
            Object.values(groupMap).forEach(g => {
                const allGroupBookings = bookings.filter(b => {
                    // Include bookings linked by masterId
                    if (g.masterId && b.masterId === g.masterId) return true;
                    // Include the MASTER booking itself (its masterId is null but its id IS the masterId)
                    if (g.masterId && String(b.id) === String(g.masterId)) return true;
                    // Include bookings linked by invoiceeId
                    if (g.invoiceeId && b.invoiceeId === g.invoiceeId) return true;
                    return false;
                });
                
                // Replace bookings with all linked bookings
                g.allBookings = allGroupBookings;
                g.todayCheckIns = g.bookings; // Keep original today's check-ins
                g.totalRooms = allGroupBookings.length;
                
                // Get primary guest name from first booking (usually the master)
                const masterBooking = allGroupBookings.find(b => String(b.id) === String(g.masterId)) || allGroupBookings[0];
                g.primaryGuest = `${masterBooking.firstName} ${masterBooking.lastName || ''}`.trim();
                g.phone = masterBooking.mobile || allGroupBookings.find(b => b.mobile)?.mobile;
            });
            
            // Sort by number of rooms (largest groups first)
            return Object.values(groupMap).sort((a, b) => b.totalRooms - a.totalRooms);
        }, [bookings, today]);
        
        // Handle unit click in Today view
        const handleUnitClick = (room, unit, booking, checkOutBooking, checkInBooking) => {
            // If both check-in and check-out on same unit today, show dual modal
            if (checkInBooking && checkOutBooking) {
                setDualGuestModal({
                    checkIn: checkInBooking,
                    checkOut: checkOutBooking,
                    room,
                    unit
                });
                return;
            }
            
            // If booked, show info modal
            if (booking) {
                setShowInfoModal(booking);
                return;
            }
            
            // If available, start booking selection
            const unitKey = `${room.id}-${unit.id}`;
            const existing = selected.find(s => s.unitKey === unitKey);
            if (existing) {
                // Already selected, remove it
                setSelected(selected.filter(s => s.unitKey !== unitKey));
            } else {
                // Add to selection with today as check-in
                const tomorrow = getBDDate(1);
                setSelected([...selected, {
                    room, 
                    unit, 
                    unitKey,
                    checkIn: today,
                    checkOut: tomorrow
                }]);
            }
        };
        
        return (
            <div style={{padding: '16px', maxWidth: '1200px', margin: '0 auto'}}>
                {/* Room Grid Section */}
                <div style={{background: 'rgba(255,255,255,0.02)', borderRadius: '20px', padding: '20px', border: '1px solid rgba(255,255,255,0.05)'}}>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px', flexWrap: 'wrap', gap: '12px'}}>
                        <h3 style={{fontSize: '18px', fontWeight: '600'}}>üìÖ Today - {formatDate(today)}</h3>
                        <div className="view-selector" style={{marginBottom: '0'}}>
                            <button className={`view-btn ${todayViewBy === 'overview' ? 'active' : ''}`} onClick={() => setTodayViewBy('overview')}>üìä Overview</button>
                            <button className={`view-btn ${todayViewBy === 'floor' ? 'active' : ''}`} onClick={() => setTodayViewBy('floor')}>üè¢ By Floor</button>
                            <button className={`view-btn ${todayViewBy === 'category' ? 'active' : ''}`} onClick={() => setTodayViewBy('category')}>üìÅ By Category</button>
                            <button className={`view-btn ${todayViewBy === 'group' ? 'active' : ''}`} onClick={() => setTodayViewBy('group')}>üë• By Group</button>
                        </div>
                    </div>
                    
                    {/* Overview - Dashboard Summary */}
                    {todayViewBy === 'overview' && (() => {
                        const selectedDate = overviewDate;
                        const isToday = selectedDate === today;
                        const checkIns = bookings.filter(b => b.arrival === selectedDate && b.status !== 'cancelled' && b.status !== 'inquiry');
                        const checkOuts = bookings.filter(b => b.departure === selectedDate && b.status !== 'cancelled' && b.status !== 'inquiry');
                        const stayingGuests = bookings.filter(b => b.arrival <= selectedDate && b.departure > selectedDate && b.status !== 'cancelled' && b.status !== 'inquiry');
                        // Use dynamic totalRooms from API for occupancy calculations
                        const totalUnits = totalRooms;
                        // Count unique occupied room/unit combinations
                        const occupiedSet = new Set(stayingGuests.map(b => `${b.roomId}-${b.unitId}`));
                        const occupiedUnits = occupiedSet.size;
                        const emptyUnits = totalUnits - occupiedUnits;
                        const occupancyRate = totalUnits > 0 ? Math.round((occupiedUnits / totalUnits) * 100) : 0;
                        const turnoverRooms = checkOuts.filter(out => checkIns.some(ci => ci.roomId === out.roomId && ci.unitId === out.unitId));
                        
                        // Get available units for selected date
                        const availableUnits = allRooms.filter(({room, unit}) => {
                            const hasBooking = bookings.some(b => 
                                b.roomId === room.id && b.unitId === unit.id && 
                                b.arrival <= selectedDate && b.departure > selectedDate && 
                                b.status !== 'cancelled' && b.status !== 'inquiry'
                            );
                            return !hasBooking;
                        });
                        
                        return (
                            <>
                                {/* Date Selector */}
                                <div style={{display: 'flex', justifyContent: 'center', alignItems: 'center', gap: '10px', marginBottom: '20px'}}>
                                    <button onClick={() => { const d = new Date(overviewDate); d.setDate(d.getDate() - 1); setOverviewDate(d.toISOString().slice(0,10)); }} style={{background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '8px', padding: '10px 14px', color: '#fff', cursor: 'pointer', fontSize: '16px'}}>‚Üê</button>
                                    <div onClick={() => overviewDateRef.current?.showPicker()} style={{cursor: 'pointer', background: isToday ? 'linear-gradient(135deg, #2D6A6A, #245858)' : 'rgba(255,255,255,0.1)', borderRadius: '10px', padding: '10px 16px', display: 'flex', alignItems: 'center', gap: '8px'}}>
                                        <span style={{fontSize: '18px'}}>üìÖ</span>
                                        <span style={{fontWeight: '600'}}>{new Date(selectedDate + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</span>
                                        <input ref={overviewDateRef} type="date" value={overviewDate} onChange={e => setOverviewDate(e.target.value)} style={{position: 'absolute', opacity: 0, pointerEvents: 'none'}}/>
                                    </div>
                                    <button onClick={() => { const d = new Date(overviewDate); d.setDate(d.getDate() + 1); setOverviewDate(d.toISOString().slice(0,10)); }} style={{background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '8px', padding: '10px 14px', color: '#fff', cursor: 'pointer', fontSize: '16px'}}>‚Üí</button>
                                </div>
                                
                                {/* Summary Cards */}
                                <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '16px', marginBottom: '20px'}}>
                                    <div style={{background: 'linear-gradient(145deg, rgba(45,106,106,0.2), rgba(45,106,106,0.05))', border: '2px solid rgba(45,106,106,0.4)', borderRadius: '16px', padding: '20px', position: 'relative', overflow: 'hidden'}}>
                                        <div style={{position: 'absolute', top: '-20px', right: '-20px', fontSize: '70px', opacity: 0.1}}>‚¨áÔ∏è</div>
                                        <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.6)', fontWeight: '600', marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '1px'}}>Check-ins</div>
                                        <div style={{fontSize: '42px', fontWeight: '800', color: '#2D6A6A', lineHeight: 1}}>{checkIns.length}</div>
                                        <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', marginTop: '6px'}}>{checkIns.length > 0 ? `${checkIns.filter(b => checkStatus[b.id] === 'checkedin').length} completed` : 'No arrivals'}</div>
                                    </div>
                                    <div style={{background: 'linear-gradient(145deg, rgba(212,168,83,0.2), rgba(212,168,83,0.05))', border: '2px solid rgba(212,168,83,0.4)', borderRadius: '16px', padding: '20px', position: 'relative', overflow: 'hidden'}}>
                                        <div style={{position: 'absolute', top: '-20px', right: '-20px', fontSize: '70px', opacity: 0.1}}>‚¨ÜÔ∏è</div>
                                        <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.6)', fontWeight: '600', marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '1px'}}>Check-outs</div>
                                        <div style={{fontSize: '42px', fontWeight: '800', color: '#D4A853', lineHeight: 1}}>{checkOuts.length}</div>
                                        <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', marginTop: '6px'}}>{checkOuts.length > 0 ? `${checkOuts.filter(b => checkStatus[b.id] === 'checkedout').length} completed` : 'No departures'}</div>
                                    </div>
                                    <div style={{background: 'linear-gradient(145deg, rgba(239,68,68,0.2), rgba(239,68,68,0.05))', border: '2px solid rgba(239,68,68,0.4)', borderRadius: '16px', padding: '20px', position: 'relative', overflow: 'hidden'}}>
                                        <div style={{position: 'absolute', top: '-20px', right: '-20px', fontSize: '70px', opacity: 0.1}}>üè®</div>
                                        <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.6)', fontWeight: '600', marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '1px'}}>Occupied</div>
                                        <div style={{fontSize: '42px', fontWeight: '800', color: '#ef4444', lineHeight: 1}}>{occupiedUnits}</div>
                                        <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', marginTop: '6px'}}>{occupancyRate}% occupancy rate</div>
                                    </div>
                                    <div style={{background: 'linear-gradient(145deg, rgba(34,197,94,0.2), rgba(34,197,94,0.05))', border: '2px solid rgba(34,197,94,0.4)', borderRadius: '16px', padding: '20px', position: 'relative', overflow: 'hidden'}}>
                                        <div style={{position: 'absolute', top: '-20px', right: '-20px', fontSize: '70px', opacity: 0.1}}>üõèÔ∏è</div>
                                        <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.6)', fontWeight: '600', marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '1px'}}>Available</div>
                                        <div style={{fontSize: '42px', fontWeight: '800', color: '#22c55e', lineHeight: 1}}>{emptyUnits}</div>
                                        <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', marginTop: '6px'}}>of {totalUnits} total units</div>
                                    </div>
                                </div>
                                
                                {/* Turnover Badge */}
                                {turnoverRooms.length > 0 && (
                                    <div style={{background: 'linear-gradient(145deg, rgba(168,85,247,0.2), rgba(168,85,247,0.05))', border: '2px solid rgba(168,85,247,0.4)', borderRadius: '12px', padding: '14px 20px', marginBottom: '20px', display: 'flex', alignItems: 'center', gap: '12px'}}>
                                        <span style={{fontSize: '24px'}}>üîÑ</span>
                                        <div>
                                            <div style={{fontWeight: '700', color: '#a855f7'}}>{turnoverRooms.length} Turnover Room{turnoverRooms.length > 1 ? 's' : ''}</div>
                                            <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.5)'}}>Same-day checkout and check-in</div>
                                        </div>
                                    </div>
                                )}
                                
                                {/* Available Units List - Click to Book */}
                                <div style={{background: 'rgba(34,197,94,0.1)', border: '1px solid rgba(34,197,94,0.3)', borderRadius: '12px', padding: '16px'}}>
                                    <h4 style={{marginBottom: '12px', fontSize: '14px', color: '#22c55e', display: 'flex', alignItems: 'center', gap: '8px'}}><span>üõèÔ∏è</span> Available Rooms ({availableUnits.length}) <span style={{fontSize: '11px', color: 'rgba(255,255,255,0.4)', fontWeight: '400'}}>‚Ä¢ Click to select</span></h4>
                                    <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(120px, 1fr))', gap: '10px', maxHeight: '300px', overflowY: 'auto'}}>
                                        {availableUnits.map(({room, unit}) => {
                                            const unitKey = `${room.id}-${unit.id}`;
                                            const isSelected = selected.some(s => s.unitKey === unitKey);
                                            const nextDay = new Date(selectedDate);
                                            nextDay.setDate(nextDay.getDate() + 1);
                                            const checkOutDate = nextDay.toISOString().slice(0,10);
                                            return (
                                                <div key={unitKey} onClick={() => {
                                                    if (isSelected) {
                                                        setSelected(selected.filter(s => s.unitKey !== unitKey));
                                                    } else {
                                                        setSelected([...selected, {unitKey, room, unit, checkIn: selectedDate, checkOut: checkOutDate}]);
                                                    }
                                                }} style={{background: isSelected ? 'linear-gradient(145deg, #2D6A6A, #245858)' : 'rgba(255,255,255,0.05)', border: isSelected ? '2px solid #fff' : '2px solid transparent', borderRadius: '10px', padding: '12px', textAlign: 'center', cursor: 'pointer', transition: 'all 0.2s'}}>
                                                    <div style={{fontWeight: '700', color: isSelected ? '#fff' : '#22c55e', fontSize: '22px'}}>{unit.n}</div>
                                                    <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', marginTop: '4px'}}>{room.short}</div>
                                                    <div style={{fontSize: '10px', color: 'rgba(255,255,255,0.4)'}}>üë§ {room.max}A</div>
                                                    {isSelected && <div style={{marginTop: '6px', fontSize: '10px', fontWeight: '600', color: '#fff'}}>‚úì Selected</div>}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </>
                        );
                    })()}
                    
                    {/* Group View */}
                    {todayViewBy === 'group' && (
                        <div>
                            {/* Stats for group check-ins today */}
                            <div style={{display: 'flex', gap: '12px', justifyContent: 'center', marginBottom: '20px', flexWrap: 'wrap'}}>
                                <div style={{background: 'rgba(168,85,247,0.15)', border: '1px solid rgba(168,85,247,0.3)', borderRadius: '10px', padding: '12px 20px', textAlign: 'center'}}>
                                    <div style={{fontSize: '24px', fontWeight: '700', color: '#a855f7'}}>{guestGroups.length}</div>
                                    <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.6)'}}>Group Check-ins Today</div>
                                </div>
                                <div style={{background: 'rgba(45,106,106,0.15)', border: '1px solid rgba(45,106,106,0.3)', borderRadius: '10px', padding: '12px 20px', textAlign: 'center'}}>
                                    <div style={{fontSize: '24px', fontWeight: '700', color: '#2D6A6A'}}>{guestGroups.reduce((sum, g) => sum + g.todayCheckIns.length, 0)}</div>
                                    <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.6)'}}>Rooms Arriving Today</div>
                                </div>
                            </div>
                            
                            {/* Group Bookings Section */}
                            {guestGroups.length > 0 && (
                                <div style={{marginBottom: '24px'}}>
                                    <h4 style={{fontSize: '14px', color: '#a855f7', marginBottom: '12px', display: 'flex', alignItems: 'center', gap: '8px'}}>
                                        <span style={{background: 'rgba(168,85,247,0.2)', padding: '4px 10px', borderRadius: '6px'}}>üë• Group Check-ins Today ({guestGroups.length} groups)</span>
                                    </h4>
                                    <div style={{display: 'flex', flexDirection: 'column', gap: '16px'}}>
                                        {guestGroups.map(group => {
                                            // Check status for today's check-ins only
                                            const todayPendingCheckIns = group.todayCheckIns.filter(b => checkStatus[b.id] !== "checkedin");
                                            const todayCheckedIn = group.todayCheckIns.filter(b => checkStatus[b.id] === "checkedin");
                                            const allTodayCheckedIn = todayPendingCheckIns.length === 0;
                                            const someCheckedIn = todayCheckedIn.length > 0;
                                            
                                            return (
                                                <div key={group.key} style={{background: 'linear-gradient(135deg, rgba(168,85,247,0.1) 0%, rgba(168,85,247,0.05) 100%)', border: '2px solid rgba(168,85,247,0.3)', borderRadius: '16px', padding: '16px', position: 'relative'}}>
                                                    {/* Group Badge */}
                                                    <div style={{position: 'absolute', top: '-10px', right: '16px', background: allTodayCheckedIn ? '#22c55e' : someCheckedIn ? '#f59e0b' : '#a855f7', padding: '4px 12px', borderRadius: '12px', fontSize: '11px', fontWeight: '700', display: 'flex', alignItems: 'center', gap: '4px'}}>
                                                        {allTodayCheckedIn ? `‚úì All ${group.todayCheckIns.length} Checked-in` : someCheckedIn ? `‚è≥ ${todayCheckedIn.length}/${group.todayCheckIns.length} Checked-in` : `${group.todayCheckIns.length} Arriving Today`}
                                                    </div>
                                                    
                                                    {/* Primary Guest Info */}
                                                    <div style={{display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '14px'}}>
                                                        <div style={{width: '50px', height: '50px', background: 'linear-gradient(135deg, #a855f7, #7c3aed)', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '20px', fontWeight: '700'}}>{group.primaryGuest.charAt(0)}</div>
                                                        <div>
                                                            <div style={{fontSize: '18px', fontWeight: '700'}}>{group.primaryGuest} <span style={{fontSize: '12px', color: 'rgba(255,255,255,0.5)', fontWeight: '400'}}>(Group)</span></div>
                                                            <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.6)'}}>üìû {group.phone || 'N/A'} ‚Ä¢ {group.totalRooms} total rooms ‚Ä¢ {group.todayCheckIns.length} arriving today</div>
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Today's Check-in Rooms */}
                                                    <div style={{marginBottom: '12px'}}>
                                                        <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', marginBottom: '8px', fontWeight: '600'}}>‚¨áÔ∏è CHECKING IN TODAY:</div>
                                                        <div style={{display: 'flex', flexWrap: 'wrap', gap: '10px'}}>
                                                            {group.todayCheckIns.map(b => {
                                                                const {room, unit, num} = getRoomInfo(b.roomId, b.unitId);
                                                                const rs = getRoomStatus(b.roomId, b.unitId, today);
                                                                const isCheckedIn = rs.isCheckedIn;
                                                                const blocked = rs.checkoutRequired;
                                                                const guestName = `${b.firstName} ${b.lastName || ''}`.trim();
                                                                
                                                                return (
                                                                    <div key={b.id} style={{
                                                                        background: isCheckedIn ? 'linear-gradient(145deg, #22c55e, #16a34a)' : blocked ? 'linear-gradient(145deg, #D4A853, #B8942F)' : 'linear-gradient(145deg, #2D6A6A, #245858)',
                                                                        borderRadius: '12px', padding: '12px 16px', textAlign: 'center', minWidth: '110px', position: 'relative',
                                                                        border: '2px solid rgba(255,255,255,0.2)', opacity: blocked && !isCheckedIn ? 0.8 : 1
                                                                    }}>
                                                                        {/* Quick toggle button */}
                                                                        <button 
                                                                            onClick={(e) => { 
                                                                                e.stopPropagation(); 
                                                                                if (blocked && !isCheckedIn) {
                                                                                    alert(`‚ö†Ô∏è Checkout Required!\n\nPlease checkout ${rs.checkout?.firstName} from room #${num} before checking in ${b.firstName}.`);
                                                                                    return;
                                                                                }
                                                                                toggle(b.id, "in"); 
                                                                            }}
                                                                            style={{
                                                                                position: 'absolute', top: '-8px', right: '-8px',
                                                                                width: '28px', height: '28px', borderRadius: '50%',
                                                                                background: isCheckedIn ? '#fff' : blocked ? 'rgba(100,100,100,0.5)' : 'linear-gradient(135deg, #2D6A6A, #245858)',
                                                                                border: isCheckedIn ? '2px solid #22c55e' : '2px solid rgba(255,255,255,0.3)',
                                                                                color: isCheckedIn ? '#22c55e' : '#fff',
                                                                                fontSize: '14px', fontWeight: '700', cursor: blocked && !isCheckedIn ? 'not-allowed' : 'pointer',
                                                                                display: 'flex', alignItems: 'center', justifyContent: 'center',
                                                                                boxShadow: '0 2px 8px rgba(0,0,0,0.3)'
                                                                            }}
                                                                            title={isCheckedIn ? 'Click to undo check-in' : blocked ? 'Checkout required first' : 'Click to check-in'}
                                                                        >
                                                                            {isCheckedIn ? '‚Ü©' : blocked ? '‚ö†' : '‚úì'}
                                                                        </button>
                                                                        <div style={{display: 'flex', gap: '4px', justifyContent: 'center', marginBottom: '4px'}}>
                                                                            {blocked && !isCheckedIn && <div style={{background: '#D4A853', color: '#fff', borderRadius: '4px', padding: '2px 6px', fontSize: '8px', fontWeight: '700'}}>OUT</div>}
                                                                            <div style={{background: isCheckedIn ? '#fff' : '#2D6A6A', color: isCheckedIn ? '#22c55e' : '#fff', borderRadius: '4px', padding: '2px 6px', fontSize: '8px', fontWeight: '700'}}>{isCheckedIn ? '‚úì IN' : 'IN'}</div>
                                                                        </div>
                                                                        <div style={{fontSize: '22px', fontWeight: '700', cursor: 'pointer'}} onClick={() => setShowInfoModal(b)}>{num}</div>
                                                                        <div style={{fontSize: '9px', opacity: 0.8}}>{room?.short}</div>
                                                                        <div style={{fontSize: '11px', marginTop: '4px', fontWeight: '600', color: isCheckedIn ? '#fff' : 'rgba(255,255,255,0.9)'}}>
                                                                            {guestName}
                                                                        </div>
                                                                        <div style={{fontSize: '9px', marginTop: '2px', opacity: 0.7, cursor: 'pointer'}} onClick={() => setShowInfoModal(b)}>
                                                                            {isCheckedIn ? 'Checked-in ‚úì' : blocked ? `Checkout ${rs.checkout?.firstName} first` : 'Pending'} ‚Ä¢ tap for info
                                                                        </div>
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Other Rooms in Group (already checked in on different days) */}
                                                    {group.allBookings.filter(b => b.arrival !== today && b.arrival < today && b.departure > today).length > 0 && (
                                                        <div style={{marginBottom: '12px', padding: '10px', background: 'rgba(0,0,0,0.15)', borderRadius: '10px'}}>
                                                            <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', marginBottom: '8px', fontWeight: '600'}}>üè® ALREADY IN-HOUSE:</div>
                                                            <div style={{display: 'flex', flexWrap: 'wrap', gap: '8px'}}>
                                                                {group.allBookings.filter(b => b.arrival !== today && b.arrival < today && b.departure > today).map(b => {
                                                                    const {room, unit, num} = getRoomInfo(b.roomId, b.unitId);
                                                                    const guestName = `${b.firstName} ${b.lastName || ''}`.trim();
                                                                    const isCheckedIn = checkStatus[b.id] === "checkedin";
                                                                    
                                                                    return (
                                                                        <div key={b.id} onClick={() => setShowInfoModal(b)} style={{
                                                                            background: isCheckedIn ? 'rgba(34,197,94,0.2)' : 'rgba(239,68,68,0.2)',
                                                                            borderRadius: '8px', padding: '8px 12px', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '8px',
                                                                            border: `1px solid ${isCheckedIn ? 'rgba(34,197,94,0.4)' : 'rgba(239,68,68,0.4)'}`
                                                                        }}>
                                                                            <div style={{fontSize: '16px', fontWeight: '700', color: isCheckedIn ? '#22c55e' : '#ef4444'}}>{num}</div>
                                                                            <div>
                                                                                <div style={{fontSize: '11px', fontWeight: '600'}}>{guestName}</div>
                                                                                <div style={{fontSize: '9px', color: 'rgba(255,255,255,0.5)'}}>{isCheckedIn ? '‚úì In-house' : 'Staying'}</div>
                                                                            </div>
                                                                        </div>
                                                                    );
                                                                })}
                                                            </div>
                                                        </div>
                                                    )}
                                                    
                                                    {/* Quick Actions */}
                                                    <div style={{display: 'flex', gap: '8px', marginTop: '12px', flexWrap: 'wrap'}}>
                                                        {todayPendingCheckIns.length > 0 && (() => {
                                                            const canCheckIn = todayPendingCheckIns.filter(b => !getRoomStatus(b.roomId, b.unitId, today).checkoutRequired);
                                                            const blocked = todayPendingCheckIns.filter(b => getRoomStatus(b.roomId, b.unitId, today).checkoutRequired);
                                                            return (
                                                                <>
                                                                    {canCheckIn.length > 0 && (
                                                                        <button onClick={() => canCheckIn.forEach(b => toggle(b.id, "in"))} style={{padding: '10px 16px', background: 'linear-gradient(135deg, #2D6A6A, #245858)', border: 'none', borderRadius: '8px', color: '#fff', fontSize: '13px', fontWeight: '600', cursor: 'pointer', boxShadow: '0 4px 12px rgba(45,106,106,0.3)'}}>
                                                                            ‚¨áÔ∏è Check-in {canCheckIn.length} Room{canCheckIn.length > 1 ? 's' : ''}
                                                                        </button>
                                                                    )}
                                                                    {blocked.length > 0 && (
                                                                        <div style={{padding: '10px 16px', background: 'rgba(212,168,83,0.2)', borderRadius: '8px', color: '#D4A853', fontSize: '12px', fontWeight: '600'}}>
                                                                            ‚ö†Ô∏è {blocked.length} room{blocked.length > 1 ? 's need' : ' needs'} checkout first
                                                                        </div>
                                                                    )}
                                                                </>
                                                            );
                                                        })()}
                                                        {allTodayCheckedIn && (
                                                            <div style={{padding: '10px 16px', background: 'rgba(34,197,94,0.2)', borderRadius: '8px', color: '#22c55e', fontSize: '13px', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '6px'}}>
                                                                ‚úì All rooms checked in
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}
                            
                            {guestGroups.length === 0 && (
                                <div style={{textAlign: 'center', padding: '40px', color: 'rgba(255,255,255,0.4)'}}>
                                    <div style={{fontSize: '48px', marginBottom: '12px'}}>üë•</div>
                                    <div style={{fontSize: '16px', fontWeight: '600', marginBottom: '8px'}}>No Group Check-ins Today</div>
                                    <div style={{fontSize: '13px'}}>Group bookings checking in today will appear here</div>
                                </div>
                            )}
                        </div>
                    )}
                    
                    {/* Floor/Category View */}
                    {todayViewBy !== 'group' && groups.map(group => {
                        if (!group.rooms.length) return null;
                        const groupOcc = group.rooms.filter(({room, unit}) => {
                            const rs = getRoomStatus(room.id, unit.id, today);
                            return rs.status !== "AVAILABLE" && rs.status !== "CHECKOUT_DONE";
                        }).length;
                        return (
                            <div key={group.key} className="today-group">
                                <div style={{textAlign: 'center', marginBottom: '12px'}}>
                                    <div className="floor-header" style={{display: 'inline-flex'}}>
                                        <span style={{fontWeight: 600}}>{group.title}</span>
                                        <span style={{color: '#2D6A6A', fontSize: 13}}>{group.rooms.length - groupOcc} free</span>
                                        <span style={{color: '#ef4444', fontSize: 13}}>{groupOcc} occupied</span>
                                    </div>
                                </div>
                                <div style={{display: 'flex', flexWrap: 'wrap', gap: '10px', justifyContent: 'center'}}>
                                    {group.rooms.map(({room, unit}) => {
                                        // Use unified room status
                                        const rs = getRoomStatus(room.id, unit.id, today);
                                        const {status, statusText, displayGuest, checkout, checkin, isCheckedOut, isCheckedIn, isTurnover, checkoutRequired} = rs;
                                        
                                        const unitKey = `${room.id}-${unit.id}`;
                                        const isSelected = selected.some(s => s.unitKey === unitKey);
                                        const isOccupied = status !== "AVAILABLE" && status !== "CHECKOUT_DONE";
                                        
                                        // Determine card background based on unified status
                                        const getCardBg = () => {
                                            if (isSelected) return 'linear-gradient(145deg, #f59e0b, #d97706)';
                                            if (status === "AVAILABLE" || status === "CHECKOUT_DONE") return 'linear-gradient(145deg, #2D6A6A, #245858)';
                                            if (status === "TURNOVER_READY" || status === "ARRIVING") return 'linear-gradient(145deg, #10b981, #059669)';
                                            if (status === "TURNOVER_PENDING" || status === "CHECKOUT_PENDING") return 'linear-gradient(145deg, #D4A853, #B8942F)';
                                            return 'linear-gradient(145deg, #ef4444, #dc2626)';
                                        };
                                        
                                        // Get final status text
                                        const getFinalStatusText = () => {
                                            if (isSelected) return 'SELECTED';
                                            return statusText;
                                        };
                                        
                                        return (
                                            <div key={unitKey} 
                                                onClick={() => handleUnitClick(room, unit, displayGuest, checkout, checkin)} 
                                                style={{
                                                    background: getCardBg(),
                                                    borderRadius: '12px', 
                                                    padding: '12px 16px', 
                                                    cursor: 'pointer', 
                                                    textAlign: 'center',
                                                    minWidth: '90px',
                                                    position: 'relative',
                                                    border: isTurnover ? '3px solid #a855f7' : checkin ? '2px solid #2D6A6A' : checkout ? '2px solid #D4A853' : isSelected ? '2px solid #fff' : '2px solid transparent',
                                                    boxShadow: isSelected ? '0 0 15px rgba(245,158,11,0.5)' : isTurnover ? '0 0 15px rgba(168,85,247,0.4)' : 'none',
                                                    transition: 'all 0.2s ease'
                                                }}>
                                                {/* Check-in/out badges */}
                                                {(checkin || checkout) && (
                                                    <div style={{display: 'flex', gap: '4px', justifyContent: 'center', marginBottom: '6px'}}>
                                                        {checkout && (
                                                            <div style={{background: isCheckedOut ? '#22c55e' : '#D4A853', borderRadius: '4px', padding: '2px 6px', fontSize: '9px', fontWeight: '700'}}>
                                                                {isCheckedOut ? '‚úì OUT' : 'OUT'}
                                                            </div>
                                                        )}
                                                        {checkin && (
                                                            <div style={{background: isCheckedIn ? '#22c55e' : '#2D6A6A', borderRadius: '4px', padding: '2px 6px', fontSize: '9px', fontWeight: '700'}}>
                                                                {isCheckedIn ? '‚úì IN' : 'IN'}
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                                {isTurnover && (
                                                    <div style={{position: 'absolute', top: '-8px', right: '-8px', background: '#a855f7', borderRadius: '50%', width: '20px', height: '20px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '10px', fontWeight: '700', boxShadow: '0 2px 8px rgba(168,85,247,0.5)'}}>2</div>
                                                )}
                                                {/* Status indicator */}
                                                {isCheckedIn && !isTurnover && (
                                                    <div style={{position: 'absolute', top: '-8px', right: '-8px', background: '#22c55e', borderRadius: '50%', width: '20px', height: '20px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '12px', fontWeight: '700', boxShadow: '0 2px 8px rgba(34,197,94,0.5)'}}>‚úì</div>
                                                )}
                                                <div style={{fontSize: '24px', fontWeight: '700'}}>{unit.n}</div>
                                                <div style={{fontSize: '10px', fontWeight: '600', marginTop: '2px', opacity: 0.9}}>
                                                    {getFinalStatusText()}
                                                </div>
                                                {displayGuest && <div style={{fontSize: '11px', marginTop: '4px', fontWeight: '500'}}>{displayGuest.firstName}</div>}
                                                {!isOccupied && !isSelected && <div style={{fontSize: '9px', marginTop: '4px', opacity: 0.7}}>Click to book</div>}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        );
                    })}
                </div>
                
                {/* Dual Guest Modal - Check-in + Check-out same day */}
                {dualGuestModal && (
                    <div className="modal-overlay" onClick={() => setDualGuestModal(null)}>
                        <div className="modal" onClick={e => e.stopPropagation()} style={{maxWidth: '700px', padding: '0', overflow: 'hidden'}}>
                            {/* Header */}
                            <div style={{background: 'linear-gradient(135deg, #a855f7 0%, #7c3aed 100%)', padding: '20px 24px', display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                <div>
                                    <h3 style={{fontSize: '20px', fontWeight: '700', margin: 0}}>üîÑ Room {dualGuestModal.unit.n} - Same Day Turnover</h3>
                                    <p style={{fontSize: '13px', opacity: 0.9, margin: '4px 0 0'}}>{dualGuestModal.room.name} ‚Ä¢ {formatDate(today)}</p>
                                </div>
                                <button onClick={() => setDualGuestModal(null)} style={{background: 'rgba(255,255,255,0.2)', border: 'none', borderRadius: '8px', width: '36px', height: '36px', color: '#fff', fontSize: '20px', cursor: 'pointer'}}>√ó</button>
                            </div>
                            
                            {/* Two Guest Cards Side by Side */}
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0'}}>
                                {/* Check-OUT Guest (Left) */}
                                <div style={{padding: '20px', background: 'linear-gradient(180deg, rgba(212,168,83,0.15) 0%, rgba(212,168,83,0.05) 100%)', borderRight: '1px solid rgba(255,255,255,0.1)'}}>
                                    <div style={{display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '16px'}}>
                                        <div style={{background: '#D4A853', borderRadius: '8px', padding: '6px 12px', fontSize: '12px', fontWeight: '700'}}>‚¨ÜÔ∏è CHECK-OUT</div>
                                    </div>
                                    <div style={{display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '16px'}}>
                                        <div style={{width: '50px', height: '50px', background: 'linear-gradient(135deg, #D4A853, #B8942F)', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '20px'}}>üë§</div>
                                        <div>
                                            <div style={{fontSize: '18px', fontWeight: '700'}}>{dualGuestModal.checkOut.firstName} {dualGuestModal.checkOut.lastName}</div>
                                            <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.6)'}}>üìû {dualGuestModal.checkOut.mobile || 'N/A'}</div>
                                        </div>
                                    </div>
                                    <div style={{background: 'rgba(0,0,0,0.2)', borderRadius: '10px', padding: '12px', marginBottom: '12px'}}>
                                        <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '8px'}}>
                                            <span style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)'}}>Arrived</span>
                                            <span style={{fontSize: '13px', fontWeight: '600'}}>{formatDate(dualGuestModal.checkOut.arrival)}</span>
                                        </div>
                                        <div style={{display: 'flex', justifyContent: 'space-between'}}>
                                            <span style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)'}}>Leaving</span>
                                            <span style={{fontSize: '13px', fontWeight: '600', color: '#D4A853'}}>{formatDate(dualGuestModal.checkOut.departure)}</span>
                                        </div>
                                    </div>
                                    <div style={{display: 'flex', justifyContent: 'space-between', padding: '10px', background: 'rgba(212,168,83,0.1)', borderRadius: '8px', marginBottom: '12px'}}>
                                        <span style={{fontSize: '12px'}}>Due Amount</span>
                                        <span style={{fontSize: '16px', fontWeight: '700', color: (parseFloat(dualGuestModal.checkOut.price) - parseFloat(dualGuestModal.checkOut.deposit)) > 0 ? '#ef4444' : '#22c55e'}}>
                                            ‡ß≥{((parseFloat(dualGuestModal.checkOut.price) || 0) - (parseFloat(dualGuestModal.checkOut.deposit) || 0)).toLocaleString()}
                                        </span>
                                    </div>
                                    <button onClick={() => {setDualGuestModal(null); setShowInfoModal(dualGuestModal.checkOut);}} style={{width: '100%', padding: '12px', background: 'rgba(212,168,83,0.2)', border: '1px solid #D4A853', borderRadius: '8px', color: '#D4A853', fontWeight: '600', cursor: 'pointer'}}>View Full Details</button>
                                </div>
                                
                                {/* Check-IN Guest (Right) */}
                                <div style={{padding: '20px', background: 'linear-gradient(180deg, rgba(45,106,106,0.15) 0%, rgba(45,106,106,0.05) 100%)'}}>
                                    <div style={{display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '16px'}}>
                                        <div style={{background: '#2D6A6A', borderRadius: '8px', padding: '6px 12px', fontSize: '12px', fontWeight: '700'}}>‚¨áÔ∏è CHECK-IN</div>
                                    </div>
                                    <div style={{display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '16px'}}>
                                        <div style={{width: '50px', height: '50px', background: 'linear-gradient(135deg, #2D6A6A, #245858)', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '20px'}}>üë§</div>
                                        <div>
                                            <div style={{fontSize: '18px', fontWeight: '700'}}>{dualGuestModal.checkIn.firstName} {dualGuestModal.checkIn.lastName}</div>
                                            <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.6)'}}>üìû {dualGuestModal.checkIn.mobile || 'N/A'}</div>
                                        </div>
                                    </div>
                                    <div style={{background: 'rgba(0,0,0,0.2)', borderRadius: '10px', padding: '12px', marginBottom: '12px'}}>
                                        <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '8px'}}>
                                            <span style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)'}}>Arriving</span>
                                            <span style={{fontSize: '13px', fontWeight: '600', color: '#2D6A6A'}}>{formatDate(dualGuestModal.checkIn.arrival)}</span>
                                        </div>
                                        <div style={{display: 'flex', justifyContent: 'space-between'}}>
                                            <span style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)'}}>Departing</span>
                                            <span style={{fontSize: '13px', fontWeight: '600'}}>{formatDate(dualGuestModal.checkIn.departure)}</span>
                                        </div>
                                    </div>
                                    <div style={{display: 'flex', justifyContent: 'space-between', padding: '10px', background: 'rgba(45,106,106,0.1)', borderRadius: '8px', marginBottom: '12px'}}>
                                        <span style={{fontSize: '12px'}}>Total Amount</span>
                                        <span style={{fontSize: '16px', fontWeight: '700'}}>‡ß≥{(parseFloat(dualGuestModal.checkIn.price) || 0).toLocaleString()}</span>
                                    </div>
                                    <button onClick={() => {setDualGuestModal(null); setShowInfoModal(dualGuestModal.checkIn);}} style={{width: '100%', padding: '12px', background: 'rgba(45,106,106,0.2)', border: '1px solid #2D6A6A', borderRadius: '8px', color: '#2D6A6A', fontWeight: '600', cursor: 'pointer'}}>View Full Details</button>
                                </div>
                            </div>
                            
                            {/* Warning message if checkout not done */}
                            {checkStatus[dualGuestModal.checkOut.id] !== "checkedout" && (
                                <div style={{padding: '12px 24px', background: 'rgba(245,158,11,0.15)', borderTop: '1px solid rgba(245,158,11,0.3)'}}>
                                    <div style={{display: 'flex', alignItems: 'center', gap: '10px', color: '#f59e0b', fontSize: '13px'}}>
                                        <span style={{fontSize: '18px'}}>‚ö†Ô∏è</span>
                                        <span><strong>Checkout Required First:</strong> Please complete the checkout for {dualGuestModal.checkOut.firstName} before checking in {dualGuestModal.checkIn.firstName}</span>
                                    </div>
                                </div>
                            )}
                            
                            {/* Footer Actions */}
                            <div style={{padding: '16px 24px', background: 'rgba(0,0,0,0.2)', display: 'flex', gap: '12px', justifyContent: 'center'}}>
                                <button onClick={() => {toggle(dualGuestModal.checkOut.id, "out");}} style={{padding: '12px 24px', background: checkStatus[dualGuestModal.checkOut.id] === "checkedout" ? 'linear-gradient(135deg, #22c55e, #16a34a)' : 'linear-gradient(135deg, #D4A853, #B8942F)', border: 'none', borderRadius: '8px', color: '#fff', fontWeight: '600', cursor: 'pointer', boxShadow: checkStatus[dualGuestModal.checkOut.id] !== "checkedout" ? '0 0 15px rgba(212,168,83,0.4)' : 'none'}}>
                                    {checkStatus[dualGuestModal.checkOut.id] === "checkedout" ? '‚Ü© Undo Check-Out' : '‚¨ÜÔ∏è Mark Check-Out'}
                                </button>
                                <button 
                                    onClick={() => {
                                        if (checkStatus[dualGuestModal.checkOut.id] !== "checkedout") {
                                            alert(`‚ö†Ô∏è Checkout Required First!\n\nPlease checkout ${dualGuestModal.checkOut.firstName} ${dualGuestModal.checkOut.lastName} before checking in the new guest.\n\nRoom must be vacated and cleaned before the next guest can check in.`);
                                            return;
                                        }
                                        toggle(dualGuestModal.checkIn.id, "in");
                                    }} 
                                    style={{
                                        padding: '12px 24px', 
                                        background: checkStatus[dualGuestModal.checkIn.id] === "checkedin" 
                                            ? 'linear-gradient(135deg, #22c55e, #16a34a)' 
                                            : checkStatus[dualGuestModal.checkOut.id] !== "checkedout"
                                                ? 'rgba(100,100,100,0.3)'
                                                : 'linear-gradient(135deg, #2D6A6A, #245858)', 
                                        border: 'none', 
                                        borderRadius: '8px', 
                                        color: checkStatus[dualGuestModal.checkOut.id] !== "checkedout" ? 'rgba(255,255,255,0.5)' : '#fff', 
                                        fontWeight: '600', 
                                        cursor: checkStatus[dualGuestModal.checkOut.id] !== "checkedout" ? 'not-allowed' : 'pointer',
                                        opacity: checkStatus[dualGuestModal.checkOut.id] !== "checkedout" && checkStatus[dualGuestModal.checkIn.id] !== "checkedin" ? 0.6 : 1
                                    }}>
                                    {checkStatus[dualGuestModal.checkIn.id] === "checkedin" ? '‚Ü© Undo Check-In' : '‚¨áÔ∏è Mark Check-In'}
                                </button>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
    };

    return (
        <div style={{minHeight: '100vh', paddingBottom: '100px'}}>
            {/* Login Modal */}
            {showLoginModal && (
                <div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.8)',zIndex:9999,display:'flex',alignItems:'center',justifyContent:'center'}}>
                    <div style={{background:'#1E293B',borderRadius:'16px',padding:'30px',width:'360px',border:'1px solid rgba(255,255,255,0.1)'}}>
                        <h2 style={{fontSize:'20px',fontWeight:'700',marginBottom:'20px',textAlign:'center'}}>üè® Staff Login</h2>
                        {loginError && <div style={{padding:'12px',background:'rgba(239,68,68,0.2)',borderRadius:'8px',color:'#ef4444',marginBottom:'16px',fontSize:'13px'}}>{loginError}</div>}
                        <input id="login-user" type="text" placeholder="Username" style={{width:'100%',padding:'14px',background:'rgba(255,255,255,0.08)',border:'1px solid rgba(255,255,255,0.15)',borderRadius:'8px',color:'#fff',marginBottom:'12px',boxSizing:'border-box'}}/>
                        <input id="login-pass" type="password" placeholder="Password" style={{width:'100%',padding:'14px',background:'rgba(255,255,255,0.08)',border:'1px solid rgba(255,255,255,0.15)',borderRadius:'8px',color:'#fff',marginBottom:'16px',boxSizing:'border-box'}}/>
                        <button onClick={function(){handleLogin(document.getElementById('login-user').value,document.getElementById('login-pass').value);}} disabled={loginLoading} style={{width:'100%',padding:'14px',background:'linear-gradient(135deg,#2D6A6A,#245858)',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'700',cursor:'pointer',opacity:loginLoading?0.7:1}}>{loginLoading?'Logging in...':'Login'}</button>
                        <button onClick={function(){setShowLoginModal(false);}} style={{width:'100%',padding:'10px',background:'transparent',border:'none',color:'rgba(255,255,255,0.5)',cursor:'pointer',marginTop:'10px'}}>Cancel</button>
                    </div>
                </div>
            )}
            
            {/* System Admin Panel */}
            {showSystemAdmin && (
                <div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'#0f172a',zIndex:9998,overflow:'auto'}}>
                    <div style={{maxWidth:'1200px',margin:'0 auto',padding:'20px'}}>
                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'30px'}}>
                            <h1 style={{fontSize:'24px',fontWeight:'700',color:'#D4A853'}}>üîê System Admin Panel</h1>
                            <button onClick={function(){setShowSystemAdmin(false);}} style={{padding:'10px 20px',background:'rgba(255,255,255,0.1)',border:'none',borderRadius:'8px',color:'#fff',cursor:'pointer'}}>‚úï Close</button>
                        </div>
                        
                        {!sysAdminToken ? (
                            <div style={{maxWidth:'400px',margin:'80px auto',background:'rgba(255,255,255,0.05)',borderRadius:'16px',padding:'30px',border:'1px solid rgba(212,168,83,0.3)'}}>
                                <h2 style={{fontSize:'20px',marginBottom:'20px',textAlign:'center',color:'#D4A853'}}>System Admin Login</h2>
                                {!sysAdminOtpSent ? (
                                    <div>
                                        <input type="email" placeholder="Email address" value={sysAdminEmail} onChange={function(e){setSysAdminEmail(e.target.value);}} style={{width:'100%',padding:'14px',background:'rgba(255,255,255,0.08)',border:'1px solid rgba(255,255,255,0.15)',borderRadius:'8px',color:'#fff',marginBottom:'16px',boxSizing:'border-box'}}/>
                                        <button onClick={requestSysAdminOtp} style={{width:'100%',padding:'14px',background:'linear-gradient(135deg,#D4A853,#b8924a)',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'700',cursor:'pointer'}}>Request OTP</button>
                                        <p style={{fontSize:'12px',color:'rgba(255,255,255,0.4)',marginTop:'12px',textAlign:'center'}}>OTP will be sent to your email</p>
                                    </div>
                                ) : (
                                    <div>
                                        <p style={{fontSize:'13px',color:'rgba(255,255,255,0.6)',marginBottom:'16px',textAlign:'center'}}>OTP sent to {sysAdminEmail}</p>
                                        <input type="text" placeholder="Enter 6-digit OTP" value={sysAdminOtp} onChange={function(e){setSysAdminOtp(e.target.value);}} maxLength={6} style={{width:'100%',padding:'14px',background:'rgba(255,255,255,0.08)',border:'1px solid rgba(255,255,255,0.15)',borderRadius:'8px',color:'#fff',marginBottom:'16px',boxSizing:'border-box',textAlign:'center',fontSize:'24px',letterSpacing:'8px'}}/>
                                        <button onClick={verifySysAdminOtp} style={{width:'100%',padding:'14px',background:'linear-gradient(135deg,#22c55e,#16a34a)',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'700',cursor:'pointer'}}>Verify OTP</button>
                                        <button onClick={function(){setSysAdminOtpSent(false);}} style={{width:'100%',padding:'10px',background:'transparent',border:'none',color:'rgba(255,255,255,0.5)',cursor:'pointer',marginTop:'10px'}}>‚Üê Back</button>
                                    </div>
                                )}
                            </div>
                        ) : (
                            <div>
                                <div style={{display:'flex',gap:'12px',marginBottom:'20px',flexWrap:'wrap'}}>
                                    <button onClick={function(){setSysAdminTab('users');}} style={{padding:'12px 24px',borderRadius:'10px',border:sysAdminTab==='users'?'2px solid #D4A853':'1px solid rgba(255,255,255,0.15)',background:sysAdminTab==='users'?'rgba(212,168,83,0.2)':'transparent',color:sysAdminTab==='users'?'#D4A853':'rgba(255,255,255,0.6)',fontWeight:'600',cursor:'pointer'}}>üë• Users</button>
                                    <button onClick={function(){setSysAdminTab('sessions');}} style={{padding:'12px 24px',borderRadius:'10px',border:sysAdminTab==='sessions'?'2px solid #D4A853':'1px solid rgba(255,255,255,0.15)',background:sysAdminTab==='sessions'?'rgba(212,168,83,0.2)':'transparent',color:sysAdminTab==='sessions'?'#D4A853':'rgba(255,255,255,0.6)',fontWeight:'600',cursor:'pointer'}}>üîó Sessions</button>
                                    <button onClick={function(){setSysAdminTab('settings');}} style={{padding:'12px 24px',borderRadius:'10px',border:sysAdminTab==='settings'?'2px solid #D4A853':'1px solid rgba(255,255,255,0.15)',background:sysAdminTab==='settings'?'rgba(212,168,83,0.2)':'transparent',color:sysAdminTab==='settings'?'#D4A853':'rgba(255,255,255,0.6)',fontWeight:'600',cursor:'pointer'}}>‚öôÔ∏è Settings</button>
                                    <button onClick={sysAdminLogout} style={{marginLeft:'auto',padding:'12px 24px',background:'rgba(239,68,68,0.2)',border:'1px solid rgba(239,68,68,0.4)',borderRadius:'10px',color:'#ef4444',cursor:'pointer'}}>Logout</button>
                                </div>
                                
                                {sysAdminTab === 'users' && (
                                    <div>
                                        <div style={{background:'rgba(255,255,255,0.03)',borderRadius:'16px',padding:'20px',marginBottom:'20px',border:'1px solid rgba(255,255,255,0.08)'}}>
                                            <h3 style={{fontSize:'16px',fontWeight:'600',marginBottom:'16px',color:'#22c55e'}}>‚ûï Create New User</h3>
                                            <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(180px,1fr))',gap:'12px'}}>
                                                <input placeholder="Username *" value={newUserForm.username} onChange={function(e){setNewUserForm({...newUserForm,username:e.target.value});}} style={{padding:'12px',background:'rgba(255,255,255,0.08)',border:'1px solid rgba(255,255,255,0.15)',borderRadius:'8px',color:'#fff'}}/>
                                                <input type="password" placeholder="Password *" value={newUserForm.password} onChange={function(e){setNewUserForm({...newUserForm,password:e.target.value});}} style={{padding:'12px',background:'rgba(255,255,255,0.08)',border:'1px solid rgba(255,255,255,0.15)',borderRadius:'8px',color:'#fff'}}/>
                                                <select value={newUserForm.role} onChange={function(e){setNewUserForm({...newUserForm,role:e.target.value});}} style={{padding:'12px',background:'rgba(255,255,255,0.08)',border:'1px solid rgba(255,255,255,0.15)',borderRadius:'8px',color:'#fff'}}>
                                                    <option value="admin">Admin (Full Access)</option>
                                                    <option value="front_desk">Front Desk</option>
                                                    <option value="hk_manager">H/K Manager</option>
                                                    <option value="hk_team">H/K Team</option>
                                                    <option value="accounting">Accounting</option>
                                                </select>
                                                <input placeholder="Full Name" value={newUserForm.name} onChange={function(e){setNewUserForm({...newUserForm,name:e.target.value});}} style={{padding:'12px',background:'rgba(255,255,255,0.08)',border:'1px solid rgba(255,255,255,0.15)',borderRadius:'8px',color:'#fff'}}/>
                                                <input placeholder="Email" value={newUserForm.email} onChange={function(e){setNewUserForm({...newUserForm,email:e.target.value});}} style={{padding:'12px',background:'rgba(255,255,255,0.08)',border:'1px solid rgba(255,255,255,0.15)',borderRadius:'8px',color:'#fff'}}/>
                                                <button onClick={createUser} style={{padding:'12px 24px',background:'linear-gradient(135deg,#22c55e,#16a34a)',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'700',cursor:'pointer'}}>Create User</button>
                                            </div>
                                        </div>
                                        <h3 style={{fontSize:'16px',fontWeight:'600',marginBottom:'12px'}}>üë• Existing Users ({sysAdminUsers.length})</h3>
                                        <div style={{display:'grid',gap:'12px'}}>
                                            {sysAdminUsers.map(function(user){return (
                                                <div key={user.id} style={{display:'flex',alignItems:'center',gap:'16px',padding:'16px',background:'rgba(255,255,255,0.03)',borderRadius:'12px',border:'1px solid rgba(255,255,255,0.08)',flexWrap:'wrap'}}>
                                                    <div style={{flex:1,minWidth:'200px'}}>
                                                        <div style={{display:'flex',alignItems:'center',gap:'10px',marginBottom:'4px',flexWrap:'wrap'}}>
                                                            <span style={{fontWeight:'600'}}>{user.name || user.username}</span>
                                                            <span style={{padding:'4px 10px',borderRadius:'12px',fontSize:'11px',background:user.role==='admin'?'rgba(212,168,83,0.2)':'rgba(45,106,106,0.2)',color:user.role==='admin'?'#D4A853':'#2D6A6A'}}>{user.role.replace('_',' ')}</span>
                                                            {!user.active && <span style={{padding:'4px 10px',borderRadius:'12px',fontSize:'11px',background:'rgba(239,68,68,0.2)',color:'#ef4444'}}>Disabled</span>}
                                                        </div>
                                                        <div style={{fontSize:'12px',color:'rgba(255,255,255,0.5)'}}>@{user.username}</div>
                                                    </div>
                                                    <button onClick={function(){toggleUserActive(user);}} style={{padding:'8px 16px',background:user.active?'rgba(249,115,22,0.2)':'rgba(34,197,94,0.2)',border:'none',borderRadius:'8px',color:user.active?'#f97316':'#22c55e',cursor:'pointer',fontSize:'12px'}}>{user.active?'Disable':'Enable'}</button>
                                                    <button onClick={function(){deleteUser(user.id);}} style={{padding:'8px 16px',background:'rgba(239,68,68,0.2)',border:'none',borderRadius:'8px',color:'#ef4444',cursor:'pointer',fontSize:'12px'}}>Delete</button>
                                                </div>
                                            );})}
                                        </div>
                                    </div>
                                )}
                                
                                {sysAdminTab === 'sessions' && (
                                    <div>
                                        <h3 style={{fontSize:'16px',fontWeight:'600',marginBottom:'12px'}}>üîó Active Sessions ({sysAdminSessions.length})</h3>
                                        <div style={{display:'grid',gap:'12px'}}>
                                            {sysAdminSessions.map(function(session){return (
                                                <div key={session.id} style={{display:'flex',alignItems:'center',gap:'16px',padding:'16px',background:'rgba(255,255,255,0.03)',borderRadius:'12px',border:'1px solid rgba(255,255,255,0.08)',flexWrap:'wrap'}}>
                                                    <div style={{flex:1,minWidth:'200px'}}>
                                                        <div style={{fontWeight:'600',marginBottom:'4px'}}>{session.name || session.username || session.userId}</div>
                                                        <div style={{fontSize:'12px',color:'rgba(255,255,255,0.5)'}}>Role: {session.role}</div>
                                                    </div>
                                                    {session.role !== 'system_admin' && <button onClick={function(){forceLogoutSession(session.id);}} style={{padding:'8px 16px',background:'rgba(239,68,68,0.2)',border:'none',borderRadius:'8px',color:'#ef4444',cursor:'pointer',fontSize:'12px'}}>Force Logout</button>}
                                                </div>
                                            );})}
                                        </div>
                                    </div>
                                )}
                                
                                {sysAdminTab === 'settings' && (
                                    <div>
                                        <div style={{background:sysAdminSettings.killSwitch?'rgba(239,68,68,0.2)':'rgba(255,255,255,0.03)',borderRadius:'16px',padding:'24px',border:sysAdminSettings.killSwitch?'2px solid rgba(239,68,68,0.5)':'1px solid rgba(255,255,255,0.08)'}}>
                                            <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',flexWrap:'wrap',gap:'16px'}}>
                                                <div>
                                                    <h3 style={{fontSize:'18px',fontWeight:'700',marginBottom:'8px',color:sysAdminSettings.killSwitch?'#ef4444':'#fff'}}>üö® Kill Switch</h3>
                                                    <p style={{fontSize:'13px',color:'rgba(255,255,255,0.5)'}}>When enabled, ALL data becomes invisible to all users.</p>
                                                </div>
                                                <button onClick={toggleKillSwitch} style={{padding:'16px 32px',background:sysAdminSettings.killSwitch?'linear-gradient(135deg,#22c55e,#16a34a)':'linear-gradient(135deg,#ef4444,#dc2626)',border:'none',borderRadius:'12px',color:'#fff',fontWeight:'700',cursor:'pointer',fontSize:'16px'}}>{sysAdminSettings.killSwitch?'üîì Deactivate':'üîí Activate'}</button>
                                            </div>
                                            {sysAdminSettings.killSwitch && <div style={{marginTop:'16px',padding:'12px',background:'rgba(239,68,68,0.2)',borderRadius:'8px',color:'#ef4444',fontSize:'14px',fontWeight:'600'}}>‚ö†Ô∏è KILL SWITCH IS ACTIVE</div>}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            )}
            
            {/* Login Required */}
            {!currentUser && !showSystemAdmin && (
                <div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'linear-gradient(135deg,#0f172a,#1E293B)',zIndex:9000,display:'flex',alignItems:'center',justifyContent:'center',flexDirection:'column'}}>
                    <div style={{textAlign:'center',marginBottom:'40px'}}>
                        <div style={{fontSize:'64px',marginBottom:'20px'}}>üè®</div>
                        <h1 style={{fontSize:'32px',fontWeight:'700',color:'#D4A853',marginBottom:'8px'}}>Miami Beach Resort</h1>
                        <p style={{color:'rgba(255,255,255,0.5)',fontSize:'14px'}}>Front Desk Management System</p>
                    </div>
                    <div style={{background:'rgba(255,255,255,0.05)',borderRadius:'20px',padding:'40px',width:'380px',border:'1px solid rgba(255,255,255,0.1)'}}>
                        <h2 style={{fontSize:'20px',fontWeight:'600',marginBottom:'24px',textAlign:'center',color:'#fff'}}>Staff Login</h2>
                        {loginError && <div style={{padding:'12px',background:'rgba(239,68,68,0.2)',borderRadius:'8px',color:'#ef4444',marginBottom:'16px',fontSize:'13px',textAlign:'center'}}>{loginError}</div>}
                        <input id="main-login-user" type="text" placeholder="Username" style={{width:'100%',padding:'16px',background:'rgba(255,255,255,0.08)',border:'1px solid rgba(255,255,255,0.15)',borderRadius:'10px',color:'#fff',marginBottom:'14px',boxSizing:'border-box',fontSize:'15px'}}/>
                        <input id="main-login-pass" type="password" placeholder="Password" style={{width:'100%',padding:'16px',background:'rgba(255,255,255,0.08)',border:'1px solid rgba(255,255,255,0.15)',borderRadius:'10px',color:'#fff',marginBottom:'20px',boxSizing:'border-box',fontSize:'15px'}}/>
                        <button onClick={function(){handleLogin(document.getElementById('main-login-user').value,document.getElementById('main-login-pass').value);}} disabled={loginLoading} style={{width:'100%',padding:'16px',background:'linear-gradient(135deg,#2D6A6A,#245858)',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'700',cursor:'pointer',fontSize:'16px'}}>{loginLoading ? 'Logging in...' : 'Login'}</button>
                        <div style={{marginTop:'20px',paddingTop:'20px',borderTop:'1px solid rgba(255,255,255,0.1)',textAlign:'center'}}>
                            <button onClick={function(){setShowSystemAdmin(true);}} style={{background:'none',border:'none',color:'rgba(255,255,255,0.4)',cursor:'pointer',fontSize:'12px'}}>üîê System Admin Access</button>
                        </div>
                    </div>
                </div>
            )}
            
            {/* Top Bar - Always Sticky */}
            <div className="top-bar">
                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '10px'}}>
                    <div>
                        <h1 style={{fontSize: '18px', fontWeight: '700'}}>üè® Miami Beach Resort</h1>
                        <p style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', marginTop: '2px'}}>Cox's Bazar ‚Ä¢ {formatDate(today)}, {time} <span style={{background: 'rgba(45,106,106,0.3)', padding: '2px 6px', borderRadius: '4px', marginLeft: '6px', fontSize: '10px', color: '#2D6A6A'}}>Local Time</span></p>
                    </div>
                    <div style={{display: 'flex', gap: '8px', alignItems: 'center'}}>
                        {/* Real-time connection status indicator */}
                        <div style={{
                            display: 'flex', 
                            alignItems: 'center', 
                            gap: '6px', 
                            padding: '6px 12px', 
                            background: realtimeStatus === 'connected' ? 'rgba(34,197,94,0.15)' : realtimeStatus === 'connecting' ? 'rgba(234,179,8,0.15)' : 'rgba(239,68,68,0.15)',
                            border: `1px solid ${realtimeStatus === 'connected' ? 'rgba(34,197,94,0.4)' : realtimeStatus === 'connecting' ? 'rgba(234,179,8,0.4)' : 'rgba(239,68,68,0.4)'}`,
                            borderRadius: '8px'
                        }}>
                            <span style={{
                                width: '8px', 
                                height: '8px', 
                                borderRadius: '50%', 
                                background: realtimeStatus === 'connected' ? '#22c55e' : realtimeStatus === 'connecting' ? '#eab308' : '#ef4444',
                                animation: realtimeStatus === 'connected' ? 'pulse-dot 2s ease-in-out infinite' : 'none'
                            }}></span>
                            <span style={{fontSize: '10px', fontWeight: '600', color: realtimeStatus === 'connected' ? '#22c55e' : realtimeStatus === 'connecting' ? '#eab308' : '#ef4444'}}>
                                {realtimeStatus === 'connected' ? '‚óè LIVE' : realtimeStatus === 'connecting' ? '‚óã Connecting...' : '‚úï Offline'}
                            </span>
                        </div>
                        <button className="search-btn" onClick={() => setShowSearchModal(true)}>üîç Search Guest</button>
                        <button onClick={fetchData} disabled={loading} style={{padding: '14px 20px', background: '#2D6A6A', border: 'none', borderRadius: '10px', color: 'white', fontWeight: '600', cursor: 'pointer', fontSize: '14px'}}>{loading ? '‚è≥' : 'üîÑ'}</button>
                        {isEditing && <span style={{fontSize: '11px', color: '#f59e0b', marginLeft: '8px'}}>‚è∏Ô∏è Auto-refresh paused</span>}
                        {currentUser ? (
                            <div style={{display:'flex',alignItems:'center',gap:'8px',marginLeft:'8px'}}>
                                <span style={{fontSize:'11px',color:'rgba(255,255,255,0.6)',background:'rgba(45,106,106,0.3)',padding:'4px 8px',borderRadius:'6px'}}>üë§ {currentUser.name}</span>
                                <button onClick={handleLogout} style={{padding:'8px 12px',background:'rgba(239,68,68,0.2)',border:'1px solid rgba(239,68,68,0.4)',borderRadius:'8px',color:'#ef4444',fontSize:'12px',cursor:'pointer',fontWeight:'600'}}>Logout</button>
                            </div>
                        ) : (
                            <button onClick={function(){setShowLoginModal(true);}} style={{padding:'8px 16px',background:'linear-gradient(135deg,#2D6A6A,#245858)',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'600',cursor:'pointer',fontSize:'12px',marginLeft:'8px'}}>üîê Login</button>
                        )}
                    </div>
                </div>
            </div>
            
            {/* Tabs - Sticky */}
            <div className="tabs-wrapper">
                {isMobile ? (
                    <select value={effectiveTab} onChange={e => setTab(e.target.value)} className="mobile-select" style={{marginBottom: '0', width: '100%', maxWidth: '300px'}}>
                        {tabs.filter(t => canAccessTab(t.id)).map(t => <option key={t.id} value={t.id}>{t.label}</option>)}
                    </select>
                ) : (
                    <div className="tabs-row" style={{marginBottom: '0'}}>{tabs.filter(t => canAccessTab(t.id)).map(t => <button key={t.id} onClick={() => setTab(t.id)} className={`nav-btn ${effectiveTab === t.id ? 'active' : ''}`}>{t.label}</button>)}</div>
                )}
                {effectiveTab === "calendar" && (
                    <>
                        <div className="date-controls" style={{marginTop: '10px'}}>
                            <div onClick={() => calendarDateRef.current?.showPicker()} style={{cursor: 'pointer'}}><input ref={calendarDateRef} type="date" value={startDate} onChange={e => setStartDate(e.target.value)} className="date-input" style={{cursor: 'pointer'}}/></div>
                            <button onClick={() => setStartDate(getBDDate())} className={`day-btn ${startDate === getBDDate() ? 'active' : ''}`}>Today</button>
                            <span style={{color: 'rgba(255,255,255,0.2)'}}>|</span>
                            {[3, 7, 15, 30].map(d => <button key={d} onClick={() => setCalDays(d)} className={`day-btn ${calDays === d ? 'active' : ''}`}>{d}d</button>)}
                        </div>
                        <div className="view-selector" style={{marginTop: '10px', marginBottom: '0'}}>
                            <button className={`view-btn ${calendarViewBy === 'floor' ? 'active' : ''}`} onClick={() => setCalendarViewBy('floor')}>üè¢ By Floor</button>
                            <button className={`view-btn ${calendarViewBy === 'category' ? 'active' : ''}`} onClick={() => setCalendarViewBy('category')}>üìÅ By Category</button>
                        </div>
                    </>
                )}
            </div>

            {error && <div style={{margin: '16px', padding: '12px', background: 'rgba(239,68,68,0.15)', border: '1px solid #ef4444', borderRadius: '8px', color: '#ef4444', fontSize: '13px'}}>{error}</div>}
            {loading && <div style={{display: 'flex', justifyContent: 'center', padding: '50px'}}><div className="loader"></div></div>}

            {!loading && (
                <>
                    {effectiveTab === "today" && <TodayView/>}
                    
                    {effectiveTab === "calendar" && (
                        <CalendarView groupBy={calendarViewBy}/>
                    )}

                    {effectiveTab === "searchbook" && (
                        <div style={{padding: '16px'}}>
                            <h2 style={{fontSize: '18px', fontWeight: '600', marginBottom: '16px', textAlign: 'center'}}>üîç Search & Book</h2>
                            <div className="date-search-row">
                                <div className="date-field" onClick={() => checkinRef.current?.showPicker()}><label>Check-in</label><input ref={checkinRef} type="date" value={searchCheckIn} onChange={handleCheckInChange} className="date-input" style={{cursor: 'pointer'}}/></div>
                                <div className="date-field" onClick={() => checkoutRef.current?.showPicker()}><label>Check-out</label><input ref={checkoutRef} type="date" value={searchCheckOut} min={searchCheckIn} onChange={e => setSearchCheckOut(e.target.value)} className="date-input" style={{cursor: 'pointer'}}/></div>
                                <div className="date-field"><label>Group By</label><select value={searchGroupBy} onChange={e => setSearchGroupBy(e.target.value)} className="group-selector"><option value="floor">By Floor</option><option value="category">By Category</option></select></div>
                            </div>
                            <h3 style={{fontSize: '15px', fontWeight: '600', marginBottom: '12px', color: '#2D6A6A', textAlign: 'center'}}>‚úì Available: {availableRooms.length} rooms</h3>
                            {(() => {
                                const groups = searchGroupBy === "floor"
                                    ? FLOORS.map(f => ({key: f, title: `üè¢ ${floorName(f)} Floor`, rooms: availableRooms.filter(r => r.floor === f)}))
                                    : ROOMS.map(r => ({key: r.id, title: r.name, rooms: availableRooms.filter(ar => ar.room.id === r.id)}));
                                return groups.map(group => {
                                    if (!group.rooms.length) return null;
                                    return (
                                        <div key={group.key} className="today-group">
                                            <div style={{textAlign: 'center', marginBottom: '12px'}}><div className="floor-header" style={{display: 'inline-flex'}}><span style={{fontWeight: 600}}>{group.title}</span><span style={{color: 'rgba(255,255,255,0.5)', fontSize: 13}}>{group.rooms.length} available</span></div></div>
                                            <div style={{display: 'flex', flexWrap: 'wrap', gap: '12px', justifyContent: 'center'}}>
                                                {group.rooms.map(({room, unit}) => {
                                                    const isSelected = selected.find(x => x.unitKey === `${room.id}-${unit.id}`);
                                                    return (
                                                        <div key={`${room.id}-${unit.id}`} onClick={() => {
                                                            const unitKey = `${room.id}-${unit.id}`;
                                                            if (isSelected) setSelected(selected.filter(x => x.unitKey !== unitKey));
                                                            else setSelected([...selected, {unitKey, room, unit, checkIn: searchCheckIn, checkOut: searchCheckOut}]);
                                                        }} style={{background: isSelected ? 'linear-gradient(145deg, #2D6A6A, #245858)' : 'rgba(255,255,255,0.03)', border: isSelected ? '2px solid #fff' : '1px solid rgba(255,255,255,0.1)', borderRadius: '12px', padding: '14px', cursor: 'pointer'}}>
                                                            <div style={{fontSize: '22px', fontWeight: '700'}}>{unit.n}</div>
                                                            <div style={{fontSize: '10px', color: 'rgba(255,255,255,0.5)', marginTop: '4px'}}>{room.short}</div>
                                                            <div style={{fontSize: '10px', color: 'rgba(255,255,255,0.4)'}}>üë§ {room.max}A</div>
                                                            {isSelected && <div style={{marginTop: '6px', fontSize: '10px', fontWeight: '600', color: '#fff'}}>‚úì Selected</div>}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    );
                                });
                            })()}
                            {selected.length > 0 && (
                                <div style={{marginTop: '24px', padding: '16px', background: 'rgba(45,106,106,0.1)', border: '1px solid rgba(45,106,106,0.3)', borderRadius: '12px'}}>
                                    <h4 style={{marginBottom: '12px', textAlign: 'center'}}>Selected: {selected.length} room(s)</h4>
                                    <div style={{display: 'flex', flexDirection: 'column', gap: '8px', marginBottom: '16px'}}>
                                        {selected.map(s => {
                                            const nights = Math.max(1, Math.ceil((new Date(s.checkOut) - new Date(s.checkIn)) / (1000 * 60 * 60 * 24)));
                                            return (
                                                <div key={s.unitKey} style={{display: 'flex', alignItems: 'center', gap: '10px', padding: '10px 14px', background: 'rgba(45,106,106,0.15)', border: '1px solid rgba(45,106,106,0.3)', borderRadius: '10px', flexWrap: 'wrap'}}>
                                                    <span style={{fontSize: '16px', fontWeight: '700', color: '#2D6A6A', minWidth: '40px'}}>{s.unit.n}</span>
                                                    <input type="date" value={s.checkIn} onChange={e => setSelected(selected.map(x => x.unitKey === s.unitKey ? {...x, checkIn: e.target.value} : x))} style={{padding: '6px 10px', background: 'rgba(255,255,255,0.1)', border: '1px solid rgba(255,255,255,0.2)', borderRadius: '6px', color: '#fff', fontSize: '12px'}}/>
                                                    <span style={{color: 'rgba(255,255,255,0.5)'}}>‚Üí</span>
                                                    <input type="date" value={s.checkOut} min={s.checkIn} onChange={e => setSelected(selected.map(x => x.unitKey === s.unitKey ? {...x, checkOut: e.target.value} : x))} style={{padding: '6px 10px', background: 'rgba(255,255,255,0.1)', border: '1px solid rgba(255,255,255,0.2)', borderRadius: '6px', color: '#fff', fontSize: '12px'}}/>
                                                    <span style={{fontSize: '12px', color: 'rgba(255,255,255,0.6)', padding: '4px 8px', background: 'rgba(255,255,255,0.1)', borderRadius: '4px'}}>{nights}N</span>
                                                    <button onClick={() => setSelected(selected.filter(x => x.unitKey !== s.unitKey))} style={{marginLeft: 'auto', background: 'none', border: 'none', color: '#ef4444', cursor: 'pointer', fontSize: '16px', padding: '0 6px'}}>√ó</button>
                                                </div>
                                            );
                                        })}
                                    </div>
                                    <div style={{display: 'flex', gap: '12px', justifyContent: 'center'}}>
                                        <button onClick={() => setShowBookModal(true)} style={{padding: '14px 30px', background: '#2D6A6A', border: 'none', borderRadius: '10px', color: 'white', fontWeight: '700', cursor: 'pointer', fontSize: '15px'}}>üìù Book {selected.length} Room(s)</button>
                                        <button onClick={() => setSelected([])} style={{padding: '14px 20px', background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '10px', color: 'white', cursor: 'pointer'}}>Clear</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {effectiveTab === "requests" && (
                        <div style={{padding: '16px'}}>
                            <h2 style={{fontSize: '18px', fontWeight: '600', marginBottom: '16px'}}>üõéÔ∏è Guest Requests</h2>
                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(320px, 1fr))', gap: '20px'}}>
                                <div>
                                    <h3 style={{fontSize: '14px', fontWeight: '600', marginBottom: '12px', color: '#2D6A6A'}}>üìã Current Guests ({currentGuests.length})</h3>
                                    {currentGuests.map(guest => <GuestRequestCard key={guest.id} guest={guest} onAddRequest={addRequest} requestCounts={getRequestCounts(guest.id)}/>)}
                                    {!currentGuests.length && <div style={{color: 'rgba(255,255,255,0.4)', textAlign: 'center', padding: '20px'}}>No guests</div>}
                                </div>
                                <div>
                                    <h3 style={{fontSize: '14px', fontWeight: '600', marginBottom: '12px', color: '#f59e0b'}}>‚è≥ Pending ({requests.filter(r => !r.done).length})</h3>
                                    {requests.filter(r => !r.done).map(req => (
                                        <div key={req.id} className="request-item request-pending">
                                            <div><div style={{fontWeight: '600'}}>{req.roomNum} - {req.guestName}</div><div style={{fontSize: '12px', color: 'rgba(255,255,255,0.6)'}}>{req.requestType}</div>{req.note && <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.4)'}}>Note: {req.note}</div>}<div style={{fontSize: '10px', color: 'rgba(255,255,255,0.3)', marginTop: '4px'}}>{new Date(req.timestamp).toLocaleTimeString()}</div></div>
                                            <button className="done-btn" onClick={() => markRequestDone(req.id)}>‚úì Done</button>
                                        </div>
                                    ))}
                                    {!requests.filter(r => !r.done).length && <div style={{color: 'rgba(255,255,255,0.4)', padding: '20px', textAlign: 'center'}}>No pending</div>}
                                </div>
                                <div>
                                    <h3 style={{fontSize: '14px', fontWeight: '600', marginBottom: '12px', color: '#2D6A6A'}}>‚úÖ Completed</h3>
                                    {requests.filter(r => r.done).slice(0, 15).map(req => (
                                        <div key={req.id} className="request-item request-done"><div><div style={{fontWeight: '600'}}>{req.roomNum} - {req.requestType}</div><div style={{fontSize: '10px', color: 'rgba(255,255,255,0.4)'}}>Done: {new Date(req.doneAt).toLocaleString()}</div></div><span style={{color: '#2D6A6A'}}>‚úì</span></div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {effectiveTab === "housekeeping" && (() => {
                        const hkDataToday = housekeepingToday;
                        const hkDataTomorrow = housekeepingTomorrow;
                        const pendingReqs = requests.filter(r => !r.done);
                        const todayCompleted = requests.filter(r => r.done && r.doneAt && new Date(r.doneAt).toDateString() === new Date().toDateString());
                        
                        // Calculate priority tasks
                        const getPriorityTasks = () => {
                            const priorities = [];
                            // VIP rooms (placeholder - could check custom field)
                            // Early check-ins (arrivals today)
                            hkDataToday.checkin.filter(c => !c.done).forEach(c => {
                                priorities.push({type: 'checkin', priority: 'high', room: c.unit.n, guest: c.booking.firstName, label: 'Early Check-in', color: '#2D6A6A'});
                            });
                            // Turnovers waiting
                            hkDataToday.turnover.filter(t => !t.outDone).forEach(t => {
                                priorities.push({type: 'turnover', priority: 'urgent', room: t.unit.n, guest: t.out.firstName, label: 'Awaiting Checkout', color: '#f97316'});
                            });
                            // Pending requests
                            pendingReqs.slice(0, 3).forEach(r => {
                                priorities.push({type: 'request', priority: 'medium', room: r.roomNum, guest: r.guestName, label: r.requestType, color: '#f59e0b'});
                            });
                            return priorities.slice(0, 6);
                        };
                        
                        const priorityTasks = getPriorityTasks();
                        
                        // HK Sub-tab categories
                        const hkCategories = [
                            {id: 'workflow', label: 'üßπ Work', tabs: [
                                {id: 'mywork', label: 'üìã My Work', icon: 'üìã'},
                                {id: 'supplies', label: 'üì¶ Supplies', icon: 'üì¶'},
                                {id: 'completed', label: '‚úÖ Completed', icon: '‚úÖ'},
                            ]},
                            {id: 'overview', label: 'üìä Overview', tabs: [
                                {id: 'dashboard', label: 'üìä Dashboard', icon: 'üìä'},
                                {id: 'roomboard', label: 'üó∫Ô∏è Room Board', icon: 'üó∫Ô∏è'},
                            ]},
                            {id: 'other', label: 'üìã Other', tabs: [
                                {id: 'tasks', label: 'üìù Requests', icon: 'üìù'},
                                {id: 'issues', label: 'üõ†Ô∏è Issues', icon: 'üõ†Ô∏è'},
                                {id: 'lostfound', label: 'üîç Lost & Found', icon: 'üîç'},
                            ]},
                        ];
                        
                        // Flatten tabs for easy access
                        const allHkTabs = hkCategories.flatMap(c => c.tabs);
                        
                        return (
                            <div style={{padding: '16px', maxWidth: '1400px', margin: '0 auto'}}>
                                {/* Header */}
                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', flexWrap: 'wrap', gap: '12px'}}>
                                    <div style={{display: 'flex', alignItems: 'center', gap: '16px'}}>
                                        <h2 style={{fontSize: '22px', fontWeight: '700'}}>üßπ Housekeeping</h2>
                                        <div style={{display: 'flex', background: 'rgba(255,255,255,0.08)', borderRadius: '10px', padding: '4px', border: '1px solid rgba(255,255,255,0.1)'}}>
                                            <button onClick={() => setHkMode('staff')} style={{padding: '6px 16px', borderRadius: '8px', border: 'none', background: hkMode === 'staff' ? '#2D6A6A' : 'transparent', color: hkMode === 'staff' ? '#fff' : 'rgba(255,255,255,0.5)', fontWeight: '600', cursor: 'pointer', fontSize: '12px'}}>üë∑ HK Team</button>
                                            {(!currentUser || currentUser.role !== 'hk_team') && <button onClick={() => setHkMode('admin')} style={{padding: '6px 16px', borderRadius: '8px', border: 'none', background: hkMode === 'admin' ? '#D4A853' : 'transparent', color: hkMode === 'admin' ? '#fff' : 'rgba(255,255,255,0.5)', fontWeight: '600', cursor: 'pointer', fontSize: '12px'}}>üìã HK Manager</button>}
                                        </div>
                                    </div>
                                    {hkMode === 'staff' && <div style={{display: 'flex', gap: '8px', alignItems: 'center'}}>
                                        <span style={{fontSize: '13px', color: 'rgba(255,255,255,0.5)'}}>{formatDate(today)}</span>
                                        <div style={{display: 'flex', background: 'rgba(255,255,255,0.05)', borderRadius: '8px', padding: '4px'}}>
                                            <button onClick={() => setHkDay('today')} style={{padding: '8px 16px', borderRadius: '6px', border: 'none', background: hkDay === 'today' ? '#2D6A6A' : 'transparent', color: hkDay === 'today' ? '#fff' : 'rgba(255,255,255,0.6)', fontWeight: '600', cursor: 'pointer', fontSize: '13px'}}>Today</button>
                                            <button onClick={() => setHkDay('tomorrow')} style={{padding: '8px 16px', borderRadius: '6px', border: 'none', background: hkDay === 'tomorrow' ? '#2D6A6A' : 'transparent', color: hkDay === 'tomorrow' ? '#fff' : 'rgba(255,255,255,0.6)', fontWeight: '600', cursor: 'pointer', fontSize: '13px'}}>Tomorrow</button>
                                        </div>
                                    </div>}
                                </div>
                                
                                {/* ========== STAFF MODE ========== */}
                                {hkMode === 'staff' && (<>
                                {/* Sub-tabs Navigation */}
                                <div style={{display: 'flex', gap: '6px', marginBottom: '20px', overflowX: 'auto', paddingBottom: '8px', flexWrap: 'wrap'}}>
                                    {allHkTabs.map(t => (
                                        <button 
                                            key={t.id} 
                                            onClick={() => setHkTab(t.id)} 
                                            style={{
                                                padding: '10px 16px', 
                                                borderRadius: '10px', 
                                                border: hkTab === t.id ? '2px solid #2D6A6A' : '1px solid rgba(255,255,255,0.1)', 
                                                background: hkTab === t.id ? 'rgba(45,106,106,0.2)' : 'rgba(255,255,255,0.03)', 
                                                color: hkTab === t.id ? '#2D6A6A' : 'rgba(255,255,255,0.7)', 
                                                fontWeight: hkTab === t.id ? '700' : '500', 
                                                cursor: 'pointer', 
                                                fontSize: '13px',
                                                whiteSpace: 'nowrap',
                                                transition: 'all 0.2s'
                                            }}
                                        >
                                            {t.label}
                                            {t.id === 'tasks' && pendingReqs.length > 0 && <span style={{background: '#ef4444', padding: '2px 8px', borderRadius: '10px', fontSize: '11px', marginLeft: '6px', color: '#fff'}}>{pendingReqs.length}</span>}
                                        </button>
                                    ))}
                                </div>
                                
                                {/* ==================== DASHBOARD ==================== */}
                                {/* ==================== MY WORK - Main Staff Workflow ==================== */}
                                {hkTab === 'mywork' && (() => {
                                    const todayStr = getBDDate();
                                    
                                    // Get rooms assigned to current floor (based on dailyAssignments)
                                    const getStaffFloors = () => {
                                        const assigns = dailyAssignments[today] || {};
                                        const staffId = hkStaffList.find(s => s.name === currentStaffName)?.id;
                                        if (!staffId) return FLOORS; // Show all if no staff selected
                                        return FLOORS.filter(f => (assigns[f] || []).includes(staffId));
                                    };
                                    
                                    const myFloors = getStaffFloors();
                                    
                                    // Get all rooms that need cleaning on my floors
                                    const getMyRooms = () => {
                                        const rooms = [];
                                        const allData = [...hkDataToday.turnover.map(r => ({...r, type: 'turnover', priority: 1})),
                                                        ...hkDataToday.checkout.map(r => ({...r, type: 'checkout', priority: 2})),
                                                        ...hkDataToday.stayover.map(r => ({...r, type: 'stayover', priority: 3})),
                                                        ...hkDataToday.checkin.map(r => ({...r, type: 'checkin', priority: 4}))];
                                        
                                        allData.forEach(r => {
                                            const roomNum = r.unit?.n || r.roomId;
                                            const floor = Math.floor(parseInt(roomNum) / 100);
                                            if (myFloors.includes(floor.toString()) || myFloors.includes(floor)) {
                                                const completed = completedRooms.find(c => c.roomId === roomNum.toString() && c.date === todayStr);
                                                rooms.push({
                                                    roomId: roomNum.toString(),
                                                    roomType: r.roomType || r.unit?.roomType || 'Standard King',
                                                    floor,
                                                    type: r.type,
                                                    priority: r.priority,
                                                    guestName: r.guestName || r.guest?.firstName || 'Guest',
                                                    occupancy: r.occupancy || r.numAdult || 2,
                                                    checkoutTime: r.checkoutTime,
                                                    checkinTime: r.checkinTime,
                                                    completed: !!completed,
                                                    completedData: completed
                                                });
                                            }
                                        });
                                        
                                        return rooms.sort((a, b) => a.priority - b.priority);
                                    };
                                    
                                    const myRooms = getMyRooms();
                                    const pendingRooms = myRooms.filter(r => !r.completed);
                                    const doneRooms = myRooms.filter(r => r.completed);
                                    
                                    // Get room config for supplies calculation
                                    const getRoomConfig = (roomType) => roomConfigs[roomType] || roomConfigs['Standard King'] || Object.values(roomConfigs)[0];
                                    
                                    // Start cleaning a room
                                    const startCleaning = (room) => {
                                        const checklist = room.type === 'stayover' ? stayoverChecklist : turnoverChecklist;
                                        const progress = cleaningProgress[room.roomId] || { items: checklist.map(item => ({ item, done: false })), startedAt: new Date().toISOString() };
                                        if (!cleaningProgress[room.roomId]) {
                                            saveCleaningProgress({...cleaningProgress, [room.roomId]: progress});
                                        }
                                        setSelectedCleaningRoom({...room, checklist: progress.items, startedAt: progress.startedAt});
                                    };
                                    
                                    // Toggle checklist item
                                    const toggleChecklistItem = (idx) => {
                                        if (!selectedCleaningRoom) return;
                                        const newChecklist = [...selectedCleaningRoom.checklist];
                                        newChecklist[idx].done = !newChecklist[idx].done;
                                        setSelectedCleaningRoom({...selectedCleaningRoom, checklist: newChecklist});
                                        saveCleaningProgress({...cleaningProgress, [selectedCleaningRoom.roomId]: { items: newChecklist, startedAt: selectedCleaningRoom.startedAt }});
                                    };
                                    
                                    // Complete room cleaning
                                    const completeRoom = () => {
                                        if (!selectedCleaningRoom || !currentStaffName) {
                                            alert('Please enter your name first');
                                            return;
                                        }
                                        const allDone = selectedCleaningRoom.checklist.every(i => i.done);
                                        if (!allDone && !confirm('Not all items checked. Complete anyway?')) return;
                                        
                                        const completionRecord = {
                                            roomId: selectedCleaningRoom.roomId,
                                            roomType: selectedCleaningRoom.roomType,
                                            cleanType: selectedCleaningRoom.type,
                                            staffName: currentStaffName,
                                            date: todayStr,
                                            startedAt: selectedCleaningRoom.startedAt,
                                            completedAt: new Date().toISOString(),
                                            checklist: selectedCleaningRoom.checklist
                                        };
                                        
                                        saveCompletedRooms([...completedRooms, completionRecord]);
                                        
                                        // Update room status to Clean
                                        const newStatuses = {...roomStatuses, [selectedCleaningRoom.roomId]: {status: 'clean', updatedAt: new Date().toISOString(), cleanedBy: currentStaffName}};
                                        setRoomStatuses(newStatuses);
                                        localStorage.setItem("miami_room_statuses_v1", JSON.stringify(newStatuses));
                                        
                                        // Clear progress
                                        const newProgress = {...cleaningProgress};
                                        delete newProgress[selectedCleaningRoom.roomId];
                                        saveCleaningProgress(newProgress);
                                        
                                        setSelectedCleaningRoom(null);
                                    };
                                    
                                    const getTypeColor = (type) => {
                                        switch(type) {
                                            case 'turnover': return {bg: 'rgba(249,115,22,0.2)', border: 'rgba(249,115,22,0.4)', color: '#f97316', label: 'üîÑ Turnover'};
                                            case 'checkout': return {bg: 'rgba(212,168,83,0.2)', border: 'rgba(212,168,83,0.4)', color: '#D4A853', label: 'üö™ Checkout'};
                                            case 'stayover': return {bg: 'rgba(14,165,233,0.2)', border: 'rgba(14,165,233,0.4)', color: '#0ea5e9', label: 'üõèÔ∏è Stayover'};
                                            case 'checkin': return {bg: 'rgba(45,106,106,0.2)', border: 'rgba(45,106,106,0.4)', color: '#2D6A6A', label: 'üü¢ Check-in'};
                                            default: return {bg: 'rgba(255,255,255,0.1)', border: 'rgba(255,255,255,0.2)', color: '#fff', label: type};
                                        }
                                    };
                                    
                                    return (
                                        <div style={{background: 'rgba(255,255,255,0.02)', borderRadius: '16px', padding: '20px', border: '1px solid rgba(255,255,255,0.08)'}}>
                                            {/* Staff Name Entry */}
                                            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'20px',flexWrap:'wrap',gap:'12px'}}>
                                                <div>
                                                    <h3 style={{fontSize: '18px', fontWeight: '700', marginBottom: '4px'}}>üìã My Work Today</h3>
                                                    <div style={{fontSize:'12px',color:'rgba(255,255,255,0.5)'}}>Floors: {myFloors.length > 0 ? myFloors.join(', ') : 'All'}</div>
                                                </div>
                                                <div style={{display:'flex',gap:'8px',alignItems:'center'}}>
                                                    <span style={{fontSize:'12px',color:'rgba(255,255,255,0.5)'}}>Staff:</span>
                                                    <select value={currentStaffName} onChange={e=>saveCurrentStaffName(e.target.value)} style={{padding:'8px 12px',background:'rgba(255,255,255,0.08)',border:'1px solid rgba(255,255,255,0.15)',borderRadius:'8px',color:'#fff',fontSize:'13px'}}>
                                                        <option value="">Select your name</option>
                                                        {hkStaffList.filter(s=>s.role!=='manager').map(s=><option key={s.id} value={s.name}>{s.name}</option>)}
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            {/* Stats Bar */}
                                            <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:'12px',marginBottom:'20px'}}>
                                                <div style={{padding:'12px',background:'rgba(249,115,22,0.15)',borderRadius:'10px',textAlign:'center'}}>
                                                    <div style={{fontSize:'24px',fontWeight:'700',color:'#f97316'}}>{myRooms.filter(r=>r.type==='turnover').length}</div>
                                                    <div style={{fontSize:'11px'}}>üîÑ Turnovers</div>
                                                </div>
                                                <div style={{padding:'12px',background:'rgba(212,168,83,0.15)',borderRadius:'10px',textAlign:'center'}}>
                                                    <div style={{fontSize:'24px',fontWeight:'700',color:'#D4A853'}}>{myRooms.filter(r=>r.type==='checkout').length}</div>
                                                    <div style={{fontSize:'11px'}}>üö™ Checkouts</div>
                                                </div>
                                                <div style={{padding:'12px',background:'rgba(14,165,233,0.15)',borderRadius:'10px',textAlign:'center'}}>
                                                    <div style={{fontSize:'24px',fontWeight:'700',color:'#0ea5e9'}}>{myRooms.filter(r=>r.type==='stayover').length}</div>
                                                    <div style={{fontSize:'11px'}}>üõèÔ∏è Stayovers</div>
                                                </div>
                                                <div style={{padding:'12px',background:'rgba(34,197,94,0.15)',borderRadius:'10px',textAlign:'center'}}>
                                                    <div style={{fontSize:'24px',fontWeight:'700',color:'#22c55e'}}>{doneRooms.length}/{myRooms.length}</div>
                                                    <div style={{fontSize:'11px'}}>‚úÖ Done</div>
                                                </div>
                                            </div>
                                            
                                            {/* Room Cleaning Interface */}
                                            {selectedCleaningRoom ? (
                                                <div style={{background:'rgba(45,106,106,0.1)',borderRadius:'16px',padding:'20px',border:'1px solid rgba(45,106,106,0.3)'}}>
                                                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'16px'}}>
                                                        <div>
                                                            <h4 style={{fontSize:'20px',fontWeight:'700',color:'#2D6A6A'}}>Room {selectedCleaningRoom.roomId}</h4>
                                                            <div style={{fontSize:'12px',color:'rgba(255,255,255,0.5)'}}>{selectedCleaningRoom.roomType} ‚Ä¢ {getTypeColor(selectedCleaningRoom.type).label}</div>
                                                        </div>
                                                        <button onClick={()=>setSelectedCleaningRoom(null)} style={{padding:'8px 16px',background:'rgba(255,255,255,0.1)',border:'none',borderRadius:'8px',color:'#fff',cursor:'pointer'}}>‚Üê Back</button>
                                                    </div>
                                                    
                                                    <div style={{marginBottom:'20px',padding:'12px',background:'rgba(255,255,255,0.05)',borderRadius:'10px'}}>
                                                        <div style={{fontSize:'12px',color:'rgba(255,255,255,0.5)',marginBottom:'4px'}}>Progress: {selectedCleaningRoom.checklist.filter(i=>i.done).length}/{selectedCleaningRoom.checklist.length} items</div>
                                                        <div style={{height:'8px',background:'rgba(255,255,255,0.1)',borderRadius:'4px',overflow:'hidden'}}>
                                                            <div style={{height:'100%',background:'linear-gradient(90deg,#2D6A6A,#22c55e)',width:`${(selectedCleaningRoom.checklist.filter(i=>i.done).length/selectedCleaningRoom.checklist.length)*100}%`,transition:'width 0.3s'}}/>
                                                        </div>
                                                    </div>
                                                    
                                                    <div style={{display:'grid',gap:'8px',marginBottom:'20px',maxHeight:'300px',overflowY:'auto'}}>
                                                        {selectedCleaningRoom.checklist.map((item, idx) => (
                                                            <button key={idx} onClick={()=>toggleChecklistItem(idx)} style={{display:'flex',alignItems:'center',gap:'12px',padding:'12px 16px',background:item.done?'rgba(34,197,94,0.2)':'rgba(255,255,255,0.03)',border:item.done?'1px solid rgba(34,197,94,0.4)':'1px solid rgba(255,255,255,0.1)',borderRadius:'10px',color:'#fff',cursor:'pointer',textAlign:'left'}}>
                                                                <div style={{width:'28px',height:'28px',borderRadius:'6px',background:item.done?'#22c55e':'rgba(255,255,255,0.1)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'16px'}}>{item.done?'‚úì':'‚óã'}</div>
                                                                <span style={{flex:1,textDecoration:item.done?'line-through':'none',opacity:item.done?0.7:1}}>{item.item}</span>
                                                            </button>
                                                        ))}
                                                    </div>
                                                    
                                                    <button onClick={completeRoom} style={{width:'100%',padding:'16px',background:'linear-gradient(135deg,#22c55e,#16a34a)',border:'none',borderRadius:'12px',color:'#fff',fontWeight:'700',fontSize:'16px',cursor:'pointer'}}>
                                                        ‚úì Complete Room & Notify Front Desk
                                                    </button>
                                                </div>
                                            ) : (
                                                <>
                                                    {/* Pending Rooms by Floor */}
                                                    <h4 style={{fontSize:'14px',fontWeight:'600',marginBottom:'12px',color:'#D4A853'}}>‚è≥ Pending Rooms ({pendingRooms.length})</h4>
                                                    {pendingRooms.length === 0 ? (
                                                        <div style={{textAlign:'center',padding:'40px',color:'rgba(255,255,255,0.4)',background:'rgba(34,197,94,0.1)',borderRadius:'12px',marginBottom:'20px'}}>
                                                            <div style={{fontSize:'48px',marginBottom:'8px'}}>üéâ</div>
                                                            <div style={{fontSize:'16px',fontWeight:'600',color:'#22c55e'}}>All rooms completed!</div>
                                                        </div>
                                                    ) : (
                                                        <div style={{display:'grid',gap:'12px',marginBottom:'24px'}}>
                                                            {FLOORS.filter(f => pendingRooms.some(r => r.floor == f)).map(floor => (
                                                                <div key={floor} style={{background:'rgba(255,255,255,0.02)',borderRadius:'12px',padding:'16px',border:'1px solid rgba(255,255,255,0.08)'}}>
                                                                    <h5 style={{fontSize:'13px',fontWeight:'600',marginBottom:'12px',color:'rgba(255,255,255,0.6)'}}>Floor {floor}</h5>
                                                                    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(140px,1fr))',gap:'10px'}}>
                                                                        {pendingRooms.filter(r => r.floor == floor).map(room => {
                                                                            const typeStyle = getTypeColor(room.type);
                                                                            const progress = cleaningProgress[room.roomId];
                                                                            const inProgress = !!progress;
                                                                            return (
                                                                                <button key={room.roomId} onClick={()=>startCleaning(room)} style={{padding:'14px',background:typeStyle.bg,border:`2px solid ${typeStyle.border}`,borderRadius:'12px',cursor:'pointer',textAlign:'center',position:'relative'}}>
                                                                                    {inProgress && <div style={{position:'absolute',top:'-6px',right:'-6px',background:'#22c55e',borderRadius:'50%',width:'20px',height:'20px',fontSize:'12px',display:'flex',alignItems:'center',justifyContent:'center'}}>‚è≥</div>}
                                                                                    <div style={{fontSize:'20px',fontWeight:'700',color:typeStyle.color}}>{room.roomId}</div>
                                                                                    <div style={{fontSize:'10px',marginTop:'4px',color:'rgba(255,255,255,0.6)'}}>{typeStyle.label.split(' ')[1]}</div>
                                                                                    <div style={{fontSize:'9px',marginTop:'2px',color:'rgba(255,255,255,0.4)'}}>{room.roomType}</div>
                                                                                </button>
                                                                            );
                                                                        })}
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                    
                                                    {/* Done Rooms Summary */}
                                                    {doneRooms.length > 0 && (
                                                        <>
                                                            <h4 style={{fontSize:'14px',fontWeight:'600',marginBottom:'12px',color:'#22c55e'}}>‚úÖ Completed Today ({doneRooms.length})</h4>
                                                            <div style={{display:'flex',flexWrap:'wrap',gap:'8px'}}>
                                                                {doneRooms.map(room => (
                                                                    <span key={room.roomId} style={{padding:'8px 14px',borderRadius:'20px',background:'rgba(34,197,94,0.2)',border:'1px solid rgba(34,197,94,0.4)',color:'#22c55e',fontSize:'13px',fontWeight:'600'}}>‚úì {room.roomId}</span>
                                                                ))}
                                                            </div>
                                                        </>
                                                    )}
                                                </>
                                            )}
                                        </div>
                                    );
                                })()}
                                
                                {/* ==================== SUPPLIES - What to collect from store ==================== */}
                                {hkTab === 'supplies' && (() => {
                                    const todayStr = getBDDate();
                                    
                                    // Get my assigned rooms
                                    const getStaffFloors = () => {
                                        const assigns = dailyAssignments[today] || {};
                                        const staffId = hkStaffList.find(s => s.name === currentStaffName)?.id;
                                        if (!staffId) return FLOORS;
                                        return FLOORS.filter(f => (assigns[f] || []).includes(staffId));
                                    };
                                    const myFloors = getStaffFloors();
                                    
                                    // Get rooms needing cleaning (not completed)
                                    const getMyPendingRooms = () => {
                                        const rooms = [];
                                        const allData = [...hkDataToday.turnover.map(r => ({...r, type: 'turnover'})),
                                                        ...hkDataToday.checkout.map(r => ({...r, type: 'checkout'})),
                                                        ...hkDataToday.stayover.map(r => ({...r, type: 'stayover'}))];
                                        
                                        allData.forEach(r => {
                                            const roomNum = r.unit?.n || r.roomId;
                                            const floor = Math.floor(parseInt(roomNum) / 100);
                                            if (myFloors.includes(floor.toString()) || myFloors.includes(floor)) {
                                                const completed = completedRooms.find(c => c.roomId === roomNum.toString() && c.date === todayStr);
                                                if (!completed) {
                                                    rooms.push({
                                                        roomId: roomNum.toString(),
                                                        roomType: r.roomType || r.unit?.roomType || 'Standard King',
                                                        type: r.type,
                                                        occupancy: r.occupancy || r.numAdult || 2
                                                    });
                                                }
                                            }
                                        });
                                        return rooms;
                                    };
                                    
                                    const pendingRooms = getMyPendingRooms();
                                    
                                    // Calculate total supplies needed
                                    const calculateSupplies = () => {
                                        const amenities = {};
                                        const linens = {};
                                        
                                        pendingRooms.forEach(room => {
                                            const config = roomConfigs[room.roomType] || roomConfigs['Standard King'] || Object.values(roomConfigs)[0];
                                            if (!config) return;
                                            
                                            // For stayovers, reduce amenities (just replenish)
                                            const amenityMultiplier = room.type === 'stayover' ? 0.5 : 1;
                                            // For stayovers, no full linen change (unless requested)
                                            const linenMultiplier = room.type === 'stayover' ? 0 : 1;
                                            
                                            if (config.amenities) {
                                                Object.entries(config.amenities).forEach(([item, qty]) => {
                                                    amenities[item] = (amenities[item] || 0) + Math.ceil(qty * amenityMultiplier);
                                                });
                                            }
                                            
                                            if (config.linens && linenMultiplier > 0) {
                                                Object.entries(config.linens).forEach(([item, qty]) => {
                                                    linens[item] = (linens[item] || 0) + Math.ceil(qty * linenMultiplier);
                                                });
                                            }
                                        });
                                        
                                        return { amenities, linens };
                                    };
                                    
                                    const supplies = calculateSupplies();
                                    
                                    return (
                                        <div style={{background: 'rgba(255,255,255,0.02)', borderRadius: '16px', padding: '20px', border: '1px solid rgba(255,255,255,0.08)'}}>
                                            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'20px'}}>
                                                <div>
                                                    <h3 style={{fontSize: '18px', fontWeight: '700', marginBottom: '4px'}}>üì¶ Supply Pick List</h3>
                                                    <div style={{fontSize:'12px',color:'rgba(255,255,255,0.5)'}}>Collect these from store for {pendingRooms.length} pending rooms</div>
                                                </div>
                                                <button onClick={()=>window.print()} style={{padding:'10px 16px',background:'rgba(255,255,255,0.1)',border:'1px solid rgba(255,255,255,0.2)',borderRadius:'8px',color:'#fff',cursor:'pointer',fontSize:'12px'}}>üñ®Ô∏è Print List</button>
                                            </div>
                                            
                                            {pendingRooms.length === 0 ? (
                                                <div style={{textAlign:'center',padding:'40px',color:'rgba(255,255,255,0.4)'}}>
                                                    <div style={{fontSize:'48px',marginBottom:'8px'}}>‚úÖ</div>
                                                    <div>No pending rooms - no supplies needed!</div>
                                                </div>
                                            ) : (
                                                <div style={{display:'grid',gridTemplateColumns:'repeat(2,1fr)',gap:'20px'}}>
                                                    {/* Linens */}
                                                    <div style={{background:'rgba(14,165,233,0.1)',borderRadius:'12px',padding:'16px',border:'1px solid rgba(14,165,233,0.3)'}}>
                                                        <h4 style={{fontSize:'14px',fontWeight:'600',marginBottom:'16px',color:'#0ea5e9'}}>üõèÔ∏è Linens</h4>
                                                        {Object.keys(supplies.linens).length === 0 ? (
                                                            <div style={{color:'rgba(255,255,255,0.4)',fontSize:'13px'}}>No linens needed (stayovers only)</div>
                                                        ) : (
                                                            <div style={{display:'grid',gap:'8px'}}>
                                                                {Object.entries(supplies.linens).filter(([,qty]) => qty > 0).map(([item, qty]) => (
                                                                    <div key={item} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'10px 14px',background:'rgba(255,255,255,0.05)',borderRadius:'8px'}}>
                                                                        <span>{item}</span>
                                                                        <span style={{fontWeight:'700',color:'#0ea5e9',fontSize:'18px'}}>{qty}</span>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                    
                                                    {/* Amenities */}
                                                    <div style={{background:'rgba(34,197,94,0.1)',borderRadius:'12px',padding:'16px',border:'1px solid rgba(34,197,94,0.3)'}}>
                                                        <h4 style={{fontSize:'14px',fontWeight:'600',marginBottom:'16px',color:'#22c55e'}}>üß¥ Amenities</h4>
                                                        {Object.keys(supplies.amenities).length === 0 ? (
                                                            <div style={{color:'rgba(255,255,255,0.4)',fontSize:'13px'}}>No amenities configured</div>
                                                        ) : (
                                                            <div style={{display:'grid',gap:'8px'}}>
                                                                {Object.entries(supplies.amenities).filter(([,qty]) => qty > 0).map(([item, qty]) => (
                                                                    <div key={item} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'10px 14px',background:'rgba(255,255,255,0.05)',borderRadius:'8px'}}>
                                                                        <span>{item}</span>
                                                                        <span style={{fontWeight:'700',color:'#22c55e',fontSize:'18px'}}>{qty}</span>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            )}
                                            
                                            {/* Room Breakdown */}
                                            {pendingRooms.length > 0 && (
                                                <div style={{marginTop:'24px'}}>
                                                    <h4 style={{fontSize:'14px',fontWeight:'600',marginBottom:'12px'}}>üìã Room-by-Room Breakdown</h4>
                                                    <div style={{display:'grid',gap:'8px',maxHeight:'300px',overflowY:'auto'}}>
                                                        {pendingRooms.map(room => {
                                                            const config = roomConfigs[room.roomType] || roomConfigs['Standard King'];
                                                            return (
                                                                <div key={room.roomId} style={{padding:'12px 16px',background:'rgba(255,255,255,0.03)',borderRadius:'10px',border:'1px solid rgba(255,255,255,0.08)'}}>
                                                                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'8px'}}>
                                                                        <span style={{fontWeight:'600'}}>Room {room.roomId}</span>
                                                                        <span style={{padding:'4px 10px',borderRadius:'12px',fontSize:'11px',background:room.type==='turnover'?'rgba(249,115,22,0.2)':room.type==='checkout'?'rgba(212,168,83,0.2)':'rgba(14,165,233,0.2)',color:room.type==='turnover'?'#f97316':room.type==='checkout'?'#D4A853':'#0ea5e9'}}>{room.type}</span>
                                                                    </div>
                                                                    <div style={{fontSize:'11px',color:'rgba(255,255,255,0.5)'}}>
                                                                        {room.roomType} ‚Ä¢ {config?.beds || 1} bed(s) ‚Ä¢ {room.occupancy} guests
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })()}
                                
                                {/* ==================== COMPLETED - Room completion logs ==================== */}
                                {hkTab === 'completed' && (() => {
                                    const todayStr = getBDDate();
                                    const todayCompleted = completedRooms.filter(r => r.date === todayStr);
                                    
                                    // Group by staff
                                    const byStaff = {};
                                    todayCompleted.forEach(r => {
                                        if (!byStaff[r.staffName]) byStaff[r.staffName] = [];
                                        byStaff[r.staffName].push(r);
                                    });
                                    
                                    return (
                                        <div style={{background: 'rgba(255,255,255,0.02)', borderRadius: '16px', padding: '20px', border: '1px solid rgba(255,255,255,0.08)'}}>
                                            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'20px'}}>
                                                <div>
                                                    <h3 style={{fontSize: '18px', fontWeight: '700', marginBottom: '4px'}}>‚úÖ Completed Rooms</h3>
                                                    <div style={{fontSize:'12px',color:'rgba(255,255,255,0.5)'}}>Today: {todayCompleted.length} rooms cleaned</div>
                                                </div>
                                            </div>
                                            
                                            {todayCompleted.length === 0 ? (
                                                <div style={{textAlign:'center',padding:'40px',color:'rgba(255,255,255,0.4)'}}>
                                                    <div style={{fontSize:'48px',marginBottom:'8px'}}>üßπ</div>
                                                    <div>No rooms completed yet today</div>
                                                </div>
                                            ) : (
                                                <>
                                                    {/* By Staff Summary */}
                                                    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(200px,1fr))',gap:'12px',marginBottom:'24px'}}>
                                                        {Object.entries(byStaff).map(([staff, rooms]) => (
                                                            <div key={staff} style={{padding:'16px',background:'rgba(34,197,94,0.1)',borderRadius:'12px',border:'1px solid rgba(34,197,94,0.3)'}}>
                                                                <div style={{fontWeight:'600',marginBottom:'8px'}}>{staff}</div>
                                                                <div style={{fontSize:'28px',fontWeight:'700',color:'#22c55e'}}>{rooms.length}</div>
                                                                <div style={{fontSize:'11px',color:'rgba(255,255,255,0.5)'}}>rooms cleaned</div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                    
                                                    {/* Detailed Log */}
                                                    <h4 style={{fontSize:'14px',fontWeight:'600',marginBottom:'12px'}}>üìú Cleaning Log</h4>
                                                    <div style={{display:'grid',gap:'8px',maxHeight:'400px',overflowY:'auto'}}>
                                                        {todayCompleted.sort((a,b) => new Date(b.completedAt) - new Date(a.completedAt)).map((record, idx) => (
                                                            <div key={idx} style={{padding:'14px 16px',background:'rgba(255,255,255,0.03)',borderRadius:'10px',border:'1px solid rgba(255,255,255,0.08)'}}>
                                                                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'6px'}}>
                                                                    <div style={{display:'flex',alignItems:'center',gap:'10px'}}>
                                                                        <span style={{fontSize:'16px',fontWeight:'700',color:'#2D6A6A'}}>Room {record.roomId}</span>
                                                                        <span style={{padding:'4px 10px',borderRadius:'12px',fontSize:'11px',background:'rgba(34,197,94,0.2)',color:'#22c55e'}}>{record.cleanType}</span>
                                                                    </div>
                                                                    <span style={{fontSize:'12px',color:'rgba(255,255,255,0.5)'}}>{new Date(record.completedAt).toLocaleTimeString()}</span>
                                                                </div>
                                                                <div style={{fontSize:'12px',color:'rgba(255,255,255,0.6)'}}>
                                                                    Cleaned by <strong>{record.staffName}</strong> ‚Ä¢ {record.roomType}
                                                                </div>
                                                                {record.checklist && (
                                                                    <div style={{fontSize:'11px',color:'rgba(255,255,255,0.4)',marginTop:'4px'}}>
                                                                        Checklist: {record.checklist.filter(i=>i.done).length}/{record.checklist.length} items completed
                                                                    </div>
                                                                )}
                                                            </div>
                                                        ))}
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    );
                                })()}
                                
                                {hkTab === 'dashboard' && (() => {
                                    const hkData = hkDay === 'today' ? hkDataToday : hkDataTomorrow;
                                    const hkTotalRooms = totalRooms; // Use dynamic totalRooms from state
                                    const occupiedToday = hkDataToday.stayover.length + hkDataToday.checkin.length;
                                    const departuresToday = hkDataToday.checkout.length + hkDataToday.turnover.length;
                                    const arrivalsToday = hkDataToday.checkin.length + hkDataToday.turnover.length;
                                    const turnoverToday = hkDataToday.turnover.length;
                                    
                                    const occupiedTomorrow = hkDataTomorrow.stayover.length + hkDataTomorrow.checkin.length;
                                    const departuresTomorrow = hkDataTomorrow.checkout.length + hkDataTomorrow.turnover.length;
                                    const arrivalsTomorrow = hkDataTomorrow.checkin.length + hkDataTomorrow.turnover.length;
                                    const turnoverTomorrow = hkDataTomorrow.turnover.length;
                                    
                                    // Calculate completion stats
                                    const checkoutsCompleted = hkDataToday.checkout.filter(c => c.done).length + hkDataToday.turnover.filter(t => t.outDone).length;
                                    const totalCheckouts = hkDataToday.checkout.length + hkDataToday.turnover.length;
                                    const checkinsCompleted = hkDataToday.checkin.filter(c => c.done).length + hkDataToday.turnover.filter(t => t.inDone).length;
                                    const totalCheckins = hkDataToday.checkin.length + hkDataToday.turnover.length;
                                    
                                    return (
                                        <div>
                                            {/* Quick Stats - Today vs Tomorrow */}
                                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '16px', marginBottom: '24px'}}>
                                                {/* Today Card */}
                                                <div style={{background: 'linear-gradient(135deg, rgba(45,106,106,0.2), rgba(45,106,106,0.05))', border: '1px solid rgba(45,106,106,0.3)', borderRadius: '16px', padding: '20px'}}>
                                                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}}>
                                                        <h3 style={{fontSize: '16px', fontWeight: '700', color: '#2D6A6A'}}>üìÖ Today</h3>
                                                        <span style={{fontSize: '12px', color: 'rgba(255,255,255,0.5)'}}>{formatDate(today)}</span>
                                                    </div>
                                                    <div style={{display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '12px'}}>
                                                        <div style={{background: 'rgba(212,168,83,0.15)', borderRadius: '10px', padding: '12px', textAlign: 'center'}}>
                                                            <div style={{fontSize: '24px', fontWeight: '700', color: '#D4A853'}}>{departuresToday}</div>
                                                            <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.6)'}}>üö™ Departures</div>
                                                        </div>
                                                        <div style={{background: 'rgba(45,106,106,0.15)', borderRadius: '10px', padding: '12px', textAlign: 'center'}}>
                                                            <div style={{fontSize: '24px', fontWeight: '700', color: '#2D6A6A'}}>{arrivalsToday}</div>
                                                            <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.6)'}}>üö∂ Arrivals</div>
                                                        </div>
                                                        <div style={{background: 'rgba(14,165,233,0.15)', borderRadius: '10px', padding: '12px', textAlign: 'center'}}>
                                                            <div style={{fontSize: '24px', fontWeight: '700', color: '#0ea5e9'}}>{hkDataToday.stayover.length}</div>
                                                            <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.6)'}}>üõèÔ∏è Stayovers</div>
                                                        </div>
                                                        <div style={{background: 'rgba(249,115,22,0.15)', borderRadius: '10px', padding: '12px', textAlign: 'center'}}>
                                                            <div style={{fontSize: '24px', fontWeight: '700', color: '#f97316'}}>{turnoverToday}</div>
                                                            <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.6)'}}>üîÑ Turnovers</div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                {/* Tomorrow Card */}
                                                <div style={{background: 'linear-gradient(135deg, rgba(139,92,246,0.2), rgba(139,92,246,0.05))', border: '1px solid rgba(139,92,246,0.3)', borderRadius: '16px', padding: '20px'}}>
                                                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}}>
                                                        <h3 style={{fontSize: '16px', fontWeight: '700', color: '#8b5cf6'}}>üìÜ Tomorrow</h3>
                                                        <span style={{fontSize: '12px', color: 'rgba(255,255,255,0.5)'}}>{formatDate(tomorrow)}</span>
                                                    </div>
                                                    <div style={{display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '12px'}}>
                                                        <div style={{background: 'rgba(212,168,83,0.15)', borderRadius: '10px', padding: '12px', textAlign: 'center'}}>
                                                            <div style={{fontSize: '24px', fontWeight: '700', color: '#D4A853'}}>{departuresTomorrow}</div>
                                                            <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.6)'}}>üö™ Departures</div>
                                                        </div>
                                                        <div style={{background: 'rgba(45,106,106,0.15)', borderRadius: '10px', padding: '12px', textAlign: 'center'}}>
                                                            <div style={{fontSize: '24px', fontWeight: '700', color: '#2D6A6A'}}>{arrivalsTomorrow}</div>
                                                            <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.6)'}}>üö∂ Arrivals</div>
                                                        </div>
                                                        <div style={{background: 'rgba(14,165,233,0.15)', borderRadius: '10px', padding: '12px', textAlign: 'center'}}>
                                                            <div style={{fontSize: '24px', fontWeight: '700', color: '#0ea5e9'}}>{hkDataTomorrow.stayover.length}</div>
                                                            <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.6)'}}>üõèÔ∏è Stayovers</div>
                                                        </div>
                                                        <div style={{background: 'rgba(249,115,22,0.15)', borderRadius: '10px', padding: '12px', textAlign: 'center'}}>
                                                            <div style={{fontSize: '24px', fontWeight: '700', color: '#f97316'}}>{turnoverTomorrow}</div>
                                                            <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.6)'}}>üîÑ Turnovers</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            {/* Progress Bars - Today's Completion */}
                                            <div style={{background: 'rgba(255,255,255,0.02)', border: '1px solid rgba(255,255,255,0.08)', borderRadius: '16px', padding: '20px', marginBottom: '24px'}}>
                                                <h3 style={{fontSize: '16px', fontWeight: '700', marginBottom: '16px'}}>üìä Today's Progress</h3>
                                                <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '16px'}}>
                                                    {/* Checkouts Progress */}
                                                    <div>
                                                        <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '6px'}}>
                                                            <span style={{fontSize: '13px', color: 'rgba(255,255,255,0.7)'}}>üö™ Checkouts</span>
                                                            <span style={{fontSize: '13px', fontWeight: '600', color: '#D4A853'}}>{checkoutsCompleted}/{totalCheckouts}</span>
                                                        </div>
                                                        <div style={{background: 'rgba(255,255,255,0.1)', borderRadius: '10px', height: '12px', overflow: 'hidden'}}>
                                                            <div style={{background: 'linear-gradient(90deg, #D4A853, #f59e0b)', height: '100%', width: totalCheckouts > 0 ? `${(checkoutsCompleted/totalCheckouts)*100}%` : '0%', borderRadius: '10px', transition: 'width 0.3s'}}></div>
                                                        </div>
                                                    </div>
                                                    {/* Checkins Progress */}
                                                    <div>
                                                        <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '6px'}}>
                                                            <span style={{fontSize: '13px', color: 'rgba(255,255,255,0.7)'}}>üö∂ Check-ins</span>
                                                            <span style={{fontSize: '13px', fontWeight: '600', color: '#2D6A6A'}}>{checkinsCompleted}/{totalCheckins}</span>
                                                        </div>
                                                        <div style={{background: 'rgba(255,255,255,0.1)', borderRadius: '10px', height: '12px', overflow: 'hidden'}}>
                                                            <div style={{background: 'linear-gradient(90deg, #2D6A6A, #22c55e)', height: '100%', width: totalCheckins > 0 ? `${(checkinsCompleted/totalCheckins)*100}%` : '0%', borderRadius: '10px', transition: 'width 0.3s'}}></div>
                                                        </div>
                                                    </div>
                                                    {/* Requests Progress */}
                                                    <div>
                                                        <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '6px'}}>
                                                            <span style={{fontSize: '13px', color: 'rgba(255,255,255,0.7)'}}>üõéÔ∏è Requests</span>
                                                            <span style={{fontSize: '13px', fontWeight: '600', color: '#f59e0b'}}>{todayCompleted.length}/{todayCompleted.length + pendingReqs.length}</span>
                                                        </div>
                                                        <div style={{background: 'rgba(255,255,255,0.1)', borderRadius: '10px', height: '12px', overflow: 'hidden'}}>
                                                            <div style={{background: 'linear-gradient(90deg, #f59e0b, #22c55e)', height: '100%', width: (todayCompleted.length + pendingReqs.length) > 0 ? `${(todayCompleted.length/(todayCompleted.length + pendingReqs.length))*100}%` : '100%', borderRadius: '10px', transition: 'width 0.3s'}}></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            {/* Priority Tasks */}
                                            <div style={{background: 'rgba(255,255,255,0.02)', border: '1px solid rgba(255,255,255,0.08)', borderRadius: '16px', padding: '20px', marginBottom: '24px'}}>
                                                <h3 style={{fontSize: '16px', fontWeight: '700', marginBottom: '16px'}}>üéØ Priority Tasks</h3>
                                                {priorityTasks.length === 0 ? (
                                                    <div style={{textAlign: 'center', padding: '30px', color: 'rgba(255,255,255,0.4)'}}>
                                                        ‚úÖ All priority tasks completed!
                                                    </div>
                                                ) : (
                                                    <div style={{display: 'flex', flexDirection: 'column', gap: '10px'}}>
                                                        {priorityTasks.map((task, idx) => (
                                                            <div key={idx} style={{display: 'flex', alignItems: 'center', gap: '12px', padding: '12px 16px', background: `${task.color}15`, border: `1px solid ${task.color}40`, borderRadius: '10px'}}>
                                                                <div style={{width: '50px', height: '50px', borderRadius: '10px', background: `${task.color}30`, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '18px', fontWeight: '700', color: task.color}}>{task.room}</div>
                                                                <div style={{flex: 1}}>
                                                                    <div style={{fontSize: '14px', fontWeight: '600'}}>{task.guest}</div>
                                                                    <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.6)'}}>{task.label}</div>
                                                                </div>
                                                                <div style={{padding: '4px 10px', background: task.color, borderRadius: '6px', fontSize: '11px', fontWeight: '700', textTransform: 'uppercase'}}>{task.priority}</div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                            
                                            {/* Quick Actions */}
                                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '12px'}}>
                                                <button onClick={() => setHkTab('roomboard')} style={{padding: '20px', background: 'linear-gradient(135deg, rgba(45,106,106,0.2), rgba(45,106,106,0.05))', border: '1px solid rgba(45,106,106,0.3)', borderRadius: '12px', color: '#fff', cursor: 'pointer', textAlign: 'center'}}>
                                                    <div style={{fontSize: '28px', marginBottom: '8px'}}>üó∫Ô∏è</div>
                                                    <div style={{fontSize: '13px', fontWeight: '600'}}>Room Board</div>
                                                </button>
                                                <button onClick={() => setHkTab('tasks')} style={{padding: '20px', background: 'linear-gradient(135deg, rgba(249,115,22,0.2), rgba(249,115,22,0.05))', border: '1px solid rgba(249,115,22,0.3)', borderRadius: '12px', color: '#fff', cursor: 'pointer', textAlign: 'center'}}>
                                                    <div style={{fontSize: '28px', marginBottom: '8px'}}>üìù</div>
                                                    <div style={{fontSize: '13px', fontWeight: '600'}}>Tasks</div>
                                                    {pendingReqs.length > 0 && <div style={{fontSize: '11px', color: '#ef4444', marginTop: '4px'}}>{pendingReqs.length} pending</div>}
                                                </button>
                                                <button onClick={() => setHkTab('inspections')} style={{padding: '20px', background: 'linear-gradient(135deg, rgba(34,197,94,0.2), rgba(34,197,94,0.05))', border: '1px solid rgba(34,197,94,0.3)', borderRadius: '12px', color: '#fff', cursor: 'pointer', textAlign: 'center'}}>
                                                    <div style={{fontSize: '28px', marginBottom: '8px'}}>‚úÖ</div>
                                                    <div style={{fontSize: '13px', fontWeight: '600'}}>Inspections</div>
                                                </button>
                                                <button onClick={() => setHkTab('issues')} style={{padding: '20px', background: 'linear-gradient(135deg, rgba(239,68,68,0.2), rgba(239,68,68,0.05))', border: '1px solid rgba(239,68,68,0.3)', borderRadius: '12px', color: '#fff', cursor: 'pointer', textAlign: 'center'}}>
                                                    <div style={{fontSize: '28px', marginBottom: '8px'}}>üõ†Ô∏è</div>
                                                    <div style={{fontSize: '13px', fontWeight: '600'}}>Maintenance</div>
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })()}
                                
                                {/* ==================== ROOM BOARD ==================== */}
                                {hkTab === 'roomboard' && (() => {
                                    const hkData = hkDay === 'today' ? hkDataToday : hkDataTomorrow;
                                    const hkDate = hkDay === 'today' ? today : tomorrow;
                                    
                                    // Get pending requests count for a room
                                    const getRoomRequests = (roomNum) => {
                                        return requests.filter(r => !r.done && r.roomNum === roomNum);
                                    };
                                    
                                    // Organize data by floor
                                    const getFloorData = (floor) => {
                                        const floorRooms = allRooms.filter(r => r.floor === floor);
                                        const checkout = hkData.checkout.filter(c => floorRooms.some(fr => fr.unit.n === c.unit.n));
                                        const turnover = hkData.turnover.filter(t => floorRooms.some(fr => fr.unit.n === t.unit.n));
                                        const stayover = hkData.stayover.filter(s => floorRooms.some(fr => fr.unit.n === s.unit.n));
                                        const checkin = hkData.checkin.filter(c => floorRooms.some(fr => fr.unit.n === c.unit.n));
                                        
                                        return { checkout, turnover, stayover, checkin, totalRooms: floorRooms.length };
                                    };
                                    
                                    // Handle staff assignment per floor
                                    const assignStaffToFloor = (floor, staffName) => {
                                        const dateKey = hkDay === 'today' ? today : tomorrow;
                                        const updated = {...floorStaffAssign, [`${dateKey}-${floor}`]: staffName};
                                        setFloorStaffAssign(updated);
                                        saveFloorStaffAssign(updated);
                                    };
                                    
                                    const getFloorStaff = (floor) => {
                                        const dateKey = hkDay === 'today' ? today : tomorrow;
                                        return floorStaffAssign[`${dateKey}-${floor}`] || '';
                                    };
                                    
                                    // Task category colors
                                    const TASK_COLORS = {
                                        checkout: {bg: 'rgba(212,168,83,0.15)', border: 'rgba(212,168,83,0.4)', color: '#D4A853', label: 'üö™ Checkout Only', desc: 'Guest departing, needs deep clean'},
                                        turnover: {bg: 'rgba(249,115,22,0.15)', border: 'rgba(249,115,22,0.4)', color: '#f97316', label: 'üîÑ Turnover', desc: 'Check-out ‚Üí Check-in same day (PRIORITY)'},
                                        stayover: {bg: 'rgba(14,165,233,0.15)', border: 'rgba(14,165,233,0.4)', color: '#0ea5e9', label: 'üõèÔ∏è Stayover', desc: 'Regular service for staying guests'},
                                        checkin: {bg: 'rgba(45,106,106,0.15)', border: 'rgba(45,106,106,0.4)', color: '#2D6A6A', label: 'üü¢ Check-in Ready', desc: 'New arrival, room should be prepared'}
                                    };
                                    
                                    // Render a task card
                                    const TaskCard = ({item, type}) => {
                                        const colors = TASK_COLORS[type];
                                        const roomNum = item.unit.n;
                                        const roomReqs = getRoomRequests(roomNum);
                                        const statusInfo = getRoomStatusInfo(roomNum);
                                        
                                        let guest, booking, isDone = false;
                                        if (type === 'turnover') {
                                            guest = item.outDone ? item.in.firstName : item.out.firstName;
                                            booking = item.outDone ? item.in : item.out;
                                            isDone = item.outDone && item.inDone;
                                        } else if (type === 'checkout') {
                                            guest = item.booking.firstName;
                                            booking = item.booking;
                                            isDone = item.done;
                                        } else if (type === 'checkin') {
                                            guest = item.booking.firstName;
                                            booking = item.booking;
                                            isDone = item.done;
                                        } else {
                                            guest = item.booking.firstName;
                                            booking = item.booking;
                                        }
                                        
                                        return (
                                            <div 
                                                style={{
                                                    background: isDone ? 'rgba(34,197,94,0.15)' : colors.bg, 
                                                    border: `2px solid ${isDone ? 'rgba(34,197,94,0.5)' : colors.border}`, 
                                                    borderRadius: '12px', 
                                                    padding: '12px', 
                                                    position: 'relative',
                                                    cursor: 'pointer',
                                                    transition: 'all 0.2s'
                                                }}
                                                onClick={() => setShowInfoModal(booking)}
                                            >
                                                {/* Room number */}
                                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '6px'}}>
                                                    <div style={{fontSize: '24px', fontWeight: '700', color: isDone ? '#22c55e' : colors.color}}>{roomNum}</div>
                                                    <div style={{display: 'flex', gap: '4px', alignItems: 'center'}}>
                                                        {roomReqs.length > 0 && (
                                                            <div style={{background: '#ef4444', padding: '2px 8px', borderRadius: '10px', fontSize: '10px', fontWeight: '700'}}>
                                                                üîî {roomReqs.length}
                                                            </div>
                                                        )}
                                                        <div style={{background: statusInfo.bg, border: `1px solid ${statusInfo.border}`, padding: '2px 6px', borderRadius: '6px', fontSize: '9px', color: statusInfo.color}}>
                                                            {statusInfo.label.split(' ')[0]}
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                {/* Guest name */}
                                                <div style={{fontSize: '13px', fontWeight: '600', marginBottom: '4px'}}>{guest}</div>
                                                
                                                {/* Room type */}
                                                <div style={{fontSize: '10px', color: 'rgba(255,255,255,0.5)'}}>{item.room.short}</div>
                                                
                                                {/* Task type badge */}
                                                <div style={{
                                                    position: 'absolute', 
                                                    bottom: '8px', 
                                                    right: '8px', 
                                                    fontSize: '9px', 
                                                    padding: '2px 8px', 
                                                    borderRadius: '8px', 
                                                    background: isDone ? '#22c55e' : colors.color, 
                                                    color: '#fff',
                                                    fontWeight: '600'
                                                }}>
                                                    {isDone ? '‚úì Done' : type === 'turnover' ? (item.outDone ? 'Ready for IN' : 'Await OUT') : type.toUpperCase()}
                                                </div>
                                                
                                                {/* Action buttons for turnover */}
                                                {type === 'turnover' && (
                                                    <div style={{position: 'absolute', top: '-8px', right: '-8px', display: 'flex', gap: '3px'}}>
                                                        <button 
                                                            onClick={(e) => { e.stopPropagation(); toggle(item.out.id, "out"); }} 
                                                            style={{width: '22px', height: '22px', borderRadius: '50%', background: item.outDone ? '#22c55e' : '#D4A853', border: 'none', color: '#fff', fontSize: '10px', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', boxShadow: '0 2px 6px rgba(0,0,0,0.3)'}}
                                                            title={item.outDone ? 'Undo OUT' : 'Check-out'}
                                                        >{item.outDone ? '‚úì' : '‚¨Ü'}</button>
                                                        <button 
                                                            onClick={(e) => { e.stopPropagation(); toggle(item.in.id, "in"); }} 
                                                            style={{width: '22px', height: '22px', borderRadius: '50%', background: item.inDone ? '#22c55e' : '#2D6A6A', border: 'none', color: '#fff', fontSize: '10px', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', boxShadow: '0 2px 6px rgba(0,0,0,0.3)'}}
                                                            title={item.inDone ? 'Undo IN' : 'Check-in'}
                                                        >{item.inDone ? '‚úì' : '‚¨á'}</button>
                                                    </div>
                                                )}
                                                
                                                {/* Action button for checkout */}
                                                {type === 'checkout' && (
                                                    <button 
                                                        onClick={(e) => { e.stopPropagation(); toggle(item.booking.id, "out"); }} 
                                                        style={{position: 'absolute', top: '-8px', right: '-8px', width: '24px', height: '24px', borderRadius: '50%', background: item.done ? '#22c55e' : '#D4A853', border: 'none', color: '#fff', fontSize: '11px', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', boxShadow: '0 2px 6px rgba(0,0,0,0.3)'}}
                                                        title={item.done ? 'Undo' : 'Check-out'}
                                                    >{item.done ? '‚Ü©' : '‚úì'}</button>
                                                )}
                                                
                                                {/* Action button for checkin */}
                                                {type === 'checkin' && (
                                                    <button 
                                                        onClick={(e) => { e.stopPropagation(); toggle(item.booking.id, "in"); }} 
                                                        style={{position: 'absolute', top: '-8px', right: '-8px', width: '24px', height: '24px', borderRadius: '50%', background: item.done ? '#22c55e' : '#2D6A6A', border: 'none', color: '#fff', fontSize: '11px', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', boxShadow: '0 2px 6px rgba(0,0,0,0.3)'}}
                                                        title={item.done ? 'Undo' : 'Check-in'}
                                                    >{item.done ? '‚Ü©' : '‚úì'}</button>
                                                )}
                                            </div>
                                        );
                                    };
                                    
                                    return (
                                        <div>
                                            {/* Header with view selector */}
                                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', flexWrap: 'wrap', gap: '12px'}}>
                                                <div>
                                                    <p style={{color: 'rgba(255,255,255,0.6)', fontSize: '13px'}}>{formatDate(hkDate)}</p>
                                                </div>
                                                <div style={{display: 'flex', background: 'rgba(255,255,255,0.05)', borderRadius: '8px', padding: '3px'}}>
                                                    <button onClick={() => setHkRoomBoardView('floor')} style={{padding: '8px 16px', borderRadius: '6px', border: 'none', background: hkRoomBoardView === 'floor' ? '#2D6A6A' : 'transparent', color: hkRoomBoardView === 'floor' ? '#fff' : 'rgba(255,255,255,0.6)', fontWeight: '600', cursor: 'pointer', fontSize: '12px'}}>By Floor</button>
                                                    <button onClick={() => setHkRoomBoardView('category')} style={{padding: '8px 16px', borderRadius: '6px', border: 'none', background: hkRoomBoardView === 'category' ? '#2D6A6A' : 'transparent', color: hkRoomBoardView === 'category' ? '#fff' : 'rgba(255,255,255,0.6)', fontWeight: '600', cursor: 'pointer', fontSize: '12px'}}>By Category</button>
                                                </div>
                                            </div>
                                            
                                            {/* Summary Stats */}
                                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '10px', marginBottom: '24px'}}>
                                                <div style={{...TASK_COLORS.turnover, background: TASK_COLORS.turnover.bg, border: `1px solid ${TASK_COLORS.turnover.border}`, borderRadius: '12px', padding: '14px', textAlign: 'center'}}>
                                                    <div style={{fontSize: '26px', fontWeight: '700', color: TASK_COLORS.turnover.color}}>{hkData.turnover.length}</div>
                                                    <div style={{fontSize: '10px', color: 'rgba(255,255,255,0.6)'}}>üîÑ Turnover</div>
                                                </div>
                                                <div style={{background: TASK_COLORS.checkout.bg, border: `1px solid ${TASK_COLORS.checkout.border}`, borderRadius: '12px', padding: '14px', textAlign: 'center'}}>
                                                    <div style={{fontSize: '26px', fontWeight: '700', color: TASK_COLORS.checkout.color}}>{hkData.checkout.length}</div>
                                                    <div style={{fontSize: '10px', color: 'rgba(255,255,255,0.6)'}}>üö™ Checkout</div>
                                                </div>
                                                <div style={{background: TASK_COLORS.stayover.bg, border: `1px solid ${TASK_COLORS.stayover.border}`, borderRadius: '12px', padding: '14px', textAlign: 'center'}}>
                                                    <div style={{fontSize: '26px', fontWeight: '700', color: TASK_COLORS.stayover.color}}>{hkData.stayover.length}</div>
                                                    <div style={{fontSize: '10px', color: 'rgba(255,255,255,0.6)'}}>üõèÔ∏è Stayover</div>
                                                </div>
                                                <div style={{background: TASK_COLORS.checkin.bg, border: `1px solid ${TASK_COLORS.checkin.border}`, borderRadius: '12px', padding: '14px', textAlign: 'center'}}>
                                                    <div style={{fontSize: '26px', fontWeight: '700', color: TASK_COLORS.checkin.color}}>{hkData.checkin.length}</div>
                                                    <div style={{fontSize: '10px', color: 'rgba(255,255,255,0.6)'}}>üü¢ Check-in</div>
                                                </div>
                                            </div>
                                            
                                            {/* ========== VIEW BY FLOOR ========== */}
                                            {hkRoomBoardView === 'floor' && (
                                                <div>
                                                    {FLOORS.map(floor => {
                                                        const floorData = getFloorData(floor);
                                                        const totalTasks = floorData.checkout.length + floorData.turnover.length + floorData.stayover.length + floorData.checkin.length;
                                                        const staffName = getFloorStaff(floor);
                                                        
                                                        if (totalTasks === 0) return null;
                                                        
                                                        return (
                                                            <div key={floor} style={{marginBottom: '28px', background: 'rgba(255,255,255,0.02)', borderRadius: '16px', padding: '20px', border: '1px solid rgba(255,255,255,0.08)'}}>
                                                                {/* Floor Header with Staff Assignment */}
                                                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px', flexWrap: 'wrap', gap: '12px'}}>
                                                                    <div style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
                                                                        <h4 style={{fontSize: '18px', fontWeight: '700', color: '#2D6A6A', margin: 0}}>Floor {floor}</h4>
                                                                        <div style={{display: 'flex', gap: '6px'}}>
                                                                            {floorData.turnover.length > 0 && <span style={{background: TASK_COLORS.turnover.bg, border: `1px solid ${TASK_COLORS.turnover.border}`, padding: '3px 8px', borderRadius: '8px', fontSize: '11px', color: TASK_COLORS.turnover.color}}>{floorData.turnover.length} üîÑ</span>}
                                                                            {floorData.checkout.length > 0 && <span style={{background: TASK_COLORS.checkout.bg, border: `1px solid ${TASK_COLORS.checkout.border}`, padding: '3px 8px', borderRadius: '8px', fontSize: '11px', color: TASK_COLORS.checkout.color}}>{floorData.checkout.length} üö™</span>}
                                                                            {floorData.stayover.length > 0 && <span style={{background: TASK_COLORS.stayover.bg, border: `1px solid ${TASK_COLORS.stayover.border}`, padding: '3px 8px', borderRadius: '8px', fontSize: '11px', color: TASK_COLORS.stayover.color}}>{floorData.stayover.length} üõèÔ∏è</span>}
                                                                            {floorData.checkin.length > 0 && <span style={{background: TASK_COLORS.checkin.bg, border: `1px solid ${TASK_COLORS.checkin.border}`, padding: '3px 8px', borderRadius: '8px', fontSize: '11px', color: TASK_COLORS.checkin.color}}>{floorData.checkin.length} üü¢</span>}
                                                                        </div>
                                                                    </div>
                                                                    
                                                                    {/* Staff Assignment */}
                                                                    <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                                                                        <span style={{fontSize: '12px', color: 'rgba(255,255,255,0.5)'}}>üë§ Assigned:</span>
                                                                        <input 
                                                                            type="text" 
                                                                            value={staffName}
                                                                            onChange={(e) => assignStaffToFloor(floor, e.target.value)}
                                                                            placeholder="Enter staff name"
                                                                            style={{
                                                                                padding: '8px 12px',
                                                                                background: staffName ? 'rgba(45,106,106,0.2)' : 'rgba(255,255,255,0.05)',
                                                                                border: staffName ? '1px solid rgba(45,106,106,0.4)' : '1px solid rgba(255,255,255,0.15)',
                                                                                borderRadius: '8px',
                                                                                color: '#fff',
                                                                                fontSize: '13px',
                                                                                width: '160px',
                                                                                outline: 'none'
                                                                            }}
                                                                        />
                                                                    </div>
                                                                </div>
                                                                
                                                                {/* Priority: Turnovers First */}
                                                                {floorData.turnover.length > 0 && (
                                                                    <div style={{marginBottom: '16px'}}>
                                                                        <div style={{fontSize: '12px', color: TASK_COLORS.turnover.color, marginBottom: '8px', fontWeight: '600'}}>üîÑ PRIORITY: Turnovers ({floorData.turnover.length})</div>
                                                                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(140px, 1fr))', gap: '10px'}}>
                                                                            {floorData.turnover.map(item => <TaskCard key={`to-${item.unit.n}`} item={item} type="turnover"/>)}
                                                                        </div>
                                                                    </div>
                                                                )}
                                                                
                                                                {/* Checkout Only */}
                                                                {floorData.checkout.length > 0 && (
                                                                    <div style={{marginBottom: '16px'}}>
                                                                        <div style={{fontSize: '12px', color: TASK_COLORS.checkout.color, marginBottom: '8px', fontWeight: '600'}}>üö™ Checkout Only ({floorData.checkout.length})</div>
                                                                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(140px, 1fr))', gap: '10px'}}>
                                                                            {floorData.checkout.map(item => <TaskCard key={`co-${item.unit.n}`} item={item} type="checkout"/>)}
                                                                        </div>
                                                                    </div>
                                                                )}
                                                                
                                                                {/* Stayover */}
                                                                {floorData.stayover.length > 0 && (
                                                                    <div style={{marginBottom: '16px'}}>
                                                                        <div style={{fontSize: '12px', color: TASK_COLORS.stayover.color, marginBottom: '8px', fontWeight: '600'}}>üõèÔ∏è Stayover Service ({floorData.stayover.length})</div>
                                                                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(140px, 1fr))', gap: '10px'}}>
                                                                            {floorData.stayover.map(item => <TaskCard key={`so-${item.unit.n}`} item={item} type="stayover"/>)}
                                                                        </div>
                                                                    </div>
                                                                )}
                                                                
                                                                {/* Check-in Ready */}
                                                                {floorData.checkin.length > 0 && (
                                                                    <div>
                                                                        <div style={{fontSize: '12px', color: TASK_COLORS.checkin.color, marginBottom: '8px', fontWeight: '600'}}>üü¢ Awaiting Check-in ({floorData.checkin.length})</div>
                                                                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(140px, 1fr))', gap: '10px'}}>
                                                                            {floorData.checkin.map(item => <TaskCard key={`ci-${item.unit.n}`} item={item} type="checkin"/>)}
                                                                        </div>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        );
                                                    })}
                                                    
                                                    {/* No tasks message */}
                                                    {(hkData.checkout.length + hkData.turnover.length + hkData.stayover.length + hkData.checkin.length) === 0 && (
                                                        <div style={{textAlign: 'center', padding: '60px 20px', color: 'rgba(255,255,255,0.4)'}}>
                                                            <div style={{fontSize: '48px', marginBottom: '16px'}}>‚ú®</div>
                                                            <div style={{fontSize: '18px', fontWeight: '600'}}>No housekeeping tasks for {hkDay}</div>
                                                            <div style={{fontSize: '13px', marginTop: '8px'}}>All rooms are in order</div>
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                            
                                            {/* ========== VIEW BY CATEGORY ========== */}
                                            {hkRoomBoardView === 'category' && (
                                                <div>
                                                    {/* Turnovers - Highest Priority */}
                                                    {hkData.turnover.length > 0 && (
                                                        <div style={{marginBottom: '24px', background: 'rgba(249,115,22,0.05)', borderRadius: '16px', padding: '20px', border: '1px solid rgba(249,115,22,0.2)'}}>
                                                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}}>
                                                                <div>
                                                                    <h4 style={{fontSize: '16px', fontWeight: '700', color: TASK_COLORS.turnover.color, margin: 0}}>üîÑ Turnovers - PRIORITY</h4>
                                                                    <p style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', margin: '4px 0 0 0'}}>{TASK_COLORS.turnover.desc}</p>
                                                                </div>
                                                                <div style={{fontSize: '28px', fontWeight: '700', color: TASK_COLORS.turnover.color}}>{hkData.turnover.length}</div>
                                                            </div>
                                                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(150px, 1fr))', gap: '12px'}}>
                                                                {hkData.turnover.map(item => <TaskCard key={`to-${item.unit.n}`} item={item} type="turnover"/>)}
                                                            </div>
                                                        </div>
                                                    )}
                                                    
                                                    {/* Checkouts Only */}
                                                    {hkData.checkout.length > 0 && (
                                                        <div style={{marginBottom: '24px', background: 'rgba(212,168,83,0.05)', borderRadius: '16px', padding: '20px', border: '1px solid rgba(212,168,83,0.2)'}}>
                                                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}}>
                                                                <div>
                                                                    <h4 style={{fontSize: '16px', fontWeight: '700', color: TASK_COLORS.checkout.color, margin: 0}}>üö™ Checkout Only</h4>
                                                                    <p style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', margin: '4px 0 0 0'}}>{TASK_COLORS.checkout.desc}</p>
                                                                </div>
                                                                <div style={{fontSize: '28px', fontWeight: '700', color: TASK_COLORS.checkout.color}}>{hkData.checkout.length}</div>
                                                            </div>
                                                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(150px, 1fr))', gap: '12px'}}>
                                                                {hkData.checkout.map(item => <TaskCard key={`co-${item.unit.n}`} item={item} type="checkout"/>)}
                                                            </div>
                                                        </div>
                                                    )}
                                                    
                                                    {/* Stayovers */}
                                                    {hkData.stayover.length > 0 && (
                                                        <div style={{marginBottom: '24px', background: 'rgba(14,165,233,0.05)', borderRadius: '16px', padding: '20px', border: '1px solid rgba(14,165,233,0.2)'}}>
                                                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}}>
                                                                <div>
                                                                    <h4 style={{fontSize: '16px', fontWeight: '700', color: TASK_COLORS.stayover.color, margin: 0}}>üõèÔ∏è Stayover Service</h4>
                                                                    <p style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', margin: '4px 0 0 0'}}>{TASK_COLORS.stayover.desc}</p>
                                                                </div>
                                                                <div style={{fontSize: '28px', fontWeight: '700', color: TASK_COLORS.stayover.color}}>{hkData.stayover.length}</div>
                                                            </div>
                                                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(150px, 1fr))', gap: '12px'}}>
                                                                {hkData.stayover.map(item => <TaskCard key={`so-${item.unit.n}`} item={item} type="stayover"/>)}
                                                            </div>
                                                        </div>
                                                    )}
                                                    
                                                    {/* Check-ins */}
                                                    {hkData.checkin.length > 0 && (
                                                        <div style={{marginBottom: '24px', background: 'rgba(45,106,106,0.05)', borderRadius: '16px', padding: '20px', border: '1px solid rgba(45,106,106,0.2)'}}>
                                                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}}>
                                                                <div>
                                                                    <h4 style={{fontSize: '16px', fontWeight: '700', color: TASK_COLORS.checkin.color, margin: 0}}>üü¢ Awaiting Check-in</h4>
                                                                    <p style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', margin: '4px 0 0 0'}}>{TASK_COLORS.checkin.desc}</p>
                                                                </div>
                                                                <div style={{fontSize: '28px', fontWeight: '700', color: TASK_COLORS.checkin.color}}>{hkData.checkin.length}</div>
                                                            </div>
                                                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(150px, 1fr))', gap: '12px'}}>
                                                                {hkData.checkin.map(item => <TaskCard key={`ci-${item.unit.n}`} item={item} type="checkin"/>)}
                                                            </div>
                                                        </div>
                                                    )}
                                                    
                                                    {/* No tasks message */}
                                                    {(hkData.checkout.length + hkData.turnover.length + hkData.stayover.length + hkData.checkin.length) === 0 && (
                                                        <div style={{textAlign: 'center', padding: '60px 20px', color: 'rgba(255,255,255,0.4)'}}>
                                                            <div style={{fontSize: '48px', marginBottom: '16px'}}>‚ú®</div>
                                                            <div style={{fontSize: '18px', fontWeight: '600'}}>No housekeeping tasks for {hkDay}</div>
                                                            <div style={{fontSize: '13px', marginTop: '8px'}}>All rooms are in order</div>
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                            
                                            {/* Room Status Section */}
                                            <div style={{marginTop: '32px', background: 'rgba(255,255,255,0.02)', borderRadius: '16px', padding: '20px', border: '1px solid rgba(255,255,255,0.08)'}}>
                                                <h3 style={{fontSize: '18px', fontWeight: '700', marginBottom: '16px', textAlign: 'center'}}>üè∑Ô∏è Room Status Tracker</h3>
                                                <p style={{color: 'rgba(255,255,255,0.5)', fontSize: '12px', marginBottom: '16px', textAlign: 'center'}}>Click any room to update its status</p>
                                                
                                                {/* Status Legend */}
                                                <div style={{display: 'flex', flexWrap: 'wrap', gap: '8px', marginBottom: '20px', justifyContent: 'center'}}>
                                                    {ROOM_STATUS_OPTIONS.map(opt => (
                                                        <div key={opt.key} style={{display: 'flex', alignItems: 'center', gap: '4px', background: opt.bg, border: `1px solid ${opt.border}`, borderRadius: '8px', padding: '4px 10px', fontSize: '11px'}}>
                                                            <span style={{color: opt.color}}>{opt.label.split(' ')[0]}</span>
                                                            <span style={{color: 'rgba(255,255,255,0.7)'}}>{opt.label.split(' ').slice(1).join(' ')}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                                
                                                {/* Rooms by Floor */}
                                                {FLOORS.map(floor => {
                                                    const floorRooms = allRooms.filter(r => r.floor === floor).sort((a, b) => parseInt(a.unit.n) - parseInt(b.unit.n));
                                                    return (
                                                        <div key={floor} style={{marginBottom: '20px'}}>
                                                            <h4 style={{fontSize: '14px', color: 'rgba(255,255,255,0.6)', marginBottom: '10px', borderBottom: '1px solid rgba(255,255,255,0.1)', paddingBottom: '6px'}}>Floor {floor} ({floorRooms.length} rooms)</h4>
                                                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(90px, 1fr))', gap: '10px'}}>
                                                                {floorRooms.map(({room, unit}) => {
                                                                    const statusInfo = getRoomStatusInfo(unit.n);
                                                                    const roomId = unit.n.toString();
                                                                    const hasOpenIssue = maintenanceIssues.some(i => i.room === roomId && i.status === 'open');
                                                                    const todayStr = getBDDate();
                                                                    const todayInspection = inspectionRecords[`${roomId}-${todayStr}`];
                                                                    const failedInspection = todayInspection && todayInspection.score < 80;
                                                                    const hasOverduePM = preventiveSchedule.some(p => p.room === roomId && new Date(p.nextDue) < new Date());
                                                                    return (
                                                                        <div 
                                                                            key={unit.n} 
                                                                            onClick={() => setRoomStatusModal({roomNum: unit.n, roomType: room.short})}
                                                                            style={{background: statusInfo.bg, border: `2px solid ${statusInfo.border}`, borderRadius: '12px', padding: '12px 8px', textAlign: 'center', cursor: 'pointer', transition: 'all 0.2s', position: 'relative'}}
                                                                            onMouseOver={(e) => {e.currentTarget.style.transform = 'scale(1.05)';}}
                                                                            onMouseOut={(e) => {e.currentTarget.style.transform = 'scale(1)';}}
                                                                        >
                                                                            {(hasOpenIssue || failedInspection || hasOverduePM) && (
                                                                                <div style={{position: 'absolute', top: '-6px', right: '-6px', display: 'flex', gap: '2px'}}>
                                                                                    {hasOpenIssue && <span title="Open maintenance issue" style={{background: '#ef4444', borderRadius: '50%', width: '18px', height: '18px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '10px'}}>üîß</span>}
                                                                                    {failedInspection && <span title="Failed inspection" style={{background: '#f97316', borderRadius: '50%', width: '18px', height: '18px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '10px'}}>‚ö†Ô∏è</span>}
                                                                                    {hasOverduePM && <span title="Overdue maintenance" style={{background: '#8b5cf6', borderRadius: '50%', width: '18px', height: '18px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '10px'}}>üìÖ</span>}
                                                                                </div>
                                                                            )}
                                                                            <div style={{fontSize: '22px', fontWeight: '700', color: statusInfo.color}}>{unit.n}</div>
                                                                            <div style={{fontSize: '10px', color: 'rgba(255,255,255,0.5)', marginTop: '2px'}}>{statusInfo.label.split(' ')[0]}</div>
                                                                        </div>
                                                                    );
                                                                })}
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                            
                                            {/* Room Status Modal */}
                                            {roomStatusModal && (
                                                <div style={{position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.7)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px'}} onClick={() => setRoomStatusModal(null)}>
                                                    <div style={{background: '#1E293B', borderRadius: '20px', padding: '24px', maxWidth: '400px', width: '100%', border: '1px solid rgba(255,255,255,0.1)'}} onClick={(e) => e.stopPropagation()}>
                                                        <h3 style={{fontSize: '20px', fontWeight: '700', marginBottom: '8px', textAlign: 'center'}}>Room {roomStatusModal.roomNum}</h3>
                                                        <p style={{color: 'rgba(255,255,255,0.5)', fontSize: '13px', marginBottom: '20px', textAlign: 'center'}}>{roomStatusModal.roomType}</p>
                                                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '10px'}}>
                                                            {ROOM_STATUS_OPTIONS.map(opt => (
                                                                <button key={opt.key} onClick={() => updateRoomStatus(roomStatusModal.roomNum, opt.key)} style={{background: opt.bg, border: `2px solid ${opt.border}`, borderRadius: '12px', padding: '14px 10px', color: '#fff', cursor: 'pointer', fontSize: '13px', fontWeight: '600'}}>
                                                                    <div style={{fontSize: '20px', marginBottom: '4px'}}>{opt.label.split(' ')[0]}</div>
                                                                    <div style={{color: opt.color}}>{opt.label.split(' ').slice(1).join(' ')}</div>
                                                                </button>
                                                            ))}
                                                        </div>
                                                        <button onClick={() => setRoomStatusModal(null)} style={{width: '100%', marginTop: '16px', padding: '12px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.2)', borderRadius: '10px', color: 'rgba(255,255,255,0.7)', cursor: 'pointer', fontSize: '14px'}}>Cancel</button>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })()}
                                
                                {/* ==================== TASKS ==================== */}
                                {hkTab === 'tasks' && (
                                    <div style={{background: 'rgba(255,255,255,0.02)', borderRadius: '16px', padding: '20px', border: '1px solid rgba(255,255,255,0.08)'}}>
                                        <h3 style={{fontSize: '18px', fontWeight: '700', marginBottom: '16px'}}>üõéÔ∏è Guest Requests {pendingReqs.length > 0 && <span style={{background: '#ef4444', padding: '4px 12px', borderRadius: '12px', fontSize: '13px', marginLeft: '8px'}}>{pendingReqs.length} pending</span>}</h3>
                                        
                                        <h4 style={{fontSize: '14px', color: '#f59e0b', marginBottom: '12px'}}>‚è≥ Pending</h4>
                                        {pendingReqs.length === 0 ? <div style={{color: 'rgba(255,255,255,0.4)', textAlign: 'center', padding: '20px'}}>No pending requests</div> : (
                                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))', gap: '12px', marginBottom: '24px'}}>
                                                {pendingReqs.map(req => (
                                                    <div key={req.id} style={{background: 'rgba(249,115,22,0.1)', border: '1px solid rgba(249,115,22,0.3)', borderRadius: '12px', padding: '14px'}}>
                                                        <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '10px'}}>
                                                            <div><div style={{fontSize: '20px', fontWeight: '700', color: '#f59e0b'}}>{req.roomNum}</div><div style={{fontSize: '13px', fontWeight: '600'}}>{req.guestName}</div></div>
                                                            <div style={{background: '#f59e0b', padding: '4px 10px', borderRadius: '8px', fontSize: '11px', fontWeight: '700', height: 'fit-content'}}>{req.requestType}</div>
                                                        </div>
                                                        {req.note && <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.6)', marginBottom: '10px', padding: '8px', background: 'rgba(0,0,0,0.2)', borderRadius: '6px'}}>{req.note}</div>}
                                                        <div style={{fontSize: '10px', color: 'rgba(255,255,255,0.4)', marginBottom: '10px'}}>Requested: {new Date(req.timestamp).toLocaleString()}</div>
                                                        <input id={"staff-" + req.id} placeholder="Enter staff name" defaultValue="" style={{width: '100%', padding: '10px', marginBottom: '10px', background: 'rgba(255,255,255,0.1)', border: '1px solid rgba(255,255,255,0.2)', borderRadius: '8px', color: '#fff', fontSize: '13px', boxSizing: 'border-box'}}/>
                                                        <div style={{display: 'flex', gap: '8px'}}>
                                                            <button onClick={() => handleRequestDone(req.id, false)} style={{flex: 1, padding: '10px', background: 'linear-gradient(145deg, #2D6A6A, #245858)', border: 'none', borderRadius: '8px', color: '#fff', fontWeight: '700', cursor: 'pointer', fontSize: '13px'}}>‚úì Done</button>
                                                            <button onClick={() => handleRequestDone(req.id, true)} style={{flex: 1, padding: '10px', background: 'linear-gradient(145deg, #ef4444, #dc2626)', border: 'none', borderRadius: '8px', color: '#fff', fontWeight: '700', cursor: 'pointer', fontSize: '13px'}}>‚úï Deny</button>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                        
                                        <h4 style={{fontSize: '14px', color: '#2D6A6A', marginBottom: '12px', marginTop: '20px'}}>‚úì Completed Today ({todayCompleted.length})</h4>
                                        {todayCompleted.length === 0 ? <div style={{color: 'rgba(255,255,255,0.4)', textAlign: 'center', padding: '20px'}}>No completed requests today</div> : (
                                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(250px, 1fr))', gap: '10px'}}>
                                                {todayCompleted.map(req => (
                                                    <div key={req.id} style={{background: req.denied ? 'rgba(239,68,68,0.1)' : 'rgba(45,106,106,0.1)', border: '1px solid ' + (req.denied ? 'rgba(239,68,68,0.3)' : 'rgba(45,106,106,0.3)'), borderRadius: '10px', padding: '12px', display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                                        <div><div style={{fontWeight: '600'}}>{req.roomNum} - {req.requestType}</div><div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)'}}>By: {req.doneBy || 'Staff'}</div></div>
                                                        <div style={{color: req.denied ? '#ef4444' : '#2D6A6A', fontWeight: '700', fontSize: '14px'}}>{req.denied ? '‚úï' : '‚úì'}</div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                )}
                                
                                {/* ==================== INSPECTIONS ==================== */}
                                {/* ==================== MAINTENANCE ISSUES ==================== */}
                                {hkTab === 'issues' && (() => {
                                    const addIssue = (room, category, description, priority, reportedBy) => {
                                        const newIssue = {
                                            id: Date.now().toString(),
                                            room, category, description, priority,
                                            status: 'open', reportedBy, assignedTo: '',
                                            createdAt: new Date().toISOString()
                                        };
                                        saveMaintenanceIssues([...maintenanceIssues, newIssue]);
                                        setShowAddIssue(false);
                                    };
                                    
                                    const updateIssueStatus = (id, status) => {
                                        const updated = maintenanceIssues.map(i => i.id===id ? {...i, status, resolvedAt: status==='resolved'?new Date().toISOString():null} : i);
                                        saveMaintenanceIssues(updated);
                                    };
                                    
                                    const filteredIssues = maintenanceIssues.filter(i => issueFilter==='all' || i.status===issueFilter);
                                    
                                    return (
                                    <div style={{background: 'rgba(255,255,255,0.02)', borderRadius: '16px', padding: '20px', border: '1px solid rgba(255,255,255,0.08)'}}>
                                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'20px',flexWrap:'wrap',gap:'12px'}}>
                                            <h3 style={{fontSize: '18px', fontWeight: '700'}}>üõ†Ô∏è Maintenance Issues</h3>
                                            <button onClick={()=>setShowAddIssue(true)} style={{padding:'10px 20px',background:'linear-gradient(135deg,#f97316,#ea580c)',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'600',cursor:'pointer'}}>‚ûï Report Issue</button>
                                        </div>
                                        
                                        <div style={{display:'flex',gap:'8px',marginBottom:'20px'}}>
                                            {['open','in-progress','resolved','all'].map(f => (
                                                <button key={f} onClick={()=>setIssueFilter(f)} style={{padding:'8px 16px',borderRadius:'8px',border:issueFilter===f?'2px solid #f97316':'1px solid rgba(255,255,255,0.15)',background:issueFilter===f?'rgba(249,115,22,0.2)':'transparent',color:issueFilter===f?'#f97316':'rgba(255,255,255,0.6)',cursor:'pointer',fontSize:'12px',textTransform:'capitalize'}}>{f.replace('-',' ')} ({maintenanceIssues.filter(i=>f==='all'||i.status===f).length})</button>
                                            ))}
                                        </div>
                                        
                                        {showAddIssue && (
                                                <div style={{background:'rgba(249,115,22,0.1)',borderRadius:'12px',padding:'20px',marginBottom:'20px',border:'1px solid rgba(249,115,22,0.3)'}}>
                                                    <h4 style={{marginBottom:'16px',color:'#f97316'}}>‚ûï Report New Issue</h4>
                                                    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(150px,1fr))',gap:'12px',marginBottom:'12px'}}>
                                                        <input placeholder="Room #" value={issueFormRoom} onChange={e=>setIssueFormRoom(e.target.value)} style={{padding:'10px',background:'rgba(255,255,255,0.08)',border:'1px solid rgba(255,255,255,0.15)',borderRadius:'8px',color:'#fff'}}/>
                                                        <select value={issueFormCategory || issueCategories[0]} onChange={e=>setIssueFormCategory(e.target.value)} style={{padding:'10px',background:'rgba(255,255,255,0.08)',border:'1px solid rgba(255,255,255,0.15)',borderRadius:'8px',color:'#fff'}}>{issueCategories.map(c=><option key={c} value={c}>{c}</option>)}</select>
                                                        <select value={issueFormPriority} onChange={e=>setIssueFormPriority(e.target.value)} style={{padding:'10px',background:'rgba(255,255,255,0.08)',border:'1px solid rgba(255,255,255,0.15)',borderRadius:'8px',color:'#fff'}}><option value="low">üü¢ Low</option><option value="medium">üü° Medium</option><option value="high">üî¥ High</option><option value="urgent">üö® Urgent</option></select>
                                                        <input placeholder="Reported by" value={issueFormReporter} onChange={e=>setIssueFormReporter(e.target.value)} style={{padding:'10px',background:'rgba(255,255,255,0.08)',border:'1px solid rgba(255,255,255,0.15)',borderRadius:'8px',color:'#fff'}}/>
                                                    </div>
                                                    <textarea placeholder="Describe the issue..." value={issueFormDesc} onChange={e=>setIssueFormDesc(e.target.value)} style={{width:'100%',padding:'10px',background:'rgba(255,255,255,0.08)',border:'1px solid rgba(255,255,255,0.15)',borderRadius:'8px',color:'#fff',minHeight:'80px',marginBottom:'12px',boxSizing:'border-box'}}/>
                                                    <div style={{display:'flex',gap:'12px'}}>
                                                        <button onClick={()=>{if(!issueFormRoom||!issueFormDesc){alert('Fill room and description');return;}addIssue(issueFormRoom,issueFormCategory||issueCategories[0],issueFormDesc,issueFormPriority,issueFormReporter);setIssueFormRoom('');setIssueFormDesc('');setIssueFormReporter('');}} style={{padding:'10px 20px',background:'#f97316',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'600',cursor:'pointer'}}>Submit Issue</button>
                                                        <button onClick={()=>setShowAddIssue(false)} style={{padding:'10px 20px',background:'rgba(255,255,255,0.1)',border:'none',borderRadius:'8px',color:'#fff',cursor:'pointer'}}>Cancel</button>
                                                    </div>
                                                </div>
                                        )}
                                        
                                        <div style={{display:'grid',gap:'12px'}}>
                                            {filteredIssues.length === 0 ? (
                                                <div style={{textAlign:'center',padding:'40px',color:'rgba(255,255,255,0.4)'}}>No {issueFilter} issues</div>
                                            ) : filteredIssues.map(issue => (
                                                <div key={issue.id} style={{padding:'16px',background:'rgba(255,255,255,0.03)',borderRadius:'10px',border:'1px solid rgba(255,255,255,0.08)'}}>
                                                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:'8px'}}>
                                                        <div style={{display:'flex',alignItems:'center',gap:'10px'}}>
                                                            <span style={{fontSize:'18px',fontWeight:'700',color:'#2D6A6A'}}>Room {issue.room}</span>
                                                            <span style={{padding:'4px 10px',borderRadius:'12px',fontSize:'11px',background:issue.priority==='urgent'?'rgba(239,68,68,0.3)':issue.priority==='high'?'rgba(239,68,68,0.2)':issue.priority==='medium'?'rgba(249,115,22,0.2)':'rgba(34,197,94,0.2)',color:issue.priority==='urgent'||issue.priority==='high'?'#ef4444':issue.priority==='medium'?'#f97316':'#22c55e'}}>{issue.priority.toUpperCase()}</span>
                                                            <span style={{padding:'4px 10px',borderRadius:'12px',fontSize:'11px',background:'rgba(255,255,255,0.1)'}}>{issue.category}</span>
                                                        </div>
                                                        <select value={issue.status} onChange={e=>updateIssueStatus(issue.id,e.target.value)} style={{padding:'6px 12px',background:'rgba(255,255,255,0.1)',border:'1px solid rgba(255,255,255,0.2)',borderRadius:'6px',color:'#fff',fontSize:'12px'}}>
                                                            <option value="open">üî¥ Open</option>
                                                            <option value="in-progress">üü° In Progress</option>
                                                            <option value="resolved">üü¢ Resolved</option>
                                                        </select>
                                                    </div>
                                                    <div style={{color:'rgba(255,255,255,0.8)',marginBottom:'8px'}}>{issue.description}</div>
                                                    <div style={{fontSize:'11px',color:'rgba(255,255,255,0.4)'}}>Reported by {issue.reportedBy || 'Unknown'} ‚Ä¢ {new Date(issue.createdAt).toLocaleDateString()}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    );
                                })()}
                                
                                {/* ==================== PREVENTIVE MAINTENANCE ==================== */}
                                {/* ==================== LINEN ==================== */}
                                {/* ==================== AMENITIES ==================== */}
                                {/* ==================== LOST & FOUND ==================== */}
                                {hkTab === 'lostfound' && (() => {
                                    const addLostItem = (item, room, category, foundBy, description) => {
                                        const newItem = {
                                            id: Date.now().toString(),
                                            item, room, category, foundBy, description,
                                            status: 'unclaimed', claimedBy: '',
                                            foundAt: new Date().toISOString()
                                        };
                                        saveLostFoundItems([...lostFoundItems, newItem]);
                                        setShowAddLfItem(false);
                                    };
                                    
                                    const markClaimed = (id, claimedBy) => {
                                        const updated = lostFoundItems.map(i => i.id===id ? {...i, status:'claimed', claimedBy, claimedAt: new Date().toISOString()} : i);
                                        saveLostFoundItems(updated);
                                    };
                                    
                                    const deleteItem = (id) => {
                                        if(confirm('Delete this item?')) saveLostFoundItems(lostFoundItems.filter(i=>i.id!==id));
                                    };
                                    
                                    const filtered = lostFoundItems.filter(i => lfFilter==='all' || i.status===lfFilter).sort((a,b) => new Date(b.foundAt) - new Date(a.foundAt));
                                    
                                    return (
                                    <div style={{background: 'rgba(255,255,255,0.02)', borderRadius: '16px', padding: '20px', border: '1px solid rgba(255,255,255,0.08)'}}>
                                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'20px',flexWrap:'wrap',gap:'12px'}}>
                                            <h3 style={{fontSize: '18px', fontWeight: '700'}}>üîç Lost & Found</h3>
                                            <button onClick={()=>setShowAddLfItem(true)} style={{padding:'10px 20px',background:'linear-gradient(135deg,#ec4899,#db2777)',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'600',cursor:'pointer'}}>‚ûï Register Item</button>
                                        </div>
                                        
                                        <div style={{display:'flex',gap:'8px',marginBottom:'20px'}}>
                                            {['unclaimed','claimed','all'].map(f => (
                                                <button key={f} onClick={()=>setLfFilter(f)} style={{padding:'8px 16px',borderRadius:'8px',border:lfFilter===f?'2px solid #ec4899':'1px solid rgba(255,255,255,0.15)',background:lfFilter===f?'rgba(236,72,153,0.2)':'transparent',color:lfFilter===f?'#ec4899':'rgba(255,255,255,0.6)',cursor:'pointer',fontSize:'12px',textTransform:'capitalize'}}>{f} ({lostFoundItems.filter(i=>f==='all'||i.status===f).length})</button>
                                            ))}
                                        </div>
                                        
                                        {showAddLfItem && (
                                                <div style={{background:'rgba(236,72,153,0.1)',borderRadius:'12px',padding:'20px',marginBottom:'20px',border:'1px solid rgba(236,72,153,0.3)'}}>
                                                    <h4 style={{marginBottom:'16px',color:'#ec4899'}}>‚ûï Register Found Item</h4>
                                                    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(150px,1fr))',gap:'12px',marginBottom:'12px'}}>
                                                        <input placeholder="Item name *" value={lfFormItem} onChange={e=>setLfFormItem(e.target.value)} style={{padding:'10px',background:'rgba(255,255,255,0.08)',border:'1px solid rgba(255,255,255,0.15)',borderRadius:'8px',color:'#fff'}}/>
                                                        <input placeholder="Room found in" value={lfFormRoom} onChange={e=>setLfFormRoom(e.target.value)} style={{padding:'10px',background:'rgba(255,255,255,0.08)',border:'1px solid rgba(255,255,255,0.15)',borderRadius:'8px',color:'#fff'}}/>
                                                        <select value={lfFormCategory || lfCategories[0]} onChange={e=>setLfFormCategory(e.target.value)} style={{padding:'10px',background:'rgba(255,255,255,0.08)',border:'1px solid rgba(255,255,255,0.15)',borderRadius:'8px',color:'#fff'}}>{lfCategories.map(c=><option key={c} value={c}>{c}</option>)}</select>
                                                        <input placeholder="Found by" value={lfFormFoundBy} onChange={e=>setLfFormFoundBy(e.target.value)} style={{padding:'10px',background:'rgba(255,255,255,0.08)',border:'1px solid rgba(255,255,255,0.15)',borderRadius:'8px',color:'#fff'}}/>
                                                    </div>
                                                    <textarea placeholder="Description (color, brand, condition...)" value={lfFormDesc} onChange={e=>setLfFormDesc(e.target.value)} style={{width:'100%',padding:'10px',background:'rgba(255,255,255,0.08)',border:'1px solid rgba(255,255,255,0.15)',borderRadius:'8px',color:'#fff',minHeight:'60px',marginBottom:'12px',boxSizing:'border-box'}}/>
                                                    <div style={{display:'flex',gap:'12px'}}>
                                                        <button onClick={()=>{if(!lfFormItem){alert('Enter item name');return;}addLostItem(lfFormItem,lfFormRoom,lfFormCategory||lfCategories[0],lfFormFoundBy,lfFormDesc);setLfFormItem('');setLfFormRoom('');setLfFormFoundBy('');setLfFormDesc('');}} style={{padding:'10px 20px',background:'#ec4899',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'600',cursor:'pointer'}}>Register Item</button>
                                                        <button onClick={()=>setShowAddLfItem(false)} style={{padding:'10px 20px',background:'rgba(255,255,255,0.1)',border:'none',borderRadius:'8px',color:'#fff',cursor:'pointer'}}>Cancel</button>
                                                    </div>
                                                </div>
                                        )}
                                        
                                        <div style={{display:'grid',gap:'12px'}}>
                                            {filtered.length === 0 ? (
                                                <div style={{textAlign:'center',padding:'40px',color:'rgba(255,255,255,0.4)'}}>No {lfFilter} items</div>
                                            ) : filtered.map(lfItem => (
                                                <div key={lfItem.id} style={{padding:'16px',background:'rgba(255,255,255,0.03)',borderRadius:'10px',border:'1px solid rgba(255,255,255,0.08)'}}>
                                                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:'8px'}}>
                                                        <div>
                                                            <div style={{display:'flex',alignItems:'center',gap:'10px',marginBottom:'4px'}}>
                                                                <span style={{fontSize:'16px',fontWeight:'700'}}>{lfItem.item}</span>
                                                                <span style={{padding:'4px 10px',borderRadius:'12px',fontSize:'11px',background:'rgba(236,72,153,0.2)',color:'#ec4899'}}>{lfItem.category}</span>
                                                                <span style={{padding:'4px 10px',borderRadius:'12px',fontSize:'11px',background:lfItem.status==='claimed'?'rgba(34,197,94,0.2)':'rgba(249,115,22,0.2)',color:lfItem.status==='claimed'?'#22c55e':'#f97316'}}>{lfItem.status}</span>
                                                            </div>
                                                            {lfItem.description && <div style={{color:'rgba(255,255,255,0.7)',fontSize:'13px',marginBottom:'4px'}}>{lfItem.description}</div>}
                                                            <div style={{fontSize:'11px',color:'rgba(255,255,255,0.4)'}}>Room {lfItem.room || 'N/A'} ‚Ä¢ Found by {lfItem.foundBy || 'Unknown'} ‚Ä¢ {new Date(lfItem.foundAt).toLocaleDateString()}</div>
                                                        </div>
                                                        <div style={{display:'flex',gap:'8px'}}>
                                                            {lfItem.status === 'unclaimed' && (
                                                                <button onClick={()=>{const name=prompt('Guest name claiming item:');if(name)markClaimed(lfItem.id,name);}} style={{padding:'8px 12px',background:'#22c55e',border:'none',borderRadius:'6px',color:'#fff',cursor:'pointer',fontSize:'12px'}}>‚úì Claimed</button>
                                                            )}
                                                            <button onClick={()=>deleteItem(lfItem.id)} style={{padding:'8px 12px',background:'rgba(239,68,68,0.2)',border:'none',borderRadius:'6px',color:'#ef4444',cursor:'pointer',fontSize:'12px'}}>üóëÔ∏è</button>
                                                        </div>
                                                    </div>
                                                    {lfItem.status === 'claimed' && <div style={{fontSize:'11px',color:'#22c55e',marginTop:'4px'}}>Claimed by: {lfItem.claimedBy} on {new Date(lfItem.claimedAt).toLocaleDateString()}</div>}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    );
                                })()}
                                
                                {/* ==================== STAFF ==================== */}
                                {/* ==================== REPORTS ==================== */}
                                </>)}
                                
                                {/* ========== ADMIN MODE ========== */}
                                {hkMode === 'admin' && (() => {
                                    // Get HK data for selected admin date
                                    const adminHkData = adminDate === today ? hkDataToday : adminDate === tomorrow ? hkDataTomorrow : {checkout:[], turnover:[], stayover:[], checkin:[]};
                                    
                                    // Get floor task counts for workload display
                                    const getFloorWorkload = (floor) => {
                                        const floorRooms = allRooms.filter(r => r.floor === floor);
                                        const checkout = adminHkData.checkout.filter(c => floorRooms.some(fr => fr.unit.n === c.unit.n)).length;
                                        const turnover = adminHkData.turnover.filter(t => floorRooms.some(fr => fr.unit.n === t.unit.n)).length;
                                        const stayover = adminHkData.stayover.filter(s => floorRooms.some(fr => fr.unit.n === s.unit.n)).length;
                                        const checkin = adminHkData.checkin.filter(c => floorRooms.some(fr => fr.unit.n === c.unit.n)).length;
                                        return { checkout, turnover, stayover, checkin, total: checkout + turnover + stayover + checkin, rooms: floorRooms.length };
                                    };
                                    
                                    // Get assigned staff for a floor on a date
                                    const getFloorAssignedStaff = (floor) => {
                                        const dateAssigns = dailyAssignments[adminDate] || {};
                                        return dateAssigns[floor] || [];
                                    };
                                    
                                    // Toggle staff assignment to floor
                                    const toggleStaffFloor = (staffId, floor) => {
                                        const dateAssigns = dailyAssignments[adminDate] || {};
                                        const floorStaff = dateAssigns[floor] || [];
                                        const newFloorStaff = floorStaff.includes(staffId) ? floorStaff.filter(id => id !== staffId) : [...floorStaff, staffId];
                                        const updated = { ...dailyAssignments, [adminDate]: { ...dateAssigns, [floor]: newFloorStaff } };
                                        saveDailyAssignments(updated);
                                    };
                                    
                                    // Get staff name by ID
                                    const getStaffName = (id) => hkStaffList.find(s => s.id === id)?.name || 'Unknown';
                                    
                                    // Copy assignments from one date to another
                                    const copyAssignments = (fromDate, toDate) => {
                                        const fromAssigns = dailyAssignments[fromDate];
                                        if (!fromAssigns) return alert('No assignments on ' + fromDate);
                                        const updated = { ...dailyAssignments, [toDate]: { ...fromAssigns } };
                                        saveDailyAssignments(updated);
                                        alert('Copied assignments from ' + fromDate + ' to ' + toDate);
                                    };
                                    
                                    const inputStyle = {padding:'12px',background:'rgba(255,255,255,0.08)',border:'1px solid rgba(255,255,255,0.15)',borderRadius:'8px',color:'#fff',fontSize:'14px'};
                                    const cardStyle = {background:'rgba(255,255,255,0.02)',borderRadius:'16px',padding:'20px',border:'1px solid rgba(255,255,255,0.08)'};
                                    
                                    return (
                                    <div>
                                        {/* Admin Sub-tabs */}
                                        <div style={{display: 'flex', gap: '8px', marginBottom: '24px', flexWrap: 'wrap'}}>
                                            {[{id:'assignments',label:'üìÖ Assignments'},{id:'staff',label:'üë• Staff'},{id:'roomsetup',label:'üè® Room Setup'},{id:'checklists',label:'‚úÖ Checklists'},{id:'requests',label:'üìã Requests'},{id:'issues',label:'üõ†Ô∏è Issues'},{id:'lostfound',label:'üîç Lost&Found'},{id:'settings',label:'‚öôÔ∏è Settings'},{id:'sync',label:'‚òÅÔ∏è Sync'}].map(t=>(
                                                <button key={t.id} onClick={()=>setHkAdminTab(t.id)} style={{padding:'12px 20px',borderRadius:'10px',border:hkAdminTab===t.id?'2px solid #D4A853':'1px solid rgba(255,255,255,0.15)',background:hkAdminTab===t.id?'rgba(212,168,83,0.2)':'rgba(255,255,255,0.03)',color:hkAdminTab===t.id?'#D4A853':'rgba(255,255,255,0.7)',fontWeight:hkAdminTab===t.id?'700':'500',cursor:'pointer',fontSize:'13px'}}>{t.label}</button>
                                            ))}
                                        </div>
                                        
                                        {/* ========== DAILY ASSIGNMENTS ========== */}
                                        {hkAdminTab === 'assignments' && (
                                            <div style={cardStyle}>
                                                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'20px',flexWrap:'wrap',gap:'12px'}}>
                                                    <h3 style={{fontSize:'18px',fontWeight:'700'}}>üìÖ Daily Floor Assignments</h3>
                                                    <div style={{display:'flex',gap:'8px',alignItems:'center'}}>
                                                        <input type="date" value={adminDate} onChange={e=>setAdminDate(e.target.value)} style={{...inputStyle,cursor:'pointer'}}/>
                                                        <button onClick={()=>setAdminDate(today)} style={{padding:'10px 16px',background:adminDate===today?'#2D6A6A':'rgba(255,255,255,0.1)',border:'none',borderRadius:'8px',color:'#fff',cursor:'pointer',fontSize:'12px'}}>Today</button>
                                                        <button onClick={()=>setAdminDate(tomorrow)} style={{padding:'10px 16px',background:adminDate===tomorrow?'#2D6A6A':'rgba(255,255,255,0.1)',border:'none',borderRadius:'8px',color:'#fff',cursor:'pointer',fontSize:'12px'}}>Tomorrow</button>
                                                    </div>
                                                </div>
                                                
                                                <div style={{background:'rgba(212,168,83,0.1)',padding:'12px 16px',borderRadius:'10px',marginBottom:'20px',display:'flex',justifyContent:'space-between',alignItems:'center',flexWrap:'wrap',gap:'12px'}}>
                                                    <div style={{fontSize:'13px',color:'#D4A853'}}>üí° Click staff names to assign/unassign. Multiple staff per floor supported.</div>
                                                    <button onClick={()=>copyAssignments(today, tomorrow)} style={{padding:'8px 16px',background:'rgba(255,255,255,0.1)',border:'1px solid rgba(255,255,255,0.2)',borderRadius:'8px',color:'#fff',cursor:'pointer',fontSize:'12px'}}>üìã Copy Today ‚Üí Tomorrow</button>
                                                </div>
                                                
                                                <div style={{display:'grid',gap:'16px'}}>
                                                    {FLOORS.map(f => {
                                                        const workload = getFloorWorkload(f);
                                                        const assignedIds = getFloorAssignedStaff(f);
                                                        const workPressure = workload.total > 8 ? 'high' : workload.total > 4 ? 'medium' : 'low';
                                                        return (
                                                            <div key={f} style={{background:'rgba(255,255,255,0.03)',borderRadius:'12px',padding:'16px',border:'1px solid rgba(255,255,255,0.1)'}}>
                                                                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'12px',flexWrap:'wrap',gap:'8px'}}>
                                                                    <div style={{display:'flex',alignItems:'center',gap:'12px'}}>
                                                                        <h4 style={{fontSize:'16px',fontWeight:'700',color:'#2D6A6A',margin:0}}>Floor {f}</h4>
                                                                        <span style={{padding:'4px 10px',borderRadius:'12px',fontSize:'11px',background:workPressure==='high'?'rgba(239,68,68,0.2)':workPressure==='medium'?'rgba(249,115,22,0.2)':'rgba(34,197,94,0.2)',color:workPressure==='high'?'#ef4444':workPressure==='medium'?'#f97316':'#22c55e'}}>{workPressure.toUpperCase()} ({workload.total} tasks)</span>
                                                                    </div>
                                                                    <div style={{display:'flex',gap:'6px',fontSize:'11px'}}>
                                                                        {workload.turnover > 0 && <span style={{padding:'3px 8px',borderRadius:'8px',background:'rgba(249,115,22,0.2)',color:'#f97316'}}>üîÑ {workload.turnover}</span>}
                                                                        {workload.checkout > 0 && <span style={{padding:'3px 8px',borderRadius:'8px',background:'rgba(212,168,83,0.2)',color:'#D4A853'}}>üö™ {workload.checkout}</span>}
                                                                        {workload.stayover > 0 && <span style={{padding:'3px 8px',borderRadius:'8px',background:'rgba(14,165,233,0.2)',color:'#0ea5e9'}}>üõèÔ∏è {workload.stayover}</span>}
                                                                        {workload.checkin > 0 && <span style={{padding:'3px 8px',borderRadius:'8px',background:'rgba(45,106,106,0.2)',color:'#2D6A6A'}}>üü¢ {workload.checkin}</span>}
                                                                    </div>
                                                                </div>
                                                                
                                                                {assignedIds.length > 0 && (
                                                                    <div style={{marginBottom:'12px',padding:'10px',background:'rgba(45,106,106,0.1)',borderRadius:'8px'}}>
                                                                        <div style={{fontSize:'11px',color:'rgba(255,255,255,0.5)',marginBottom:'6px'}}>ASSIGNED:</div>
                                                                        <div style={{display:'flex',flexWrap:'wrap',gap:'6px'}}>
                                                                            {assignedIds.map(id => <span key={id} style={{padding:'4px 10px',borderRadius:'12px',background:'#2D6A6A',color:'#fff',fontSize:'12px',fontWeight:'600'}}>{getStaffName(id)}</span>)}
                                                                        </div>
                                                                    </div>
                                                                )}
                                                                
                                                                <div style={{display:'flex',flexWrap:'wrap',gap:'8px'}}>
                                                                    {hkStaffList.filter(s=>s.role!=='manager').length === 0 ? (
                                                                        <span style={{color:'rgba(255,255,255,0.4)',fontSize:'12px'}}>Add staff members first</span>
                                                                    ) : hkStaffList.filter(s=>s.role!=='manager').map(s => {
                                                                        const isAssigned = assignedIds.includes(s.id);
                                                                        return (
                                                                            <button key={s.id} onClick={()=>toggleStaffFloor(s.id,f)} style={{padding:'8px 14px',borderRadius:'20px',border:isAssigned?'2px solid #2D6A6A':'1px solid rgba(255,255,255,0.2)',background:isAssigned?'rgba(45,106,106,0.3)':'transparent',color:isAssigned?'#fff':'rgba(255,255,255,0.6)',cursor:'pointer',fontSize:'12px',fontWeight:isAssigned?'600':'400'}}>{isAssigned?'‚úì ':''}{s.name}</button>
                                                                        );
                                                                    })}
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                                
                                                {/* Staff workload summary */}
                                                <div style={{marginTop:'24px',padding:'16px',background:'rgba(255,255,255,0.03)',borderRadius:'12px',border:'1px solid rgba(255,255,255,0.1)'}}>
                                                    <h4 style={{fontSize:'14px',fontWeight:'600',marginBottom:'12px'}}>üë• Staff Workload for {adminDate === today ? 'Today' : adminDate === tomorrow ? 'Tomorrow' : adminDate}</h4>
                                                    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(200px,1fr))',gap:'10px'}}>
                                                        {hkStaffList.filter(s=>s.role!=='manager').map(s => {
                                                            const assignedFloors = FLOORS.filter(f => (dailyAssignments[adminDate]?.[f] || []).includes(s.id));
                                                            const totalTasks = assignedFloors.reduce((sum, f) => sum + getFloorWorkload(f).total, 0);
                                                            return (
                                                                <div key={s.id} style={{padding:'12px',background:'rgba(255,255,255,0.03)',borderRadius:'8px',border:'1px solid rgba(255,255,255,0.08)'}}>
                                                                    <div style={{fontWeight:'600',marginBottom:'4px'}}>{s.name}</div>
                                                                    <div style={{fontSize:'12px',color:'rgba(255,255,255,0.5)'}}>
                                                                        {assignedFloors.length === 0 ? 'Not assigned' : `Floors: ${assignedFloors.join(', ')} ‚Ä¢ ${totalTasks} tasks`}
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                        
                                        {/* ========== STAFF MANAGEMENT ========== */}
                                        {hkAdminTab === 'staff' && (
                                            <div style={cardStyle}>
                                                <h3 style={{fontSize:'18px',fontWeight:'700',marginBottom:'20px'}}>üë• Staff Management</h3>
                                                
                                                <div style={{background:'rgba(255,255,255,0.03)',borderRadius:'12px',padding:'16px',marginBottom:'20px',border:'1px solid rgba(255,255,255,0.1)'}}>
                                                    <h4 style={{fontSize:'14px',fontWeight:'600',marginBottom:'16px',color:'#D4A853'}}>‚ûï Add New Staff</h4>
                                                    <div style={{display:'flex',gap:'12px',flexWrap:'wrap'}}>
                                                        <input id="hkNewName" placeholder="Full Name *" style={{...inputStyle,flex:'1 1 200px'}}/>
                                                        <input id="hkNewPhone" placeholder="Phone" style={{...inputStyle,flex:'1 1 150px'}}/>
                                                        <select id="hkNewRole" style={{...inputStyle,flex:'1 1 150px',cursor:'pointer'}}>
                                                            <option value="cleaner">üßπ Cleaner</option>
                                                            <option value="supervisor">üëî Supervisor</option>
                                                            <option value="manager">üëë Manager</option>
                                                        </select>
                                                        <button onClick={()=>{
                                                            const n=document.getElementById('hkNewName').value.trim();
                                                            const p=document.getElementById('hkNewPhone').value.trim();
                                                            const r=document.getElementById('hkNewRole').value;
                                                            if(!n) return alert('Enter name');
                                                            const newStaff = {id:Date.now().toString(), name:n, phone:p, role:r, active:true, createdAt:new Date().toISOString()};
                                                            saveHkStaffList([...hkStaffList, newStaff]);
                                                            document.getElementById('hkNewName').value='';
                                                            document.getElementById('hkNewPhone').value='';
                                                        }} style={{padding:'12px 24px',background:'linear-gradient(135deg,#D4A853,#B8942F)',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'700',cursor:'pointer'}}>‚ûï Add Staff</button>
                                                    </div>
                                                </div>
                                                
                                                <div style={{display:'grid',gap:'12px'}}>
                                                    {hkStaffList.length === 0 ? (
                                                        <div style={{textAlign:'center',padding:'40px',color:'rgba(255,255,255,0.4)'}}>
                                                            <div style={{fontSize:'32px',marginBottom:'8px'}}>üë•</div>
                                                            <div>No staff members yet. Add your first team member above.</div>
                                                        </div>
                                                    ) : hkStaffList.map(s => (
                                                        <div key={s.id} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'14px 16px',background:'rgba(255,255,255,0.03)',borderRadius:'10px',border:'1px solid rgba(255,255,255,0.08)'}}>
                                                            <div style={{flex:1}}>
                                                                <div style={{display:'flex',alignItems:'center',gap:'10px',marginBottom:'4px'}}>
                                                                    <span style={{fontWeight:'600',fontSize:'15px'}}>{s.name}</span>
                                                                    <span style={{padding:'3px 10px',borderRadius:'12px',fontSize:'11px',background:s.role==='manager'?'rgba(212,168,83,0.2)':s.role==='supervisor'?'rgba(45,106,106,0.2)':'rgba(255,255,255,0.1)',color:s.role==='manager'?'#D4A853':s.role==='supervisor'?'#2D6A6A':'rgba(255,255,255,0.7)'}}>{s.role==='cleaner'?'üßπ':s.role==='supervisor'?'üëî':'üëë'} {s.role}</span>
                                                                </div>
                                                                {s.phone && <div style={{fontSize:'12px',color:'rgba(255,255,255,0.5)'}}>üìû {s.phone}</div>}
                                                            </div>
                                                            <button onClick={()=>{if(confirm('Remove '+s.name+'?')){saveHkStaffList(hkStaffList.filter(x=>x.id!==s.id));}}} style={{padding:'8px 12px',background:'rgba(239,68,68,0.2)',border:'none',borderRadius:'6px',color:'#ef4444',cursor:'pointer',fontSize:'12px'}}>üóëÔ∏è Remove</button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                        
                                        {/* ========== ROOM SETUP - Configure room types with amenities/linens ========== */}
                                        {hkAdminTab === 'roomsetup' && (
                                            <div style={cardStyle}>
                                                <h3 style={{fontSize:'18px',fontWeight:'700',marginBottom:'8px'}}>üè® Room Setup</h3>
                                                <p style={{color:'rgba(255,255,255,0.5)',marginBottom:'20px',fontSize:'13px'}}>Define what amenities and linens each room type requires</p>
                                                
                                                {Object.entries(roomConfigs).map(([roomType, config]) => (
                                                    <div key={roomType} style={{background:'rgba(255,255,255,0.03)',borderRadius:'12px',padding:'16px',marginBottom:'16px',border:'1px solid rgba(255,255,255,0.1)'}}>
                                                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'16px'}}>
                                                            <h4 style={{fontSize:'15px',fontWeight:'600',color:'#2D6A6A'}}>{roomType}</h4>
                                                            <div style={{display:'flex',gap:'8px',fontSize:'12px',color:'rgba(255,255,255,0.5)'}}>
                                                                <span>{config.beds} bed(s)</span>
                                                                <span>‚Ä¢</span>
                                                                <span>{config.bedType}</span>
                                                                <span>‚Ä¢</span>
                                                                <span>Max {config.maxOccupancy} guests</span>
                                                            </div>
                                                        </div>
                                                        
                                                        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'16px'}}>
                                                            {/* Amenities */}
                                                            <div>
                                                                <h5 style={{fontSize:'12px',fontWeight:'600',marginBottom:'10px',color:'#22c55e'}}>üß¥ Amenities</h5>
                                                                <div style={{display:'grid',gap:'6px'}}>
                                                                    {Object.entries(config.amenities || {}).map(([item, qty]) => (
                                                                        <div key={item} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'8px 12px',background:'rgba(34,197,94,0.1)',borderRadius:'6px',fontSize:'12px'}}>
                                                                            <span>{item}</span>
                                                                            <input type="number" min="0" value={qty} onChange={e => {
                                                                                const newConfigs = {...roomConfigs};
                                                                                newConfigs[roomType].amenities[item] = parseInt(e.target.value) || 0;
                                                                                saveRoomConfigs(newConfigs);
                                                                            }} style={{width:'50px',padding:'4px',background:'rgba(255,255,255,0.1)',border:'1px solid rgba(255,255,255,0.2)',borderRadius:'4px',color:'#fff',textAlign:'center'}}/>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                            
                                                            {/* Linens */}
                                                            <div>
                                                                <h5 style={{fontSize:'12px',fontWeight:'600',marginBottom:'10px',color:'#0ea5e9'}}>üõèÔ∏è Linens</h5>
                                                                <div style={{display:'grid',gap:'6px'}}>
                                                                    {Object.entries(config.linens || {}).map(([item, qty]) => (
                                                                        <div key={item} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'8px 12px',background:'rgba(14,165,233,0.1)',borderRadius:'6px',fontSize:'12px'}}>
                                                                            <span>{item}</span>
                                                                            <input type="number" min="0" value={qty} onChange={e => {
                                                                                const newConfigs = {...roomConfigs};
                                                                                newConfigs[roomType].linens[item] = parseInt(e.target.value) || 0;
                                                                                saveRoomConfigs(newConfigs);
                                                                            }} style={{width:'50px',padding:'4px',background:'rgba(255,255,255,0.1)',border:'1px solid rgba(255,255,255,0.2)',borderRadius:'4px',color:'#fff',textAlign:'center'}}/>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                                
                                                <div style={{marginTop:'20px',padding:'16px',background:'rgba(212,168,83,0.1)',borderRadius:'12px',border:'1px solid rgba(212,168,83,0.3)'}}>
                                                    <h4 style={{fontSize:'14px',fontWeight:'600',marginBottom:'12px',color:'#D4A853'}}>‚ûï Add New Room Type</h4>
                                                    <div style={{display:'flex',gap:'12px',flexWrap:'wrap'}}>
                                                        <input id="newRoomTypeName" placeholder="Room type name (e.g., Penthouse)" style={{...inputStyle,flex:'1 1 200px'}}/>
                                                        <select id="newRoomTypeBeds" style={{...inputStyle}}>
                                                            <option value="1">1 Bed</option>
                                                            <option value="2">2 Beds</option>
                                                        </select>
                                                        <select id="newRoomTypeBedType" style={{...inputStyle}}>
                                                            <option value="King">King</option>
                                                            <option value="Queen">Queen</option>
                                                            <option value="Twin">Twin</option>
                                                        </select>
                                                        <button onClick={()=>{
                                                            const name = document.getElementById('newRoomTypeName').value.trim();
                                                            if(!name) return alert('Enter room type name');
                                                            if(roomConfigs[name]) return alert('Room type already exists');
                                                            const beds = parseInt(document.getElementById('newRoomTypeBeds').value);
                                                            const bedType = document.getElementById('newRoomTypeBedType').value;
                                                            const template = roomConfigs['Standard King'] || Object.values(roomConfigs)[0];
                                                            const newConfigs = {...roomConfigs, [name]: {
                                                                beds, bedType, maxOccupancy: beds * 2,
                                                                amenities: {...(template?.amenities || {})},
                                                                linens: {...(template?.linens || {})}
                                                            }};
                                                            saveRoomConfigs(newConfigs);
                                                            document.getElementById('newRoomTypeName').value = '';
                                                        }} style={{padding:'12px 24px',background:'#D4A853',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'700',cursor:'pointer'}}>‚ûï Add</button>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                        
                                        {/* ========== CHECKLISTS - Configure cleaning checklists ========== */}
                                        {hkAdminTab === 'checklists' && (
                                            <div style={cardStyle}>
                                                <h3 style={{fontSize:'18px',fontWeight:'700',marginBottom:'8px'}}>‚úÖ Cleaning Checklists</h3>
                                                <p style={{color:'rgba(255,255,255,0.5)',marginBottom:'20px',fontSize:'13px'}}>Define cleaning tasks for turnover and stayover rooms</p>
                                                
                                                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'20px'}}>
                                                    {/* Turnover Checklist */}
                                                    <div style={{background:'rgba(249,115,22,0.1)',borderRadius:'12px',padding:'16px',border:'1px solid rgba(249,115,22,0.3)'}}>
                                                        <h4 style={{fontSize:'14px',fontWeight:'600',marginBottom:'16px',color:'#f97316'}}>üîÑ Turnover Checklist</h4>
                                                        <p style={{fontSize:'11px',color:'rgba(255,255,255,0.5)',marginBottom:'12px'}}>For checkout + check-in rooms (full clean)</p>
                                                        
                                                        <div style={{display:'grid',gap:'8px',marginBottom:'16px',maxHeight:'300px',overflowY:'auto'}}>
                                                            {turnoverChecklist.map((item, idx) => (
                                                                <div key={idx} style={{display:'flex',alignItems:'center',gap:'8px',padding:'10px 12px',background:'rgba(255,255,255,0.05)',borderRadius:'8px'}}>
                                                                    <span style={{color:'#f97316',fontWeight:'600',width:'20px'}}>{idx+1}.</span>
                                                                    <span style={{flex:1,fontSize:'13px'}}>{item}</span>
                                                                    <button onClick={()=>saveTurnoverChecklist(turnoverChecklist.filter((_,i)=>i!==idx))} style={{background:'none',border:'none',color:'#ef4444',cursor:'pointer',padding:'4px'}}>√ó</button>
                                                                </div>
                                                            ))}
                                                        </div>
                                                        
                                                        <div style={{display:'flex',gap:'8px'}}>
                                                            <input id="newTurnoverItem" placeholder="Add checklist item" style={{flex:1,padding:'10px',background:'rgba(255,255,255,0.08)',border:'1px solid rgba(255,255,255,0.15)',borderRadius:'8px',color:'#fff',fontSize:'13px'}}/>
                                                            <button onClick={()=>{
                                                                const item = document.getElementById('newTurnoverItem').value.trim();
                                                                if(!item) return;
                                                                saveTurnoverChecklist([...turnoverChecklist, item]);
                                                                document.getElementById('newTurnoverItem').value = '';
                                                            }} style={{padding:'10px 16px',background:'#f97316',border:'none',borderRadius:'8px',color:'#fff',cursor:'pointer'}}>‚ûï</button>
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Stayover Checklist */}
                                                    <div style={{background:'rgba(14,165,233,0.1)',borderRadius:'12px',padding:'16px',border:'1px solid rgba(14,165,233,0.3)'}}>
                                                        <h4 style={{fontSize:'14px',fontWeight:'600',marginBottom:'16px',color:'#0ea5e9'}}>üõèÔ∏è Stayover Checklist</h4>
                                                        <p style={{fontSize:'11px',color:'rgba(255,255,255,0.5)',marginBottom:'12px'}}>For occupied rooms (light clean)</p>
                                                        
                                                        <div style={{display:'grid',gap:'8px',marginBottom:'16px',maxHeight:'300px',overflowY:'auto'}}>
                                                            {stayoverChecklist.map((item, idx) => (
                                                                <div key={idx} style={{display:'flex',alignItems:'center',gap:'8px',padding:'10px 12px',background:'rgba(255,255,255,0.05)',borderRadius:'8px'}}>
                                                                    <span style={{color:'#0ea5e9',fontWeight:'600',width:'20px'}}>{idx+1}.</span>
                                                                    <span style={{flex:1,fontSize:'13px'}}>{item}</span>
                                                                    <button onClick={()=>saveStayoverChecklist(stayoverChecklist.filter((_,i)=>i!==idx))} style={{background:'none',border:'none',color:'#ef4444',cursor:'pointer',padding:'4px'}}>√ó</button>
                                                                </div>
                                                            ))}
                                                        </div>
                                                        
                                                        <div style={{display:'flex',gap:'8px'}}>
                                                            <input id="newStayoverItem" placeholder="Add checklist item" style={{flex:1,padding:'10px',background:'rgba(255,255,255,0.08)',border:'1px solid rgba(255,255,255,0.15)',borderRadius:'8px',color:'#fff',fontSize:'13px'}}/>
                                                            <button onClick={()=>{
                                                                const item = document.getElementById('newStayoverItem').value.trim();
                                                                if(!item) return;
                                                                saveStayoverChecklist([...stayoverChecklist, item]);
                                                                document.getElementById('newStayoverItem').value = '';
                                                            }} style={{padding:'10px 16px',background:'#0ea5e9',border:'none',borderRadius:'8px',color:'#fff',cursor:'pointer'}}>‚ûï</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                        
                                        {/* ========== REQUEST TYPES ========== */}
                                        {hkAdminTab === 'requests' && (
                                            <div style={cardStyle}>
                                                <h3 style={{fontSize:'18px',fontWeight:'700',marginBottom:'20px'}}>üìã Request Types Configuration</h3>
                                                
                                                <div style={{background:'rgba(255,255,255,0.03)',borderRadius:'12px',padding:'16px',marginBottom:'20px',border:'1px solid rgba(255,255,255,0.1)'}}>
                                                    <h4 style={{fontSize:'14px',fontWeight:'600',marginBottom:'16px',color:'#D4A853'}}>‚ûï Add Custom Request Type</h4>
                                                    <div style={{display:'flex',gap:'12px'}}>
                                                        <input id="hkNewReqType" placeholder="Request type name" style={{...inputStyle,flex:1}}/>
                                                        <button onClick={()=>{
                                                            const t=document.getElementById('hkNewReqType').value.trim();
                                                            if(!t) return;
                                                            if(allRequestTypes.includes(t)) return alert('Already exists');
                                                            saveRequestTypes([...customRequestTypes, t]);
                                                            document.getElementById('hkNewReqType').value='';
                                                        }} style={{padding:'12px 24px',background:'#D4A853',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'700',cursor:'pointer'}}>‚ûï Add</button>
                                                    </div>
                                                </div>
                                                
                                                <h4 style={{fontSize:'14px',fontWeight:'600',marginBottom:'12px'}}>Default Types (cannot remove)</h4>
                                                <div style={{display:'flex',flexWrap:'wrap',gap:'8px',marginBottom:'20px'}}>
                                                    {REQUEST_TYPES.map(t => <span key={t} style={{padding:'8px 14px',borderRadius:'20px',background:'rgba(45,106,106,0.15)',border:'1px solid rgba(45,106,106,0.3)',color:'#2D6A6A',fontSize:'12px'}}>{t}</span>)}
                                                </div>
                                                
                                                {customRequestTypes.length > 0 && (
                                                    <>
                                                        <h4 style={{fontSize:'14px',fontWeight:'600',marginBottom:'12px'}}>Custom Types</h4>
                                                        <div style={{display:'flex',flexWrap:'wrap',gap:'8px'}}>
                                                            {customRequestTypes.map(t => (
                                                                <span key={t} style={{padding:'8px 14px',borderRadius:'20px',background:'rgba(212,168,83,0.15)',border:'1px solid rgba(212,168,83,0.3)',color:'#D4A853',fontSize:'12px',display:'flex',alignItems:'center',gap:'8px'}}>
                                                                    {t}
                                                                    <button onClick={()=>saveRequestTypes(customRequestTypes.filter(x=>x!==t))} style={{background:'none',border:'none',color:'#ef4444',cursor:'pointer',padding:0,fontSize:'14px'}}>√ó</button>
                                                                </span>
                                                            ))}
                                                        </div>
                                                    </>
                                                )}
                                            </div>
                                        )}
                                        
                                        {/* ========== INSPECTION ITEMS CONFIG ========== */}
                                        {hkAdminTab === 'inspections' && (
                                            <div style={cardStyle}>
                                                <h3 style={{fontSize:'18px',fontWeight:'700',marginBottom:'20px'}}>‚úÖ Inspection Checklist Items</h3>
                                                <p style={{color:'rgba(255,255,255,0.5)',marginBottom:'20px',fontSize:'13px'}}>Configure the checklist items used for room inspections</p>
                                                
                                                <div style={{background:'rgba(255,255,255,0.03)',borderRadius:'12px',padding:'16px',marginBottom:'20px',border:'1px solid rgba(255,255,255,0.1)'}}>
                                                    <h4 style={{fontSize:'14px',fontWeight:'600',marginBottom:'16px',color:'#D4A853'}}>‚ûï Add Inspection Item</h4>
                                                    <div style={{display:'flex',gap:'12px'}}>
                                                        <input id="newInspectionItem" placeholder="e.g., Minibar fully stocked" style={{...inputStyle,flex:1}}/>
                                                        <button onClick={()=>{
                                                            const t=document.getElementById('newInspectionItem').value.trim();
                                                            if(!t) return;
                                                            if(inspectionItems.includes(t)) return alert('Already exists');
                                                            saveInspectionItems([...inspectionItems, t]);
                                                            document.getElementById('newInspectionItem').value='';
                                                        }} style={{padding:'12px 24px',background:'#2D6A6A',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'700',cursor:'pointer'}}>‚ûï Add</button>
                                                    </div>
                                                </div>
                                                
                                                <div style={{display:'grid',gap:'8px'}}>
                                                    {inspectionItems.map((item, idx) => (
                                                        <div key={idx} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'12px 16px',background:'rgba(255,255,255,0.03)',borderRadius:'8px',border:'1px solid rgba(255,255,255,0.08)'}}>
                                                            <span style={{display:'flex',alignItems:'center',gap:'10px'}}><span style={{color:'#2D6A6A',fontWeight:'600'}}>{idx+1}.</span> {item}</span>
                                                            <button onClick={()=>saveInspectionItems(inspectionItems.filter((_,i)=>i!==idx))} style={{padding:'6px 12px',background:'rgba(239,68,68,0.2)',border:'none',borderRadius:'6px',color:'#ef4444',cursor:'pointer',fontSize:'12px'}}>üóëÔ∏è</button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                        
                                        {/* ========== ISSUE CATEGORIES CONFIG ========== */}
                                        {hkAdminTab === 'issues' && (
                                            <div style={cardStyle}>
                                                <h3 style={{fontSize:'18px',fontWeight:'700',marginBottom:'20px'}}>üõ†Ô∏è Maintenance Issue Categories</h3>
                                                <p style={{color:'rgba(255,255,255,0.5)',marginBottom:'20px',fontSize:'13px'}}>Configure categories for reporting maintenance issues</p>
                                                
                                                <div style={{background:'rgba(255,255,255,0.03)',borderRadius:'12px',padding:'16px',marginBottom:'20px',border:'1px solid rgba(255,255,255,0.1)'}}>
                                                    <h4 style={{fontSize:'14px',fontWeight:'600',marginBottom:'16px',color:'#D4A853'}}>‚ûï Add Issue Category</h4>
                                                    <div style={{display:'flex',gap:'12px'}}>
                                                        <input id="newIssueCategory" placeholder="e.g., Flooring" style={{...inputStyle,flex:1}}/>
                                                        <button onClick={()=>{
                                                            const t=document.getElementById('newIssueCategory').value.trim();
                                                            if(!t) return;
                                                            if(issueCategories.includes(t)) return alert('Already exists');
                                                            saveIssueCategories([...issueCategories, t]);
                                                            document.getElementById('newIssueCategory').value='';
                                                        }} style={{padding:'12px 24px',background:'#f97316',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'700',cursor:'pointer'}}>‚ûï Add</button>
                                                    </div>
                                                </div>
                                                
                                                <div style={{display:'flex',flexWrap:'wrap',gap:'8px'}}>
                                                    {issueCategories.map((cat, idx) => (
                                                        <span key={idx} style={{padding:'8px 14px',borderRadius:'20px',background:'rgba(249,115,22,0.15)',border:'1px solid rgba(249,115,22,0.3)',color:'#f97316',fontSize:'12px',display:'flex',alignItems:'center',gap:'8px'}}>
                                                            {cat}
                                                            <button onClick={()=>saveIssueCategories(issueCategories.filter((_,i)=>i!==idx))} style={{background:'none',border:'none',color:'#ef4444',cursor:'pointer',padding:0,fontSize:'14px'}}>√ó</button>
                                                        </span>
                                                    ))}
                                                </div>
                                                
                                                <div style={{marginTop:'24px',padding:'16px',background:'rgba(249,115,22,0.1)',borderRadius:'12px',border:'1px solid rgba(249,115,22,0.2)'}}>
                                                    <h4 style={{fontSize:'14px',fontWeight:'600',marginBottom:'12px'}}>üìä Current Issues Summary</h4>
                                                    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(120px,1fr))',gap:'8px'}}>
                                                        <div style={{padding:'12px',background:'rgba(239,68,68,0.2)',borderRadius:'8px',textAlign:'center'}}><div style={{fontSize:'24px',fontWeight:'700',color:'#ef4444'}}>{maintenanceIssues.filter(i=>i.status==='open').length}</div><div style={{fontSize:'11px'}}>Open</div></div>
                                                        <div style={{padding:'12px',background:'rgba(249,115,22,0.2)',borderRadius:'8px',textAlign:'center'}}><div style={{fontSize:'24px',fontWeight:'700',color:'#f97316'}}>{maintenanceIssues.filter(i=>i.status==='in-progress').length}</div><div style={{fontSize:'11px'}}>In Progress</div></div>
                                                        <div style={{padding:'12px',background:'rgba(34,197,94,0.2)',borderRadius:'8px',textAlign:'center'}}><div style={{fontSize:'24px',fontWeight:'700',color:'#22c55e'}}>{maintenanceIssues.filter(i=>i.status==='resolved').length}</div><div style={{fontSize:'11px'}}>Resolved</div></div>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                        
                                        {/* ========== PREVENTIVE MAINTENANCE CONFIG ========== */}
                                        {hkAdminTab === 'preventive' && (
                                            <div style={cardStyle}>
                                                <h3 style={{fontSize:'18px',fontWeight:'700',marginBottom:'20px'}}>üìÖ Preventive Maintenance Types</h3>
                                                <p style={{color:'rgba(255,255,255,0.5)',marginBottom:'20px',fontSize:'13px'}}>Configure scheduled maintenance task types</p>
                                                
                                                <div style={{background:'rgba(255,255,255,0.03)',borderRadius:'12px',padding:'16px',marginBottom:'20px',border:'1px solid rgba(255,255,255,0.1)'}}>
                                                    <h4 style={{fontSize:'14px',fontWeight:'600',marginBottom:'16px',color:'#D4A853'}}>‚ûï Add Maintenance Type</h4>
                                                    <div style={{display:'flex',gap:'12px'}}>
                                                        <input id="newPreventiveType" placeholder="e.g., HVAC Inspection" style={{...inputStyle,flex:1}}/>
                                                        <button onClick={()=>{
                                                            const t=document.getElementById('newPreventiveType').value.trim();
                                                            if(!t) return;
                                                            if(preventiveTypes.includes(t)) return alert('Already exists');
                                                            savePreventiveTypes([...preventiveTypes, t]);
                                                            document.getElementById('newPreventiveType').value='';
                                                        }} style={{padding:'12px 24px',background:'#8b5cf6',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'700',cursor:'pointer'}}>‚ûï Add</button>
                                                    </div>
                                                </div>
                                                
                                                <div style={{display:'flex',flexWrap:'wrap',gap:'8px'}}>
                                                    {preventiveTypes.map((type, idx) => (
                                                        <span key={idx} style={{padding:'8px 14px',borderRadius:'20px',background:'rgba(139,92,246,0.15)',border:'1px solid rgba(139,92,246,0.3)',color:'#8b5cf6',fontSize:'12px',display:'flex',alignItems:'center',gap:'8px'}}>
                                                            {type}
                                                            <button onClick={()=>savePreventiveTypes(preventiveTypes.filter((_,i)=>i!==idx))} style={{background:'none',border:'none',color:'#ef4444',cursor:'pointer',padding:0,fontSize:'14px'}}>√ó</button>
                                                        </span>
                                                    ))}
                                                </div>
                                                
                                                <div style={{marginTop:'24px',padding:'16px',background:'rgba(139,92,246,0.1)',borderRadius:'12px',border:'1px solid rgba(139,92,246,0.2)'}}>
                                                    <h4 style={{fontSize:'14px',fontWeight:'600',marginBottom:'12px'}}>üìä Schedule Summary</h4>
                                                    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(120px,1fr))',gap:'8px'}}>
                                                        <div style={{padding:'12px',background:'rgba(239,68,68,0.2)',borderRadius:'8px',textAlign:'center'}}><div style={{fontSize:'24px',fontWeight:'700',color:'#ef4444'}}>{preventiveSchedule.filter(p=>new Date(p.nextDue)<new Date()).length}</div><div style={{fontSize:'11px'}}>Overdue</div></div>
                                                        <div style={{padding:'12px',background:'rgba(249,115,22,0.2)',borderRadius:'8px',textAlign:'center'}}><div style={{fontSize:'24px',fontWeight:'700',color:'#f97316'}}>{preventiveSchedule.filter(p=>{const d=new Date(p.nextDue);const t=new Date();return d>=t&&d<=new Date(t.getTime()+7*24*60*60*1000);}).length}</div><div style={{fontSize:'11px'}}>Due This Week</div></div>
                                                        <div style={{padding:'12px',background:'rgba(34,197,94,0.2)',borderRadius:'8px',textAlign:'center'}}><div style={{fontSize:'24px',fontWeight:'700',color:'#22c55e'}}>{preventiveSchedule.length}</div><div style={{fontSize:'11px'}}>Total Scheduled</div></div>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                        
                                        {/* ========== LINEN TYPES CONFIG ========== */}
                                        {hkAdminTab === 'linen' && (
                                            <div style={cardStyle}>
                                                <h3 style={{fontSize:'18px',fontWeight:'700',marginBottom:'20px'}}>üõèÔ∏è Linen Types & Inventory</h3>
                                                <p style={{color:'rgba(255,255,255,0.5)',marginBottom:'20px',fontSize:'13px'}}>Configure linen types and track inventory levels</p>
                                                
                                                <div style={{background:'rgba(255,255,255,0.03)',borderRadius:'12px',padding:'16px',marginBottom:'20px',border:'1px solid rgba(255,255,255,0.1)'}}>
                                                    <h4 style={{fontSize:'14px',fontWeight:'600',marginBottom:'16px',color:'#D4A853'}}>‚ûï Add Linen Type</h4>
                                                    <div style={{display:'flex',gap:'12px'}}>
                                                        <input id="newLinenType" placeholder="e.g., Pool Towel" style={{...inputStyle,flex:1}}/>
                                                        <button onClick={()=>{
                                                            const t=document.getElementById('newLinenType').value.trim();
                                                            if(!t) return;
                                                            if(linenTypes.includes(t)) return alert('Already exists');
                                                            saveLinenTypes([...linenTypes, t]);
                                                            document.getElementById('newLinenType').value='';
                                                        }} style={{padding:'12px 24px',background:'#0ea5e9',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'700',cursor:'pointer'}}>‚ûï Add</button>
                                                    </div>
                                                </div>
                                                
                                                <h4 style={{fontSize:'14px',fontWeight:'600',marginBottom:'12px'}}>üì¶ Inventory Counts</h4>
                                                <div style={{display:'grid',gap:'12px'}}>
                                                    {linenTypes.map((type, idx) => {
                                                        const inv = linenInventory[type] || {clean:0,dirty:0,inLaundry:0};
                                                        return (
                                                            <div key={idx} style={{display:'grid',gridTemplateColumns:'1fr repeat(3,100px) auto',gap:'12px',alignItems:'center',padding:'12px 16px',background:'rgba(255,255,255,0.03)',borderRadius:'8px',border:'1px solid rgba(255,255,255,0.08)'}}>
                                                                <span style={{fontWeight:'600'}}>{type}</span>
                                                                <div><label style={{fontSize:'10px',color:'rgba(255,255,255,0.5)'}}>Clean</label><input type="number" min="0" value={inv.clean} onChange={e=>saveLinenInventory({...linenInventory,[type]:{...inv,clean:parseInt(e.target.value)||0}})} style={{...inputStyle,width:'100%',padding:'8px'}}/></div>
                                                                <div><label style={{fontSize:'10px',color:'rgba(255,255,255,0.5)'}}>Dirty</label><input type="number" min="0" value={inv.dirty} onChange={e=>saveLinenInventory({...linenInventory,[type]:{...inv,dirty:parseInt(e.target.value)||0}})} style={{...inputStyle,width:'100%',padding:'8px'}}/></div>
                                                                <div><label style={{fontSize:'10px',color:'rgba(255,255,255,0.5)'}}>Laundry</label><input type="number" min="0" value={inv.inLaundry} onChange={e=>saveLinenInventory({...linenInventory,[type]:{...inv,inLaundry:parseInt(e.target.value)||0}})} style={{...inputStyle,width:'100%',padding:'8px'}}/></div>
                                                                <button onClick={()=>{saveLinenTypes(linenTypes.filter((_,i)=>i!==idx));const newInv={...linenInventory};delete newInv[type];saveLinenInventory(newInv);}} style={{padding:'6px 12px',background:'rgba(239,68,68,0.2)',border:'none',borderRadius:'6px',color:'#ef4444',cursor:'pointer',fontSize:'12px'}}>üóëÔ∏è</button>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        )}
                                        
                                        {/* ========== AMENITY TYPES CONFIG ========== */}
                                        {hkAdminTab === 'amenities' && (
                                            <div style={cardStyle}>
                                                <h3 style={{fontSize:'18px',fontWeight:'700',marginBottom:'20px'}}>üß¥ Amenity Types & Stock</h3>
                                                <p style={{color:'rgba(255,255,255,0.5)',marginBottom:'20px',fontSize:'13px'}}>Configure amenity types and track stock levels</p>
                                                
                                                <div style={{background:'rgba(255,255,255,0.03)',borderRadius:'12px',padding:'16px',marginBottom:'20px',border:'1px solid rgba(255,255,255,0.1)'}}>
                                                    <h4 style={{fontSize:'14px',fontWeight:'600',marginBottom:'16px',color:'#D4A853'}}>‚ûï Add Amenity Type</h4>
                                                    <div style={{display:'flex',gap:'12px'}}>
                                                        <input id="newAmenityType" placeholder="e.g., Sewing Kit" style={{...inputStyle,flex:1}}/>
                                                        <button onClick={()=>{
                                                            const t=document.getElementById('newAmenityType').value.trim();
                                                            if(!t) return;
                                                            if(amenityTypes.includes(t)) return alert('Already exists');
                                                            saveAmenityTypes([...amenityTypes, t]);
                                                            document.getElementById('newAmenityType').value='';
                                                        }} style={{padding:'12px 24px',background:'#22c55e',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'700',cursor:'pointer'}}>‚ûï Add</button>
                                                    </div>
                                                </div>
                                                
                                                <h4 style={{fontSize:'14px',fontWeight:'600',marginBottom:'12px'}}>üì¶ Stock Levels</h4>
                                                <div style={{display:'grid',gap:'12px'}}>
                                                    {amenityTypes.map((type, idx) => {
                                                        const inv = amenityInventory[type] || {inStock:0,lowThreshold:10,perRoom:1};
                                                        const isLow = inv.inStock <= inv.lowThreshold;
                                                        return (
                                                            <div key={idx} style={{display:'grid',gridTemplateColumns:'1fr repeat(3,100px) auto',gap:'12px',alignItems:'center',padding:'12px 16px',background:isLow?'rgba(239,68,68,0.1)':'rgba(255,255,255,0.03)',borderRadius:'8px',border:isLow?'1px solid rgba(239,68,68,0.3)':'1px solid rgba(255,255,255,0.08)'}}>
                                                                <span style={{fontWeight:'600',color:isLow?'#ef4444':'inherit'}}>{isLow?'‚ö†Ô∏è ':''}{type}</span>
                                                                <div><label style={{fontSize:'10px',color:'rgba(255,255,255,0.5)'}}>In Stock</label><input type="number" min="0" value={inv.inStock} onChange={e=>saveAmenityInventory({...amenityInventory,[type]:{...inv,inStock:parseInt(e.target.value)||0}})} style={{...inputStyle,width:'100%',padding:'8px'}}/></div>
                                                                <div><label style={{fontSize:'10px',color:'rgba(255,255,255,0.5)'}}>Low Alert</label><input type="number" min="0" value={inv.lowThreshold} onChange={e=>saveAmenityInventory({...amenityInventory,[type]:{...inv,lowThreshold:parseInt(e.target.value)||0}})} style={{...inputStyle,width:'100%',padding:'8px'}}/></div>
                                                                <div><label style={{fontSize:'10px',color:'rgba(255,255,255,0.5)'}}>Per Room</label><input type="number" min="0" value={inv.perRoom} onChange={e=>saveAmenityInventory({...amenityInventory,[type]:{...inv,perRoom:parseInt(e.target.value)||0}})} style={{...inputStyle,width:'100%',padding:'8px'}}/></div>
                                                                <button onClick={()=>{saveAmenityTypes(amenityTypes.filter((_,i)=>i!==idx));const newInv={...amenityInventory};delete newInv[type];saveAmenityInventory(newInv);}} style={{padding:'6px 12px',background:'rgba(239,68,68,0.2)',border:'none',borderRadius:'6px',color:'#ef4444',cursor:'pointer',fontSize:'12px'}}>üóëÔ∏è</button>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        )}
                                        
                                        {/* ========== LOST & FOUND CONFIG ========== */}
                                        {hkAdminTab === 'lostfound' && (
                                            <div style={cardStyle}>
                                                <h3 style={{fontSize:'18px',fontWeight:'700',marginBottom:'20px'}}>üîç Lost & Found Categories</h3>
                                                <p style={{color:'rgba(255,255,255,0.5)',marginBottom:'20px',fontSize:'13px'}}>Configure categories for lost and found items</p>
                                                
                                                <div style={{background:'rgba(255,255,255,0.03)',borderRadius:'12px',padding:'16px',marginBottom:'20px',border:'1px solid rgba(255,255,255,0.1)'}}>
                                                    <h4 style={{fontSize:'14px',fontWeight:'600',marginBottom:'16px',color:'#D4A853'}}>‚ûï Add Category</h4>
                                                    <div style={{display:'flex',gap:'12px'}}>
                                                        <input id="newLfCategory" placeholder="e.g., Sports Equipment" style={{...inputStyle,flex:1}}/>
                                                        <button onClick={()=>{
                                                            const t=document.getElementById('newLfCategory').value.trim();
                                                            if(!t) return;
                                                            if(lfCategories.includes(t)) return alert('Already exists');
                                                            saveLfCategories([...lfCategories, t]);
                                                            document.getElementById('newLfCategory').value='';
                                                        }} style={{padding:'12px 24px',background:'#ec4899',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'700',cursor:'pointer'}}>‚ûï Add</button>
                                                    </div>
                                                </div>
                                                
                                                <div style={{display:'flex',flexWrap:'wrap',gap:'8px',marginBottom:'24px'}}>
                                                    {lfCategories.map((cat, idx) => (
                                                        <span key={idx} style={{padding:'8px 14px',borderRadius:'20px',background:'rgba(236,72,153,0.15)',border:'1px solid rgba(236,72,153,0.3)',color:'#ec4899',fontSize:'12px',display:'flex',alignItems:'center',gap:'8px'}}>
                                                            {cat}
                                                            <button onClick={()=>saveLfCategories(lfCategories.filter((_,i)=>i!==idx))} style={{background:'none',border:'none',color:'#ef4444',cursor:'pointer',padding:0,fontSize:'14px'}}>√ó</button>
                                                        </span>
                                                    ))}
                                                </div>
                                                
                                                <div style={{padding:'16px',background:'rgba(236,72,153,0.1)',borderRadius:'12px',border:'1px solid rgba(236,72,153,0.2)'}}>
                                                    <h4 style={{fontSize:'14px',fontWeight:'600',marginBottom:'12px'}}>üìä Lost & Found Summary</h4>
                                                    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(120px,1fr))',gap:'8px'}}>
                                                        <div style={{padding:'12px',background:'rgba(249,115,22,0.2)',borderRadius:'8px',textAlign:'center'}}><div style={{fontSize:'24px',fontWeight:'700',color:'#f97316'}}>{lostFoundItems.filter(i=>i.status==='unclaimed').length}</div><div style={{fontSize:'11px'}}>Unclaimed</div></div>
                                                        <div style={{padding:'12px',background:'rgba(34,197,94,0.2)',borderRadius:'8px',textAlign:'center'}}><div style={{fontSize:'24px',fontWeight:'700',color:'#22c55e'}}>{lostFoundItems.filter(i=>i.status==='claimed').length}</div><div style={{fontSize:'11px'}}>Claimed</div></div>
                                                        <div style={{padding:'12px',background:'rgba(139,92,246,0.2)',borderRadius:'8px',textAlign:'center'}}><div style={{fontSize:'24px',fontWeight:'700',color:'#8b5cf6'}}>{lostFoundItems.length}</div><div style={{fontSize:'11px'}}>Total Items</div></div>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                        
                                        {/* ========== SETTINGS ========== */}
                                        {hkAdminTab === 'settings' && (
                                            <div style={cardStyle}>
                                                <h3 style={{fontSize:'18px',fontWeight:'700',marginBottom:'20px'}}>‚öôÔ∏è Settings & Statistics</h3>
                                                
                                                <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(150px,1fr))',gap:'12px',marginBottom:'24px'}}>
                                                    <div style={{padding:'16px',background:'rgba(45,106,106,0.1)',borderRadius:'10px',textAlign:'center'}}><div style={{fontSize:'28px',fontWeight:'700',color:'#2D6A6A'}}>{hkStaffList.length}</div><div style={{fontSize:'11px',color:'rgba(255,255,255,0.5)'}}>Staff Members</div></div>
                                                    <div style={{padding:'16px',background:'rgba(212,168,83,0.1)',borderRadius:'10px',textAlign:'center'}}><div style={{fontSize:'28px',fontWeight:'700',color:'#D4A853'}}>{Object.keys(dailyAssignments).length}</div><div style={{fontSize:'11px',color:'rgba(255,255,255,0.5)'}}>Days Scheduled</div></div>
                                                    <div style={{padding:'16px',background:'rgba(249,115,22,0.1)',borderRadius:'10px',textAlign:'center'}}><div style={{fontSize:'28px',fontWeight:'700',color:'#f97316'}}>{requests.filter(r=>!r.done).length}</div><div style={{fontSize:'11px',color:'rgba(255,255,255,0.5)'}}>Pending Requests</div></div>
                                                    <div style={{padding:'16px',background:'rgba(34,197,94,0.1)',borderRadius:'10px',textAlign:'center'}}><div style={{fontSize:'28px',fontWeight:'700',color:'#22c55e'}}>{requests.filter(r=>r.done).length}</div><div style={{fontSize:'11px',color:'rgba(255,255,255,0.5)'}}>Completed</div></div>
                                                </div>
                                                
                                                <div style={{background:'rgba(255,255,255,0.03)',borderRadius:'12px',padding:'16px',border:'1px solid rgba(255,255,255,0.1)'}}>
                                                    <h4 style={{fontSize:'14px',fontWeight:'600',marginBottom:'12px',color:'#D4A853'}}>üè∑Ô∏è Room Status Options</h4>
                                                    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(140px,1fr))',gap:'8px'}}>
                                                        {ROOM_STATUS_OPTIONS.map(opt => <div key={opt.key} style={{padding:'10px',borderRadius:'8px',background:opt.bg,border:`1px solid ${opt.border}`,textAlign:'center'}}><span style={{fontSize:'14px'}}>{opt.label}</span></div>)}
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                        
                                        {/* ========== DATABASE SYNC ========== */}
                                        {hkAdminTab === 'sync' && (
                                            <div style={cardStyle}>
                                                <h3 style={{fontSize:'18px',fontWeight:'700',marginBottom:'20px'}}>‚òÅÔ∏è Database Sync</h3>
                                                <p style={{color:'rgba(255,255,255,0.5)',marginBottom:'20px',fontSize:'13px'}}>Backup and restore housekeeping data to/from cloud server</p>
                                                
                                                <div style={{display:'flex',gap:'16px',flexWrap:'wrap',marginBottom:'24px'}}>
                                                    <button onClick={async()=>{
                                                        const btn=event.target; btn.textContent='‚è≥ Uploading...'; btn.disabled=true;
                                                        await syncToServer('staffList', hkStaffList);
                                                        await syncToServer('dailyAssignments', dailyAssignments);
                                                        await syncToServer('customRequestTypes', customRequestTypes);
                                                        await syncToServer('roomStatuses', roomStatuses);
                                                        await syncToServer('requests', requests);
                                                        await syncToServer('roomConfigs', roomConfigs);
                                                        await syncToServer('turnoverChecklist', turnoverChecklist);
                                                        await syncToServer('stayoverChecklist', stayoverChecklist);
                                                        await syncToServer('completedRooms', completedRooms);
                                                        await syncToServer('issueCategories', issueCategories);
                                                        await syncToServer('maintenanceIssues', maintenanceIssues);
                                                        await syncToServer('lfCategories', lfCategories);
                                                        await syncToServer('lostFoundItems', lostFoundItems);
                                                        btn.textContent='‚úÖ Uploaded!'; setTimeout(()=>{btn.textContent='‚¨ÜÔ∏è Upload All Data';btn.disabled=false;},2000);
                                                    }} style={{padding:'16px 32px',background:'linear-gradient(135deg,#2D6A6A,#245858)',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'700',cursor:'pointer',fontSize:'14px'}}>‚¨ÜÔ∏è Upload All Data</button>
                                                    
                                                    <button onClick={async()=>{
                                                        const btn=event.target; btn.textContent='‚è≥ Downloading...'; btn.disabled=true;
                                                        const staff = await loadFromServer('staffList');
                                                        const assigns = await loadFromServer('dailyAssignments');
                                                        const reqTypes = await loadFromServer('customRequestTypes');
                                                        const roomCfg = await loadFromServer('roomConfigs');
                                                        const turnover = await loadFromServer('turnoverChecklist');
                                                        const stayover = await loadFromServer('stayoverChecklist');
                                                        const completed = await loadFromServer('completedRooms');
                                                        const issCats = await loadFromServer('issueCategories');
                                                        const issues = await loadFromServer('maintenanceIssues');
                                                        const lfCats = await loadFromServer('lfCategories');
                                                        const lfItems = await loadFromServer('lostFoundItems');
                                                        if(staff) { saveHkStaffList(staff); }
                                                        if(assigns) { saveDailyAssignments(assigns); }
                                                        if(reqTypes) { saveRequestTypes(reqTypes); }
                                                        if(roomCfg) { saveRoomConfigs(roomCfg); }
                                                        if(turnover) { saveTurnoverChecklist(turnover); }
                                                        if(stayover) { saveStayoverChecklist(stayover); }
                                                        if(completed) { saveCompletedRooms(completed); }
                                                        if(issCats) { saveIssueCategories(issCats); }
                                                        if(issues) { saveMaintenanceIssues(issues); }
                                                        if(lfCats) { saveLfCategories(lfCats); }
                                                        if(lfItems) { saveLostFoundItems(lfItems); }
                                                        btn.textContent='‚úÖ Downloaded!'; setTimeout(()=>{btn.textContent='‚¨áÔ∏è Download All Data';btn.disabled=false;},2000);
                                                    }} style={{padding:'16px 32px',background:'linear-gradient(135deg,#D4A853,#B8942F)',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'700',cursor:'pointer',fontSize:'14px'}}>‚¨áÔ∏è Download All Data</button>
                                                </div>
                                                
                                                <div style={{background:'rgba(255,255,255,0.03)',borderRadius:'12px',padding:'16px',border:'1px solid rgba(255,255,255,0.1)'}}>
                                                    <h4 style={{fontSize:'14px',fontWeight:'600',marginBottom:'12px'}}>üìä Data Summary</h4>
                                                    <div style={{display:'grid',gap:'8px',fontSize:'13px'}}>
                                                        <div style={{display:'flex',justifyContent:'space-between',padding:'8px 12px',background:'rgba(255,255,255,0.03)',borderRadius:'6px'}}><span>Staff Members</span><span style={{color:'#2D6A6A'}}>{hkStaffList.length}</span></div>
                                                        <div style={{display:'flex',justifyContent:'space-between',padding:'8px 12px',background:'rgba(255,255,255,0.03)',borderRadius:'6px'}}><span>Daily Assignments</span><span style={{color:'#2D6A6A'}}>{Object.keys(dailyAssignments).length} days</span></div>
                                                        <div style={{display:'flex',justifyContent:'space-between',padding:'8px 12px',background:'rgba(255,255,255,0.03)',borderRadius:'6px'}}><span>Room Types Configured</span><span style={{color:'#2D6A6A'}}>{Object.keys(roomConfigs).length}</span></div>
                                                        <div style={{display:'flex',justifyContent:'space-between',padding:'8px 12px',background:'rgba(255,255,255,0.03)',borderRadius:'6px'}}><span>Completed Rooms (Total)</span><span style={{color:'#22c55e'}}>{completedRooms.length}</span></div>
                                                        <div style={{display:'flex',justifyContent:'space-between',padding:'8px 12px',background:'rgba(255,255,255,0.03)',borderRadius:'6px'}}><span>Maintenance Issues</span><span style={{color:'#f97316'}}>{maintenanceIssues.filter(i=>i.status==='open').length} open</span></div>
                                                        <div style={{display:'flex',justifyContent:'space-between',padding:'8px 12px',background:'rgba(255,255,255,0.03)',borderRadius:'6px'}}><span>Lost & Found Items</span><span style={{color:'#ec4899'}}>{lostFoundItems.filter(i=>i.status==='unclaimed').length} unclaimed</span></div>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                    );
                                })()}
                            </div>
                        );
                    })()}

                    {effectiveTab === "movements" && (
                        <div style={{padding: '16px'}}>
                            <h2 style={{fontSize: '18px', fontWeight: '600', marginBottom: '16px'}}>‚ÜîÔ∏è Movements - {formatDate(today)}</h2>
                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: '14px'}}>
                                <div className="hk-section">
                                    <h3 style={{color: '#2D6A6A', marginBottom: '10px', fontSize: '13px'}}>üü¢ Ready for Check-in ({movements.pendingIn.length})</h3>
                                    {movements.pendingIn.map(b => { 
                                        const {num} = getRoomInfo(b.roomId, b.unitId); 
                                        const counts = getRequestCounts(b.id); 
                                        const rs = getRoomStatus(b.roomId, b.unitId, today);
                                        const blocked = rs.checkoutRequired;
                                        const statusLabel = blocked ? 'Waiting for Check-out' : rs.isTurnover ? 'Ready for Check-in' : 'Ready for Early Check-in';
                                        return (
                                            <div key={b.id} className="mv-card" style={{opacity: blocked ? 0.6 : 1}}>
                                                <div>
                                                    <div style={{fontWeight: '600'}}>{b.firstName} <span style={{color: 'rgba(255,255,255,0.5)'}}>#{num}</span></div>
                                                    <div style={{fontSize: '10px', color: blocked ? '#f59e0b' : '#2D6A6A', marginTop: '2px'}}>{blocked ? `‚ö†Ô∏è Checkout ${rs.checkout?.firstName} first` : statusLabel}</div>
                                                    {counts.total > 0 && <div style={{marginTop: '4px'}}>{counts.pending > 0 && <span className="request-count pending">‚è≥ {counts.pending}</span>} {counts.done > 0 && <span className="request-count done">‚úì {counts.done}</span>}</div>}
                                                </div>
                                                <button className="mv-btn mv-btn-pending" style={{opacity: blocked ? 0.5 : 1, cursor: blocked ? 'not-allowed' : 'pointer'}} onClick={() => {
                                                    if (blocked) { alert(`‚ö†Ô∏è Checkout Required!\n\nPlease checkout ${rs.checkout?.firstName} from room #${num} before checking in ${b.firstName}.`); return; }
                                                    toggle(b.id, "in");
                                                }}>‚úì</button>
                                            </div>
                                        ); 
                                    })}
                                    {!movements.pendingIn.length && <div style={{color: 'rgba(255,255,255,0.4)', textAlign: 'center', padding: '20px'}}>None</div>}
                                </div>
                                <div className="hk-section">
                                    <h3 style={{color: '#22c55e', marginBottom: '10px', fontSize: '13px'}}>‚úÖ Checked-in ({movements.doneIn.length})</h3>
                                    {movements.doneIn.map(b => { const {num} = getRoomInfo(b.roomId, b.unitId); const counts = getRequestCounts(b.id); return (
                                        <div key={b.id} className="mv-card"><div><div style={{fontWeight: '600'}}>{b.firstName} <span style={{color: 'rgba(255,255,255,0.5)'}}>#{num}</span></div><div style={{fontSize: '10px', color: '#22c55e', marginTop: '2px'}}>Checked-in ‚úì</div>{counts.total > 0 && <div style={{marginTop: '4px'}}>{counts.pending > 0 && <span className="request-count pending">‚è≥ {counts.pending}</span>} {counts.done > 0 && <span className="request-count done">‚úì {counts.done}</span>}</div>}</div><button className="mv-btn mv-btn-done" onClick={() => toggle(b.id, "in")}>‚Ü©</button></div>
                                    ); })}
                                    {!movements.doneIn.length && <div style={{color: 'rgba(255,255,255,0.4)', textAlign: 'center', padding: '20px'}}>None</div>}
                                </div>
                                <div className="hk-section">
                                    <h3 style={{color: '#D4A853', marginBottom: '10px', fontSize: '13px'}}>‚è≥ Waiting for Check-out ({movements.pendingOut.length})</h3>
                                    {movements.pendingOut.map(b => { const {num} = getRoomInfo(b.roomId, b.unitId); const counts = getRequestCounts(b.id); return (
                                        <div key={b.id} className="mv-card"><div><div style={{fontWeight: '600'}}>{b.firstName} <span style={{color: 'rgba(255,255,255,0.5)'}}>#{num}</span></div><div style={{fontSize: '10px', color: '#D4A853', marginTop: '2px'}}>Waiting for Check-out</div>{counts.total > 0 && <div style={{marginTop: '4px'}}>{counts.pending > 0 && <span className="request-count pending">‚è≥ {counts.pending}</span>} {counts.done > 0 && <span className="request-count done">‚úì {counts.done}</span>}</div>}</div><button className="mv-btn mv-btn-pending" onClick={() => toggle(b.id, "out")}>‚úì</button></div>
                                    ); })}
                                    {!movements.pendingOut.length && <div style={{color: 'rgba(255,255,255,0.4)', textAlign: 'center', padding: '20px'}}>None</div>}
                                </div>
                                <div className="hk-section">
                                    <h3 style={{color: '#22c55e', marginBottom: '10px', fontSize: '13px'}}>üëã Checked-out ({movements.doneOut.length})</h3>
                                    {movements.doneOut.map(b => { const {num} = getRoomInfo(b.roomId, b.unitId); const counts = getRequestCounts(b.id); return (
                                        <div key={b.id} className="mv-card"><div><div style={{fontWeight: '600'}}>{b.firstName} <span style={{color: 'rgba(255,255,255,0.5)'}}>#{num}</span></div><div style={{fontSize: '10px', color: '#22c55e', marginTop: '2px'}}>Checked-out ‚úì</div>{counts.total > 0 && <div style={{marginTop: '4px'}}>{counts.pending > 0 && <span className="request-count pending">‚è≥ {counts.pending}</span>} {counts.done > 0 && <span className="request-count done">‚úì {counts.done}</span>}</div>}</div><button className="mv-btn mv-btn-done" onClick={() => toggle(b.id, "out")}>‚Ü©</button></div>
                                    ); })}
                                    {!movements.doneOut.length && <div style={{color: 'rgba(255,255,255,0.4)', textAlign: 'center', padding: '20px'}}>None</div>}
                                </div>
                            </div>
                        </div>
                    )}

                    {effectiveTab === "accounting" && <AccountingTab bookings={bookings} getRoomInfo={getRoomInfo} formatDate={formatDate} fetchData={fetchData} setShowInfoModal={setShowInfoModal} setIsEditing={setIsEditing}/>}

                                        {effectiveTab === "dashboard" && (
                        <div style={{padding: '16px', maxWidth: '1200px', margin: '0 auto'}}>
                            {/* Header with Date Selector */}
                            <div style={{display: 'flex', flexWrap: 'wrap', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px', gap: '16px'}}>
                                <div>
                                    <h2 style={{fontSize: '24px', fontWeight: '700', marginBottom: '4px'}}>üìä Dashboard</h2>
                                    <p style={{color: 'rgba(255,255,255,0.5)', fontSize: '14px'}}>
                                        {dashDate === today ? "Today's Overview" : dashDate < today ? "Historical View" : "Future Forecast"}
                                    </p>
                                </div>
                                <div style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                                    <button onClick={() => { const d = new Date(dashDate); d.setDate(d.getDate() - 1); setDashDate(d.toISOString().slice(0,10)); }} style={{background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '8px', padding: '10px 14px', color: '#fff', cursor: 'pointer', fontSize: '16px'}}>‚Üê</button>
                                    <div onClick={() => dashDateRef.current?.showPicker()} style={{cursor: 'pointer', background: dashDate === today ? 'linear-gradient(135deg, #2D6A6A, #245858)' : 'rgba(255,255,255,0.1)', borderRadius: '10px', padding: '10px 16px', display: 'flex', alignItems: 'center', gap: '8px'}}>
                                        <span style={{fontSize: '18px'}}>üìÖ</span>
                                        <span style={{fontWeight: '600'}}>{new Date(dashDate + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</span>
                                        <input ref={dashDateRef} type="date" value={dashDate} onChange={e => setDashDate(e.target.value)} style={{position: 'absolute', opacity: 0, pointerEvents: 'none'}}/>
                                    </div>
                                    <button onClick={() => { const d = new Date(dashDate); d.setDate(d.getDate() + 1); setDashDate(d.toISOString().slice(0,10)); }} style={{background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '8px', padding: '10px 14px', color: '#fff', cursor: 'pointer', fontSize: '16px'}}>‚Üí</button>
                                    {dashDate !== today && <button onClick={() => setDashDate(today)} style={{background: 'linear-gradient(135deg, #2D6A6A, #245858)', border: 'none', borderRadius: '8px', padding: '10px 16px', color: '#fff', cursor: 'pointer', fontWeight: '600', fontSize: '13px'}}>Today</button>}
                                </div>
                            </div>
                            
                            {/* Summary Cards - calculations done inline */}
                            {(() => {
                                const checkIns = bookings.filter(b => b.arrival === dashDate && b.status !== 'cancelled' && b.status !== 'inquiry');
                                const checkOuts = bookings.filter(b => b.departure === dashDate && b.status !== 'cancelled' && b.status !== 'inquiry');
                                const stayingGuests = bookings.filter(b => b.arrival <= dashDate && b.departure > dashDate && b.status !== 'cancelled' && b.status !== 'inquiry');
                                // Use dynamic totalRooms from API for accurate occupancy
                                const totalUnits = totalRooms;
                                // Count unique occupied room/unit combinations
                                const occupiedSet = new Set(stayingGuests.map(b => `${b.roomId}-${b.unitId}`));
                                const occupiedUnits = occupiedSet.size;
                                const emptyUnits = totalUnits - occupiedUnits;
                                const occupancyRate = totalUnits > 0 ? Math.round((occupiedUnits / totalUnits) * 100) : 0;
                                const turnoverRooms = checkOuts.filter(out => checkIns.some(ci => ci.roomId === out.roomId && ci.unitId === out.unitId));
                                
                                return (
                                    <>
                                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(220px, 1fr))', gap: '16px', marginBottom: '24px'}}>
                                            <div style={{background: 'linear-gradient(145deg, rgba(45,106,106,0.2), rgba(45,106,106,0.05))', border: '2px solid rgba(45,106,106,0.4)', borderRadius: '16px', padding: '20px', position: 'relative', overflow: 'hidden'}}>
                                                <div style={{position: 'absolute', top: '-20px', right: '-20px', fontSize: '80px', opacity: 0.1}}>‚¨áÔ∏è</div>
                                                <div style={{fontSize: '13px', color: 'rgba(255,255,255,0.6)', fontWeight: '600', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '1px'}}>Check-ins</div>
                                                <div style={{fontSize: '48px', fontWeight: '800', color: '#2D6A6A', lineHeight: 1}}>{checkIns.length}</div>
                                                <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.5)', marginTop: '8px'}}>{checkIns.length > 0 ? `${checkIns.filter(b => checkStatus[b.id] === 'checkedin').length} completed` : 'No arrivals'}</div>
                                            </div>
                                            <div style={{background: 'linear-gradient(145deg, rgba(212,168,83,0.2), rgba(212,168,83,0.05))', border: '2px solid rgba(212,168,83,0.4)', borderRadius: '16px', padding: '20px', position: 'relative', overflow: 'hidden'}}>
                                                <div style={{position: 'absolute', top: '-20px', right: '-20px', fontSize: '80px', opacity: 0.1}}>‚¨ÜÔ∏è</div>
                                                <div style={{fontSize: '13px', color: 'rgba(255,255,255,0.6)', fontWeight: '600', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '1px'}}>Check-outs</div>
                                                <div style={{fontSize: '48px', fontWeight: '800', color: '#D4A853', lineHeight: 1}}>{checkOuts.length}</div>
                                                <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.5)', marginTop: '8px'}}>{checkOuts.length > 0 ? `${checkOuts.filter(b => checkStatus[b.id] === 'checkedout').length} completed` : 'No departures'}</div>
                                            </div>
                                            <div style={{background: 'linear-gradient(145deg, rgba(239,68,68,0.2), rgba(239,68,68,0.05))', border: '2px solid rgba(239,68,68,0.4)', borderRadius: '16px', padding: '20px', position: 'relative', overflow: 'hidden'}}>
                                                <div style={{position: 'absolute', top: '-20px', right: '-20px', fontSize: '80px', opacity: 0.1}}>üè®</div>
                                                <div style={{fontSize: '13px', color: 'rgba(255,255,255,0.6)', fontWeight: '600', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '1px'}}>Occupied</div>
                                                <div style={{fontSize: '48px', fontWeight: '800', color: '#ef4444', lineHeight: 1}}>{occupiedUnits}</div>
                                                <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.5)', marginTop: '8px'}}>{occupancyRate}% occupancy rate</div>
                                            </div>
                                            <div style={{background: 'linear-gradient(145deg, rgba(34,197,94,0.2), rgba(34,197,94,0.05))', border: '2px solid rgba(34,197,94,0.4)', borderRadius: '16px', padding: '20px', position: 'relative', overflow: 'hidden'}}>
                                                <div style={{position: 'absolute', top: '-20px', right: '-20px', fontSize: '80px', opacity: 0.1}}>üõèÔ∏è</div>
                                                <div style={{fontSize: '13px', color: 'rgba(255,255,255,0.6)', fontWeight: '600', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '1px'}}>Available</div>
                                                <div style={{fontSize: '48px', fontWeight: '800', color: '#22c55e', lineHeight: 1}}>{emptyUnits}</div>
                                                <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.5)', marginTop: '8px'}}>of {totalUnits} total units</div>
                                            </div>
                                        </div>
                                        
                                        {turnoverRooms.length > 0 && (
                                            <div style={{background: 'linear-gradient(145deg, rgba(168,85,247,0.2), rgba(168,85,247,0.05))', border: '2px solid rgba(168,85,247,0.4)', borderRadius: '12px', padding: '14px 20px', marginBottom: '24px', display: 'flex', alignItems: 'center', gap: '12px'}}>
                                                <span style={{fontSize: '24px'}}>üîÑ</span>
                                                <div>
                                                    <div style={{fontWeight: '700', color: '#a855f7'}}>{turnoverRooms.length} Turnover Room{turnoverRooms.length > 1 ? 's' : ''}</div>
                                                    <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.5)'}}>Same-day checkout and check-in</div>
                                                </div>
                                            </div>
                                        )}
                                        
                                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '16px'}}>
                                            {checkIns.length > 0 && (
                                                <div className="hk-section" style={{background: 'rgba(45,106,106,0.1)', border: '1px solid rgba(45,106,106,0.3)'}}>
                                                    <h3 style={{marginBottom: '14px', fontSize: '14px', color: '#2D6A6A', display: 'flex', alignItems: 'center', gap: '8px'}}><span>‚¨áÔ∏è</span> Arriving ({checkIns.length})</h3>
                                                    <div style={{maxHeight: '200px', overflowY: 'auto'}}>
                                                        {checkIns.map(b => { const {num} = getRoomInfo(b.roomId, b.unitId); const done = checkStatus[b.id] === 'checkedin'; return (
                                                            <div key={b.id} onClick={() => setShowInfoModal(b)} style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '10px 12px', background: done ? 'rgba(34,197,94,0.1)' : 'rgba(255,255,255,0.05)', borderRadius: '8px', marginBottom: '6px', cursor: 'pointer'}}>
                                                                <div style={{display: 'flex', alignItems: 'center', gap: '10px'}}><span style={{fontWeight: '700', color: done ? '#22c55e' : '#2D6A6A', fontSize: '18px'}}>{num}</span><span style={{fontSize: '13px'}}>{b.firstName}</span></div>
                                                                {done && <span style={{color: '#22c55e', fontSize: '14px'}}>‚úì</span>}
                                                            </div>
                                                        ); })}
                                                    </div>
                                                </div>
                                            )}
                                            {checkOuts.length > 0 && (
                                                <div className="hk-section" style={{background: 'rgba(212,168,83,0.1)', border: '1px solid rgba(212,168,83,0.3)'}}>
                                                    <h3 style={{marginBottom: '14px', fontSize: '14px', color: '#D4A853', display: 'flex', alignItems: 'center', gap: '8px'}}><span>‚¨ÜÔ∏è</span> Departing ({checkOuts.length})</h3>
                                                    <div style={{maxHeight: '200px', overflowY: 'auto'}}>
                                                        {checkOuts.map(b => { const {num} = getRoomInfo(b.roomId, b.unitId); const done = checkStatus[b.id] === 'checkedout'; return (
                                                            <div key={b.id} onClick={() => setShowInfoModal(b)} style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '10px 12px', background: done ? 'rgba(34,197,94,0.1)' : 'rgba(255,255,255,0.05)', borderRadius: '8px', marginBottom: '6px', cursor: 'pointer'}}>
                                                                <div style={{display: 'flex', alignItems: 'center', gap: '10px'}}><span style={{fontWeight: '700', color: done ? '#22c55e' : '#D4A853', fontSize: '18px'}}>{num}</span><span style={{fontSize: '13px'}}>{b.firstName}</span></div>
                                                                {done && <span style={{color: '#22c55e', fontSize: '14px'}}>‚úì</span>}
                                                            </div>
                                                        ); })}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                        
                                        <div style={{marginTop: '32px', padding: '40px', background: 'rgba(255,255,255,0.02)', border: '2px dashed rgba(255,255,255,0.1)', borderRadius: '16px', textAlign: 'center'}}>
                                            <div style={{fontSize: '32px', marginBottom: '12px', opacity: 0.3}}>üìà</div>
                                            <div style={{color: 'rgba(255,255,255,0.3)', fontSize: '14px'}}>More analytics coming soon...</div>
                                        </div>
                                    </>
                                );
                            })()}
                        </div>
                    )}
                </>
            )}

                    {effectiveTab === "whatsapp" && <WhatsAppTab />}

            {selected.length > 0 && tab !== "searchbook" && (() => {
                const totalNights = selected.reduce((sum, s) => {
                    const n = Math.max(1, Math.ceil((new Date(s.checkOut) - new Date(s.checkIn)) / (1000 * 60 * 60 * 24)));
                    return sum + n;
                }, 0);
                return (
                    <div style={{position: 'fixed', bottom: '20px', left: '16px', right: '16px', zIndex: 1000, maxWidth: '650px', margin: '0 auto', padding: '20px', background: 'linear-gradient(145deg, #0f172a 0%, #1e293b 100%)', borderRadius: '20px', boxShadow: '0 15px 50px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.1)', border: '2px solid rgba(45,106,106,0.5)'}}>
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '14px'}}>
                            <div style={{fontSize: '16px', fontWeight: '700', color: '#fff', display: 'flex', alignItems: 'center', gap: '8px'}}>
                                <span style={{fontSize: '20px'}}>üì¶</span> 
                                <span>{selected.length} Room(s) Selected</span>
                            </div>
                            <button onClick={() => setSelected([])} style={{background: 'linear-gradient(135deg, #ef4444, #dc2626)', border: 'none', borderRadius: '8px', padding: '8px 14px', color: '#fff', fontSize: '12px', cursor: 'pointer', fontWeight: '600', boxShadow: '0 4px 12px rgba(239,68,68,0.3)'}}>‚úï Clear All</button>
                        </div>
                        <div style={{maxHeight: '150px', overflowY: 'auto', marginBottom: '14px'}}>
                            {selected.map(s => {
                                const nights = Math.max(1, Math.ceil((new Date(s.checkOut) - new Date(s.checkIn)) / (1000 * 60 * 60 * 24)));
                                return (
                                    <div key={s.unitKey} style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '12px 16px', background: 'linear-gradient(135deg, rgba(45,106,106,0.25) 0%, rgba(45,106,106,0.1) 100%)', border: '1px solid rgba(45,106,106,0.5)', borderRadius: '12px', marginBottom: '8px'}}>
                                        <div style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
                                            <span style={{fontSize: '22px', fontWeight: '800', color: '#4ade80', textShadow: '0 2px 8px rgba(74,222,128,0.3)'}}>{s.unit.n}</span>
                                            <span style={{fontSize: '13px', color: 'rgba(255,255,255,0.7)', fontWeight: '500'}}>{s.room.short}</span>
                                        </div>
                                        <div style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                                            <span style={{fontSize: '13px', color: '#fff', fontWeight: '600', background: 'rgba(0,0,0,0.3)', padding: '4px 10px', borderRadius: '6px'}}>{s.checkIn.slice(8)}-{s.checkIn.slice(5,7)} ‚Üí {s.checkOut.slice(8)}-{s.checkOut.slice(5,7)}</span>
                                            <span style={{padding: '5px 12px', background: 'linear-gradient(135deg, #D4A853, #B8942F)', borderRadius: '6px', fontSize: '12px', fontWeight: '700', color: '#fff', boxShadow: '0 2px 8px rgba(212,168,83,0.3)'}}>{nights}N</span>
                                            <button onClick={() => setSelected(selected.filter(x => x.unitKey !== s.unitKey))} style={{background: 'rgba(239,68,68,0.2)', border: '1px solid rgba(239,68,68,0.4)', borderRadius: '6px', color: '#ef4444', cursor: 'pointer', fontSize: '16px', padding: '4px 8px', fontWeight: '700'}}>√ó</button>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.6)', marginBottom: '12px', textAlign: 'center', fontWeight: '500'}}>üí° Click another date on same unit to change check-out</div>
                        <button onClick={() => setShowBookModal(true)} style={{width: '100%', padding: '16px', background: 'linear-gradient(135deg, #2D6A6A 0%, #1a4a4a 100%)', border: '2px solid rgba(45,106,106,0.6)', borderRadius: '12px', color: 'white', fontWeight: '700', fontSize: '16px', cursor: 'pointer', boxShadow: '0 8px 25px rgba(45,106,106,0.4)', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px'}}>
                            <span style={{fontSize: '18px'}}>‚ûï</span>
                            <span>Book {selected.length} Room(s) ‚Ä¢ {totalNights} Total Night{totalNights > 1 ? 's' : ''}</span>
                        </button>
                    </div>
                );
            })()}

            {showSearchModal && (
                <div className="modal-overlay" onClick={() => setShowSearchModal(false)}>
                    <div className="modal" onClick={e => e.stopPropagation()} style={{maxWidth: '550px'}}>
                        <div className="modal-header"><h3 style={{fontSize: '18px', fontWeight: '700'}}>üîç Search Guest</h3><button className="modal-close" onClick={() => setShowSearchModal(false)}>√ó</button></div>
                        <input type="text" placeholder="Search by ID, phone, email, or name..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} className="search-input" autoFocus/>
                        <div style={{marginTop: '16px', maxHeight: '400px', overflowY: 'auto'}}>
                            {globalSearchResults.map(b => { const {num, room} = getRoomInfo(b.roomId, b.unitId); return (<div key={b.id} className="search-result" onClick={() => {setShowInfoModal(b); setShowSearchModal(false);}}><div style={{display: 'flex', justifyContent: 'space-between'}}><div><div style={{fontWeight: '600'}}>{b.firstName} {b.lastName}</div><div style={{fontSize: '12px', color: 'rgba(255,255,255,0.5)'}}>{room?.name}</div><div style={{fontSize: '11px', color: 'rgba(255,255,255,0.4)'}}>üìû {b.mobile || 'N/A'} ‚Ä¢ ID: {b.id}</div></div><div style={{textAlign: 'right'}}><div style={{fontWeight: '700', color: '#2D6A6A', fontSize: '18px'}}>{num}</div><div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)'}}>{formatDate(b.arrival)}</div></div></div></div>); })}
                            {searchQuery && !globalSearchResults.length && <div style={{textAlign: 'center', color: 'rgba(255,255,255,0.4)', padding: '30px'}}>No results</div>}
                            {!searchQuery && <div style={{textAlign: 'center', color: 'rgba(255,255,255,0.4)', padding: '30px'}}>Type to search...</div>}
                        </div>
                    </div>
                </div>
            )}

            {showInfoModal && <InfoModal booking={showInfoModal} onClose={() => setShowInfoModal(null)} getMultiUnitInfo={getMultiUnitInfo} getRequestCounts={getRequestCounts} requests={requests} onUpdate={() => {fetchData(true); setShowInfoModal(null);}} checkStatus={checkStatus} toggle={toggle} today={today} bookings={bookings} getRoomStatus={getRoomStatus} setIsEditing={setIsEditing} currentTab={tab} currentUser={currentUser}/>}
            {showBookModal && <BookingModal selected={selected} checkIn={effectiveTab === "searchbook" ? searchCheckIn : multiBookCheckIn} checkOut={effectiveTab === "searchbook" ? searchCheckOut : multiBookCheckOut} onClose={() => {setShowBookModal(false); setSelected([]); fetchData(true);}} setIsEditing={setIsEditing}/>}
        </div>
    );
}

function GuestRequestCard({guest, onAddRequest, requestCounts}) {
    const [requestType, setRequestType] = useState("");
    const [note, setNote] = useState("");
    const [expanded, setExpanded] = useState(false);
    const handleSubmit = () => { if (!requestType) return; onAddRequest(guest.num, guest.firstName, guest.id, requestType, note); setRequestType(""); setNote(""); setExpanded(false); };
    return (
        <div className="request-card">
            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                <div>
                    <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                        <span style={{fontSize: '18px', fontWeight: '700', color: '#2D6A6A'}}>{guest.num}</span>
                        {requestCounts.total > 0 && <span style={{fontSize: '11px'}}>{requestCounts.pending > 0 && <span className="request-count pending">‚è≥ {requestCounts.pending}</span>}{requestCounts.done > 0 && <span className="request-count done" style={{marginLeft: '4px'}}>‚úì {requestCounts.done}</span>}</span>}
                    </div>
                    <div style={{fontWeight: '600', marginTop: '2px'}}>{guest.firstName}</div>
                </div>
                <button onClick={() => setExpanded(!expanded)} style={{padding: '8px 14px', background: expanded ? 'rgba(255,255,255,0.1)' : '#2D6A6A', border: 'none', borderRadius: '8px', color: 'white', fontWeight: '600', cursor: 'pointer', fontSize: '12px'}}>{expanded ? '‚úï' : '+ Request'}</button>
            </div>
            {expanded && (<div style={{marginTop: '12px'}}><select value={requestType} onChange={e => setRequestType(e.target.value)} className="request-select"><option value="">Select...</option>{REQUEST_TYPES.map(t => <option key={t} value={t}>{t}</option>)}</select><textarea value={note} onChange={e => setNote(e.target.value)} placeholder="Note..." className="request-note" rows={2}/><button onClick={handleSubmit} disabled={!requestType} className="request-btn" style={{opacity: requestType ? 1 : 0.5}}>Submit</button></div>)}
        </div>
    );
}

function InfoModal({booking, onClose, getMultiUnitInfo, getRequestCounts, requests, onUpdate, checkStatus, toggle, today, bookings, getRoomStatus, setIsEditing, currentTab, currentUser}) {
    const {num, room} = getRoomInfo(booking.roomId, booking.unitId);
    const multiUnit = getMultiUnitInfo(booking);
    const price = parseFloat(booking.price) || 0, paid = parseFloat(booking.deposit) || 0, due = price - paid;
    const counts = getRequestCounts(booking.id);
    const bookingRequests = requests.filter(r => r.bookingId === booking.id);
    
    // Pause auto-refresh while modal is open
    useEffect(() => {
        if (setIsEditing) setIsEditing(true);
        return () => { if (setIsEditing) setIsEditing(false); };
    }, []); // eslint-disable-line react-hooks/exhaustive-deps
    
    // Use unified room status - but we need to check for this specific booking
    const rs = getRoomStatus(booking.roomId, booking.unitId, today);
    
    // Check-in/out status
    const isCheckInToday = booking.arrival === today;
    const isCheckOutToday = booking.departure === today;
    const isGuestCheckedIn = checkStatus && checkStatus[booking.id] === "checkedin";
    const isGuestCheckedOut = checkStatus && checkStatus[booking.id] === "checkedout";
    
    // Use unified logic for checkout blocking
    const isPendingCheckoutFirst = isCheckInToday && rs.checkoutRequired && rs.checkout?.id !== booking.id;
    
    const [editMode, setEditMode] = useState(null); // 'guest', 'dates', 'payment', 'notes'
    const [saving, setSaving] = useState(false);
    const [form, setForm] = useState({
        firstName: booking.firstName || '',
        lastName: booking.lastName || '',
        mobile: booking.mobile || '',
        email: booking.email || '',
        nid: booking.custom4 || '',
        dob: booking.custom5 || '',
        arrival: booking.arrival || '',
        departure: booking.departure || '',
        price: price.toString(),
        deposit: paid.toString(),
        status: booking.status || 'confirmed',
        subStatus: booking.subStatus || 'none',
        notes: booking.notes || ''
    });
    
    // Group booking payment mode
    const [paymentMode, setPaymentMode] = useState("simple"); // simple | advanced
    const [roomPayments, setRoomPayments] = useState({});
    
    // Get all bookings in the group
    const groupBookings = useMemo(() => {
        if (!booking) return [];
        // Use String comparison for type safety (API returns mixed types)
        const masterIdStr = String(booking.masterId || booking.id);
        const related = bookings.filter(b => 
            String(b.masterId) === masterIdStr || 
            String(b.id) === masterIdStr || 
            (booking.masterId && String(b.masterId) === String(booking.masterId))
        );
        // Sort: master booking first (no masterId), then by room number
        const sorted = related.sort((a, b) => {
            if (!a.masterId && b.masterId) return -1;
            if (a.masterId && !b.masterId) return 1;
            return (getRoomInfo(a.roomId, a.unitId).num || 0) - (getRoomInfo(b.roomId, b.unitId).num || 0);
        });
        return sorted.length > 1 ? sorted : [];
    }, [booking, bookings]);
    
    // Initialize room payments when entering payment edit mode
    useEffect(() => {
        if (editMode === 'payment' && groupBookings.length > 1) {
            const initial = {};
            groupBookings.forEach(b => { initial[b.id] = ''; });
            setRoomPayments(initial);
            setPaymentMode('simple');
        }
    }, [editMode, groupBookings]);
    
    const inputStyle = {width: '100%', padding: '10px', background: 'rgba(255,255,255,0.08)', border: '1px solid rgba(255,255,255,0.15)', borderRadius: '6px', color: '#fff', fontSize: '14px'};
    
    // Invoice PDF Generator - Comprehensive with Group Booking Support
    // State for invoice loading
    const [invoiceLoading, setInvoiceLoading] = React.useState(false);
    
    const generateInvoice = async function() {
        try {
            setInvoiceLoading(true);
            
            // Check for jsPDF library
            if (typeof window.jspdf === 'undefined') {
                alert('PDF library is loading. Please wait a moment and try again.');
                var script = document.createElement('script');
                script.src = 'https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js';
                document.head.appendChild(script);
                setInvoiceLoading(false);
                return;
            }
            
            // FETCH FRESH DATA FROM BEDS24 before generating invoice
            // This ensures we get correct guest names for ALL units in a group
            let freshBookings = [];
            try {
                const response = await fetch('https://beds24-proxy-1006186358018.us-central1.run.app/getBookings');
                const data = await response.json();
                freshBookings = data.data || data || [];
                console.log('Fetched', freshBookings.length, 'bookings from Beds24 for invoice');
            } catch (fetchErr) {
                console.warn('Could not fetch fresh data, using cached:', fetchErr);
                freshBookings = bookings; // Fallback to cached data
            }
            
            // MASTER BOOKING ID LOGIC:
            // 1. If this booking HAS a masterId, use that as the group identifier
            // 2. If this booking has NO masterId (it IS the master), use its ID as the group identifier
            // Two types of data must be pulled:
            // - Type 1: Bookings where masterId === groupId (children)
            // - Type 2: Booking where id === groupId (master itself, has masterId: null)
            const groupId = String(booking.masterId || booking.id);
            
            const allBookings = freshBookings.filter(b => {
                // Type 1: Child bookings that link to the master
                if (String(b.masterId) === groupId) return true;
                // Type 2: The master booking itself (id matches, masterId is null)
                if (String(b.id) === groupId) return true;
                return false;
            });
            
            // Sort: master booking first (no masterId), then by room number
            allBookings.sort((a, b) => {
                if (!a.masterId && b.masterId) return -1;
                if (a.masterId && !b.masterId) return 1;
                return getRoomInfo(a.roomId, a.unitId).num - getRoomInfo(b.roomId, b.unitId).num;
            });
            
            console.log('Invoice group (groupId=' + groupId + '):', allBookings.length, 'bookings');
            allBookings.forEach(b => console.log('  Room', getRoomInfo(b.roomId, b.unitId).num, '- Guest:', b.firstName, b.lastName, '- masterId:', b.masterId));
            
            const isGroupBooking = allBookings.length > 1;
            
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF();
            const pageWidth = 210;
            const margin = 15;
            let y = 15;
            
            // Calculate totals for group
            let totalPrice = 0;
            let totalPaid = 0;
            let totalGuests = 0;
            allBookings.forEach(function(b) {
                totalPrice += parseFloat(b.price) || 0;
                totalPaid += parseFloat(b.deposit) || 0;
                totalGuests += (parseInt(b.numAdult) || 1) + (parseInt(b.numChild) || 0);
            });
            const totalDue = totalPrice - totalPaid;
            
            // Use first booking for common details
            const mainBooking = allBookings[0];
            const nights = Math.max(1, Math.ceil((new Date(mainBooking.departure) - new Date(mainBooking.arrival)) / (1000 * 60 * 60 * 24)));
            const agent = mainBooking.refererEditable || mainBooking.referer || 'Direct Booking';
            const bookingSource = mainBooking.apiSource || mainBooking.channel || 'Direct';
            const externalRef = mainBooking.apiReference || '';
            
            // ===== HEADER =====
            doc.setFillColor(30, 41, 59);
            doc.rect(0, 0, pageWidth, 50, 'F');
            
            doc.setTextColor(212, 168, 83);
            doc.setFontSize(26);
            doc.setFont('helvetica', 'bold');
            doc.text('MIAMI BEACH RESORT', pageWidth/2, 22, { align: 'center' });
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text("Cox's Bazar, Bangladesh", pageWidth/2, 32, { align: 'center' });
            doc.text('Phone: +880 1234-567890 | Email: info@miamibeachresort.bd', pageWidth/2, 40, { align: 'center' });
            
            y = 60;
            
            // ===== INVOICE TITLE & NUMBER =====
            doc.setFillColor(45, 106, 106);
            doc.rect(margin, y, pageWidth - 2*margin, 12, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('INVOICE', margin + 5, y + 8);
            doc.setFontSize(11);
            doc.text('INV-' + booking.id.toString().slice(-8).toUpperCase(), pageWidth - margin - 5, y + 8, { align: 'right' });
            
            y += 20;
            
            // ===== BOOKING DETAILS BOX =====
            doc.setFillColor(248, 250, 252);
            doc.setDrawColor(200, 200, 200);
            doc.roundedRect(margin, y, pageWidth - 2*margin, 35, 2, 2, 'FD');
            
            doc.setTextColor(100, 100, 100);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            
            // Left column
            doc.text('Reservation No:', margin + 5, y + 8);
            doc.text('Invoice Date:', margin + 5, y + 16);
            doc.text('Booking Source:', margin + 5, y + 24);
            doc.text('Booked By:', margin + 5, y + 32);
            
            doc.setTextColor(30, 30, 30);
            doc.setFont('helvetica', 'bold');
            doc.text(booking.id.toString(), margin + 45, y + 8);
            doc.text(new Date().toLocaleDateString('en-GB'), margin + 45, y + 16);
            doc.text(bookingSource, margin + 45, y + 24);
            doc.text(agent, margin + 45, y + 32);
            
            // Right column
            doc.setTextColor(100, 100, 100);
            doc.setFont('helvetica', 'normal');
            doc.text('Room(s):', margin + 105, y + 8);
            doc.text('Total Rooms:', margin + 105, y + 16);
            doc.text('Check-in:', margin + 105, y + 24);
            doc.text('Check-out:', margin + 105, y + 32);
            
            doc.setTextColor(30, 30, 30);
            doc.setFont('helvetica', 'bold');
            // List all room numbers for group booking
            var allRoomNums = allBookings.map(function(b) { return getRoomInfo(b.roomId, b.unitId).num; }).join(', ');
            doc.text(allRoomNums.substring(0, 25), margin + 140, y + 8);
            doc.text(allBookings.length.toString(), margin + 140, y + 16);
            doc.text(mainBooking.arrival || 'N/A', margin + 140, y + 24);
            doc.text(mainBooking.departure || 'N/A', margin + 140, y + 32);
            
            y += 42;
            
            // ===== GUEST INFORMATION =====
            doc.setFillColor(45, 106, 106);
            doc.rect(margin, y, pageWidth - 2*margin, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('GUEST INFORMATION', margin + 5, y + 6);
            
            y += 12;
            
            doc.setTextColor(60, 60, 60);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            
            // Find master booking (no masterId) or use first booking
            var masterBookingData = allBookings.find(function(b) { return !b.masterId; }) || allBookings[0];
            const primaryGuestName = ((masterBookingData.firstName || '') + ' ' + (masterBookingData.lastName || '')).trim() || 'N/A';
            
            doc.text('Primary Guest: ' + primaryGuestName, margin + 5, y);
            doc.text('Total Guests: ' + totalGuests, margin + 105, y);
            
            y += 7;
            doc.text('Phone: ' + (masterBookingData.mobile || mainBooking.mobile || 'N/A'), margin + 5, y);
            doc.text('Email: ' + (masterBookingData.email || mainBooking.email || 'N/A'), margin + 105, y);
            
            y += 7;
            var nidValue = masterBookingData.custom4 || mainBooking.custom4;
            doc.text('NID/Passport: ' + (nidValue && nidValue !== 'default' ? nidValue : 'N/A'), margin + 5, y);
            if (externalRef) {
                doc.text('External Ref: ' + externalRef, margin + 105, y);
            }
            
            y += 12;
            
            // ===== CHARGES TABLE =====
            doc.setFillColor(45, 106, 106);
            doc.rect(margin, y, pageWidth - 2*margin, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('CHARGES', margin + 5, y + 6);
            
            y += 10;
            
            // Table header
            doc.setFillColor(240, 240, 240);
            doc.rect(margin, y, pageWidth - 2*margin, 8, 'F');
            doc.setTextColor(60, 60, 60);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text('Description', margin + 5, y + 6);
            doc.text('Nights', margin + 90, y + 6);
            doc.text('Rate/Night', margin + 115, y + 6);
            doc.text('Amount (BDT)', pageWidth - margin - 5, y + 6, { align: 'right' });
            
            y += 10;
            
            // Room charge rows - one for each room in group with guest names
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(30, 30, 30);
            
            allBookings.forEach(function(b, index) {
                var roomInfo = getRoomInfo(b.roomId, b.unitId);
                var roomNum = roomInfo.num;
                var roomTypeName = (roomInfo.room?.short || roomInfo.room?.name || 'Standard').substring(0, 15);
                var roomPrice = parseFloat(b.price) || 0;
                var roomPaid = parseFloat(b.deposit) || 0;
                var roomNights = Math.max(1, Math.ceil((new Date(b.departure) - new Date(b.arrival)) / (1000 * 60 * 60 * 24)));
                var roomRate = Math.round(roomPrice / roomNights);
                var roomGuestName = ((b.firstName || '') + ' ' + (b.lastName || '')).trim() || 'Guest';
                
                // Room line with guest name for group bookings
                if (isGroupBooking) {
                    doc.text('Room ' + roomNum + ' (' + roomGuestName.substring(0, 20) + ')', margin + 5, y + 5);
                } else {
                    doc.text('Room ' + roomNum + ' - ' + roomTypeName, margin + 5, y + 5);
                }
                doc.text(roomNights.toString(), margin + 95, y + 5);
                doc.text(roomRate.toLocaleString(), margin + 120, y + 5);
                doc.text(roomPrice.toLocaleString(), pageWidth - margin - 5, y + 5, { align: 'right' });
                
                // Show individual dates if different from main booking
                if (isGroupBooking && (b.arrival !== mainBooking.arrival || b.departure !== mainBooking.departure)) {
                    y += 4;
                    doc.setFontSize(7);
                    doc.setTextColor(100, 100, 100);
                    doc.text('  (' + b.arrival + ' to ' + b.departure + ')', margin + 5, y + 5);
                    doc.setFontSize(9);
                    doc.setTextColor(30, 30, 30);
                }
                
                // Show paid amount for each room if group booking
                if (isGroupBooking && roomPaid > 0) {
                    y += 4;
                    doc.setFontSize(8);
                    doc.setTextColor(34, 197, 94);
                    doc.text('  Paid: BDT ' + roomPaid.toLocaleString(), margin + 5, y + 5);
                    doc.setFontSize(9);
                    doc.setTextColor(30, 30, 30);
                }
                
                y += 8;
            });
            
            doc.setDrawColor(200, 200, 200);
            doc.line(margin, y, pageWidth - margin, y);
            
            y += 15;
            
            // ===== PAYMENT SUMMARY =====
            y += 15;
            doc.setFillColor(248, 250, 252);
            doc.roundedRect(margin + 90, y, 85, 40, 2, 2, 'F');
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(60, 60, 60);
            
            doc.text(isGroupBooking ? 'Total (' + allBookings.length + ' rooms):' : 'Subtotal:', margin + 95, y + 10);
            doc.text('BDT ' + totalPrice.toLocaleString(), pageWidth - margin - 5, y + 10, { align: 'right' });
            
            doc.text('Advance Paid:', margin + 95, y + 20);
            doc.setTextColor(34, 197, 94);
            doc.text('BDT ' + totalPaid.toLocaleString(), pageWidth - margin - 5, y + 20, { align: 'right' });
            
            doc.setDrawColor(150, 150, 150);
            doc.line(margin + 95, y + 25, pageWidth - margin - 5, y + 25);
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            if (totalDue > 0) {
                doc.setTextColor(220, 50, 50);
            } else {
                doc.setTextColor(34, 197, 94);
            }
            doc.text('Balance Due:', margin + 95, y + 35);
            doc.text('BDT ' + totalDue.toLocaleString(), pageWidth - margin - 5, y + 35, { align: 'right' });
            
            y += 55;
            
            // ===== PAYMENT STATUS =====
            if (totalDue <= 0) {
                doc.setFillColor(34, 197, 94);
                doc.roundedRect(margin, y, pageWidth - 2*margin, 12, 2, 2, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('FULLY PAID - THANK YOU!', pageWidth/2, y + 8, { align: 'center' });
            } else {
                doc.setFillColor(254, 243, 199);
                doc.roundedRect(margin, y, pageWidth - 2*margin, 12, 2, 2, 'F');
                doc.setTextColor(180, 83, 9);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('PAYMENT DUE: BDT ' + totalDue.toLocaleString(), pageWidth/2, y + 8, { align: 'center' });
            }
            
            y += 20;
            
            // ===== TERMS & CONDITIONS =====
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(120, 120, 120);
            doc.text('Terms & Conditions:', margin, y);
            y += 5;
            doc.text('1. Check-in time: 2:00 PM | Check-out time: 12:00 PM', margin, y);
            y += 4;
            doc.text('2. Early check-in and late check-out subject to availability and additional charges.', margin, y);
            y += 4;
            doc.text('3. All rates are inclusive of applicable taxes unless stated otherwise.', margin, y);
            
            // ===== FOOTER =====
            doc.setFillColor(30, 41, 59);
            doc.rect(0, 277, pageWidth, 20, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.text('Thank you for choosing Miami Beach Resort!', pageWidth/2, 285, { align: 'center' });
            doc.setFontSize(7);
            doc.setTextColor(180, 180, 180);
            doc.text('This is a computer-generated invoice. Generated on ' + new Date().toLocaleString(), pageWidth/2, 292, { align: 'center' });
            
            // Save PDF
            var fileName;
            if (isGroupBooking) {
                fileName = 'Invoice-Group-' + allRoomNums.replace(/,\s*/g, '-') + '-' + (mainBooking.firstName || 'Guest') + '.pdf';
            } else {
                fileName = 'Invoice-' + num + '-' + (mainBooking.firstName || 'Guest') + '-' + mainBooking.id.toString().slice(-6) + '.pdf';
            }
            setInvoiceLoading(false);
            doc.save(fileName);
            
        } catch (err) {
            console.error('Invoice generation error:', err);
            alert('Error generating invoice: ' + err.message);
            setInvoiceLoading(false);
        }
    };
    
    // WhatsApp Share Function - Send booking details to guest
    const [whatsappLoading, setWhatsappLoading] = React.useState(false);
    
    const sendToWhatsApp = async function(withInvoice = false) {
        try {
            // Get phone number
            let phone = booking.mobile || '';
            phone = phone.replace(/[^0-9+]/g, ''); // Remove non-numeric except +
            
            if (!phone) {
                alert('No phone number found for this guest. Please add a phone number first.');
                return;
            }
            
            // Format phone for WhatsApp (remove leading 0, add country code if needed)
            if (phone.startsWith('0')) {
                phone = '88' + phone; // Bangladesh country code
            } else if (!phone.startsWith('+') && !phone.startsWith('88')) {
                phone = '88' + phone;
            }
            phone = phone.replace('+', ''); // WhatsApp API doesn't need +
            
            // Get group booking info
            const groupId = String(booking.masterId || booking.id);
            let allBookings = bookings.filter(b => 
                String(b.masterId) === groupId || String(b.id) === groupId
            );
            if (allBookings.length === 0) allBookings = [booking];
            const isGroup = allBookings.length > 1;
            
            // Calculate totals
            const totalPrice = allBookings.reduce((s, b) => s + (parseFloat(b.price) || 0), 0);
            const totalPaid = allBookings.reduce((s, b) => s + (parseFloat(b.deposit) || 0), 0);
            const totalDue = totalPrice - totalPaid;
            
            // Get room numbers
            const roomNumbers = allBookings.map(b => getRoomInfo(b.roomId, b.unitId).num).join(', ');
            
            // Calculate nights
            const checkIn = new Date(booking.arrival);
            const checkOut = new Date(booking.departure);
            const nights = Math.max(1, Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24)));
            
            // Format dates nicely
            const formatDateNice = (d) => new Date(d + 'T00:00:00').toLocaleDateString('en-GB', {day: 'numeric', month: 'short', year: 'numeric'});
            
            // Build message
            let message = `üè® *MIAMI BEACH RESORT*\n`;
            message += `üìç Cox's Bazar, Bangladesh\n`;
            message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
            
            message += `Dear *${booking.firstName || 'Guest'}*,\n\n`;
            message += `Thank you for choosing Miami Beach Resort! Here are your booking details:\n\n`;
            
            message += `üìã *BOOKING DETAILS*\n`;
            message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            message += `üîñ Booking ID: #${booking.id}\n`;
            message += `üö™ Room${isGroup ? 's' : ''}: *${roomNumbers}*\n`;
            message += `üìÖ Check-in: *${formatDateNice(booking.arrival)}*\n`;
            message += `üìÖ Check-out: *${formatDateNice(booking.departure)}*\n`;
            message += `üåô Duration: *${nights} Night${nights > 1 ? 's' : ''}*\n`;
            message += `üë§ Guests: ${booking.numAdult || 1} Adult${(booking.numAdult || 1) > 1 ? 's' : ''}`;
            if (booking.numChild > 0) message += `, ${booking.numChild} Child${booking.numChild > 1 ? 'ren' : ''}`;
            message += `\n\n`;
            
            message += `üí∞ *PAYMENT SUMMARY*\n`;
            message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            if (isGroup) {
                allBookings.forEach(b => {
                    const bNum = getRoomInfo(b.roomId, b.unitId).num;
                    const bPrice = parseFloat(b.price) || 0;
                    message += `Room ${bNum}: ‡ß≥${bPrice.toLocaleString()}\n`;
                });
                message += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
            }
            message += `Total Amount: ‡ß≥${totalPrice.toLocaleString()}\n`;
            message += `Amount Paid: ‡ß≥${totalPaid.toLocaleString()}\n`;
            message += `*Balance Due: ‡ß≥${totalDue.toLocaleString()}*\n\n`;
            
            if (totalDue > 0) {
                message += `‚ö†Ô∏è Please clear the balance upon arrival.\n\n`;
            } else {
                message += `‚úÖ Your booking is fully paid!\n\n`;
            }
            
            message += `üìû *CONTACT US*\n`;
            message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            message += `For any queries, please contact our front desk.\n\n`;
            
            message += `We look forward to welcoming you! üå¥\n`;
            message += `_Miami Beach Resort Team_`;
            
            // If withInvoice, first download the invoice
            if (withInvoice) {
                setWhatsappLoading(true);
                await generateInvoice();
                setWhatsappLoading(false);
                
                // Add note about attaching PDF
                message += `\n\nüìé _Invoice PDF has been downloaded. Please attach it to this chat._`;
            }
            
            // Encode message for URL
            const encodedMessage = encodeURIComponent(message);
            
            // Open WhatsApp
            const whatsappUrl = `https://wa.me/${phone}?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
            
        } catch (err) {
            console.error('WhatsApp share error:', err);
            alert('Error sending to WhatsApp: ' + err.message);
            setWhatsappLoading(false);
        }
    };
    
    const saveChanges = async (fields) => {
        setSaving(true);
        try {
            const updateData = {id: booking.id};
            fields.forEach(f => {
                if (f === 'nid') updateData.custom4 = form.nid;
                else if (f === 'dob') updateData.custom5 = form.dob;
                else updateData[f] = form[f];
            });
            
            console.log("Updating booking:", updateData);
            const res = await fetch(PROXY + "?endpoint=bookings&action=write", {
                method: "POST", 
                headers: {"Content-Type": "application/json"}, 
                body: JSON.stringify([updateData])
            });
            const result = await res.json();
            console.log("Update response:", result);
            
            const success = Array.isArray(result) ? result[0]?.success : result.success;
            if (success) {
                setEditMode(null);
                if (onUpdate) onUpdate();
            } else {
                alert("Update failed: " + JSON.stringify(result));
            }
        } catch(e) {
            console.error("Update error:", e);
            alert("Error: " + e.message);
        }
        setSaving(false);
    };
    
    // Save payment - handles both simple and advanced modes
    // Beds24 API Invoice Item Types:
    // - type: "charge" (1) = Room price/accommodation
    // - type: "payment" (200) = Generic payment received
    // - qty: positive for charges/payments, negative was old method
    const savePayment = async () => {
        setSaving(true);
        try {
            const isAdvancedMode = groupBookings.length > 1 && paymentMode === 'advanced';

            if (isAdvancedMode) {
                // Advanced mode: Update each room's deposit individually with invoice items
                // Beds24 API uses 'amount' field (not 'price') for invoice items
                const updates = [];
                for (const b of groupBookings) {
                    const addAmount = parseFloat(roomPayments[b.id]) || 0;
                    if (addAmount > 0) {
                        const currentDeposit = parseFloat(b.deposit) || 0;
                        updates.push({
                            id: b.id,
                            deposit: currentDeposit + addAmount,
                            invoiceItems: [{
                                type: "payment",
                                description: "Cash Received",
                                qty: 1,
                                amount: addAmount
                            }]
                        });
                    }
                }

                if (updates.length === 0) {
                    alert("Please enter payment amount for at least one room");
                    setSaving(false);
                    return;
                }

                console.log("Updating deposits with invoice items (advanced mode):", updates);
                const res = await fetch(PROXY + "?endpoint=bookings", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify(updates)
                });
                const result = await res.json();
                console.log("Beds24 update response:", result);
                const allSuccess = Array.isArray(result) ? result.every(r => r.success) : result.success;
                if (!allSuccess) {
                    alert("Some payments failed to save: " + JSON.stringify(result));
                }
            } else {
                // Simple mode: Update the form values (price and deposit)
                const newPrice = parseFloat(form.price) || 0;
                const newDeposit = parseFloat(form.deposit) || 0;
                const oldPrice = parseFloat(booking.price) || 0;
                const oldDeposit = parseFloat(booking.deposit) || 0;

                const updateData = {
                    id: booking.id,
                    price: newPrice,
                    deposit: newDeposit
                };

                // Build invoice items with correct Beds24 types
                // Beds24 API uses 'amount' field (not 'price') for invoice items
                const invoiceItems = [];

                // If deposit increased, add payment invoice item (type: payment)
                if (newDeposit > oldDeposit) {
                    invoiceItems.push({
                        type: "payment",
                        description: "Cash Received",
                        qty: 1,
                        amount: newDeposit - oldDeposit
                    });
                }

                // If price changed, update accommodation charge (type: charge)
                if (newPrice !== oldPrice) {
                    invoiceItems.push({
                        type: "charge",
                        description: "[ROOMNAME1] [FIRSTNIGHT] - [LEAVINGDAY]",
                        qty: 1,
                        amount: newPrice
                    });
                }

                if (invoiceItems.length > 0) {
                    updateData.invoiceItems = invoiceItems;
                }

                console.log("Updating payment with invoice items (simple mode):", updateData);
                const res = await fetch(PROXY + "?endpoint=bookings", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify([updateData])
                });
                const result = await res.json();
                console.log("Beds24 update response:", result);
                const success = Array.isArray(result) ? result[0]?.success : result.success;
                if (!success) {
                    alert("Update failed: " + JSON.stringify(result));
                    setSaving(false);
                    return;
                }
            }
            
            setEditMode(null);
            setPaymentMode('simple');
            setRoomPayments({});
            if (onUpdate) onUpdate();
        } catch(e) {
            console.error("Payment error:", e);
            alert("Error: " + e.message);
        }
        setSaving(false);
    };
    
    return (
        <div className="modal-overlay" onClick={onClose}>
            <div className="modal" onClick={e => e.stopPropagation()} style={{maxHeight: '90vh', overflowY: 'auto'}}>
                <div className="modal-header"><h3 style={{fontSize: '18px', fontWeight: '700'}}>‚ÑπÔ∏è Booking Details</h3><button className="modal-close" onClick={onClose}>√ó</button></div>
                
                {/* Room & Guest Header */}
                <div style={{display: 'flex', alignItems: 'center', gap: '16px', marginBottom: '20px'}}>
                    <div style={{width: '70px', height: '70px', background: 'linear-gradient(135deg, #2D6A6A, #245858)', borderRadius: '12px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '28px', fontWeight: '700'}}>{num}</div>
                    <div style={{flex: 1}}>
                        <div style={{fontSize: '20px', fontWeight: '700'}}>{booking.firstName} {booking.lastName}</div>
                        <div style={{color: 'rgba(255,255,255,0.5)', fontSize: '13px'}}>{room?.name}</div>
                        <div style={{color: 'rgba(255,255,255,0.4)', fontSize: '12px'}}>ID: {booking.id}</div>
                    </div>
                </div>
                
                {/* Warning for pending checkout on turnover */}
                {isPendingCheckoutFirst && (
                    <div style={{display: 'flex', alignItems: 'center', gap: '10px', padding: '12px', background: 'rgba(245,158,11,0.15)', border: '1px solid rgba(245,158,11,0.3)', borderRadius: '10px', marginBottom: '16px', color: '#f59e0b', fontSize: '13px'}}>
                        <span style={{fontSize: '18px'}}>‚ö†Ô∏è</span>
                        <span><strong>Checkout Required First:</strong> {rs.checkout?.firstName} must checkout before this guest can check in.</span>
                    </div>
                )}
                
                {/* Check-in / Check-out Action Buttons - Hidden for Housekeeping */}
                {currentTab !== 'housekeeping' && (isCheckInToday || isCheckOutToday) && toggle && (
                    <div style={{display: 'flex', gap: '10px', marginBottom: '16px', padding: '12px', background: 'rgba(0,0,0,0.2)', borderRadius: '10px'}}>
                        {isCheckInToday && (
                            <button 
                                onClick={() => {
                                    if (isPendingCheckoutFirst) {
                                        alert(`‚ö†Ô∏è Checkout Required First!\n\nPlease checkout ${rs.checkout?.firstName} ${rs.checkout?.lastName || ''} before checking in ${booking.firstName}.\n\nRoom must be vacated and cleaned before the next guest can check in.`);
                                        return;
                                    }
                                    toggle(booking.id, "in");
                                }} 
                                style={{
                                    flex: 1, padding: '12px', 
                                    background: isGuestCheckedIn 
                                        ? 'linear-gradient(135deg, #22c55e, #16a34a)' 
                                        : isPendingCheckoutFirst
                                            ? 'rgba(100,100,100,0.3)'
                                            : 'linear-gradient(135deg, #2D6A6A, #245858)', 
                                    border: 'none', borderRadius: '8px', 
                                    color: isPendingCheckoutFirst && !isGuestCheckedIn ? 'rgba(255,255,255,0.5)' : '#fff', 
                                    fontWeight: '700', fontSize: '14px', 
                                    cursor: isPendingCheckoutFirst && !isGuestCheckedIn ? 'not-allowed' : 'pointer',
                                    display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px',
                                    opacity: isPendingCheckoutFirst && !isGuestCheckedIn ? 0.6 : 1
                                }}>
                                {isGuestCheckedIn ? '‚Ü© Undo Check-in' : '‚¨áÔ∏è Mark Check-in'}
                            </button>
                        )}
                        {isCheckOutToday && (
                            <button 
                                onClick={() => toggle(booking.id, "out")} 
                                style={{
                                    flex: 1, padding: '12px', 
                                    background: isGuestCheckedOut ? 'linear-gradient(135deg, #22c55e, #16a34a)' : 'linear-gradient(135deg, #D4A853, #B8942F)', 
                                    border: 'none', borderRadius: '8px', color: '#fff', fontWeight: '700', fontSize: '14px', cursor: 'pointer',
                                    display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px'
                                }}>
                                {isGuestCheckedOut ? '‚Ü© Undo Check-out' : '‚¨ÜÔ∏è Mark Check-out'}
                            </button>
                        )}
                    </div>
                )}
                
                {/* Booking Source & Agent Info */}
                <div style={{display: 'flex', gap: '8px', marginBottom: '16px', flexWrap: 'wrap'}}>
                    {/* Source/Channel Badge */}
                    <div style={{
                        display: 'flex', alignItems: 'center', gap: '6px',
                        padding: '6px 12px', borderRadius: '20px', fontSize: '12px',
                        background: booking.apiSource === 'Direct' || booking.channel === 'direct' 
                            ? 'rgba(34,197,94,0.15)' 
                            : booking.apiSource?.toLowerCase().includes('booking') || booking.channel?.toLowerCase().includes('booking')
                            ? 'rgba(0,53,128,0.2)'
                            : booking.apiSource?.toLowerCase().includes('airbnb') || booking.channel?.toLowerCase().includes('airbnb')
                            ? 'rgba(255,90,95,0.2)'
                            : 'rgba(168,85,247,0.15)',
                        color: booking.apiSource === 'Direct' || booking.channel === 'direct'
                            ? '#22c55e'
                            : booking.apiSource?.toLowerCase().includes('booking') || booking.channel?.toLowerCase().includes('booking')
                            ? '#4B9CD3'
                            : booking.apiSource?.toLowerCase().includes('airbnb') || booking.channel?.toLowerCase().includes('airbnb')
                            ? '#FF5A5F'
                            : '#a855f7',
                        border: '1px solid currentColor'
                    }}>
                        <span>{booking.apiSource === 'Direct' || booking.channel === 'direct' ? 'üè®' : 
                               booking.apiSource?.toLowerCase().includes('booking') ? 'üÖ±Ô∏è' :
                               booking.apiSource?.toLowerCase().includes('airbnb') ? 'üè†' : 'üåê'}</span>
                        <span style={{fontWeight: '600'}}>{booking.apiSource || booking.channel || 'Direct'}</span>
                    </div>
                    
                    {/* Agent Badge */}
                    {(booking.referer || booking.refererEditable) && (
                        <div style={{
                            display: 'flex', alignItems: 'center', gap: '6px',
                            padding: '6px 12px', borderRadius: '20px', fontSize: '12px',
                            background: 'rgba(212,168,83,0.15)',
                            color: '#D4A853',
                            border: '1px solid rgba(212,168,83,0.4)'
                        }}>
                            <span>üë§</span>
                            <span style={{fontWeight: '600'}}>{booking.refererEditable || booking.referer}</span>
                        </div>
                    )}
                    
                    {/* External Reference */}
                    {booking.apiReference && (
                        <div style={{
                            display: 'flex', alignItems: 'center', gap: '6px',
                            padding: '6px 12px', borderRadius: '20px', fontSize: '11px',
                            background: 'rgba(255,255,255,0.05)',
                            color: 'rgba(255,255,255,0.6)',
                            border: '1px solid rgba(255,255,255,0.1)'
                        }}>
                            <span>üîó</span>
                            <span>Ref: {booking.apiReference}</span>
                        </div>
                    )}
                </div>
                
                {/* Guest Info Section */}
                <div className="info-section" style={{position: 'relative'}}>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px'}}>
                        <div className="info-label">üë§ Guest Info</div>
                        {currentTab !== 'housekeeping' && <button onClick={() => setEditMode(editMode === 'guest' ? null : 'guest')} style={{background: editMode === 'guest' ? 'rgba(239,68,68,0.2)' : 'rgba(45,106,106,0.2)', border: 'none', borderRadius: '6px', padding: '6px 12px', color: editMode === 'guest' ? '#ef4444' : '#2D6A6A', cursor: 'pointer', fontSize: '12px', fontWeight: '600'}}>{editMode === 'guest' ? '‚úï Cancel' : '‚úèÔ∏è Edit'}</button>}
                    </div>
                    {editMode === 'guest' && currentTab !== 'housekeeping' ? (
                        <div style={{display: 'flex', flexDirection: 'column', gap: '10px'}}>
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px'}}>
                                <input value={form.firstName} onChange={e => setForm({...form, firstName: e.target.value})} placeholder="First Name" style={inputStyle}/>
                                <input value={form.lastName} onChange={e => setForm({...form, lastName: e.target.value})} placeholder="Last Name" style={inputStyle}/>
                            </div>
                            <input value={form.mobile} onChange={e => setForm({...form, mobile: e.target.value})} placeholder="Phone" style={inputStyle}/>
                            <input value={form.email} onChange={e => setForm({...form, email: e.target.value})} placeholder="Email" style={inputStyle}/>
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px'}}>
                                <input value={form.nid} onChange={e => setForm({...form, nid: e.target.value})} placeholder="NID" style={inputStyle}/>
                                <input value={form.dob} onChange={e => setForm({...form, dob: e.target.value})} placeholder="DOB" style={inputStyle}/>
                            </div>
                            <button onClick={() => saveChanges(['firstName', 'lastName', 'mobile', 'email', 'nid', 'dob'])} disabled={saving} style={{padding: '12px', background: '#2D6A6A', border: 'none', borderRadius: '8px', color: '#fff', fontWeight: '700', cursor: 'pointer', opacity: saving ? 0.6 : 1}}>{saving ? '‚è≥ Saving...' : 'üíæ Save Guest Info'}</button>
                        </div>
                    ) : (
                        <div>
                            <div className="info-value" style={{marginBottom: '6px'}}>{booking.firstName} {booking.lastName}</div>
                            {currentTab !== 'housekeeping' && (
                                <>
                                    <div style={{fontSize: '13px', color: 'rgba(255,255,255,0.6)'}}>üìû {booking.mobile || 'No phone'}</div>
                                    {booking.email && booking.email !== 'default' && <div style={{fontSize: '13px', color: 'rgba(255,255,255,0.5)', marginTop: '4px'}}>‚úâÔ∏è {booking.email}</div>}
                                    {booking.custom4 && booking.custom4 !== 'default' && <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.4)', marginTop: '4px'}}>ü™™ NID: {booking.custom4}</div>}
                                    {booking.custom5 && booking.custom5 !== 'default' && <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.4)', marginTop: '2px'}}>üéÇ DOB: {booking.custom5}</div>}
                                </>
                            )}
                        </div>
                    )}
                </div>
                
                {/* Dates Section */}
                <div className="info-section">
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px'}}>
                        <div className="info-label">üìÖ Stay Dates</div>
                        {currentTab !== 'housekeeping' && <button onClick={() => setEditMode(editMode === 'dates' ? null : 'dates')} style={{background: editMode === 'dates' ? 'rgba(239,68,68,0.2)' : 'rgba(45,106,106,0.2)', border: 'none', borderRadius: '6px', padding: '6px 12px', color: editMode === 'dates' ? '#ef4444' : '#2D6A6A', cursor: 'pointer', fontSize: '12px', fontWeight: '600'}}>{editMode === 'dates' ? '‚úï Cancel' : '‚úèÔ∏è Edit'}</button>}
                    </div>
                    {editMode === 'dates' ? (
                        <div style={{display: 'flex', flexDirection: 'column', gap: '10px'}}>
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px'}}>
                                <div><label style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', display: 'block', marginBottom: '4px'}}>Check-in</label><input type="date" value={form.arrival} onChange={e => setForm({...form, arrival: e.target.value})} style={inputStyle}/></div>
                                <div><label style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', display: 'block', marginBottom: '4px'}}>Check-out</label><input type="date" value={form.departure} min={form.arrival} onChange={e => setForm({...form, departure: e.target.value})} style={inputStyle}/></div>
                            </div>
                            <button onClick={() => saveChanges(['arrival', 'departure'])} disabled={saving} style={{padding: '12px', background: '#2D6A6A', border: 'none', borderRadius: '8px', color: '#fff', fontWeight: '700', cursor: 'pointer', opacity: saving ? 0.6 : 1}}>{saving ? '‚è≥ Saving...' : 'üíæ Save Dates'}</button>
                        </div>
                    ) : (
                        <div className="info-grid">
                            <div><div className="info-label">Check-in</div><div className="info-value">{formatDate(booking.arrival)}</div></div>
                            <div><div className="info-label">Check-out</div><div className="info-value">{formatDate(booking.departure)}</div></div>
                        </div>
                    )}
                </div>
                
                {/* Payment Section - Hidden for Housekeeping */}
                {currentTab !== 'housekeeping' && (
                <div className="info-section">
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px'}}>
                        <div className="info-label">üí∞ Payment</div>
                        <button onClick={() => setEditMode(editMode === 'payment' ? null : 'payment')} style={{background: editMode === 'payment' ? 'rgba(239,68,68,0.2)' : 'rgba(45,106,106,0.2)', border: 'none', borderRadius: '6px', padding: '6px 12px', color: editMode === 'payment' ? '#ef4444' : '#2D6A6A', cursor: 'pointer', fontSize: '12px', fontWeight: '600'}}>{editMode === 'payment' ? '‚úï Cancel' : '‚úèÔ∏è Edit'}</button>
                    </div>
                    {editMode === 'payment' ? (
                        <div style={{display: 'flex', flexDirection: 'column', gap: '10px'}}>
                            {/* Simple/Advanced Toggle - Only for group bookings */}
                            {groupBookings.length > 1 && (
                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '10px', background: 'rgba(212,168,83,0.1)', border: '1px solid rgba(212,168,83,0.3)', borderRadius: '8px', marginBottom: '6px'}}>
                                    <div>
                                        <div style={{fontSize: '12px', fontWeight: '600', color: '#D4A853'}}>üë• Group Booking ({groupBookings.length} rooms)</div>
                                        <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)'}}>Rooms: {groupBookings.map(b => getRoomInfo(b.roomId, b.unitId).num).join(', ')}</div>
                                    </div>
                                    <div style={{display: 'flex', gap: '6px'}}>
                                        <button type="button" onClick={() => setPaymentMode('simple')} style={{
                                            padding: '6px 12px', borderRadius: '6px', fontSize: '11px', fontWeight: '600', cursor: 'pointer',
                                            background: paymentMode === 'simple' ? '#2D6A6A' : 'rgba(255,255,255,0.08)',
                                            color: paymentMode === 'simple' ? '#fff' : 'rgba(255,255,255,0.6)',
                                            border: paymentMode === 'simple' ? 'none' : '1px solid rgba(255,255,255,0.15)'
                                        }}>Simple</button>
                                        <button type="button" onClick={() => setPaymentMode('advanced')} style={{
                                            padding: '6px 12px', borderRadius: '6px', fontSize: '11px', fontWeight: '600', cursor: 'pointer',
                                            background: paymentMode === 'advanced' ? '#2D6A6A' : 'rgba(255,255,255,0.08)',
                                            color: paymentMode === 'advanced' ? '#fff' : 'rgba(255,255,255,0.6)',
                                            border: paymentMode === 'advanced' ? 'none' : '1px solid rgba(255,255,255,0.15)'
                                        }}>Advanced</button>
                                    </div>
                                </div>
                            )}
                            
                            {/* Simple Mode - Edit current booking's price/deposit */}
                            {(groupBookings.length <= 1 || paymentMode === 'simple') && (
                                <>
                                    <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px'}}>
                                        <div><label style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', display: 'block', marginBottom: '4px'}}>Total Price (‡ß≥)</label><input type="number" value={form.price} onChange={e => setForm({...form, price: e.target.value})} style={inputStyle}/></div>
                                        <div><label style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', display: 'block', marginBottom: '4px'}}>Paid (‡ß≥)</label><input type="number" value={form.deposit} onChange={e => setForm({...form, deposit: e.target.value})} style={inputStyle}/></div>
                                    </div>
                                    <div style={{padding: '10px', background: 'rgba(255,255,255,0.05)', borderRadius: '6px', textAlign: 'center'}}>
                                        <span style={{fontSize: '12px', color: 'rgba(255,255,255,0.5)'}}>Due: </span>
                                        <span style={{fontSize: '18px', fontWeight: '700', color: (parseFloat(form.price) - parseFloat(form.deposit)) > 0 ? '#ef4444' : '#2D6A6A'}}>‡ß≥{(parseFloat(form.price || 0) - parseFloat(form.deposit || 0)).toLocaleString()}</span>
                                    </div>
                                </>
                            )}
                            
                            {/* Advanced Mode - Per room payment */}
                            {groupBookings.length > 1 && paymentMode === 'advanced' && (
                                <div>
                                    <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', marginBottom: '10px'}}>
                                        ‚ÑπÔ∏è Add payment to each room individually
                                    </div>
                                    {groupBookings.map(b => {
                                        const {num: roomNum, room: roomInfo} = getRoomInfo(b.roomId, b.unitId);
                                        const roomPrice = parseFloat(b.price) || 0;
                                        const roomPaid = parseFloat(b.deposit) || 0;
                                        const roomDue = roomPrice - roomPaid;
                                        return (
                                            <div key={b.id} style={{display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px', padding: '10px', background: 'rgba(0,0,0,0.2)', borderRadius: '8px'}}>
                                                <div style={{flex: 1}}>
                                                    <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                                                        <span style={{fontSize: '14px', fontWeight: '700', color: b.id === booking.id ? '#D4A853' : '#fff'}}>{roomNum}</span>
                                                        {b.id === booking.id && <span style={{fontSize: '9px', background: '#D4A853', color: '#000', padding: '2px 6px', borderRadius: '4px'}}>Current</span>}
                                                    </div>
                                                    <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)'}}>{roomInfo?.short || ''}</div>
                                                    <div style={{fontSize: '10px', color: 'rgba(255,255,255,0.4)', marginTop: '2px'}}>
                                                        Total: ‡ß≥{roomPrice.toLocaleString()} ‚Ä¢ Paid: ‡ß≥{roomPaid.toLocaleString()} ‚Ä¢ <span style={{color: roomDue > 0 ? '#ef4444' : '#22c55e'}}>Due: ‡ß≥{roomDue.toLocaleString()}</span>
                                                    </div>
                                                </div>
                                                <div style={{width: '110px'}}>
                                                    <input 
                                                        type="number" 
                                                        value={roomPayments[b.id] || ''} 
                                                        onChange={e => setRoomPayments({...roomPayments, [b.id]: e.target.value})}
                                                        placeholder="Add ‡ß≥"
                                                        style={{width: '100%', padding: '10px', background: 'rgba(255,255,255,0.08)', border: '1px solid rgba(255,255,255,0.15)', borderRadius: '6px', color: '#fff', fontSize: '14px', textAlign: 'right'}}
                                                    />
                                                </div>
                                            </div>
                                        );
                                    })}
                                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginTop: '8px', padding: '10px', background: 'rgba(34,197,94,0.15)', borderRadius: '8px'}}>
                                        <span style={{fontSize: '12px', fontWeight: '600'}}>Total Adding</span>
                                        <span style={{fontSize: '16px', fontWeight: '700', color: '#22c55e'}}>
                                            ‡ß≥{Object.values(roomPayments).reduce((sum, amt) => sum + (parseFloat(amt) || 0), 0).toLocaleString()}
                                        </span>
                                    </div>
                                </div>
                            )}
                            
                            <button onClick={savePayment} disabled={saving} style={{padding: '12px', background: '#2D6A6A', border: 'none', borderRadius: '8px', color: '#fff', fontWeight: '700', cursor: 'pointer', opacity: saving ? 0.6 : 1}}>{saving ? '‚è≥ Saving...' : 'üíæ Save Payment'}</button>
                        </div>
                    ) : (
                        <>
                            <div className="info-grid" style={{marginTop: '8px'}}>
                                <div><div className="info-label">Total</div><div className="info-value">‡ß≥{price.toLocaleString()}</div></div>
                                <div><div className="info-label">Paid</div><div className="info-value" style={{color: '#2D6A6A'}}>‡ß≥{paid.toLocaleString()}</div></div>
                            </div>
                            <div style={{marginTop: '12px', padding: '12px', background: due > 0 ? 'rgba(239,68,68,0.15)' : 'rgba(45,106,106,0.15)', borderRadius: '8px', textAlign: 'center'}}>
                                <div className="info-label">Due</div>
                                <div style={{fontSize: '28px', fontWeight: '700', color: due > 0 ? '#ef4444' : '#2D6A6A'}}>‡ß≥{due.toLocaleString()}</div>
                            </div>
                        </>
                    )}
                </div>
                )}
                
                {/* Booking Status Section */}
                <div className="info-section">
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px'}}>
                        <div className="info-label">üìã Booking Status</div>
                        {currentTab !== 'housekeeping' && <button onClick={() => setEditMode(editMode === 'status' ? null : 'status')} style={{background: editMode === 'status' ? 'rgba(239,68,68,0.2)' : 'rgba(45,106,106,0.2)', border: 'none', borderRadius: '6px', padding: '6px 12px', color: editMode === 'status' ? '#ef4444' : '#2D6A6A', cursor: 'pointer', fontSize: '12px', fontWeight: '600'}}>{editMode === 'status' ? '‚úï Cancel' : '‚úèÔ∏è Change'}</button>}
                    </div>
                    {editMode === 'status' ? (
                        <div style={{display: 'flex', flexDirection: 'column', gap: '10px'}}>
                            <div>
                                <label style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', display: 'block', marginBottom: '4px'}}>Status</label>
                                <select value={form.status || booking.status || 'confirmed'} onChange={e => setForm({...form, status: e.target.value})} style={{...inputStyle, cursor: 'pointer'}}>
                                    <option value="confirmed">‚úÖ Confirmed</option>
                                    <option value="request">‚è≥ Request (Pending)</option>
                                    <option value="new">üÜï New</option>
                                    <option value="cancelled">‚ùå Cancelled</option>
                                    <option value="black">‚¨õ Black (Blocked)</option>
                                    <option value="inquiry">‚ùì Inquiry</option>
                                </select>
                            </div>
                            <div>
                                <label style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', display: 'block', marginBottom: '4px'}}>Sub-Status</label>
                                <select value={form.subStatus || booking.subStatus || 'none'} onChange={e => setForm({...form, subStatus: e.target.value})} style={{...inputStyle, cursor: 'pointer'}}>
                                    <option value="none">‚Äî None ‚Äî</option>
                                    <option value="actionRequired">‚ö†Ô∏è Action Required</option>
                                    <option value="walkin">üö∂ Walk-in</option>
                                    <option value="noShow">üö´ No Show</option>
                                    <option value="cancelledByGuest">üë§ Cancelled by Guest</option>
                                    <option value="cancelledByHost">üè® Cancelled by Host</option>
                                    <option value="allotment">üì¶ Allotment</option>
                                    <option value="waitlist">üìã Waitlist</option>
                                </select>
                            </div>
                            {(form.status === 'cancelled' || form.subStatus === 'cancelledByGuest' || form.subStatus === 'cancelledByHost') && (
                                <div style={{padding: '10px', background: 'rgba(239,68,68,0.15)', borderRadius: '6px', fontSize: '12px', color: '#ef4444'}}>
                                    ‚ö†Ô∏è Warning: Cancelled bookings will release the room dates
                                </div>
                            )}
                            <button onClick={() => saveChanges(['status', 'subStatus'])} disabled={saving} style={{padding: '12px', background: '#2D6A6A', border: 'none', borderRadius: '8px', color: '#fff', fontWeight: '700', cursor: 'pointer', opacity: saving ? 0.6 : 1}}>{saving ? '‚è≥ Saving...' : 'üíæ Save Status'}</button>
                        </div>
                    ) : (
                        <div style={{display: 'flex', alignItems: 'center', gap: '10px', flexWrap: 'wrap'}}>
                            <span style={{
                                padding: '6px 14px', 
                                borderRadius: '20px', 
                                fontSize: '13px', 
                                fontWeight: '600',
                                background: booking.status === 'confirmed' ? 'rgba(34,197,94,0.2)' : 
                                           booking.status === 'request' ? 'rgba(245,158,11,0.2)' : 
                                           booking.status === 'cancelled' ? 'rgba(239,68,68,0.2)' :
                                           booking.status === 'new' ? 'rgba(59,130,246,0.2)' :
                                           booking.status === 'black' ? 'rgba(100,100,100,0.2)' :
                                           'rgba(168,85,247,0.2)',
                                color: booking.status === 'confirmed' ? '#22c55e' : 
                                       booking.status === 'request' ? '#f59e0b' : 
                                       booking.status === 'cancelled' ? '#ef4444' :
                                       booking.status === 'new' ? '#3b82f6' :
                                       booking.status === 'black' ? '#888' :
                                       '#a855f7'
                            }}>
                                {booking.status === 'confirmed' ? '‚úÖ Confirmed' : 
                                 booking.status === 'request' ? '‚è≥ Request' : 
                                 booking.status === 'cancelled' ? '‚ùå Cancelled' :
                                 booking.status === 'new' ? 'üÜï New' :
                                 booking.status === 'black' ? '‚¨õ Blocked' :
                                 booking.status === 'inquiry' ? '‚ùì Inquiry' :
                                 booking.status || 'Unknown'}
                            </span>
                            {booking.subStatus && booking.subStatus !== 'none' && (
                                <span style={{padding: '4px 10px', borderRadius: '12px', fontSize: '11px', background: 'rgba(255,255,255,0.1)', color: 'rgba(255,255,255,0.7)'}}>
                                    {booking.subStatus === 'actionRequired' ? '‚ö†Ô∏è Action Required' :
                                     booking.subStatus === 'walkin' ? 'üö∂ Walk-in' :
                                     booking.subStatus === 'noShow' ? 'üö´ No Show' :
                                     booking.subStatus === 'cancelledByGuest' ? 'üë§ By Guest' :
                                     booking.subStatus === 'cancelledByHost' ? 'üè® By Host' :
                                     booking.subStatus}
                                </span>
                            )}
                        </div>
                    )}
                </div>
                
                {/* Notes Section - Hidden for Housekeeping */}
                {currentTab !== 'housekeeping' && (
                <div className="info-section">
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px'}}>
                        <div className="info-label">üìù Notes</div>
                        <button onClick={() => setEditMode(editMode === 'notes' ? null : 'notes')} style={{background: editMode === 'notes' ? 'rgba(239,68,68,0.2)' : 'rgba(45,106,106,0.2)', border: 'none', borderRadius: '6px', padding: '6px 12px', color: editMode === 'notes' ? '#ef4444' : '#2D6A6A', cursor: 'pointer', fontSize: '12px', fontWeight: '600'}}>{editMode === 'notes' ? '‚úï Cancel' : '‚úèÔ∏è Edit'}</button>
                    </div>
                    {editMode === 'notes' ? (
                        <div style={{display: 'flex', flexDirection: 'column', gap: '10px'}}>
                            <textarea 
                                value={form.notes} 
                                onChange={e => setForm({...form, notes: e.target.value})} 
                                placeholder="Add booking notes..." 
                                rows={4} 
                                style={{...inputStyle, resize: 'vertical', minHeight: '80px'}}
                            />
                            <button onClick={() => saveChanges(['notes'])} disabled={saving} style={{padding: '12px', background: '#2D6A6A', border: 'none', borderRadius: '8px', color: '#fff', fontWeight: '700', cursor: 'pointer', opacity: saving ? 0.6 : 1}}>{saving ? '‚è≥ Saving...' : 'üíæ Save Notes'}</button>
                        </div>
                    ) : (
                        <div style={{padding: '10px', background: 'rgba(255,255,255,0.03)', borderRadius: '8px', minHeight: '40px'}}>
                            {booking.notes ? (
                                <div style={{fontSize: '13px', color: 'rgba(255,255,255,0.8)', whiteSpace: 'pre-wrap', lineHeight: '1.5'}}>{booking.notes}</div>
                            ) : (
                                <div style={{fontSize: '13px', color: 'rgba(255,255,255,0.4)', fontStyle: 'italic'}}>No notes</div>
                            )}
                        </div>
                    )}
                </div>
                )}
                
                {/* Requests Section */}
                {counts.total > 0 && (
                    <div className="info-section">
                        <div className="info-label">üõéÔ∏è Requests ({counts.total})</div>
                        <div style={{display: 'flex', gap: '8px', marginTop: '8px'}}>{counts.pending > 0 && <span className="request-count pending" style={{padding: '4px 10px'}}>‚è≥ {counts.pending} Pending</span>}{counts.done > 0 && <span className="request-count done" style={{padding: '4px 10px'}}>‚úì {counts.done} Done</span>}</div>
                        <div style={{marginTop: '10px', maxHeight: '150px', overflowY: 'auto'}}>
                            {bookingRequests.map(r => (<div key={r.id} style={{padding: '8px', background: 'rgba(255,255,255,0.03)', borderRadius: '6px', marginBottom: '6px', fontSize: '12px', borderLeft: r.done ? '3px solid #2D6A6A' : '3px solid #f59e0b'}}><div style={{fontWeight: '600'}}>{r.requestType}</div>{r.note && <div style={{color: 'rgba(255,255,255,0.5)', marginTop: '2px'}}>{r.note}</div>}<div style={{color: 'rgba(255,255,255,0.4)', marginTop: '4px'}}>{r.done ? `‚úì Done ${new Date(r.doneAt).toLocaleTimeString()}` : `‚è≥ ${new Date(r.timestamp).toLocaleTimeString()}`}</div></div>))}
                        </div>
                    </div>
                )}
                
                {/* Download Invoice Button - Hidden for Housekeeping */}
                {(!currentUser || (currentUser.role !== 'hk_team' && currentUser.role !== 'hk_manager')) && (
                    <div style={{marginTop: '16px', paddingTop: '16px', borderTop: '1px solid rgba(255,255,255,0.1)'}}>
                        {/* Invoice Button */}
                        <button onClick={generateInvoice} disabled={invoiceLoading} style={{width: '100%', padding: '14px', background: invoiceLoading ? 'linear-gradient(135deg, #6b7280, #4b5563)' : 'linear-gradient(135deg, #D4A853, #c49a4a)', border: 'none', borderRadius: '10px', color: '#fff', fontWeight: '700', cursor: invoiceLoading ? 'wait' : 'pointer', fontSize: '14px', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px', opacity: invoiceLoading ? 0.7 : 1}}>
                            {invoiceLoading ? '‚è≥ Preparing invoice...' : 'üìÑ Download Invoice (PDF)'}
                        </button>
                        
                        {/* WhatsApp Buttons Row */}
                        <div style={{display: 'flex', gap: '10px', marginTop: '10px'}}>
                            {/* Send Summary to WhatsApp */}
                            <button 
                                onClick={() => sendToWhatsApp(false)} 
                                disabled={whatsappLoading}
                                style={{flex: 1, padding: '12px', background: 'linear-gradient(135deg, #25D366, #128C7E)', border: 'none', borderRadius: '10px', color: '#fff', fontWeight: '600', cursor: 'pointer', fontSize: '13px', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '6px'}}
                            >
                                üí¨ Send to WhatsApp
                            </button>
                            
                            {/* Send with Invoice */}
                            <button 
                                onClick={() => sendToWhatsApp(true)} 
                                disabled={whatsappLoading || invoiceLoading}
                                style={{flex: 1, padding: '12px', background: whatsappLoading ? 'linear-gradient(135deg, #6b7280, #4b5563)' : 'linear-gradient(135deg, #128C7E, #075E54)', border: 'none', borderRadius: '10px', color: '#fff', fontWeight: '600', cursor: (whatsappLoading || invoiceLoading) ? 'wait' : 'pointer', fontSize: '13px', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '6px', opacity: (whatsappLoading || invoiceLoading) ? 0.7 : 1}}
                            >
                                {whatsappLoading ? '‚è≥ Loading...' : 'üìÑüí¨ With Invoice'}
                            </button>
                        </div>
                        
                        {/* Phone number hint */}
                        {booking.mobile && (
                            <div style={{marginTop: '8px', fontSize: '11px', color: 'rgba(255,255,255,0.4)', textAlign: 'center'}}>
                                üì± Will send to: {booking.mobile}
                            </div>
                        )}
                        {!booking.mobile && (
                            <div style={{marginTop: '8px', fontSize: '11px', color: '#f59e0b', textAlign: 'center'}}>
                                ‚ö†Ô∏è No phone number - add one to enable WhatsApp
                            </div>
                        )}
                    </div>
                )}
                
                {/* Multi-Unit Info */}
                {multiUnit && (<div className="info-section" style={{background: 'rgba(45,106,106,0.1)', border: '1px solid rgba(45,106,106,0.3)'}}><div className="info-label" style={{color: '#2D6A6A'}}>üîó Multi-Room ({multiUnit.count})</div><div style={{fontSize: '13px', marginTop: '6px'}}>Rooms: {multiUnit.rooms.join(", ")}</div><div style={{marginTop: '10px', padding: '10px', background: 'rgba(0,0,0,0.2)', borderRadius: '8px', textAlign: 'center'}}><div className="info-label">Total Due</div><div style={{fontSize: '24px', fontWeight: '700', color: multiUnit.totalDue > 0 ? '#ef4444' : '#2D6A6A'}}>‡ß≥{multiUnit.totalDue.toLocaleString()}</div></div></div>)}
            </div>
        </div>
    );
}

function AccountingTab({bookings, getRoomInfo, formatDate, fetchData, setShowInfoModal, setIsEditing}) {
    // Main view toggle: "cashflow" | "revenue" | "bookings"
    const [accView, setAccView] = useState("cashflow");
    
    // ===== DAILY CASH FLOW STATES =====
    const today = getBDDate();
    const [selectedDate, setSelectedDate] = useState(today);
    const dateRef = React.useRef(null);
    
    // Shift management
    const SHIFTS = [
        {id: "morning", label: "üåÖ Morning", time: "6AM - 2PM", color: "#f59e0b"},
        {id: "day", label: "‚òÄÔ∏è Day", time: "2PM - 10PM", color: "#2D6A6A"},
        {id: "night", label: "üåô Night", time: "10PM - 6AM", color: "#6366f1"}
    ];
    
    const [currentShift, setCurrentShift] = useState(() => {
        const hour = new Date().getHours();
        if (hour >= 6 && hour < 14) return "morning";
        if (hour >= 14 && hour < 22) return "day";
        return "night";
    });
    
    // Cash flow data structure stored in localStorage
    const [cashFlowData, setCashFlowData] = useState(() => {
        try { return JSON.parse(localStorage.getItem("miami_cashflow_v2") || "{}"); } catch { return {}; }
    });
    
    // Staff management
    const [staffOnDuty, setStaffOnDuty] = useState(() => {
        try { return JSON.parse(localStorage.getItem("miami_staff_v1") || "{}"); } catch { return {}; }
    });
    const [staffName, setStaffName] = useState("");
    
    // Transaction modal
    const [showTransModal, setShowTransModal] = useState(null);
    const [transForm, setTransForm] = useState({
        type: "advance", source: "cash", amount: "", bookingId: "", guestName: "", roomNum: "",
        transactionId: "", reference: "", responsiblePerson: "", description: "", category: "income",
        selectedBooking: null, checkInDate: ""
    });
    const [guestSearchQuery, setGuestSearchQuery] = useState("");
    const [showGuestDropdown, setShowGuestDropdown] = useState(false);
    const [syncingToApi, setSyncingToApi] = useState(false);
    
    // Group booking payment states
    const [paymentMode, setPaymentMode] = useState("simple"); // simple | advanced
    const [groupBookings, setGroupBookings] = useState([]); // Related bookings for group
    const [roomPayments, setRoomPayments] = useState({}); // {bookingId: amount} for advanced mode
    
    // Get group booking info
    const getGroupBookings = (booking) => {
        if (!booking) return [];
        // Check if this booking has a masterId or if its id is a masterId for others
        const masterId = booking.masterId || booking.id;
        const related = bookings.filter(b => 
            b.masterId === masterId || 
            b.id === masterId || 
            (booking.masterId && b.masterId === booking.masterId)
        );
        // Only return if more than 1 booking in group
        return related.length > 1 ? related : [];
    };
    
    // Search bookings for guest
    const searchedGuests = useMemo(() => {
        if (!guestSearchQuery || guestSearchQuery.length < 2) return [];
        const q = guestSearchQuery.toLowerCase();
        return bookings.filter(b => {
            const name = `${b.firstName || ''} ${b.lastName || ''}`.toLowerCase();
            const room = getRoomInfo(b.roomId, b.unitId).num;
            return name.includes(q) || room.includes(q) || (b.mobile && b.mobile.includes(q));
        }).slice(0, 10);
    }, [guestSearchQuery, bookings, getRoomInfo]);
    
    // Select guest from search
    const selectGuest = (booking) => {
        const {num} = getRoomInfo(booking.roomId, booking.unitId);
        const group = getGroupBookings(booking);
        
        // Initialize room payments for advanced mode
        const initialPayments = {};
        group.forEach(b => { initialPayments[b.id] = ""; });
        
        setTransForm({
            ...transForm,
            selectedBooking: booking,
            bookingId: booking.id,
            guestName: `${booking.firstName || ''} ${booking.lastName || ''}`.trim(),
            roomNum: num,
            checkInDate: booking.arrival
        });
        setGroupBookings(group);
        setRoomPayments(initialPayments);
        setPaymentMode("simple");
        setGuestSearchQuery("");
        setShowGuestDropdown(false);
    };
    
    // Income types
    const INCOME_TYPES = [
        {id: "advance", label: "üí∞ Advance Payment", color: "#2D6A6A", needsGuest: true},
        {id: "guest", label: "üë§ Guest Payment", color: "#22c55e", needsGuest: true},
        {id: "agency", label: "üè¢ Agency Collection", color: "#8b5cf6"},
        {id: "management_cash", label: "üíº Cash from Management", color: "#f59e0b"},
        {id: "bank_withdrawal", label: "üè¶ Bank Withdrawal", color: "#3b82f6"},
        {id: "other_income", label: "üì• Other Income", color: "#6366f1"}
    ];
    
    // Expense types
    const EXPENSE_TYPES = [
        {id: "bill_payment", label: "üìÑ Bill Payment", color: "#ef4444", requiresRef: true},
        {id: "refund", label: "üí∏ Refund", color: "#f97316"},
        {id: "management_taken", label: "üíº Cash to Management", color: "#dc2626"},
        {id: "bank_deposit", label: "üè¶ Bank Deposit", color: "#3b82f6"},
        {id: "supplies", label: "üõí Supplies/Purchase", color: "#8b5cf6"},
        {id: "salary_advance", label: "üë§ Salary Advance", color: "#6366f1"},
        {id: "maintenance", label: "üîß Maintenance", color: "#f59e0b"},
        {id: "other_expense", label: "üì§ Other Expense", color: "#94a3b8"}
    ];
    
    // Payment sources/methods
    const PAYMENT_SOURCES = [
        {id: "cash", label: "üíµ Cash", color: "#22c55e", requiresTxId: false},
        {id: "bkash", label: "üì± bKash", color: "#E2136E", requiresTxId: true},
        {id: "nagad", label: "üì± Nagad", color: "#f97316", requiresTxId: true},
        {id: "rocket", label: "üì± Rocket", color: "#8b5cf6", requiresTxId: true},
        {id: "bank", label: "üè¶ Bank Transfer", color: "#3b82f6", requiresTxId: true},
        {id: "card", label: "üí≥ Card", color: "#6366f1", requiresTxId: true},
        {id: "agency", label: "üè¢ Agency", color: "#a855f7", requiresTxId: false},
        {id: "other", label: "üìã Other", color: "#94a3b8", requiresTxId: true}
    ];
    
    const getSourceInfo = (id) => PAYMENT_SOURCES.find(s => s.id === id) || PAYMENT_SOURCES[0];
    const getIncomeTypeInfo = (id) => INCOME_TYPES.find(t => t.id === id) || INCOME_TYPES[0];
    const getExpenseTypeInfo = (id) => EXPENSE_TYPES.find(t => t.id === id) || EXPENSE_TYPES[0];
    const getShiftInfo = (id) => SHIFTS.find(s => s.id === id) || SHIFTS[0];
    
    // Save functions
    const saveCashFlow = (updated) => {
        localStorage.setItem("miami_cashflow_v2", JSON.stringify(updated));
        setCashFlowData(updated);
    };
    
    const saveStaff = (updated) => {
        localStorage.setItem("miami_staff_v1", JSON.stringify(updated));
        setStaffOnDuty(updated);
    };
    
    // Get day's data
    const getDayData = (date) => cashFlowData[date] || {income: [], expenses: [], handovers: []};
    const dayData = getDayData(selectedDate);
    
    // Get shift data for a specific shift
    const getShiftData = (date, shiftId) => {
        const day = getDayData(date);
        return {
            income: day.income.filter(t => t.shift === shiftId),
            expenses: day.expenses.filter(t => t.shift === shiftId)
        };
    };
    
    // Calculate shift totals
    const calculateShiftTotals = (date, shiftId) => {
        const shift = getShiftData(date, shiftId);
        const totalIncome = shift.income.reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
        const totalExpense = shift.expenses.reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
        
        const incomeBySource = {};
        PAYMENT_SOURCES.forEach(s => { incomeBySource[s.id] = 0; });
        shift.income.forEach(t => {
            incomeBySource[t.source] = (incomeBySource[t.source] || 0) + (parseFloat(t.amount) || 0);
        });
        
        const incomeByType = {};
        INCOME_TYPES.forEach(t => { incomeByType[t.id] = 0; });
        shift.income.forEach(t => {
            incomeByType[t.type] = (incomeByType[t.type] || 0) + (parseFloat(t.amount) || 0);
        });
        
        const expensesByType = {};
        EXPENSE_TYPES.forEach(t => { expensesByType[t.id] = 0; });
        shift.expenses.forEach(t => {
            expensesByType[t.type] = (expensesByType[t.type] || 0) + (parseFloat(t.amount) || 0);
        });
        
        const cashIncome = shift.income.filter(t => t.source === 'cash').reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
        const cashExpense = shift.expenses.filter(t => t.source === 'cash').reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
        
        return { totalIncome, totalExpense, netCash: cashIncome - cashExpense, incomeBySource, incomeByType, expensesByType, cashIncome, cashExpense, transactions: shift.income.length + shift.expenses.length };
    };
    
    // Calculate day totals
    const calculateDayTotals = (date) => {
        const day = getDayData(date);
        const totalIncome = day.income.reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
        const totalExpense = day.expenses.reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
        
        const incomeBySource = {};
        PAYMENT_SOURCES.forEach(s => { incomeBySource[s.id] = 0; });
        day.income.forEach(t => {
            incomeBySource[t.source] = (incomeBySource[t.source] || 0) + (parseFloat(t.amount) || 0);
        });
        
        const cashIncome = day.income.filter(t => t.source === 'cash').reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
        const cashExpense = day.expenses.filter(t => t.source === 'cash').reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
        
        return { totalIncome, totalExpense, netCash: cashIncome - cashExpense, incomeBySource, cashIncome, cashExpense };
    };
    
    const shiftTotals = calculateShiftTotals(selectedDate, currentShift);
    const dayTotals = calculateDayTotals(selectedDate);
    
    // Add transaction
    const addTransaction = async () => {
        const source = PAYMENT_SOURCES.find(s => s.id === transForm.source);
        if (source?.requiresTxId && !transForm.transactionId) {
            alert("Transaction ID is required for " + source.label);
            return;
        }
        
        const expType = EXPENSE_TYPES.find(t => t.id === transForm.type);
        if (expType?.requiresRef && !transForm.reference && showTransModal === 'expense') {
            alert("Reference/Invoice number is required for " + expType.label);
            return;
        }
        
        const incomeType = INCOME_TYPES.find(t => t.id === transForm.type);
        const needsGuestSync = incomeType?.needsGuest && transForm.selectedBooking;
        const isGroupBooking = groupBookings.length > 1;
        const isAdvancedMode = isGroupBooking && paymentMode === 'advanced';
        
        // Validate amount
        if (isAdvancedMode) {
            const totalAdvanced = Object.values(roomPayments).reduce((sum, amt) => sum + (parseFloat(amt) || 0), 0);
            if (totalAdvanced === 0) {
                alert("Please enter payment amount for at least one room");
                return;
            }
        } else if (!transForm.amount) {
            return;
        }
        
        // Sync to Beds24 if guest payment
        if (needsGuestSync) {
            setSyncingToApi(true);
            try {
                // Get payment source info for Beds24 format
                const sourceInfo = PAYMENT_SOURCES.find(s => s.id === transForm.source);
                // Format: "Bkash Received DA39PF3E39" or "Cash Received"
                let paymentDesc = sourceInfo?.id === 'bkash' ? 'Bkash Received' :
                                  sourceInfo?.id === 'nagad' ? 'Nagad Received' :
                                  sourceInfo?.id === 'rocket' ? 'Rocket Received' :
                                  sourceInfo?.id === 'bank' ? 'Bank Transfer' :
                                  sourceInfo?.id === 'card' ? 'Card Payment' :
                                  sourceInfo?.id === 'cash' ? 'Cash Received' :
                                  'Payment Received';
                if (sourceInfo?.requiresTxId && transForm.transactionId) {
                    paymentDesc += " " + transForm.transactionId.toUpperCase();
                }
                
                if (isAdvancedMode) {
                    // Advanced mode: Update each room's deposit individually with invoice items
                    const updates = [];
                    for (const b of groupBookings) {
                        const paymentAmt = parseFloat(roomPayments[b.id]) || 0;
                        if (paymentAmt > 0) {
                            const currentDeposit = parseFloat(b.deposit) || 0;
                            updates.push({
                                id: b.id,
                                deposit: currentDeposit + paymentAmt,
                                invoiceItems: [{
                                    type: "payment",
                                    description: paymentDesc,
                                    qty: 1,
                                    price: paymentAmt
                                }]
                            });
                        }
                    }

                    if (updates.length > 0) {
                        console.log("Syncing payments with invoice items (advanced):", updates);
                        const res = await fetch(PROXY + "?endpoint=bookings", {
                            method: "POST",
                            headers: {"Content-Type": "application/json"},
                            body: JSON.stringify(updates)
                        });
                        const result = await res.json();
                        console.log("Beds24 response:", result);
                        const allSuccess = Array.isArray(result) ? result.every(r => r.success) : result.success;
                        if (!allSuccess) {
                            alert("Some payments failed to sync: " + JSON.stringify(result));
                        }
                    }
                } else {
                    // Simple mode: Update selected booking's deposit with invoice item
                    const booking = transForm.selectedBooking;
                    const currentDeposit = parseFloat(booking.deposit) || 0;
                    const paymentAmt = parseFloat(transForm.amount) || 0;
                    const newDeposit = currentDeposit + paymentAmt;

                    const updateData = {
                        id: booking.id,
                        deposit: newDeposit,
                        invoiceItems: [{
                            type: "payment",
                            description: paymentDesc,
                            qty: 1,
                            price: paymentAmt
                        }]
                    };

                    console.log("Syncing payment with invoice item (simple):", updateData);
                    const res = await fetch(PROXY + "?endpoint=bookings", {
                        method: "POST",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify([updateData])
                    });
                    const result = await res.json();
                    console.log("Beds24 response:", result);
                    const success = Array.isArray(result) ? result[0]?.success : result.success;
                    if (!success) {
                        alert("Failed to sync payment: " + JSON.stringify(result));
                        setSyncingToApi(false);
                        return;
                    }
                }
                // Refresh bookings data (force refresh after payment update)
                fetchData(true);
            } catch (e) {
                alert("Error syncing payment: " + e.message);
                setSyncingToApi(false);
                return;
            }
            setSyncingToApi(false);
        }
        
        // Calculate total amount for transaction record
        const totalAmount = isAdvancedMode 
            ? Object.values(roomPayments).reduce((sum, amt) => sum + (parseFloat(amt) || 0), 0)
            : parseFloat(transForm.amount) || 0;
        
        // Build room details for advanced mode
        const roomDetails = isAdvancedMode 
            ? groupBookings.filter(b => parseFloat(roomPayments[b.id]) > 0).map(b => ({
                bookingId: b.id,
                room: getRoomInfo(b.roomId, b.unitId).num,
                amount: parseFloat(roomPayments[b.id]) || 0
            }))
            : null;
        
        const newTrans = {
            id: Date.now(),
            ...transForm,
            amount: totalAmount,
            shift: currentShift,
            staff: staffOnDuty[selectedDate]?.[currentShift] || "Unknown",
            timestamp: new Date().toISOString(),
            syncedToBeds24: needsGuestSync,
            paymentMode: isAdvancedMode ? 'advanced' : 'simple',
            roomDetails: roomDetails,
            groupRooms: isGroupBooking ? groupBookings.map(b => getRoomInfo(b.roomId, b.unitId).num).join(', ') : null
        };
        
        const day = getDayData(selectedDate);
        const updated = {
            ...cashFlowData,
            [selectedDate]: {
                ...day,
                income: showTransModal === 'income' ? [...day.income, newTrans] : day.income,
                expenses: showTransModal === 'expense' ? [...day.expenses, newTrans] : day.expenses
            }
        };
        
        saveCashFlow(updated);
        setShowTransModal(null);
        setGuestSearchQuery("");
        setGroupBookings([]);
        setRoomPayments({});
        setPaymentMode("simple");
        setTransForm({ type: "advance", source: "cash", amount: "", bookingId: "", guestName: "", roomNum: "", transactionId: "", reference: "", responsiblePerson: "", description: "", category: "income", selectedBooking: null, checkInDate: "" });
    };
    
    // Delete transaction
    const deleteTransaction = (transId, isExpense) => {
        if (!confirm("Delete this transaction?")) return;
        const day = getDayData(selectedDate);
        const updated = {
            ...cashFlowData,
            [selectedDate]: {
                ...day,
                income: isExpense ? day.income : day.income.filter(t => t.id !== transId),
                expenses: isExpense ? day.expenses.filter(t => t.id !== transId) : day.expenses
            }
        };
        saveCashFlow(updated);
    };
    
    // Assign staff
    const assignStaff = () => {
        if (!staffName.trim()) return;
        const dayStaff = staffOnDuty[selectedDate] || {};
        const updated = { ...staffOnDuty, [selectedDate]: {...dayStaff, [currentShift]: staffName.trim()} };
        saveStaff(updated);
        setStaffName("");
    };
    
    // Handover
    const [showHandoverModal, setShowHandoverModal] = useState(false);
    const [handoverNotes, setHandoverNotes] = useState("");
    
    // Pause auto-refresh when modals are open
    useEffect(() => {
        if (setIsEditing) setIsEditing(showTransModal !== null || showHandoverModal);
    }, [showTransModal, showHandoverModal]); // eslint-disable-line react-hooks/exhaustive-deps
    
    const completeHandover = () => {
        const shiftData = calculateShiftTotals(selectedDate, currentShift);
        const handover = {
            id: Date.now(), shift: currentShift, staff: staffOnDuty[selectedDate]?.[currentShift] || "Unknown",
            cashToHandover: shiftData.netCash, totalIncome: shiftData.totalIncome, totalExpense: shiftData.totalExpense,
            notes: handoverNotes, timestamp: new Date().toISOString(), verified: false
        };
        
        const day = getDayData(selectedDate);
        const updated = { ...cashFlowData, [selectedDate]: { ...day, handovers: [...(day.handovers || []), handover] } };
        saveCashFlow(updated);
        setShowHandoverModal(false);
        setHandoverNotes("");
    };
    
    // ===== REVENUE BY CHECKOUT STATES =====
    const [revDateFrom, setRevDateFrom] = useState(getBDDate(-30));
    const [revDateTo, setRevDateTo] = useState(getBDDate());
    
    const revenueBookings = bookings.filter(b => {
        if (!b.departure) return false;
        return b.departure >= revDateFrom && b.departure <= revDateTo;
    }).sort((a, b) => new Date(b.departure) - new Date(a.departure));
    
    const revenueTotals = revenueBookings.reduce((acc, b) => {
        const price = parseFloat(b.price) || 0;
        const deposit = parseFloat(b.deposit) || 0;
        acc.revenue += price;
        acc.collected += deposit;
        acc.due += (price - deposit);
        if (price - deposit <= 0) acc.fullyPaid++;
        else if (deposit > 0) acc.partial++;
        else acc.unpaid++;
        return acc;
    }, {revenue: 0, collected: 0, due: 0, fullyPaid: 0, partial: 0, unpaid: 0});
    
    // ===== ALL BOOKINGS STATES =====
    const [accDateFrom, setAccDateFrom] = useState(getBDDate(-30));
    const [accDateTo, setAccDateTo] = useState(getBDDate(30));
    const [accFilter, setAccFilter] = useState("all");
    const [accSearch, setAccSearch] = useState("");
    const [quickPayId, setQuickPayId] = useState(null);
    const [quickPayAmount, setQuickPayAmount] = useState("");
    const [quickPayMethod, setQuickPayMethod] = useState("cash");
    const [saving, setSaving] = useState(false);
    
    const [paymentHistory, setPaymentHistory] = useState(() => {
        try { return JSON.parse(localStorage.getItem("miami_payment_history_v1") || "{}"); } catch { return {}; }
    });
    
    const savePaymentHistory = (updated) => {
        localStorage.setItem("miami_payment_history_v1", JSON.stringify(updated));
        setPaymentHistory(updated);
    };
    
    const filteredBookings = bookings.filter(b => {
        if (b.arrival < accDateFrom || b.arrival > accDateTo) return false;
        const price = parseFloat(b.price) || 0;
        const deposit = parseFloat(b.deposit) || 0;
        const due = price - deposit;
        if (accFilter === "paid" && due > 0) return false;
        if (accFilter === "unpaid" && deposit > 0) return false;
        if (accFilter === "partial" && (deposit === 0 || due === 0)) return false;
        if (accSearch && !b.firstName?.toLowerCase().includes(accSearch.toLowerCase()) && !b.mobile?.includes(accSearch)) return false;
        return true;
    }).sort((a, b) => new Date(b.arrival) - new Date(a.arrival));
    
    const allInRange = bookings.filter(b => b.arrival >= accDateFrom && b.arrival <= accDateTo);
    const bookingsTotals = allInRange.reduce((acc, b) => {
        const price = parseFloat(b.price) || 0;
        const deposit = parseFloat(b.deposit) || 0;
        acc.revenue += price;
        acc.collected += deposit;
        acc.due += (price - deposit);
        if (price - deposit <= 0) acc.fullyPaid++;
        else if (deposit > 0) acc.partial++;
        else acc.unpaid++;
        return acc;
    }, {revenue: 0, collected: 0, due: 0, fullyPaid: 0, partial: 0, unpaid: 0});
    
    const handleQuickPay = async (bookingId, amount, currentDeposit, method) => {
        setSaving(true);
        try {
            const paymentAmt = parseFloat(amount || 0);
            const newDeposit = parseFloat(currentDeposit || 0) + paymentAmt;

            // Format description like Beds24: "Bkash Received TX123" or "Cash Received"
            let paymentDesc = method === 'bkash' ? 'Bkash Received' :
                              method === 'nagad' ? 'Nagad Received' :
                              method === 'rocket' ? 'Rocket Received' :
                              method === 'bank' ? 'Bank Transfer' :
                              method === 'card' ? 'Card Payment' :
                              method === 'cash' ? 'Cash Received' :
                              'Payment Received';

            const updateData = {
                id: bookingId,
                deposit: newDeposit,
                invoiceItems: [{
                    type: "payment",
                    description: paymentDesc,
                    qty: 1,
                    price: paymentAmt
                }]
            };

            console.log("Quick pay with invoice item:", updateData);
            const res = await fetch(PROXY + "?endpoint=bookings", {
                method: "POST", headers: {"Content-Type": "application/json"},
                body: JSON.stringify([updateData])
            });
            const result = await res.json();
            console.log("Beds24 response:", result);
            const success = Array.isArray(result) ? result[0]?.success : result.success;
            if (success) {
                const bookingPayments = paymentHistory[bookingId] || [];
                const newPayment = {id: Date.now(), amount: paymentAmt, method: method || "cash", date: today};
                savePaymentHistory({...paymentHistory, [bookingId]: [...bookingPayments, newPayment]});
                fetchData(true);
                setQuickPayId(null);
                setQuickPayAmount("");
                setQuickPayMethod("cash");
            }
        } catch(e) { alert("Error: " + e.message); }
        setSaving(false);
    };
    
    // Styles
    const cardStyle = {background: 'rgba(255,255,255,0.03)', border: '1px solid rgba(255,255,255,0.08)', borderRadius: '12px', padding: '14px'};
    const inputStyle = {padding: '10px 12px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: '#fff', fontSize: '13px', width: '100%'};
    const tabBtnStyle = (active) => ({
        padding: '12px 20px',
        background: active ? 'linear-gradient(135deg, #2D6A6A, #245858)' : 'rgba(255,255,255,0.05)',
        border: active ? 'none' : '1px solid rgba(255,255,255,0.1)',
        borderRadius: '10px',
        color: active ? '#fff' : 'rgba(255,255,255,0.6)',
        cursor: 'pointer',
        fontSize: '13px',
        fontWeight: active ? '700' : '500'
    });
    
    return (
        <div style={{padding: '16px'}}>
            <h2 style={{fontSize: '18px', fontWeight: '600', marginBottom: '16px'}}>üí∞ Accounting</h2>
            
            {/* Sub-Tab Toggle */}
            <div style={{display: 'flex', gap: '8px', marginBottom: '20px', flexWrap: 'wrap'}}>
                <button onClick={() => setAccView("cashflow")} style={tabBtnStyle(accView === "cashflow")}>üìä Daily Cash Flow</button>
                <button onClick={() => setAccView("revenue")} style={tabBtnStyle(accView === "revenue")}>üìÜ Revenue by Check-out</button>
                <button onClick={() => setAccView("bookings")} style={tabBtnStyle(accView === "bookings")}>üìã All Bookings</button>
            </div>
            
            {/* ========== DAILY CASH FLOW VIEW ========== */}
            {accView === "cashflow" && (
                <div>
                    {/* Date & Shift Selector */}
                    <div style={{display: 'flex', gap: '12px', marginBottom: '16px', flexWrap: 'wrap', alignItems: 'center'}}>
                        <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                            <button onClick={() => { const d = new Date(selectedDate); d.setDate(d.getDate() - 1); setSelectedDate(d.toISOString().slice(0,10)); }} style={{padding: '8px 12px', background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '8px', color: '#fff', cursor: 'pointer'}}>‚Üê</button>
                            <div onClick={() => dateRef.current?.showPicker()} style={{cursor: 'pointer', background: selectedDate === today ? '#2D6A6A' : 'rgba(255,255,255,0.1)', borderRadius: '8px', padding: '8px 14px', display: 'flex', alignItems: 'center', gap: '8px'}}>
                                <span>üìÖ</span>
                                <span style={{fontWeight: '600'}}>{formatDate(selectedDate)}</span>
                                <input ref={dateRef} type="date" value={selectedDate} onChange={e => setSelectedDate(e.target.value)} style={{position: 'absolute', opacity: 0, pointerEvents: 'none'}}/>
                            </div>
                            <button onClick={() => { const d = new Date(selectedDate); d.setDate(d.getDate() + 1); setSelectedDate(d.toISOString().slice(0,10)); }} style={{padding: '8px 12px', background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '8px', color: '#fff', cursor: 'pointer'}}>‚Üí</button>
                        </div>
                        
                        {/* Shift Toggle */}
                        <div style={{display: 'flex', gap: '6px', marginLeft: 'auto'}}>
                            {SHIFTS.map(s => (
                                <button key={s.id} onClick={() => setCurrentShift(s.id)} style={{
                                    padding: '8px 14px', borderRadius: '8px', fontSize: '12px', fontWeight: currentShift === s.id ? '700' : '500', cursor: 'pointer',
                                    background: currentShift === s.id ? s.color : 'rgba(255,255,255,0.05)',
                                    color: currentShift === s.id ? '#fff' : 'rgba(255,255,255,0.6)',
                                    border: currentShift === s.id ? 'none' : '1px solid rgba(255,255,255,0.1)'
                                }}>{s.label}</button>
                            ))}
                        </div>
                    </div>
                    
                    {/* Staff Assignment */}
                    <div style={{...cardStyle, marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '12px', flexWrap: 'wrap'}}>
                        <span style={{fontSize: '13px', color: 'rgba(255,255,255,0.6)'}}>üë§ Staff on {getShiftInfo(currentShift).label}:</span>
                        {staffOnDuty[selectedDate]?.[currentShift] ? (
                            <span style={{fontWeight: '600', color: getShiftInfo(currentShift).color}}>{staffOnDuty[selectedDate][currentShift]}</span>
                        ) : (
                            <div style={{display: 'flex', gap: '8px'}}>
                                <input type="text" placeholder="Enter staff name" value={staffName} onChange={e => setStaffName(e.target.value)} style={{...inputStyle, width: '150px'}}/>
                                <button onClick={assignStaff} style={{padding: '8px 14px', background: '#2D6A6A', border: 'none', borderRadius: '8px', color: '#fff', cursor: 'pointer', fontWeight: '600', fontSize: '12px'}}>Assign</button>
                            </div>
                        )}
                    </div>
                    
                    {/* Shift Summary Cards */}
                    <div style={{marginBottom: '20px'}}>
                        <div style={{fontSize: '14px', fontWeight: '600', marginBottom: '10px', color: getShiftInfo(currentShift).color}}>{getShiftInfo(currentShift).label} Summary ({getShiftInfo(currentShift).time})</div>
                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(130px, 1fr))', gap: '10px'}}>
                            <div style={{background: 'linear-gradient(145deg, rgba(34,197,94,0.2), rgba(34,197,94,0.05))', border: '1px solid rgba(34,197,94,0.3)', borderRadius: '12px', padding: '14px', textAlign: 'center'}}>
                                <div style={{fontSize: '10px', color: 'rgba(255,255,255,0.5)'}}>üí∞ Total Income</div>
                                <div style={{fontSize: '22px', fontWeight: '700', color: '#22c55e'}}>‡ß≥{shiftTotals.totalIncome.toLocaleString()}</div>
                            </div>
                            <div style={{background: 'linear-gradient(145deg, rgba(239,68,68,0.2), rgba(239,68,68,0.05))', border: '1px solid rgba(239,68,68,0.3)', borderRadius: '12px', padding: '14px', textAlign: 'center'}}>
                                <div style={{fontSize: '10px', color: 'rgba(255,255,255,0.5)'}}>üì§ Total Expense</div>
                                <div style={{fontSize: '22px', fontWeight: '700', color: '#ef4444'}}>‡ß≥{shiftTotals.totalExpense.toLocaleString()}</div>
                            </div>
                            <div style={{background: 'linear-gradient(145deg, rgba(45,106,106,0.2), rgba(45,106,106,0.05))', border: '1px solid rgba(45,106,106,0.3)', borderRadius: '12px', padding: '14px', textAlign: 'center'}}>
                                <div style={{fontSize: '10px', color: 'rgba(255,255,255,0.5)'}}>üíµ Cash In Hand</div>
                                <div style={{fontSize: '22px', fontWeight: '700', color: shiftTotals.netCash >= 0 ? '#2D6A6A' : '#ef4444'}}>‡ß≥{shiftTotals.netCash.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Income by Source */}
                    <div style={{...cardStyle, marginBottom: '16px'}}>
                        <div style={{fontSize: '13px', fontWeight: '600', marginBottom: '10px'}}>üí≥ Income by Payment Channel</div>
                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(100px, 1fr))', gap: '8px'}}>
                            {PAYMENT_SOURCES.filter(s => shiftTotals.incomeBySource[s.id] > 0).map(s => (
                                <div key={s.id} style={{background: `${s.color}15`, border: `1px solid ${s.color}40`, borderRadius: '8px', padding: '10px', textAlign: 'center'}}>
                                    <div style={{fontSize: '10px', color: 'rgba(255,255,255,0.6)'}}>{s.label}</div>
                                    <div style={{fontSize: '16px', fontWeight: '700', color: s.color}}>‡ß≥{shiftTotals.incomeBySource[s.id].toLocaleString()}</div>
                                </div>
                            ))}
                            {Object.values(shiftTotals.incomeBySource).every(v => v === 0) && (
                                <div style={{color: 'rgba(255,255,255,0.4)', fontSize: '12px', padding: '10px'}}>No income recorded</div>
                            )}
                        </div>
                    </div>
                    
                    {/* Income by Type */}
                    {shiftTotals.totalIncome > 0 && (
                        <div style={{...cardStyle, marginBottom: '16px'}}>
                            <div style={{fontSize: '13px', fontWeight: '600', marginBottom: '10px'}}>üìä Income by Category</div>
                            <div style={{display: 'flex', flexWrap: 'wrap', gap: '8px'}}>
                                {INCOME_TYPES.filter(t => shiftTotals.incomeByType[t.id] > 0).map(t => (
                                    <div key={t.id} style={{background: `${t.color}15`, border: `1px solid ${t.color}40`, borderRadius: '8px', padding: '8px 12px'}}>
                                        <span style={{fontSize: '11px', color: 'rgba(255,255,255,0.6)'}}>{t.label}:</span>
                                        <span style={{fontSize: '14px', fontWeight: '700', color: t.color, marginLeft: '6px'}}>‡ß≥{shiftTotals.incomeByType[t.id].toLocaleString()}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                    
                    {/* Expenses by Type */}
                    {shiftTotals.totalExpense > 0 && (
                        <div style={{...cardStyle, marginBottom: '16px'}}>
                            <div style={{fontSize: '13px', fontWeight: '600', marginBottom: '10px', color: '#ef4444'}}>üì§ Expenses by Category</div>
                            <div style={{display: 'flex', flexWrap: 'wrap', gap: '8px'}}>
                                {EXPENSE_TYPES.filter(t => shiftTotals.expensesByType[t.id] > 0).map(t => (
                                    <div key={t.id} style={{background: `${t.color}15`, border: `1px solid ${t.color}40`, borderRadius: '8px', padding: '8px 12px'}}>
                                        <span style={{fontSize: '11px', color: 'rgba(255,255,255,0.6)'}}>{t.label}:</span>
                                        <span style={{fontSize: '14px', fontWeight: '700', color: t.color, marginLeft: '6px'}}>‡ß≥{shiftTotals.expensesByType[t.id].toLocaleString()}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                    
                    {/* Action Buttons */}
                    <div style={{display: 'flex', gap: '10px', marginBottom: '20px', flexWrap: 'wrap'}}>
                        <button onClick={() => { setShowTransModal('income'); setTransForm({...transForm, category: 'income', type: 'advance', source: 'cash'}); }} style={{padding: '12px 20px', background: 'linear-gradient(135deg, #22c55e, #16a34a)', border: 'none', borderRadius: '10px', color: '#fff', fontWeight: '700', cursor: 'pointer', fontSize: '14px'}}>‚ûï Add Income</button>
                        <button onClick={() => { setShowTransModal('expense'); setTransForm({...transForm, category: 'expense', type: 'bill_payment', source: 'cash'}); }} style={{padding: '12px 20px', background: 'linear-gradient(135deg, #ef4444, #dc2626)', border: 'none', borderRadius: '10px', color: '#fff', fontWeight: '700', cursor: 'pointer', fontSize: '14px'}}>‚ûñ Add Expense</button>
                        <button onClick={() => setShowHandoverModal(true)} style={{padding: '12px 20px', background: 'linear-gradient(135deg, #f59e0b, #d97706)', border: 'none', borderRadius: '10px', color: '#fff', fontWeight: '700', cursor: 'pointer', fontSize: '14px', marginLeft: 'auto'}}>üîÑ Shift Handover</button>
                    </div>
                    
                    {/* Day Total Summary */}
                    <div style={{background: 'linear-gradient(145deg, rgba(212,168,83,0.15), rgba(212,168,83,0.05))', border: '1px solid rgba(212,168,83,0.3)', borderRadius: '12px', padding: '16px', marginBottom: '16px'}}>
                        <div style={{fontSize: '14px', fontWeight: '600', marginBottom: '12px', color: '#D4A853'}}>üìä Day Total (All Shifts Combined)</div>
                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(140px, 1fr))', gap: '12px'}}>
                            <div style={{textAlign: 'center'}}><div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)'}}>Total Income</div><div style={{fontSize: '20px', fontWeight: '700', color: '#22c55e'}}>‡ß≥{dayTotals.totalIncome.toLocaleString()}</div></div>
                            <div style={{textAlign: 'center'}}><div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)'}}>Total Expense</div><div style={{fontSize: '20px', fontWeight: '700', color: '#ef4444'}}>‡ß≥{dayTotals.totalExpense.toLocaleString()}</div></div>
                            <div style={{textAlign: 'center'}}><div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)'}}>Net Cash</div><div style={{fontSize: '20px', fontWeight: '700', color: dayTotals.netCash >= 0 ? '#D4A853' : '#ef4444'}}>‡ß≥{dayTotals.netCash.toLocaleString()}</div></div>
                        </div>
                        {/* Day Income by Source */}
                        <div style={{marginTop: '14px', paddingTop: '14px', borderTop: '1px solid rgba(255,255,255,0.1)'}}>
                            <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.5)', marginBottom: '8px'}}>Day Collection by Channel:</div>
                            <div style={{display: 'flex', flexWrap: 'wrap', gap: '8px'}}>
                                {PAYMENT_SOURCES.filter(s => dayTotals.incomeBySource[s.id] > 0).map(s => (
                                    <span key={s.id} style={{padding: '4px 10px', background: `${s.color}20`, borderRadius: '6px', fontSize: '12px', color: s.color}}>{s.label.split(' ')[1] || s.label}: ‡ß≥{dayTotals.incomeBySource[s.id].toLocaleString()}</span>
                                ))}
                            </div>
                        </div>
                    </div>
                    
                    {/* Transaction List */}
                    <div style={{...cardStyle}}>
                        <div style={{fontSize: '14px', fontWeight: '600', marginBottom: '12px'}}>üìã {getShiftInfo(currentShift).label} Transactions</div>
                        <div style={{maxHeight: '300px', overflowY: 'auto'}}>
                            {[...getShiftData(selectedDate, currentShift).income.map(t => ({...t, isExpense: false})), ...getShiftData(selectedDate, currentShift).expenses.map(t => ({...t, isExpense: true}))].sort((a, b) => b.id - a.id).map(t => {
                                const sourceInfo = getSourceInfo(t.source);
                                const typeInfo = t.isExpense ? getExpenseTypeInfo(t.type) : getIncomeTypeInfo(t.type);
                                return (
                                    <div key={t.id} style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '12px', background: t.isExpense ? 'rgba(239,68,68,0.1)' : 'rgba(34,197,94,0.1)', borderRadius: '10px', marginBottom: '8px', flexWrap: 'wrap', gap: '8px'}}>
                                        <div style={{flex: 1, minWidth: '200px'}}>
                                            <div style={{display: 'flex', alignItems: 'center', gap: '8px', flexWrap: 'wrap'}}>
                                                <span style={{padding: '2px 8px', background: `${typeInfo.color}30`, borderRadius: '4px', fontSize: '11px', color: typeInfo.color}}>{typeInfo.label}</span>
                                                <span style={{padding: '2px 8px', background: `${sourceInfo.color}30`, borderRadius: '4px', fontSize: '11px', color: sourceInfo.color}}>{sourceInfo.label}</span>
                                            </div>
                                            {t.guestName && <div style={{fontSize: '12px', marginTop: '4px'}}>üë§ {t.guestName} {t.roomNum ? `(${t.roomNum})` : ''}</div>}
                                            {t.transactionId && <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', marginTop: '2px'}}>üÜî TxID: {t.transactionId}</div>}
                                            {t.reference && <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', marginTop: '2px'}}>üìÑ Ref: {t.reference}</div>}
                                            {t.responsiblePerson && <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', marginTop: '2px'}}>üë§ By: {t.responsiblePerson}</div>}
                                            {t.description && <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', marginTop: '2px'}}>üìù {t.description}</div>}
                                            <div style={{fontSize: '10px', color: 'rgba(255,255,255,0.3)', marginTop: '4px'}}>Staff: {t.staff} ‚Ä¢ {new Date(t.timestamp).toLocaleTimeString()}</div>
                                        </div>
                                        <div style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                                            <span style={{fontSize: '18px', fontWeight: '700', color: t.isExpense ? '#ef4444' : '#22c55e'}}>{t.isExpense ? '-' : '+'}‡ß≥{t.amount.toLocaleString()}</span>
                                            <button onClick={() => deleteTransaction(t.id, t.isExpense)} style={{background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '6px', padding: '4px 8px', color: '#ef4444', cursor: 'pointer', fontSize: '14px'}}>√ó</button>
                                        </div>
                                    </div>
                                );
                            })}
                            {getShiftData(selectedDate, currentShift).income.length === 0 && getShiftData(selectedDate, currentShift).expenses.length === 0 && (
                                <div style={{textAlign: 'center', padding: '30px', color: 'rgba(255,255,255,0.4)'}}>No transactions for this shift</div>
                            )}
                        </div>
                    </div>
                    
                    {/* Handovers */}
                    {dayData.handovers?.length > 0 && (
                        <div style={{...cardStyle, marginTop: '16px'}}>
                            <div style={{fontSize: '14px', fontWeight: '600', marginBottom: '12px'}}>üîÑ Shift Handovers</div>
                            {dayData.handovers.map(h => {
                                const shiftInfo = getShiftInfo(h.shift);
                                return (
                                    <div key={h.id} style={{padding: '12px', background: `${shiftInfo.color}15`, border: `1px solid ${shiftInfo.color}40`, borderRadius: '10px', marginBottom: '8px'}}>
                                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '8px'}}>
                                            <div><span style={{fontWeight: '600', color: shiftInfo.color}}>{shiftInfo.label}</span><span style={{fontSize: '12px', color: 'rgba(255,255,255,0.5)', marginLeft: '10px'}}>by {h.staff}</span></div>
                                            <div style={{fontWeight: '700', color: '#D4A853'}}>üíµ Cash: ‡ß≥{h.cashToHandover.toLocaleString()}</div>
                                        </div>
                                        <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', marginTop: '6px'}}>Income: ‡ß≥{h.totalIncome.toLocaleString()} ‚Ä¢ Expense: ‡ß≥{h.totalExpense.toLocaleString()}</div>
                                        {h.notes && <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.6)', marginTop: '6px', padding: '6px', background: 'rgba(0,0,0,0.2)', borderRadius: '6px'}}>üìù {h.notes}</div>}
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            )}
            
            {/* ========== REVENUE BY CHECKOUT VIEW ========== */}
            {accView === "revenue" && (
                <div>
                    <div style={{background: 'linear-gradient(145deg, rgba(212,168,83,0.15), rgba(212,168,83,0.05))', border: '1px solid rgba(212,168,83,0.3)', borderRadius: '12px', padding: '16px', marginBottom: '20px'}}>
                        <div style={{display: 'flex', alignItems: 'center', gap: '12px', flexWrap: 'wrap'}}>
                            <span style={{fontSize: '14px', color: 'rgba(255,255,255,0.7)'}}>üìÜ Check-out Date Range:</span>
                            <input type="date" value={revDateFrom} onChange={e => setRevDateFrom(e.target.value)} style={{...inputStyle, width: 'auto'}}/>
                            <span style={{color: 'rgba(255,255,255,0.4)'}}>‚Üí</span>
                            <input type="date" value={revDateTo} onChange={e => setRevDateTo(e.target.value)} style={{...inputStyle, width: 'auto'}}/>
                            <span style={{marginLeft: 'auto', fontSize: '13px', color: '#D4A853', fontWeight: '600'}}>üè® {revenueBookings.length} Checkouts</span>
                        </div>
                        <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', marginTop: '8px'}}>‚ÑπÔ∏è Revenue based on checkout (departure) date</div>
                    </div>
                    
                    <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(140px, 1fr))', gap: '12px', marginBottom: '20px'}}>
                        <div style={{background: 'linear-gradient(145deg, rgba(45,106,106,0.2), rgba(45,106,106,0.05))', border: '1px solid rgba(45,106,106,0.3)', borderRadius: '12px', padding: '16px', textAlign: 'center'}}><div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', marginBottom: '4px'}}>Total Revenue</div><div style={{fontSize: '22px', fontWeight: '700', color: '#2D6A6A'}}>‡ß≥{revenueTotals.revenue.toLocaleString()}</div></div>
                        <div style={{background: 'linear-gradient(145deg, rgba(34,197,94,0.2), rgba(34,197,94,0.05))', border: '1px solid rgba(34,197,94,0.3)', borderRadius: '12px', padding: '16px', textAlign: 'center'}}><div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', marginBottom: '4px'}}>Collected</div><div style={{fontSize: '22px', fontWeight: '700', color: '#22c55e'}}>‡ß≥{revenueTotals.collected.toLocaleString()}</div></div>
                        <div style={{background: 'linear-gradient(145deg, rgba(239,68,68,0.2), rgba(239,68,68,0.05))', border: '1px solid rgba(239,68,68,0.3)', borderRadius: '12px', padding: '16px', textAlign: 'center'}}><div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', marginBottom: '4px'}}>Outstanding</div><div style={{fontSize: '22px', fontWeight: '700', color: '#ef4444'}}>‡ß≥{revenueTotals.due.toLocaleString()}</div></div>
                        <div style={{background: 'linear-gradient(145deg, rgba(212,168,83,0.2), rgba(212,168,83,0.05))', border: '1px solid rgba(212,168,83,0.3)', borderRadius: '12px', padding: '16px', textAlign: 'center'}}><div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', marginBottom: '4px'}}>Collection Rate</div><div style={{fontSize: '22px', fontWeight: '700', color: '#D4A853'}}>{revenueTotals.revenue > 0 ? Math.round((revenueTotals.collected / revenueTotals.revenue) * 100) : 0}%</div></div>
                    </div>
                    
                    <div style={{display: 'flex', gap: '8px', marginBottom: '16px', flexWrap: 'wrap'}}>
                        <span style={{padding: '4px 10px', background: 'rgba(45,106,106,0.15)', border: '1px solid rgba(45,106,106,0.3)', borderRadius: '20px', fontSize: '12px', color: '#2D6A6A'}}>‚úÖ {revenueTotals.fullyPaid} Paid</span>
                        <span style={{padding: '4px 10px', background: 'rgba(249,115,22,0.15)', border: '1px solid rgba(249,115,22,0.3)', borderRadius: '20px', fontSize: '12px', color: '#f97316'}}>‚ö†Ô∏è {revenueTotals.partial} Partial</span>
                        <span style={{padding: '4px 10px', background: 'rgba(239,68,68,0.15)', border: '1px solid rgba(239,68,68,0.3)', borderRadius: '20px', fontSize: '12px', color: '#ef4444'}}>‚ùå {revenueTotals.unpaid} Unpaid</span>
                    </div>
                    
                    <div style={{display: 'flex', flexDirection: 'column', gap: '8px', maxHeight: '50vh', overflowY: 'auto'}}>
                        {revenueBookings.map(b => {
                            const {num, room} = getRoomInfo(b.roomId, b.unitId);
                            const price = parseFloat(b.price) || 0;
                            const deposit = parseFloat(b.deposit) || 0;
                            const due = price - deposit;
                            const status = due <= 0 ? 'paid' : deposit > 0 ? 'partial' : 'unpaid';
                            const statusColor = status === 'paid' ? '#2D6A6A' : status === 'partial' ? '#f97316' : '#ef4444';
                            return (
                                <div key={b.id} onClick={() => setShowInfoModal(b)} style={{...cardStyle, borderLeft: '4px solid ' + statusColor, cursor: 'pointer'}}>
                                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', flexWrap: 'wrap', gap: '10px'}}>
                                        <div style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
                                            <div style={{width: '50px', height: '50px', background: 'linear-gradient(135deg, #2D6A6A, #245858)', borderRadius: '10px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '18px', fontWeight: '700'}}>{num}</div>
                                            <div>
                                                <div style={{fontWeight: '600', fontSize: '15px'}}>{b.firstName} {b.lastName}</div>
                                                <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.5)'}}>{room?.short}</div>
                                                <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.4)', marginTop: '2px'}}>üìÖ Checkout: <strong style={{color: '#D4A853'}}>{formatDate(b.departure)}</strong></div>
                                            </div>
                                        </div>
                                        <div style={{textAlign: 'right'}}>
                                            <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.5)'}}>Total: ‡ß≥{price.toLocaleString()}</div>
                                            <div style={{fontSize: '12px', color: '#2D6A6A'}}>Paid: ‡ß≥{deposit.toLocaleString()}</div>
                                            <div style={{fontSize: '16px', fontWeight: '700', color: statusColor, marginTop: '2px'}}>{status === 'paid' ? '‚úÖ' : status === 'partial' ? '‚ö†Ô∏è' : '‚ùå'} Due: ‡ß≥{due.toLocaleString()}</div>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                        {revenueBookings.length === 0 && <div style={{textAlign: 'center', padding: '40px', color: 'rgba(255,255,255,0.4)'}}>No checkouts found for selected date range</div>}
                    </div>
                </div>
            )}
            
            {/* ========== ALL BOOKINGS VIEW ========== */}
            {accView === "bookings" && (
                <div>
                    <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(140px, 1fr))', gap: '12px', marginBottom: '20px'}}>
                        <div style={{background: 'linear-gradient(145deg, rgba(45,106,106,0.2), rgba(45,106,106,0.05))', border: '1px solid rgba(45,106,106,0.3)', borderRadius: '12px', padding: '16px', textAlign: 'center'}}><div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', marginBottom: '4px'}}>Total Revenue</div><div style={{fontSize: '22px', fontWeight: '700', color: '#2D6A6A'}}>‡ß≥{bookingsTotals.revenue.toLocaleString()}</div></div>
                        <div style={{background: 'linear-gradient(145deg, rgba(45,106,106,0.2), rgba(45,106,106,0.05))', border: '1px solid rgba(45,106,106,0.3)', borderRadius: '12px', padding: '16px', textAlign: 'center'}}><div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', marginBottom: '4px'}}>Collected</div><div style={{fontSize: '22px', fontWeight: '700', color: '#2D6A6A'}}>‡ß≥{bookingsTotals.collected.toLocaleString()}</div></div>
                        <div style={{background: 'linear-gradient(145deg, rgba(239,68,68,0.2), rgba(239,68,68,0.05))', border: '1px solid rgba(239,68,68,0.3)', borderRadius: '12px', padding: '16px', textAlign: 'center'}}><div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', marginBottom: '4px'}}>Outstanding</div><div style={{fontSize: '22px', fontWeight: '700', color: '#ef4444'}}>‡ß≥{bookingsTotals.due.toLocaleString()}</div></div>
                        <div style={{background: 'linear-gradient(145deg, rgba(212,168,83,0.2), rgba(212,168,83,0.05))', border: '1px solid rgba(212,168,83,0.3)', borderRadius: '12px', padding: '16px', textAlign: 'center'}}><div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', marginBottom: '4px'}}>Collection Rate</div><div style={{fontSize: '22px', fontWeight: '700', color: '#D4A853'}}>{bookingsTotals.revenue > 0 ? Math.round((bookingsTotals.collected / bookingsTotals.revenue) * 100) : 0}%</div></div>
                    </div>
                    
                    <div style={{display: 'flex', flexWrap: 'wrap', gap: '10px', marginBottom: '16px', alignItems: 'center'}}>
                        <input type="date" value={accDateFrom} onChange={e => setAccDateFrom(e.target.value)} style={{...inputStyle, width: 'auto'}}/>
                        <span style={{color: 'rgba(255,255,255,0.4)'}}>‚Üí</span>
                        <input type="date" value={accDateTo} onChange={e => setAccDateTo(e.target.value)} style={{...inputStyle, width: 'auto'}}/>
                        <select value={accFilter} onChange={e => setAccFilter(e.target.value)} style={{...inputStyle, width: 'auto'}}>
                            <option value="all">All ({allInRange.length})</option>
                            <option value="paid">‚úÖ Paid ({bookingsTotals.fullyPaid})</option>
                            <option value="partial">‚ö†Ô∏è Partial ({bookingsTotals.partial})</option>
                            <option value="unpaid">‚ùå Unpaid ({bookingsTotals.unpaid})</option>
                        </select>
                        <input type="text" placeholder="üîç Search guest..." value={accSearch} onChange={e => setAccSearch(e.target.value)} style={{...inputStyle, flex: 1, minWidth: '150px'}}/>
                    </div>
                    
                    <div style={{display: 'flex', flexDirection: 'column', gap: '8px', maxHeight: '50vh', overflowY: 'auto'}}>
                        {filteredBookings.map(b => {
                            const {num, room} = getRoomInfo(b.roomId, b.unitId);
                            const price = parseFloat(b.price) || 0;
                            const deposit = parseFloat(b.deposit) || 0;
                            const due = price - deposit;
                            const status = due <= 0 ? 'paid' : deposit > 0 ? 'partial' : 'unpaid';
                            const statusColor = status === 'paid' ? '#2D6A6A' : status === 'partial' ? '#f97316' : '#ef4444';
                            return (
                                <div key={b.id} onClick={() => setShowInfoModal(b)} style={{...cardStyle, borderLeft: '4px solid ' + statusColor, cursor: 'pointer'}}>
                                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', flexWrap: 'wrap', gap: '10px'}}>
                                        <div style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
                                            <div style={{width: '50px', height: '50px', background: 'linear-gradient(135deg, #2D6A6A, #245858)', borderRadius: '10px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '18px', fontWeight: '700'}}>{num}</div>
                                            <div>
                                                <div style={{fontWeight: '600', fontSize: '15px'}}>{b.firstName} {b.lastName}</div>
                                                <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.5)'}}>{room?.short}</div>
                                                <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.4)', marginTop: '2px'}}>{formatDate(b.arrival)} ‚Üí {formatDate(b.departure)}</div>
                                            </div>
                                        </div>
                                        <div style={{textAlign: 'right'}}>
                                            <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.5)'}}>Total: ‡ß≥{price.toLocaleString()}</div>
                                            <div style={{fontSize: '12px', color: '#2D6A6A'}}>Paid: ‡ß≥{deposit.toLocaleString()}</div>
                                            <div style={{fontSize: '16px', fontWeight: '700', color: statusColor, marginTop: '2px'}}>{status === 'paid' ? '‚úÖ' : status === 'partial' ? '‚ö†Ô∏è' : '‚ùå'} Due: ‡ß≥{due.toLocaleString()}</div>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                        {filteredBookings.length === 0 && <div style={{textAlign: 'center', padding: '40px', color: 'rgba(255,255,255,0.4)'}}>No bookings found for this period</div>}
                    </div>
                </div>
            )}
            
            {/* ========== ADD TRANSACTION MODAL ========== */}
            {showTransModal && (
                <div className="modal-overlay">
                    <div className="modal" style={{maxWidth: '500px', background: '#1a2332'}}>
                        <div className="modal-header" style={{borderBottom: '1px solid rgba(255,255,255,0.1)', paddingBottom: '16px', marginBottom: '20px'}}>
                            <h3 style={{fontSize: '18px', fontWeight: '700', color: showTransModal === 'income' ? '#22c55e' : '#ef4444'}}>{showTransModal === 'income' ? '‚ûï Add Income' : '‚ûñ Add Expense'}</h3>
                            <button className="modal-close" onClick={() => { setShowTransModal(null); setGuestSearchQuery(''); setShowGuestDropdown(false); setGroupBookings([]); setRoomPayments({}); setPaymentMode('simple'); }}>√ó</button>
                        </div>
                        
                        <div style={{marginBottom: '16px'}}>
                            <label style={{fontSize: '12px', color: 'rgba(255,255,255,0.6)', display: 'block', marginBottom: '8px'}}>Transaction Type</label>
                            <div style={{display: 'flex', flexWrap: 'wrap', gap: '6px'}}>
                                {(showTransModal === 'income' ? INCOME_TYPES : EXPENSE_TYPES).map(t => (
                                    <button key={t.id} type="button" onClick={() => setTransForm({...transForm, type: t.id})} style={{
                                        padding: '8px 12px', borderRadius: '8px', fontSize: '11px', cursor: 'pointer',
                                        background: transForm.type === t.id ? `${t.color}30` : 'rgba(255,255,255,0.05)',
                                        border: transForm.type === t.id ? `2px solid ${t.color}` : '1px solid rgba(255,255,255,0.1)',
                                        color: transForm.type === t.id ? t.color : 'rgba(255,255,255,0.6)',
                                        fontWeight: transForm.type === t.id ? '600' : '400'
                                    }}>{t.label}</button>
                                ))}
                            </div>
                        </div>
                        
                        <div style={{marginBottom: '16px'}}>
                            <label style={{fontSize: '12px', color: 'rgba(255,255,255,0.6)', display: 'block', marginBottom: '8px'}}>Payment Method</label>
                            <div style={{display: 'flex', flexWrap: 'wrap', gap: '6px'}}>
                                {PAYMENT_SOURCES.map(s => (
                                    <button key={s.id} type="button" onClick={() => setTransForm({...transForm, source: s.id})} style={{
                                        padding: '8px 12px', borderRadius: '8px', fontSize: '11px', cursor: 'pointer',
                                        background: transForm.source === s.id ? `${s.color}30` : 'rgba(255,255,255,0.05)',
                                        border: transForm.source === s.id ? `2px solid ${s.color}` : '1px solid rgba(255,255,255,0.1)',
                                        color: transForm.source === s.id ? s.color : 'rgba(255,255,255,0.6)',
                                        fontWeight: transForm.source === s.id ? '600' : '400'
                                    }}>{s.label}</button>
                                ))}
                            </div>
                        </div>
                        
                        {/* Amount field - hide in advanced mode for group bookings */}
                        {!(showTransModal === 'income' && getIncomeTypeInfo(transForm.type)?.needsGuest && transForm.selectedBooking && groupBookings.length > 1 && paymentMode === 'advanced') && (
                            <div style={{marginBottom: '16px'}}>
                                <label style={{fontSize: '12px', color: 'rgba(255,255,255,0.6)', display: 'block', marginBottom: '6px'}}>Amount (‡ß≥) *</label>
                                <input type="number" value={transForm.amount} onChange={e => setTransForm({...transForm, amount: e.target.value})} placeholder="0" style={{...inputStyle, fontSize: '18px', fontWeight: '600'}}/>
                            </div>
                        )}
                        
                        {getSourceInfo(transForm.source)?.requiresTxId && (
                            <div style={{marginBottom: '16px'}}>
                                <label style={{fontSize: '12px', color: 'rgba(255,255,255,0.6)', display: 'block', marginBottom: '6px'}}>Transaction ID * <span style={{color: '#f59e0b'}}>(Required for {getSourceInfo(transForm.source).label})</span></label>
                                <input type="text" value={transForm.transactionId} onChange={e => setTransForm({...transForm, transactionId: e.target.value})} placeholder="Enter transaction ID" style={inputStyle}/>
                            </div>
                        )}
                        
                        {showTransModal === 'expense' && getExpenseTypeInfo(transForm.type)?.requiresRef && (
                            <div style={{marginBottom: '16px'}}>
                                <label style={{fontSize: '12px', color: 'rgba(255,255,255,0.6)', display: 'block', marginBottom: '6px'}}>Invoice/Reference No. * <span style={{color: '#f59e0b'}}>(Required)</span></label>
                                <input type="text" value={transForm.reference} onChange={e => setTransForm({...transForm, reference: e.target.value})} placeholder="Invoice or bill number" style={inputStyle}/>
                            </div>
                        )}
                        
                        {showTransModal === 'income' && getIncomeTypeInfo(transForm.type)?.needsGuest && (
                            <div style={{marginBottom: '16px'}}>
                                <label style={{fontSize: '12px', color: 'rgba(255,255,255,0.6)', display: 'block', marginBottom: '6px'}}>Search Guest <span style={{color: '#2D6A6A'}}>(Type name, room or phone)</span></label>
                                <div style={{position: 'relative'}}>
                                    <input 
                                        type="text" 
                                        value={transForm.selectedBooking ? `${transForm.guestName} - Room ${transForm.roomNum}` : guestSearchQuery}
                                        onChange={e => {
                                            if (transForm.selectedBooking) {
                                                setTransForm({...transForm, selectedBooking: null, guestName: '', roomNum: '', bookingId: '', checkInDate: ''});
                                                setGroupBookings([]);
                                                setRoomPayments({});
                                                setPaymentMode('simple');
                                            }
                                            setGuestSearchQuery(e.target.value);
                                            setShowGuestDropdown(true);
                                        }}
                                        onFocus={() => setShowGuestDropdown(true)}
                                        placeholder="Search by guest name, room number or phone..." 
                                        style={{...inputStyle, paddingRight: transForm.selectedBooking ? '40px' : '12px'}}
                                    />
                                    {transForm.selectedBooking && (
                                        <button 
                                            onClick={() => {
                                                setTransForm({...transForm, selectedBooking: null, guestName: '', roomNum: '', bookingId: '', checkInDate: ''});
                                                setGuestSearchQuery('');
                                                setGroupBookings([]);
                                                setRoomPayments({});
                                                setPaymentMode('simple');
                                            }}
                                            style={{position: 'absolute', right: '8px', top: '50%', transform: 'translateY(-50%)', background: 'rgba(239,68,68,0.2)', border: 'none', borderRadius: '4px', padding: '4px 8px', color: '#ef4444', cursor: 'pointer', fontSize: '12px'}}
                                        >‚úï</button>
                                    )}
                                    {showGuestDropdown && searchedGuests.length > 0 && !transForm.selectedBooking && (
                                        <div style={{position: 'absolute', top: '100%', left: 0, right: 0, background: '#1a2332', border: '1px solid rgba(255,255,255,0.15)', borderRadius: '8px', marginTop: '4px', maxHeight: '200px', overflowY: 'auto', zIndex: 1000}}>
                                            {searchedGuests.map(b => {
                                                const {num, room} = getRoomInfo(b.roomId, b.unitId);
                                                const price = parseFloat(b.price) || 0;
                                                const deposit = parseFloat(b.deposit) || 0;
                                                const due = price - deposit;
                                                return (
                                                    <div 
                                                        key={b.id} 
                                                        onClick={() => selectGuest(b)}
                                                        style={{padding: '10px 12px', cursor: 'pointer', borderBottom: '1px solid rgba(255,255,255,0.08)', display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}
                                                        onMouseEnter={e => e.currentTarget.style.background = 'rgba(45,106,106,0.2)'}
                                                        onMouseLeave={e => e.currentTarget.style.background = 'transparent'}
                                                    >
                                                        <div>
                                                            <div style={{fontWeight: '600', fontSize: '13px'}}>{b.firstName} {b.lastName}</div>
                                                            <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)'}}>üìÖ Check-in: {formatDate(b.arrival)} ‚Ä¢ {room?.short || 'Room'}</div>
                                                        </div>
                                                        <div style={{textAlign: 'right'}}>
                                                            <div style={{fontWeight: '700', color: '#2D6A6A', fontSize: '16px'}}>{num}</div>
                                                            <div style={{fontSize: '10px', color: due > 0 ? '#ef4444' : '#22c55e'}}>Due: ‡ß≥{due.toLocaleString()}</div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                                {transForm.selectedBooking && (
                                    <div style={{marginTop: '10px', padding: '12px', background: 'rgba(45,106,106,0.15)', border: '1px solid rgba(45,106,106,0.3)', borderRadius: '8px'}}>
                                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                            <div>
                                                <div style={{fontSize: '13px', fontWeight: '600'}}>{transForm.guestName}</div>
                                                <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)'}}>üìÖ Check-in: {formatDate(transForm.checkInDate)} ‚Ä¢ Room {transForm.roomNum}</div>
                                                {groupBookings.length > 1 && (
                                                    <div style={{fontSize: '11px', color: '#D4A853', marginTop: '2px'}}>üë• Group: {groupBookings.map(b => getRoomInfo(b.roomId, b.unitId).num).join(', ')}</div>
                                                )}
                                            </div>
                                            <div style={{textAlign: 'right'}}>
                                                <div style={{fontSize: '10px', color: 'rgba(255,255,255,0.5)'}}>
                                                    {groupBookings.length > 1 ? 'Group Total Due' : 'Current Due'}
                                                </div>
                                                <div style={{fontSize: '16px', fontWeight: '700', color: '#ef4444'}}>
                                                    ‡ß≥{(groupBookings.length > 1 
                                                        ? groupBookings.reduce((sum, b) => sum + ((parseFloat(b.price) || 0) - (parseFloat(b.deposit) || 0)), 0)
                                                        : ((parseFloat(transForm.selectedBooking.price) || 0) - (parseFloat(transForm.selectedBooking.deposit) || 0))
                                                    ).toLocaleString()}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {/* Simple/Advanced Toggle - Only for group bookings */}
                                        {groupBookings.length > 1 && (
                                            <div style={{marginTop: '12px', paddingTop: '12px', borderTop: '1px solid rgba(255,255,255,0.1)'}}>
                                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px'}}>
                                                    <span style={{fontSize: '11px', color: 'rgba(255,255,255,0.6)'}}>Payment Mode</span>
                                                    <div style={{display: 'flex', gap: '6px'}}>
                                                        <button type="button" onClick={() => setPaymentMode('simple')} style={{
                                                            padding: '6px 12px', borderRadius: '6px', fontSize: '11px', fontWeight: '600', cursor: 'pointer',
                                                            background: paymentMode === 'simple' ? '#2D6A6A' : 'rgba(255,255,255,0.08)',
                                                            color: paymentMode === 'simple' ? '#fff' : 'rgba(255,255,255,0.6)',
                                                            border: paymentMode === 'simple' ? 'none' : '1px solid rgba(255,255,255,0.15)'
                                                        }}>Simple</button>
                                                        <button type="button" onClick={() => setPaymentMode('advanced')} style={{
                                                            padding: '6px 12px', borderRadius: '6px', fontSize: '11px', fontWeight: '600', cursor: 'pointer',
                                                            background: paymentMode === 'advanced' ? '#2D6A6A' : 'rgba(255,255,255,0.08)',
                                                            color: paymentMode === 'advanced' ? '#fff' : 'rgba(255,255,255,0.6)',
                                                            border: paymentMode === 'advanced' ? 'none' : '1px solid rgba(255,255,255,0.15)'
                                                        }}>Advanced</button>
                                                    </div>
                                                </div>
                                                
                                                {/* Advanced Mode - Per room payment */}
                                                {paymentMode === 'advanced' && (
                                                    <div style={{marginTop: '10px'}}>
                                                        <div style={{fontSize: '10px', color: 'rgba(255,255,255,0.5)', marginBottom: '8px'}}>
                                                            ‚ÑπÔ∏è Enter payment amount for each room individually
                                                        </div>
                                                        {groupBookings.map(b => {
                                                            const {num, room} = getRoomInfo(b.roomId, b.unitId);
                                                            const price = parseFloat(b.price) || 0;
                                                            const deposit = parseFloat(b.deposit) || 0;
                                                            const due = price - deposit;
                                                            return (
                                                                <div key={b.id} style={{display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px', padding: '8px', background: 'rgba(0,0,0,0.2)', borderRadius: '6px'}}>
                                                                    <div style={{flex: 1}}>
                                                                        <div style={{fontSize: '12px', fontWeight: '600'}}>Room {num}</div>
                                                                        <div style={{fontSize: '10px', color: 'rgba(255,255,255,0.5)'}}>{room?.short || ''} ‚Ä¢ Due: <span style={{color: due > 0 ? '#ef4444' : '#22c55e'}}>‡ß≥{due.toLocaleString()}</span></div>
                                                                    </div>
                                                                    <div style={{width: '100px'}}>
                                                                        <input 
                                                                            type="number" 
                                                                            value={roomPayments[b.id] || ''} 
                                                                            onChange={e => setRoomPayments({...roomPayments, [b.id]: e.target.value})}
                                                                            placeholder="‡ß≥ 0"
                                                                            style={{width: '100%', padding: '8px', background: 'rgba(255,255,255,0.08)', border: '1px solid rgba(255,255,255,0.15)', borderRadius: '6px', color: '#fff', fontSize: '13px', textAlign: 'right'}}
                                                                        />
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginTop: '8px', padding: '8px', background: 'rgba(34,197,94,0.15)', borderRadius: '6px'}}>
                                                            <span style={{fontSize: '12px', fontWeight: '600'}}>Total Payment</span>
                                                            <span style={{fontSize: '14px', fontWeight: '700', color: '#22c55e'}}>
                                                                ‡ß≥{Object.values(roomPayments).reduce((sum, amt) => sum + (parseFloat(amt) || 0), 0).toLocaleString()}
                                                            </span>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                        
                                    </div>
                                )}
                            </div>
                        )}
                        
                        {showTransModal === 'expense' && (
                            <div style={{marginBottom: '16px'}}>
                                <label style={{fontSize: '12px', color: 'rgba(255,255,255,0.6)', display: 'block', marginBottom: '6px'}}>Responsible Person</label>
                                <input type="text" value={transForm.responsiblePerson} onChange={e => setTransForm({...transForm, responsiblePerson: e.target.value})} placeholder="Who authorized/received" style={inputStyle}/>
                            </div>
                        )}
                        
                        <div style={{marginBottom: '20px'}}>
                            <label style={{fontSize: '12px', color: 'rgba(255,255,255,0.6)', display: 'block', marginBottom: '6px'}}>Description/Notes</label>
                            <textarea value={transForm.description} onChange={e => setTransForm({...transForm, description: e.target.value})} placeholder="Additional details..." rows={2} style={{...inputStyle, resize: 'none'}}/>
                        </div>
                        
                        <div style={{display: 'flex', gap: '12px'}}>
                            <button onClick={() => { setShowTransModal(null); setGuestSearchQuery(''); setShowGuestDropdown(false); setGroupBookings([]); setRoomPayments({}); setPaymentMode('simple'); }} style={{flex: 1, padding: '14px', background: 'rgba(255,255,255,0.08)', border: '1px solid rgba(255,255,255,0.15)', borderRadius: '10px', color: 'rgba(255,255,255,0.8)', fontWeight: '600', cursor: 'pointer'}}>Cancel</button>
                            <button onClick={addTransaction} disabled={!transForm.amount || syncingToApi} style={{flex: 2, padding: '14px', background: showTransModal === 'income' ? 'linear-gradient(135deg, #22c55e, #16a34a)' : 'linear-gradient(135deg, #ef4444, #dc2626)', border: 'none', borderRadius: '10px', color: '#fff', fontWeight: '700', cursor: 'pointer', opacity: (transForm.amount && !syncingToApi) ? 1 : 0.5}}>{syncingToApi ? '‚è≥ Syncing...' : (showTransModal === 'income' ? '‚ûï Add Income' : '‚ûñ Add Expense')}</button>
                        </div>
                    </div>
                </div>
            )}
            
            {/* ========== HANDOVER MODAL ========== */}
            {showHandoverModal && (
                <div className="modal-overlay">
                    <div className="modal" style={{maxWidth: '450px', background: '#1a2332'}}>
                        <div className="modal-header" style={{borderBottom: '1px solid rgba(255,255,255,0.1)', paddingBottom: '16px', marginBottom: '20px'}}>
                            <h3 style={{fontSize: '18px', fontWeight: '700', color: '#f59e0b'}}>üîÑ Shift Handover</h3>
                            <button className="modal-close" onClick={() => setShowHandoverModal(false)}>√ó</button>
                        </div>
                        
                        <div style={{marginBottom: '20px'}}>
                            <div style={{background: 'rgba(212,168,83,0.15)', border: '1px solid rgba(212,168,83,0.3)', borderRadius: '12px', padding: '16px', marginBottom: '16px'}}>
                                <div style={{fontSize: '13px', color: 'rgba(255,255,255,0.6)', marginBottom: '8px'}}>{getShiftInfo(currentShift).label} Summary</div>
                                <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px'}}>
                                    <div><div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)'}}>Total Income</div><div style={{fontSize: '18px', fontWeight: '700', color: '#22c55e'}}>‡ß≥{shiftTotals.totalIncome.toLocaleString()}</div></div>
                                    <div><div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)'}}>Total Expense</div><div style={{fontSize: '18px', fontWeight: '700', color: '#ef4444'}}>‡ß≥{shiftTotals.totalExpense.toLocaleString()}</div></div>
                                </div>
                                <div style={{marginTop: '12px', paddingTop: '12px', borderTop: '1px dashed rgba(255,255,255,0.2)'}}>
                                    <div style={{fontSize: '13px', color: 'rgba(255,255,255,0.7)'}}>üíµ Cash to Handover:</div>
                                    <div style={{fontSize: '28px', fontWeight: '800', color: '#D4A853'}}>‡ß≥{shiftTotals.netCash.toLocaleString()}</div>
                                </div>
                            </div>
                            
                            <div><label style={{fontSize: '12px', color: 'rgba(255,255,255,0.6)', display: 'block', marginBottom: '6px'}}>Handover Notes</label><textarea value={handoverNotes} onChange={e => setHandoverNotes(e.target.value)} placeholder="Any notes for next shift..." rows={3} style={{...inputStyle, resize: 'none'}}/></div>
                        </div>
                        
                        <div style={{display: 'flex', gap: '12px'}}>
                            <button onClick={() => setShowHandoverModal(false)} style={{flex: 1, padding: '14px', background: 'rgba(255,255,255,0.08)', border: '1px solid rgba(255,255,255,0.15)', borderRadius: '10px', color: 'rgba(255,255,255,0.8)', fontWeight: '600', cursor: 'pointer'}}>Cancel</button>
                            <button onClick={completeHandover} style={{flex: 2, padding: '14px', background: 'linear-gradient(135deg, #f59e0b, #d97706)', border: 'none', borderRadius: '10px', color: '#fff', fontWeight: '700', cursor: 'pointer'}}>‚úì Complete Handover</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}
function BookingModal({selected, checkIn, checkOut, onClose, onSuccess, setIsEditing}) {
    const hasIndividualDates = selected.length > 0 && selected[0].checkIn;
    const defaultCheckIn = hasIndividualDates ? selected[0].checkIn : (checkIn || getBDDate());
    const defaultCheckOut = hasIndividualDates ? selected[0].checkOut : (checkOut || getBDDate(1));
    
    // Pause auto-refresh while modal is open
    useEffect(() => {
        if (setIsEditing) setIsEditing(true);
        return () => { if (setIsEditing) setIsEditing(false); };
    }, []); // eslint-disable-line react-hooks/exhaustive-deps
    
    // Local state for room selections with editable dates
    const [roomSelections, setRoomSelections] = useState(
        selected.map(s => ({
            ...s,
            checkIn: s.checkIn || defaultCheckIn,
            checkOut: s.checkOut || defaultCheckOut
        }))
    );
    
    // Calculate total nights for pricing
    const getTotalNights = () => {
        return roomSelections.reduce((sum, s) => sum + Math.max(1, Math.ceil((new Date(s.checkOut) - new Date(s.checkIn)) / (1000 * 60 * 60 * 24))), 0);
    };
    
    const [form, setForm] = useState({
        guests: [{name: ""}],
        phones: [""],
        email: "",
        nid: "",
        dob: "",
        checkIn: defaultCheckIn,
        checkOut: defaultCheckOut,
        status: "confirmed",
        subStatus: "none",
        // Guest count
        numAdult: "2",
        numChild: "0",
        // Pricing fields
        pricingMode: "simple", // simple or advanced
        priceType: "total", // "total" or "perNight"
        rackRate: "",
        salePrice: "",
        discountType: "percent", // percent or amount
        discountValue: "",
        advancePayment: "",
        paymentMethod: "cash",
        transactionId: "",
        notes: ""
    });
    const [status, setStatus] = useState("");
    const [createdBooking, setCreatedBooking] = useState(null);
    
    // Calculate total nights across all room selections
    const totalNights = useMemo(() => {
        if (roomSelections.length === 0) return 1;
        // For multi-room, use the first room's nights (they usually have same dates)
        const s = roomSelections[0];
        return Math.max(1, Math.ceil((new Date(s.checkOut) - new Date(s.checkIn)) / (1000 * 60 * 60 * 24)));
    }, [roomSelections]);

    // Calculate pricing based on inputs
    const calculatePricing = () => {
        const rackRateInput = parseFloat(form.rackRate) || 0;
        const salePriceInput = parseFloat(form.salePrice) || 0;
        const discountValue = parseFloat(form.discountValue) || 0;
        const advance = parseFloat(form.advancePayment) || 0;
        const isPerNight = form.priceType === 'perNight';
        const numRooms = Math.max(1, roomSelections.length);

        // Convert to total if per-night selected
        const rackRate = isPerNight ? rackRateInput * totalNights * numRooms : rackRateInput;
        const salePrice = isPerNight ? salePriceInput * totalNights * numRooms : salePriceInput;

        let finalPrice = salePrice;
        let discountAmount = 0;
        let discountPercent = 0;

        if (rackRate > 0) {
            if (form.discountType === 'percent' && discountValue > 0) {
                // Calculate sale price from discount %
                discountAmount = (rackRate * discountValue) / 100;
                finalPrice = rackRate - discountAmount;
                discountPercent = discountValue;
            } else if (form.discountType === 'amount' && discountValue > 0) {
                // Calculate sale price from discount amount
                discountAmount = discountValue;
                finalPrice = rackRate - discountAmount;
                discountPercent = rackRate > 0 ? ((discountAmount / rackRate) * 100).toFixed(1) : 0;
            } else if (salePrice > 0 && salePrice < rackRate) {
                // Calculate discount from sale price
                discountAmount = rackRate - salePrice;
                discountPercent = ((discountAmount / rackRate) * 100).toFixed(1);
                finalPrice = salePrice;
            } else if (salePrice === 0) {
                finalPrice = rackRate;
            }
        }

        const due = Math.max(0, finalPrice - advance);

        // Per-night values for display
        const perNightPrice = numRooms > 0 && totalNights > 0 ? finalPrice / (totalNights * numRooms) : finalPrice;

        return {
            rackRate,
            salePrice: finalPrice,
            discountAmount,
            discountPercent,
            advance,
            due,
            finalPrice,
            perNightPrice,
            totalNights,
            numRooms,
            isPerNight
        };
    };
    
    const pricing = calculatePricing();
    
    const PAYMENT_METHODS = [
        {id: "cash", label: "üíµ Cash", color: "#22c55e", requiresTxId: false, beds24Label: "Cash Received"},
        {id: "bkash", label: "üì± bKash/MFS", color: "#E2136E", requiresTxId: true, beds24Label: "Bkash Received"},
        {id: "bank", label: "üè¶ Bank Transfer", color: "#3b82f6", requiresTxId: true, beds24Label: "Bank Transfer"},
        {id: "card", label: "üí≥ Card", color: "#8b5cf6", requiresTxId: true, beds24Label: "Card Payment"}
    ];
    
    const add = (f) => form[f].length < 3 && setForm({...form, [f]: [...form[f], f === 'guests' ? {name: ""} : ""]});
    const upd = (f, i, v) => { const a = [...form[f]]; f === 'guests' ? a[i].name = v : a[i] = v; setForm({...form, [f]: a}); };
    const rem = (f, i) => form[f].length > 1 && setForm({...form, [f]: form[f].filter((_, idx) => idx !== i)});
    
    // Update room date
    const updateRoomDate = (index, field, value) => {
        setRoomSelections(prev => prev.map((s, i) => {
            if (i !== index) return s;
            const updated = {...s, [field]: value};
            // Ensure checkout is after checkin
            if (field === 'checkIn' && new Date(value) >= new Date(s.checkOut)) {
                const nextDay = new Date(value);
                nextDay.setDate(nextDay.getDate() + 1);
                updated.checkOut = nextDay.toISOString().slice(0,10);
            }
            return updated;
        }));
    };
    
    const submit = async (e) => {
        e.preventDefault();
        // Prevent double submission - return if already loading
        if (status === "loading") {
            console.log("‚ö†Ô∏è Submission already in progress, ignoring duplicate click");
            return;
        }
        setStatus("loading");
        try {
            const names = form.guests.map(g => g.name).filter(Boolean).join(", ");
            const phones = form.phones.filter(Boolean).join(", ");
            const groupId = "GRP" + Date.now();
            const advanceAmt = parseFloat(form.advancePayment) || 0;
            
            // Calculate prices based on mode
            let totalPrice = 0;
            if (form.pricingMode === 'advanced') {
                totalPrice = roomSelections.reduce((sum, s) => sum + (parseFloat(s.price) || 0), 0);
            } else {
                totalPrice = pricing.finalPrice || 0;
            }
            
            const data = roomSelections.map((s, idx) => {
                // In advanced mode, use individual room price; in simple mode, divide total
                const roomPrice = form.pricingMode === 'advanced' 
                    ? (parseFloat(s.price) || 0) 
                    : (totalPrice / roomSelections.length);
                
                // Calculate nights for this room
                const checkInDate = new Date(s.checkIn);
                const checkOutDate = new Date(s.checkOut);
                const nights = Math.ceil((checkOutDate - checkInDate) / (1000 * 60 * 60 * 24));
                const pricePerNight = nights > 0 ? roomPrice / nights : roomPrice;
                
                // Calculate deposit for this room
                const roomDeposit = advanceAmt / roomSelections.length;
                
                // Beds24 API V2 invoice item format:
                // - type: "charge" or "payment"
                // - description: string
                // - qty: integer (positive)
                // - amount: number (the value)
                // NOTE: autoInvoiceItemCharge only works when NO invoiceItems are sent.
                // Since we need to send payments, we must also explicitly send the charge.
                const invoiceItems = [];

                // Add accommodation charge using Beds24 template variables
                // [ROOMNAME1] = Room name, [FIRSTNIGHT] = Check-in date, [LEAVINGDAY] = Check-out date
                invoiceItems.push({
                    type: "charge",
                    description: "[ROOMNAME1] [FIRSTNIGHT] - [LEAVINGDAY]",
                    qty: 1,
                    amount: roomPrice
                });

                // Add payment if advance was paid
                if (roomDeposit > 0) {
                    const method = PAYMENT_METHODS.find(m => m.id === form.paymentMethod);
                    // Format: "Bkash Received DA39PF3E39" or "Cash Received"
                    let paymentDesc = method?.beds24Label || "Payment Received";
                    if (method?.requiresTxId && form.transactionId) {
                        paymentDesc += " " + form.transactionId.toUpperCase();
                    }
                    invoiceItems.push({
                        type: "payment",
                        description: paymentDesc,
                        qty: 1,
                        amount: roomDeposit
                    });
                }

                // Build rateDescription for pricing breakdown
                const perNightRate = nights > 0 ? roomPrice / nights : roomPrice;
                const rateDesc = `‡ß≥${perNightRate.toLocaleString()} per night √ó ${nights} night${nights > 1 ? 's' : ''} = ‡ß≥${roomPrice.toLocaleString()}`;

                // Build booking object
                const bookingData = {
                    propertyId: PROPERTY,
                    roomId: s.room.id,
                    unitId: s.unit.id,
                    arrival: s.checkIn,
                    departure: s.checkOut,
                    numAdult: parseInt(form.numAdult) || 2,
                    numChild: parseInt(form.numChild) || 0,
                    status: form.status,
                    subStatus: form.subStatus !== "none" ? form.subStatus : undefined,
                    firstName: names,
                    email: form.email || "guest@miami.com",
                    mobile: phones,
                    custom4: form.nid || "",
                    custom5: form.dob || "",
                    price: roomPrice,
                    deposit: roomDeposit,
                    rateDescription: rateDesc,
                    notes: form.notes || "",
                    referer: "miami_frontdesk",
                    groupId: roomSelections.length > 1 ? groupId : undefined,
                    // Always include invoice items (charge + payment)
                    invoiceItems: invoiceItems
                };

                return bookingData;
            });
            
            console.log("Booking data to send:", JSON.stringify(data, null, 2));

            const res = await fetch(PROXY + "?endpoint=bookings", {method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify(data)});
            const result = await res.json();
            console.log("Beds24 response:", result);
            
            const isArray = Array.isArray(result);
            const allSuccess = isArray ? result.every(r => r.success) : result.success;
            const errors = isArray ? result.filter(r => !r.success).map(r => r.error || "Unknown error") : [];
            const bookingIds = isArray ? result.filter(r => r.success && r.new?.id).map(r => r.new.id) : (result.new?.id ? [result.new.id] : []);
            
            if (allSuccess) { 
                // Save payment to local history if advance was paid
                if (advanceAmt > 0 && bookingIds.length > 0) {
                    const paymentHistory = JSON.parse(localStorage.getItem("miami_payment_history_v1") || "{}");
                    bookingIds.forEach(bid => {
                        paymentHistory[bid] = [{
                            amount: advanceAmt / bookingIds.length,
                            method: form.paymentMethod,
                            date: new Date().toISOString(),
                            note: "Advance payment at booking"
                        }];
                    });
                    localStorage.setItem("miami_payment_history_v1", JSON.stringify(paymentHistory));
                }
                
                setCreatedBooking({
                    ids: bookingIds,
                    guest: names,
                    phone: phones,
                    email: form.email,
                    rooms: selected.map(s => s.unit.n),
                    checkIn: hasIndividualDates ? selected[0].checkIn : form.checkIn,
                    checkOut: hasIndividualDates ? selected[0].checkOut : form.checkOut,
                    nights: getTotalNights(),
                    status: form.status,
                    totalPrice: totalPrice,
                    advancePaid: advanceAmt,
                    due: totalPrice - advanceAmt,
                    paymentMethod: PAYMENT_METHODS.find(m => m.id === form.paymentMethod)
                });
                setStatus("success");
            } else {
                const errorMsg = errors.length ? errors.join(", ") : (result.error || JSON.stringify(result));
                setStatus("error: " + errorMsg);
            }
        } catch(e) { 
            console.error("Booking error:", e);
            setStatus("error: " + e.message); 
        }
    };
    
    // Beautiful Success/Confirmation Screen
    if (status === "success" && createdBooking) {
        return (
            <div className="modal-overlay">
                <div className="modal" style={{maxWidth: '480px', padding: '0', overflow: 'hidden'}}>
                    {/* Header with gradient */}
                    <div style={{background: 'linear-gradient(135deg, #2D6A6A 0%, #1E4D4D 100%)', padding: '30px 24px', textAlign: 'center'}}>
                        <div style={{width: '80px', height: '80px', background: 'rgba(255,255,255,0.2)', borderRadius: '50%', margin: '0 auto 16px', display: 'flex', alignItems: 'center', justifyContent: 'center'}}>
                            <span style={{fontSize: '40px'}}>‚úÖ</span>
                        </div>
                        <h2 style={{fontSize: '24px', fontWeight: '700', margin: '0 0 8px'}}>Booking Confirmed!</h2>
                        <p style={{fontSize: '14px', opacity: 0.8, margin: 0}}>Reservation has been created successfully</p>
                    </div>
                    
                    {/* Booking Details */}
                    <div style={{padding: '24px'}}>
                        {/* Booking IDs */}
                        <div style={{background: 'rgba(45,106,106,0.1)', border: '1px dashed rgba(45,106,106,0.4)', borderRadius: '8px', padding: '12px', marginBottom: '20px', textAlign: 'center'}}>
                            <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)', marginBottom: '4px'}}>BOOKING ID{createdBooking.ids.length > 1 ? 'S' : ''}</div>
                            <div style={{fontSize: '18px', fontWeight: '700', color: '#2D6A6A', letterSpacing: '1px'}}>{createdBooking.ids.join(", ")}</div>
                        </div>
                        
                        {/* Guest Info Card */}
                        <div style={{background: 'rgba(255,255,255,0.03)', borderRadius: '12px', padding: '16px', marginBottom: '16px'}}>
                            <div style={{display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '12px'}}>
                                <div style={{width: '48px', height: '48px', background: 'linear-gradient(135deg, #D4A853 0%, #B8942F 100%)', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '20px'}}>üë§</div>
                                <div>
                                    <div style={{fontSize: '18px', fontWeight: '700'}}>{createdBooking.guest}</div>
                                    <div style={{fontSize: '13px', color: 'rgba(255,255,255,0.5)'}}>üìû {createdBooking.phone}</div>
                                </div>
                            </div>
                            {createdBooking.email && <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.4)', marginTop: '4px'}}>‚úâÔ∏è {createdBooking.email}</div>}
                        </div>
                        
                        {/* Room & Dates */}
                        <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '16px'}}>
                            <div style={{background: 'rgba(255,255,255,0.03)', borderRadius: '10px', padding: '14px'}}>
                                <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.4)', marginBottom: '4px'}}>üè® ROOM{createdBooking.rooms.length > 1 ? 'S' : ''}</div>
                                <div style={{fontSize: '15px', fontWeight: '600'}}>{createdBooking.rooms.join(", ")}</div>
                            </div>
                            <div style={{background: 'rgba(255,255,255,0.03)', borderRadius: '10px', padding: '14px'}}>
                                <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.4)', marginBottom: '4px'}}>üåô NIGHTS</div>
                                <div style={{fontSize: '15px', fontWeight: '600'}}>{createdBooking.nights} Night{createdBooking.nights > 1 ? 's' : ''}</div>
                            </div>
                        </div>
                        
                        <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '16px'}}>
                            <div style={{background: 'rgba(255,255,255,0.03)', borderRadius: '10px', padding: '14px'}}>
                                <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.4)', marginBottom: '4px'}}>üìÖ CHECK-IN</div>
                                <div style={{fontSize: '14px', fontWeight: '600'}}>{new Date(createdBooking.checkIn).toLocaleDateString('en-US', {weekday: 'short', month: 'short', day: 'numeric'})}</div>
                            </div>
                            <div style={{background: 'rgba(255,255,255,0.03)', borderRadius: '10px', padding: '14px'}}>
                                <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.4)', marginBottom: '4px'}}>üìÖ CHECK-OUT</div>
                                <div style={{fontSize: '14px', fontWeight: '600'}}>{new Date(createdBooking.checkOut).toLocaleDateString('en-US', {weekday: 'short', month: 'short', day: 'numeric'})}</div>
                            </div>
                        </div>
                        
                        {/* Payment Summary */}
                        {createdBooking.totalPrice > 0 && (
                            <div style={{background: 'linear-gradient(135deg, rgba(45,106,106,0.15) 0%, rgba(45,106,106,0.05) 100%)', borderRadius: '12px', padding: '16px', border: '1px solid rgba(45,106,106,0.2)'}}>
                                <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '10px'}}>
                                    <span style={{color: 'rgba(255,255,255,0.6)'}}>Total Amount</span>
                                    <span style={{fontWeight: '600'}}>‡ß≥{createdBooking.totalPrice.toLocaleString()}</span>
                                </div>
                                {createdBooking.advancePaid > 0 && (
                                    <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '10px', alignItems: 'center'}}>
                                        <span style={{color: 'rgba(255,255,255,0.6)', display: 'flex', alignItems: 'center', gap: '6px'}}>
                                            Advance Paid 
                                            <span style={{background: createdBooking.paymentMethod?.color || '#22c55e', padding: '2px 8px', borderRadius: '4px', fontSize: '10px'}}>{createdBooking.paymentMethod?.label?.split(' ')[1] || 'Cash'}</span>
                                        </span>
                                        <span style={{fontWeight: '600', color: '#22c55e'}}>-‡ß≥{createdBooking.advancePaid.toLocaleString()}</span>
                                    </div>
                                )}
                                <div style={{borderTop: '1px solid rgba(255,255,255,0.1)', paddingTop: '10px', display: 'flex', justifyContent: 'space-between'}}>
                                    <span style={{fontWeight: '700', fontSize: '16px'}}>Balance Due</span>
                                    <span style={{fontWeight: '700', fontSize: '20px', color: createdBooking.due > 0 ? '#ef4444' : '#22c55e'}}>‡ß≥{createdBooking.due.toLocaleString()}</span>
                                </div>
                            </div>
                        )}
                        
                        {/* Status Badge */}
                        <div style={{textAlign: 'center', marginTop: '16px'}}>
                            <span style={{
                                display: 'inline-block',
                                padding: '8px 20px', 
                                borderRadius: '20px', 
                                fontSize: '13px', 
                                fontWeight: '600',
                                background: createdBooking.status === 'confirmed' ? 'rgba(34,197,94,0.2)' : 
                                           createdBooking.status === 'request' ? 'rgba(245,158,11,0.2)' : 'rgba(59,130,246,0.2)',
                                color: createdBooking.status === 'confirmed' ? '#22c55e' : 
                                       createdBooking.status === 'request' ? '#f59e0b' : '#3b82f6'
                            }}>
                                {createdBooking.status === 'confirmed' ? '‚úÖ Confirmed' : 
                                 createdBooking.status === 'request' ? '‚è≥ Request Pending' : 'üÜï New Booking'}
                            </span>
                        </div>
                    </div>
                    
                    {/* Actions */}
                    <div style={{padding: '0 24px 24px'}}>
                        {/* WhatsApp Share Button */}
                        {createdBooking.phone && (
                            <button 
                                onClick={() => {
                                    // Format phone number
                                    let phone = createdBooking.phone.replace(/[^0-9+]/g, '');
                                    if (phone.startsWith('0')) phone = '88' + phone;
                                    else if (!phone.startsWith('+') && !phone.startsWith('88')) phone = '88' + phone;
                                    phone = phone.replace('+', '');
                                    
                                    // Format dates nicely
                                    const formatDateNice = (d) => new Date(d + 'T00:00:00').toLocaleDateString('en-GB', {day: 'numeric', month: 'short', year: 'numeric'});
                                    
                                    // Build WhatsApp message
                                    let msg = `üè® *MIAMI BEACH RESORT*\n`;
                                    msg += `üìç Cox's Bazar, Bangladesh\n`;
                                    msg += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
                                    msg += `Dear *${createdBooking.guest}*,\n\n`;
                                    msg += `‚úÖ Your booking has been *confirmed*! Here are your details:\n\n`;
                                    msg += `üìã *BOOKING DETAILS*\n`;
                                    msg += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                                    msg += `üîñ Booking ID: *#${createdBooking.ids.join(', #')}*\n`;
                                    msg += `üö™ Room${createdBooking.rooms.length > 1 ? 's' : ''}: *${createdBooking.rooms.join(', ')}*\n`;
                                    msg += `üìÖ Check-in: *${formatDateNice(createdBooking.checkIn)}*\n`;
                                    msg += `üìÖ Check-out: *${formatDateNice(createdBooking.checkOut)}*\n`;
                                    msg += `üåô Duration: *${createdBooking.nights} Night${createdBooking.nights > 1 ? 's' : ''}*\n\n`;
                                    
                                    if (createdBooking.totalPrice > 0) {
                                        msg += `üí∞ *PAYMENT SUMMARY*\n`;
                                        msg += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                                        msg += `Total Amount: ‡ß≥${createdBooking.totalPrice.toLocaleString()}\n`;
                                        if (createdBooking.advancePaid > 0) {
                                            msg += `Advance Paid: ‡ß≥${createdBooking.advancePaid.toLocaleString()}\n`;
                                        }
                                        msg += `*Balance Due: ‡ß≥${createdBooking.due.toLocaleString()}*\n\n`;
                                        
                                        if (createdBooking.due > 0) {
                                            msg += `‚ö†Ô∏è Please clear the balance upon arrival.\n\n`;
                                        } else {
                                            msg += `‚úÖ Your booking is fully paid!\n\n`;
                                        }
                                    }
                                    
                                    msg += `We look forward to welcoming you! üå¥\n`;
                                    msg += `_Miami Beach Resort Team_`;
                                    
                                    window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
                                }} 
                                style={{width: '100%', padding: '14px', background: 'linear-gradient(135deg, #25D366, #128C7E)', border: 'none', borderRadius: '10px', color: 'white', fontWeight: '700', cursor: 'pointer', fontSize: '15px', marginBottom: '10px', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px'}}
                            >
                                üí¨ Send Confirmation to WhatsApp
                            </button>
                        )}
                        {!createdBooking.phone && (
                            <div style={{padding: '10px', background: 'rgba(245,158,11,0.1)', border: '1px solid rgba(245,158,11,0.3)', borderRadius: '8px', marginBottom: '10px', textAlign: 'center', fontSize: '12px', color: '#f59e0b'}}>
                                ‚ö†Ô∏è No phone number - cannot send WhatsApp
                            </div>
                        )}
                        <button onClick={() => { if(onSuccess) onSuccess(); onClose(); }} style={{width: '100%', padding: '14px', background: '#2D6A6A', border: 'none', borderRadius: '10px', color: 'white', fontWeight: '700', cursor: 'pointer', fontSize: '15px'}}>
                            Done
                        </button>
                    </div>
                </div>
            </div>
        );
    }
    
    const inputStyle = {width: '100%', padding: '14px', background: 'rgba(255,255,255,0.08)', border: '1px solid rgba(255,255,255,0.18)', borderRadius: '10px', color: '#fff', fontSize: '15px', fontWeight: '500'};
    const nights = getTotalNights();
    
    return (
        <div className="modal-overlay">
            <div className="modal" style={{maxHeight: '90vh', overflowY: 'auto', background: '#1a2332'}}>
                <div className="modal-header" style={{borderBottom: '1px solid rgba(255,255,255,0.1)', paddingBottom: '16px', marginBottom: '20px'}}><h3 style={{fontSize: '20px', fontWeight: '700'}}>‚ûï New Booking</h3><button className="modal-close" onClick={onClose}>√ó</button></div>
                
                {/* Selected Rooms with Editable Dates */}
                <div style={{marginBottom: '24px'}}>
                    {roomSelections.map((s, index) => {
                        const n = Math.max(1, Math.ceil((new Date(s.checkOut) - new Date(s.checkIn)) / (1000 * 60 * 60 * 24)));
                        return (
                            <div key={s.unitKey || s.key || index} style={{padding: '14px 16px', background: 'linear-gradient(135deg, rgba(45,106,106,0.25) 0%, rgba(45,106,106,0.1) 100%)', border: '1px solid rgba(45,106,106,0.4)', borderRadius: '10px', marginBottom: '8px'}}>
                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px'}}>
                                    <span style={{fontSize: '18px', fontWeight: '700', color: '#4ade80'}}>{s.unit.n}</span>
                                    <span style={{fontSize: '12px', color: 'rgba(255,255,255,0.5)'}}>{s.room?.short || ''}</span>
                                </div>
                                <div style={{display: 'flex', gap: '10px', alignItems: 'center', flexWrap: 'wrap'}}>
                                    <input type="date" value={s.checkIn} onChange={e => updateRoomDate(index, 'checkIn', e.target.value)} style={{padding: '8px 10px', background: 'rgba(0,0,0,0.3)', border: '1px solid rgba(255,255,255,0.2)', borderRadius: '6px', color: '#fff', fontSize: '13px', flex: '1', minWidth: '120px'}}/>
                                    <span style={{color: 'rgba(255,255,255,0.5)'}}>‚Üí</span>
                                    <input type="date" value={s.checkOut} min={s.checkIn} onChange={e => updateRoomDate(index, 'checkOut', e.target.value)} style={{padding: '8px 10px', background: 'rgba(0,0,0,0.3)', border: '1px solid rgba(255,255,255,0.2)', borderRadius: '6px', color: '#fff', fontSize: '13px', flex: '1', minWidth: '120px'}}/>
                                    <span style={{color: '#D4A853', fontWeight: '700', fontSize: '13px', background: 'rgba(212,168,83,0.2)', padding: '6px 10px', borderRadius: '6px'}}>({n}N)</span>
                                </div>
                            </div>
                        );
                    })}
                </div>
                
                <form onSubmit={submit}>
                    
                    {/* Guest Info */}
                    <div style={{marginBottom: '18px'}}>
                        <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '8px', alignItems: 'center'}}>
                            <label style={{fontSize: '13px', color: 'rgba(255,255,255,0.85)', fontWeight: '600'}}>üë§ Guests *</label>
                            {form.guests.length < 3 && <button type="button" onClick={() => add('guests')} style={{background: 'rgba(45,106,106,0.2)', border: '1px solid rgba(45,106,106,0.4)', borderRadius: '6px', padding: '4px 10px', color: '#4ade80', fontSize: '12px', cursor: 'pointer', fontWeight: '600'}}>+ Add</button>}
                        </div>
                        {form.guests.map((g, i) => (
                            <div key={i} style={{display: 'flex', gap: '10px', marginBottom: '10px'}}>
                                <input type="text" required value={g.name} onChange={e => upd('guests', i, e.target.value)} placeholder={`Guest ${i+1} name`} style={{...inputStyle, flex: 1}}/>
                                {form.guests.length > 1 && <button type="button" onClick={() => rem('guests', i)} style={{background: 'rgba(239,68,68,0.15)', border: '1px solid rgba(239,68,68,0.3)', borderRadius: '8px', width: '44px', color: '#ef4444', fontSize: '20px', cursor: 'pointer'}}>√ó</button>}
                            </div>
                        ))}
                    </div>
                    
                    {/* Phone */}
                    <div style={{marginBottom: '18px'}}>
                        <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '8px', alignItems: 'center'}}>
                            <label style={{fontSize: '13px', color: 'rgba(255,255,255,0.85)', fontWeight: '600'}}>üìû Phone *</label>
                            {form.phones.length < 3 && <button type="button" onClick={() => add('phones')} style={{background: 'rgba(45,106,106,0.2)', border: '1px solid rgba(45,106,106,0.4)', borderRadius: '6px', padding: '4px 10px', color: '#4ade80', fontSize: '12px', cursor: 'pointer', fontWeight: '600'}}>+ Add</button>}
                        </div>
                        {form.phones.map((p, i) => (
                            <div key={i} style={{display: 'flex', gap: '10px', marginBottom: '10px'}}>
                                <input type="tel" required value={p} onChange={e => upd('phones', i, e.target.value)} placeholder={`Phone ${i+1}`} style={{...inputStyle, flex: 1}}/>
                                {form.phones.length > 1 && <button type="button" onClick={() => rem('phones', i)} style={{background: 'rgba(239,68,68,0.15)', border: '1px solid rgba(239,68,68,0.3)', borderRadius: '8px', width: '44px', color: '#ef4444', fontSize: '20px', cursor: 'pointer'}}>√ó</button>}
                            </div>
                        ))}
                    </div>
                    
                    {/* Email & ID */}
                    <input type="email" value={form.email} onChange={e => setForm({...form, email: e.target.value})} placeholder="‚úâÔ∏è Email (optional)" style={{...inputStyle, marginBottom: '14px'}}/>
                    <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '18px'}}>
                        <input type="text" value={form.nid} onChange={e => setForm({...form, nid: e.target.value})} placeholder="ü™™ NID" style={inputStyle}/>
                        <input type="text" value={form.dob} onChange={e => setForm({...form, dob: e.target.value})} placeholder="üéÇ DOB" style={inputStyle}/>
                    </div>
                    
                    {/* Booking Status */}
                    <div style={{marginBottom: '16px', padding: '16px', background: 'rgba(30,41,59,0.8)', borderRadius: '12px', border: '1px solid rgba(255,255,255,0.12)'}}>
                        <label style={{fontSize: '12px', color: 'rgba(255,255,255,0.7)', display: 'block', marginBottom: '10px', fontWeight: '600'}}>üìã Booking Status</label>
                        <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px'}}>
                            <select value={form.status} onChange={e => setForm({...form, status: e.target.value})} style={{...inputStyle, cursor: 'pointer', background: 'rgba(255,255,255,0.08)', border: '1px solid rgba(255,255,255,0.15)', fontSize: '14px', fontWeight: '500'}}>
                                <option value="confirmed">‚úÖ Confirmed</option>
                                <option value="request">‚è≥ Request</option>
                                <option value="new">üÜï New</option>
                                <option value="black">‚¨õ Black (Block)</option>
                            </select>
                            <select value={form.subStatus} onChange={e => setForm({...form, subStatus: e.target.value})} style={{...inputStyle, cursor: 'pointer', background: 'rgba(255,255,255,0.08)', border: '1px solid rgba(255,255,255,0.15)', fontSize: '14px'}}>
                                <option value="none">Sub-status...</option>
                                <option value="walkin">üö∂ Walk-in</option>
                                <option value="actionRequired">‚ö†Ô∏è Action Required</option>
                                <option value="allotment">üì¶ Allotment</option>
                            </select>
                        </div>
                        {form.status === 'black' && (
                            <div style={{marginTop: '10px', padding: '10px', background: 'rgba(55,65,81,0.5)', borderRadius: '8px', fontSize: '12px', color: 'rgba(255,255,255,0.7)', display: 'flex', alignItems: 'center', gap: '8px'}}>
                                <span>‚ÑπÔ∏è</span> Black booking blocks dates without a guest (maintenance, owner use, etc.)
                            </div>
                        )}
                    </div>
                    
                    {/* Payment Section - Redesigned */}
                    <div style={{marginBottom: '16px', padding: '16px', background: 'linear-gradient(135deg, rgba(45,106,106,0.15) 0%, rgba(45,106,106,0.05) 100%)', borderRadius: '12px', border: '1px solid rgba(45,106,106,0.25)'}}>
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '14px'}}>
                            <label style={{fontSize: '13px', color: 'rgba(255,255,255,0.85)', fontWeight: '600'}}>üí∞ Payment Details</label>
                            <div style={{display: 'flex', gap: '6px'}}>
                                <button type="button" onClick={() => setForm({...form, pricingMode: 'simple'})} style={{
                                    padding: '6px 12px', borderRadius: '6px', fontSize: '11px', fontWeight: '600', cursor: 'pointer',
                                    background: form.pricingMode === 'simple' ? '#2D6A6A' : 'rgba(255,255,255,0.08)',
                                    color: form.pricingMode === 'simple' ? '#fff' : 'rgba(255,255,255,0.6)',
                                    border: form.pricingMode === 'simple' ? 'none' : '1px solid rgba(255,255,255,0.15)'
                                }}>Simple</button>
                                <button type="button" onClick={() => setForm({...form, pricingMode: 'advanced'})} style={{
                                    padding: '6px 12px', borderRadius: '6px', fontSize: '11px', fontWeight: '600', cursor: 'pointer',
                                    background: form.pricingMode === 'advanced' ? '#2D6A6A' : 'rgba(255,255,255,0.08)',
                                    color: form.pricingMode === 'advanced' ? '#fff' : 'rgba(255,255,255,0.6)',
                                    border: form.pricingMode === 'advanced' ? 'none' : '1px solid rgba(255,255,255,0.15)'
                                }}>Advanced</button>
                            </div>
                        </div>
                        
                        {/* Simple Mode - Total pricing */}
                        {form.pricingMode === 'simple' && (
                            <>
                                {/* Row 0: Adults, Children & Price Type */}
                                <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '12px', marginBottom: '12px'}}>
                                    <div>
                                        <label style={{fontSize: '11px', color: 'rgba(255,255,255,0.6)', display: 'block', marginBottom: '5px', fontWeight: '500'}}>üë§ Adults</label>
                                        <select value={form.numAdult} onChange={e => setForm({...form, numAdult: e.target.value})} style={{...inputStyle, fontSize: '14px', padding: '12px', cursor: 'pointer'}}>
                                            {[1,2,3,4,5,6,7,8,9,10].map(n => <option key={n} value={n}>{n}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label style={{fontSize: '11px', color: 'rgba(255,255,255,0.6)', display: 'block', marginBottom: '5px', fontWeight: '500'}}>üë∂ Children</label>
                                        <select value={form.numChild} onChange={e => setForm({...form, numChild: e.target.value})} style={{...inputStyle, fontSize: '14px', padding: '12px', cursor: 'pointer'}}>
                                            {[0,1,2,3,4,5,6].map(n => <option key={n} value={n}>{n}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label style={{fontSize: '11px', color: 'rgba(255,255,255,0.6)', display: 'block', marginBottom: '5px', fontWeight: '500'}}>üìÖ Price Type</label>
                                        <select value={form.priceType} onChange={e => setForm({...form, priceType: e.target.value})} style={{...inputStyle, fontSize: '14px', padding: '12px', cursor: 'pointer', background: form.priceType === 'perNight' ? 'rgba(45,106,106,0.3)' : 'rgba(255,255,255,0.08)'}}>
                                            <option value="total">Total Stay</option>
                                            <option value="perNight">Per Night</option>
                                        </select>
                                    </div>
                                </div>

                                {/* Show nights/rooms info when per-night selected */}
                                {form.priceType === 'perNight' && (
                                    <div style={{marginBottom: '12px', padding: '8px 12px', background: 'rgba(45,106,106,0.2)', borderRadius: '8px', fontSize: '12px', color: 'rgba(255,255,255,0.8)'}}>
                                        üìä {pricing.totalNights} night{pricing.totalNights > 1 ? 's' : ''} √ó {pricing.numRooms} room{pricing.numRooms > 1 ? 's' : ''} = Prices will be multiplied by {pricing.totalNights * pricing.numRooms}
                                    </div>
                                )}

                                {/* Row 1: Rack Rate & Sale Price */}
                                <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '12px'}}>
                                    <div>
                                        <label style={{fontSize: '11px', color: 'rgba(255,255,255,0.6)', display: 'block', marginBottom: '5px', fontWeight: '500'}}>üìä Rack Rate (‡ß≥){form.priceType === 'perNight' ? '/night' : ''}</label>
                                        <input type="number" value={form.rackRate} onChange={e => setForm({...form, rackRate: e.target.value, discountValue: ''})} placeholder={form.priceType === 'perNight' ? 'Per night price' : 'Total price'} style={{...inputStyle, fontSize: '14px', padding: '12px'}}/>
                                    </div>
                                    <div>
                                        <label style={{fontSize: '11px', color: 'rgba(255,255,255,0.6)', display: 'block', marginBottom: '5px', fontWeight: '500'}}>üíµ Sale Price (‡ß≥){form.priceType === 'perNight' ? '/night' : ''}</label>
                                        <input type="number" value={form.salePrice} onChange={e => setForm({...form, salePrice: e.target.value, discountValue: ''})} placeholder={form.priceType === 'perNight' ? 'Per night price' : 'Total price'} style={{...inputStyle, fontSize: '14px', padding: '12px', background: parseFloat(form.rackRate) > 0 ? 'rgba(34,197,94,0.15)' : 'rgba(255,255,255,0.08)', borderColor: parseFloat(form.rackRate) > 0 ? 'rgba(34,197,94,0.3)' : 'rgba(255,255,255,0.18)'}}/>
                                    </div>
                                </div>
                                
                                {/* Row 2: Discount */}
                                {parseFloat(form.rackRate) > 0 && (
                                    <div style={{marginBottom: '12px'}}>
                                        <label style={{fontSize: '11px', color: 'rgba(255,255,255,0.6)', display: 'block', marginBottom: '5px', fontWeight: '500'}}>üè∑Ô∏è Discount</label>
                                        <div style={{display: 'flex', gap: '8px'}}>
                                            <div style={{display: 'flex', borderRadius: '8px', overflow: 'hidden', border: '1px solid rgba(255,255,255,0.15)'}}>
                                                <button type="button" onClick={() => setForm({...form, discountType: 'percent', discountValue: ''})} style={{
                                                    padding: '10px 14px', border: 'none', cursor: 'pointer', fontSize: '13px', fontWeight: '600',
                                                    background: form.discountType === 'percent' ? '#D4A853' : 'rgba(255,255,255,0.08)',
                                                    color: form.discountType === 'percent' ? '#000' : 'rgba(255,255,255,0.6)'
                                                }}>%</button>
                                                <button type="button" onClick={() => setForm({...form, discountType: 'amount', discountValue: ''})} style={{
                                                    padding: '10px 14px', border: 'none', cursor: 'pointer', fontSize: '13px', fontWeight: '600',
                                                    background: form.discountType === 'amount' ? '#D4A853' : 'rgba(255,255,255,0.08)',
                                                    color: form.discountType === 'amount' ? '#000' : 'rgba(255,255,255,0.6)'
                                                }}>‡ß≥</button>
                                            </div>
                                            <input type="number" value={form.discountValue} onChange={e => setForm({...form, discountValue: e.target.value, salePrice: ''})} placeholder={form.discountType === 'percent' ? 'Discount %' : 'Discount amount'} style={{...inputStyle, flex: 1, fontSize: '14px', padding: '10px 12px'}}/>
                                        </div>
                                        {/* Auto-calculated info */}
                                        {pricing.discountAmount > 0 && (
                                            <div style={{marginTop: '6px', fontSize: '11px', color: '#D4A853'}}>
                                                üí° {form.discountType === 'percent' ? `‡ß≥${pricing.discountAmount.toLocaleString()} off` : `${pricing.discountPercent}% off`}
                                            </div>
                                        )}
                                    </div>
                                )}
                                
                                {/* Row 3: Advance Payment */}
                                <div style={{marginBottom: '12px'}}>
                                    <label style={{fontSize: '11px', color: 'rgba(255,255,255,0.6)', display: 'block', marginBottom: '5px', fontWeight: '500'}}>üí≥ Advance Payment (‡ß≥)</label>
                                    <input type="number" value={form.advancePayment} onChange={e => setForm({...form, advancePayment: e.target.value})} placeholder="0" style={{...inputStyle, fontSize: '14px', padding: '12px'}}/>
                                </div>
                                
                                {/* Payment Method */}
                                {parseFloat(form.advancePayment) > 0 && (
                                    <div style={{marginBottom: '12px'}}>
                                        <label style={{fontSize: '11px', color: 'rgba(255,255,255,0.6)', display: 'block', marginBottom: '8px', fontWeight: '500'}}>Payment Method</label>
                                        <div style={{display: 'flex', gap: '8px', flexWrap: 'wrap'}}>
                                            {PAYMENT_METHODS.map(m => (
                                                <button key={m.id} type="button" onClick={() => setForm({...form, paymentMethod: m.id, transactionId: ''})} style={{
                                                    padding: '8px 12px', borderRadius: '8px', fontSize: '12px', cursor: 'pointer', fontWeight: form.paymentMethod === m.id ? '700' : '500',
                                                    border: form.paymentMethod === m.id ? `2px solid ${m.color}` : '1px solid rgba(255,255,255,0.15)',
                                                    background: form.paymentMethod === m.id ? `${m.color}25` : 'rgba(255,255,255,0.05)',
                                                    color: form.paymentMethod === m.id ? m.color : 'rgba(255,255,255,0.7)'
                                                }}>{m.label}</button>
                                            ))}
                                        </div>
                                        {/* Transaction ID input for bKash/Bank/Card */}
                                        {PAYMENT_METHODS.find(m => m.id === form.paymentMethod)?.requiresTxId && (
                                            <div style={{marginTop: '10px'}}>
                                                <input 
                                                    type="text" 
                                                    value={form.transactionId} 
                                                    onChange={e => setForm({...form, transactionId: e.target.value})} 
                                                    placeholder={`${PAYMENT_METHODS.find(m => m.id === form.paymentMethod)?.label.replace(/üì±|üè¶|üí≥/g, '').trim()} Transaction ID`}
                                                    style={{...inputStyle, fontSize: '13px', padding: '10px', textTransform: 'uppercase'}}
                                                />
                                            </div>
                                        )}
                                    </div>
                                )}
                            </>
                        )}
                        
                        {/* Advanced Mode - Per room pricing */}
                        {form.pricingMode === 'advanced' && (
                            <>
                                <div style={{marginBottom: '12px', padding: '10px', background: 'rgba(0,0,0,0.2)', borderRadius: '8px', fontSize: '11px', color: 'rgba(255,255,255,0.6)'}}>
                                    ‚ÑπÔ∏è Set individual room prices for each room in the group.
                                </div>
                                {roomSelections.map((s, idx) => {
                                    const roomNights = Math.max(1, Math.ceil((new Date(s.checkOut) - new Date(s.checkIn)) / (1000 * 60 * 60 * 24)));
                                    return (
                                        <div key={s.unitKey || idx} style={{padding: '12px', background: 'rgba(0,0,0,0.15)', borderRadius: '8px', marginBottom: '10px'}}>
                                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px'}}>
                                                <span style={{fontWeight: '700', color: '#4ade80'}}>Room {s.unit.n}</span>
                                                <span style={{fontSize: '11px', color: 'rgba(255,255,255,0.5)'}}>{roomNights}N</span>
                                            </div>
                                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px'}}>
                                                <input type="number" value={s.rackRate || ''} onChange={e => setRoomSelections(prev => prev.map((r, i) => i === idx ? {...r, rackRate: e.target.value} : r))} placeholder="Rack Rate" style={{padding: '8px 10px', background: 'rgba(255,255,255,0.08)', border: '1px solid rgba(255,255,255,0.15)', borderRadius: '6px', color: '#fff', fontSize: '13px'}}/>
                                                <input type="number" value={s.price || ''} onChange={e => setRoomSelections(prev => prev.map((r, i) => i === idx ? {...r, price: e.target.value} : r))} placeholder="Sale Price" style={{padding: '8px 10px', background: 'rgba(34,197,94,0.15)', border: '1px solid rgba(34,197,94,0.3)', borderRadius: '6px', color: '#fff', fontSize: '13px'}}/>
                                            </div>
                                        </div>
                                    );
                                })}
                                
                                {/* Advance Payment for Advanced Mode */}
                                <div style={{marginTop: '12px'}}>
                                    <label style={{fontSize: '11px', color: 'rgba(255,255,255,0.6)', display: 'block', marginBottom: '5px', fontWeight: '500'}}>üí≥ Advance Payment (‡ß≥)</label>
                                    <input type="number" value={form.advancePayment} onChange={e => setForm({...form, advancePayment: e.target.value})} placeholder="0" style={{...inputStyle, fontSize: '14px', padding: '12px'}}/>
                                </div>
                                
                                {/* Payment Method */}
                                {parseFloat(form.advancePayment) > 0 && (
                                    <div style={{marginTop: '12px'}}>
                                        <label style={{fontSize: '11px', color: 'rgba(255,255,255,0.6)', display: 'block', marginBottom: '8px', fontWeight: '500'}}>Payment Method</label>
                                        <div style={{display: 'flex', gap: '8px', flexWrap: 'wrap'}}>
                                            {PAYMENT_METHODS.map(m => (
                                                <button key={m.id} type="button" onClick={() => setForm({...form, paymentMethod: m.id, transactionId: ''})} style={{
                                                    padding: '8px 12px', borderRadius: '8px', fontSize: '12px', cursor: 'pointer', fontWeight: form.paymentMethod === m.id ? '700' : '500',
                                                    border: form.paymentMethod === m.id ? `2px solid ${m.color}` : '1px solid rgba(255,255,255,0.15)',
                                                    background: form.paymentMethod === m.id ? `${m.color}25` : 'rgba(255,255,255,0.05)',
                                                    color: form.paymentMethod === m.id ? m.color : 'rgba(255,255,255,0.7)'
                                                }}>{m.label}</button>
                                            ))}
                                        </div>
                                        {/* Transaction ID input for bKash/Bank/Card */}
                                        {PAYMENT_METHODS.find(m => m.id === form.paymentMethod)?.requiresTxId && (
                                            <div style={{marginTop: '10px'}}>
                                                <input 
                                                    type="text" 
                                                    value={form.transactionId} 
                                                    onChange={e => setForm({...form, transactionId: e.target.value})} 
                                                    placeholder={`${PAYMENT_METHODS.find(m => m.id === form.paymentMethod)?.label.replace(/üì±|üè¶|üí≥/g, '').trim()} Transaction ID`}
                                                    style={{...inputStyle, fontSize: '13px', padding: '10px', textTransform: 'uppercase'}}
                                                />
                                            </div>
                                        )}
                                    </div>
                                )}
                            </>
                        )}
                        
                        {/* Payment Summary */}
                        {(pricing.finalPrice > 0 || form.pricingMode === 'advanced') && (
                            <div style={{marginTop: '14px', padding: '14px', background: 'rgba(0,0,0,0.3)', borderRadius: '10px', border: '1px solid rgba(255,255,255,0.1)'}}>
                                <div style={{fontSize: '12px', fontWeight: '600', color: 'rgba(255,255,255,0.7)', marginBottom: '10px'}}>üìã Summary</div>
                                {form.pricingMode === 'simple' ? (
                                    <>
                                        {/* Guest count display */}
                                        <div style={{display: 'flex', justifyContent: 'space-between', fontSize: '12px', marginBottom: '6px'}}>
                                            <span style={{color: 'rgba(255,255,255,0.5)'}}>Guests:</span>
                                            <span style={{color: 'rgba(255,255,255,0.7)'}}>{form.numAdult} Adult{form.numAdult > 1 ? 's' : ''}{parseInt(form.numChild) > 0 ? `, ${form.numChild} Child${form.numChild > 1 ? 'ren' : ''}` : ''}</span>
                                        </div>
                                        {/* Per-night breakdown when applicable */}
                                        {form.priceType === 'perNight' && parseFloat(form.salePrice) > 0 && (
                                            <div style={{display: 'flex', justifyContent: 'space-between', fontSize: '12px', marginBottom: '6px'}}>
                                                <span style={{color: 'rgba(255,255,255,0.5)'}}>Rate:</span>
                                                <span style={{color: 'rgba(255,255,255,0.7)'}}>‡ß≥{parseFloat(form.salePrice).toLocaleString()}/night √ó {pricing.totalNights} night{pricing.totalNights > 1 ? 's' : ''} √ó {pricing.numRooms} room{pricing.numRooms > 1 ? 's' : ''}</span>
                                            </div>
                                        )}
                                        {parseFloat(form.rackRate) > 0 && (
                                            <div style={{display: 'flex', justifyContent: 'space-between', fontSize: '13px', marginBottom: '6px'}}>
                                                <span style={{color: 'rgba(255,255,255,0.5)'}}>Rack Rate{form.priceType === 'perNight' ? ' (Total)' : ''}:</span>
                                                <span style={{color: 'rgba(255,255,255,0.7)', textDecoration: pricing.discountAmount > 0 ? 'line-through' : 'none'}}>‡ß≥{pricing.rackRate.toLocaleString()}</span>
                                            </div>
                                        )}
                                        {pricing.discountAmount > 0 && (
                                            <div style={{display: 'flex', justifyContent: 'space-between', fontSize: '13px', marginBottom: '6px'}}>
                                                <span style={{color: '#D4A853'}}>Discount ({pricing.discountPercent}%):</span>
                                                <span style={{color: '#D4A853'}}>-‡ß≥{pricing.discountAmount.toLocaleString()}</span>
                                            </div>
                                        )}
                                        <div style={{display: 'flex', justifyContent: 'space-between', fontSize: '14px', marginBottom: '6px', paddingTop: '6px', borderTop: '1px solid rgba(255,255,255,0.1)'}}>
                                            <span style={{color: 'rgba(255,255,255,0.8)', fontWeight: '600'}}>Sale Price{form.priceType === 'perNight' ? ' (Total)' : ''}:</span>
                                            <span style={{fontWeight: '700', color: '#22c55e'}}>‡ß≥{pricing.finalPrice.toLocaleString()}</span>
                                        </div>
                                        {parseFloat(form.advancePayment) > 0 && (
                                            <div style={{display: 'flex', justifyContent: 'space-between', fontSize: '13px', marginBottom: '6px'}}>
                                                <span style={{color: 'rgba(255,255,255,0.5)'}}>Advance Paid:</span>
                                                <span style={{color: '#4ade80'}}>-‡ß≥{parseFloat(form.advancePayment).toLocaleString()}</span>
                                            </div>
                                        )}
                                        <div style={{display: 'flex', justifyContent: 'space-between', fontSize: '15px', marginTop: '8px', paddingTop: '8px', borderTop: '1px dashed rgba(255,255,255,0.2)'}}>
                                            <span style={{fontWeight: '700'}}>Due Amount:</span>
                                            <span style={{fontWeight: '800', fontSize: '18px', color: pricing.due > 0 ? '#ef4444' : '#22c55e'}}>‡ß≥{pricing.due.toLocaleString()}</span>
                                        </div>
                                    </>
                                ) : (
                                    <>
                                        {roomSelections.map((s, idx) => (
                                            <div key={idx} style={{display: 'flex', justifyContent: 'space-between', fontSize: '13px', marginBottom: '4px'}}>
                                                <span style={{color: 'rgba(255,255,255,0.6)'}}>Room {s.unit.n}:</span>
                                                <span style={{color: '#4ade80'}}>‡ß≥{(parseFloat(s.price) || 0).toLocaleString()}</span>
                                            </div>
                                        ))}
                                        <div style={{display: 'flex', justifyContent: 'space-between', fontSize: '14px', marginTop: '8px', paddingTop: '8px', borderTop: '1px solid rgba(255,255,255,0.1)'}}>
                                            <span style={{fontWeight: '600'}}>Total:</span>
                                            <span style={{fontWeight: '700', color: '#22c55e'}}>‡ß≥{roomSelections.reduce((sum, s) => sum + (parseFloat(s.price) || 0), 0).toLocaleString()}</span>
                                        </div>
                                        {parseFloat(form.advancePayment) > 0 && (
                                            <div style={{display: 'flex', justifyContent: 'space-between', fontSize: '13px', marginTop: '4px'}}>
                                                <span style={{color: 'rgba(255,255,255,0.5)'}}>Advance:</span>
                                                <span style={{color: '#4ade80'}}>-‡ß≥{parseFloat(form.advancePayment).toLocaleString()}</span>
                                            </div>
                                        )}
                                        <div style={{display: 'flex', justifyContent: 'space-between', fontSize: '15px', marginTop: '8px', paddingTop: '8px', borderTop: '1px dashed rgba(255,255,255,0.2)'}}>
                                            <span style={{fontWeight: '700'}}>Due:</span>
                                            <span style={{fontWeight: '800', fontSize: '18px', color: (roomSelections.reduce((sum, s) => sum + (parseFloat(s.price) || 0), 0) - parseFloat(form.advancePayment || 0)) > 0 ? '#ef4444' : '#22c55e'}}>
                                                ‡ß≥{Math.max(0, roomSelections.reduce((sum, s) => sum + (parseFloat(s.price) || 0), 0) - parseFloat(form.advancePayment || 0)).toLocaleString()}
                                            </span>
                                        </div>
                                    </>
                                )}
                            </div>
                        )}
                    </div>
                    
                    {/* Notes */}
                    <textarea value={form.notes} onChange={e => setForm({...form, notes: e.target.value})} placeholder="üìù Notes (optional)" rows={2} style={{...inputStyle, marginBottom: '20px', resize: 'none', minHeight: '60px'}}/>
                    
                    {/* Error Display */}
                    {status.startsWith("error") && (
                        <div style={{padding: '12px', background: 'rgba(239,68,68,0.2)', border: '1px solid #ef4444', borderRadius: '10px', color: '#fca5a5', fontSize: '13px', marginBottom: '16px', fontWeight: '500'}}>{status}</div>
                    )}
                    
                    {/* Action Buttons */}
                    <div style={{display: 'flex', gap: '14px', marginTop: '8px'}}>
                        <button type="button" onClick={onClose} style={{flex: 1, padding: '16px', background: 'rgba(255,255,255,0.08)', border: '1px solid rgba(255,255,255,0.15)', borderRadius: '12px', color: 'rgba(255,255,255,0.8)', fontWeight: '600', cursor: 'pointer', fontSize: '15px'}}>Cancel</button>
                        <button type="submit" disabled={status === "loading"} style={{flex: 2, padding: '16px', background: status === "loading" ? 'rgba(45,106,106,0.5)' : 'linear-gradient(135deg, #2D6A6A 0%, #245858 100%)', border: 'none', borderRadius: '12px', color: 'white', fontWeight: '700', cursor: status === "loading" ? 'not-allowed' : 'pointer', opacity: status === "loading" ? 0.7 : 1, fontSize: '16px', boxShadow: status === "loading" ? 'none' : '0 4px 15px rgba(45,106,106,0.4)', pointerEvents: status === "loading" ? 'none' : 'auto'}}>
                            {status === "loading" ? "‚è≥ Creating Booking..." : `‚úì Create Booking ${nights > 0 ? `(${nights}N)` : ''}`}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
}

// WhatsApp Integration Tab Component
function WhatsAppTab() {
    const WA_SERVICE = "https://whatsapp-service-1006186358018.us-central1.run.app";
    
    const [waStatus, setWaStatus] = React.useState('loading');
    const [waQrCode, setWaQrCode] = React.useState(null);
    const [waConnectedAs, setWaConnectedAs] = React.useState(null);
    const [waError, setWaError] = React.useState(null);
    const [waChecking, setWaChecking] = React.useState(false);
    
    const checkStatus = React.useCallback(async () => {
        try {
            setWaChecking(true);
            const res = await fetch(WA_SERVICE + '/status');
            if (!res.ok) throw new Error('Service unavailable');
            const data = await res.json();
            setWaStatus(data.status || 'disconnected');
            setWaQrCode(data.qrCode);
            setWaConnectedAs(data.connectedAs);
            setWaError(data.lastError);
        } catch (err) {
            console.error('WA status error:', err);
            setWaStatus('error');
            setWaError('Cannot connect to WhatsApp service.');
        } finally {
            setWaChecking(false);
        }
    }, []);
    
    React.useEffect(() => {
        checkStatus();
        const interval = setInterval(checkStatus, 3000);
        return () => clearInterval(interval);
    }, [checkStatus]);
    
    const handleLogout = async () => {
        if (!confirm('Disconnect WhatsApp? You will need to scan QR again.')) return;
        try {
            await fetch(WA_SERVICE + '/logout', { method: 'POST' });
            setWaStatus('disconnected');
            setWaConnectedAs(null);
            checkStatus();
        } catch (err) {
            alert('Error: ' + err.message);
        }
    };
    
    const handleRestart = async () => {
        try {
            setWaStatus('loading');
            await fetch(WA_SERVICE + '/restart', { method: 'POST' });
            setTimeout(checkStatus, 3000);
        } catch (err) {
            alert('Error: ' + err.message);
        }
    };
    
    return (
        <div style={{height: 'calc(100vh - 140px)', display: 'flex', flexDirection: 'column', background: '#111b21'}}>
            {/* Header */}
            <div style={{padding: '16px 20px', background: 'linear-gradient(135deg, #25D366 0%, #128C7E 100%)', display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '10px'}}>
                <div style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
                    <span style={{fontSize: '28px'}}>üí¨</span>
                    <div>
                        <h2 style={{fontSize: '20px', fontWeight: '700', margin: 0}}>WhatsApp Integration</h2>
                        <p style={{fontSize: '12px', opacity: 0.8, margin: 0}}>
                            {waStatus === 'connected' ? 'Connected as ' + (waConnectedAs?.name || waConnectedAs?.phone || 'Unknown') : 'Scan QR code to connect'}
                        </p>
                    </div>
                </div>
                <div style={{display: 'flex', gap: '10px'}}>
                    {waStatus === 'connected' && (
                        <button onClick={handleLogout} style={{padding: '8px 16px', background: 'rgba(239,68,68,0.2)', border: '1px solid rgba(239,68,68,0.4)', borderRadius: '8px', color: '#ef4444', fontWeight: '600', cursor: 'pointer', fontSize: '13px'}}>
                            Disconnect
                        </button>
                    )}
                    <button onClick={handleRestart} style={{padding: '8px 16px', background: 'rgba(255,255,255,0.2)', border: '1px solid rgba(255,255,255,0.3)', borderRadius: '8px', color: '#fff', fontWeight: '600', cursor: 'pointer', fontSize: '13px'}}>
                        üîÑ Restart
                    </button>
                </div>
            </div>
            
            {/* Main Content */}
            <div style={{flex: 1, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '40px', overflowY: 'auto'}}>
                {/* Loading/Initializing State */}
                {(waStatus === 'loading' || waStatus === 'connecting' || waStatus === 'initializing') && (
                    <div style={{textAlign: 'center'}}>
                        <div style={{fontSize: '60px', marginBottom: '20px', animation: 'waPulse 1.5s infinite'}}>‚è≥</div>
                        <style>{'.waPulse { animation: waPulse 1.5s infinite; } @keyframes waPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }'}</style>
                        <h3 style={{fontSize: '22px', fontWeight: '600', marginBottom: '10px'}}>
                            {waStatus === 'connecting' ? 'Connecting to WhatsApp...' : waStatus === 'initializing' ? 'Starting WhatsApp...' : 'Loading Service...'}
                        </h3>
                        <p style={{color: 'rgba(255,255,255,0.5)'}}>This may take a minute...</p>
                    </div>
                )}
                
                {/* QR Code State */}
                {waStatus === 'qr_ready' && waQrCode && (
                    <div style={{textAlign: 'center', background: 'rgba(255,255,255,0.05)', padding: '40px', borderRadius: '20px', border: '1px solid rgba(255,255,255,0.1)'}}>
                        <h3 style={{fontSize: '22px', fontWeight: '600', marginBottom: '20px'}}>üì± Scan with WhatsApp</h3>
                        <div style={{background: '#fff', padding: '16px', borderRadius: '12px', display: 'inline-block', marginBottom: '20px'}}>
                            <img src={waQrCode} alt="QR Code" style={{width: '280px', height: '280px', display: 'block'}}/>
                        </div>
                        <p style={{color: 'rgba(255,255,255,0.6)', marginBottom: '8px'}}>
                            Open WhatsApp ‚Üí Settings ‚Üí Linked Devices ‚Üí Link a Device
                        </p>
                        <p style={{color: 'rgba(255,255,255,0.4)', fontSize: '12px'}}>
                            {waChecking ? 'üîÑ Checking...' : '‚è≥ Waiting for scan'}
                        </p>
                    </div>
                )}
                
                {/* Connected State */}
                {waStatus === 'connected' && (
                    <div style={{textAlign: 'center', maxWidth: '500px'}}>
                        <div style={{width: '100px', height: '100px', background: 'linear-gradient(135deg, #25D366, #128C7E)', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto 24px', fontSize: '50px'}}>‚úÖ</div>
                        <h3 style={{fontSize: '26px', fontWeight: '700', marginBottom: '12px', color: '#25D366'}}>WhatsApp Connected!</h3>
                        {waConnectedAs && (
                            <div style={{background: 'rgba(37,211,102,0.1)', border: '1px solid rgba(37,211,102,0.3)', borderRadius: '12px', padding: '16px', marginBottom: '24px'}}>
                                <div style={{fontSize: '18px', fontWeight: '600'}}>{waConnectedAs.name || 'WhatsApp User'}</div>
                                <div style={{color: 'rgba(255,255,255,0.5)', fontSize: '14px', marginTop: '4px'}}>+{waConnectedAs.phone}</div>
                            </div>
                        )}
                        <p style={{color: 'rgba(255,255,255,0.6)', lineHeight: '1.6'}}>
                            You can now send booking confirmations directly to guests from the booking details!
                        </p>
                    </div>
                )}
                
                {/* Disconnected State */}
                {waStatus === 'disconnected' && !waQrCode && (
                    <div style={{textAlign: 'center'}}>
                        <div style={{fontSize: '60px', marginBottom: '20px'}}>üì±</div>
                        <h3 style={{fontSize: '22px', fontWeight: '600', marginBottom: '12px'}}>WhatsApp Disconnected</h3>
                        <p style={{color: 'rgba(255,255,255,0.5)', marginBottom: '20px'}}>Click Restart to generate a new QR code</p>
                        <button onClick={handleRestart} style={{padding: '14px 28px', background: 'linear-gradient(135deg, #25D366 0%, #128C7E 100%)', border: 'none', borderRadius: '10px', color: '#fff', fontWeight: '700', cursor: 'pointer', fontSize: '15px'}}>
                            üîÑ Generate QR Code
                        </button>
                    </div>
                )}
                
                {/* Error State */}
                {waStatus === 'error' && (
                    <div style={{textAlign: 'center', maxWidth: '500px'}}>
                        <div style={{fontSize: '60px', marginBottom: '20px'}}>‚ö†Ô∏è</div>
                        <h3 style={{fontSize: '22px', fontWeight: '600', marginBottom: '12px', color: '#f59e0b'}}>Service Not Available</h3>
                        <p style={{color: 'rgba(255,255,255,0.6)', marginBottom: '20px'}}>{waError}</p>
                        <button onClick={checkStatus} style={{padding: '12px 24px', background: 'linear-gradient(135deg, #25D366, #128C7E)', border: 'none', borderRadius: '10px', color: '#fff', fontWeight: '600', cursor: 'pointer'}}>
                            üîÑ Retry Connection
                        </button>
                    </div>
                )}
            </div>
            
            {/* Status Bar */}
            <div style={{padding: '12px 20px', background: 'rgba(0,0,0,0.3)', borderTop: '1px solid rgba(255,255,255,0.1)', display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '8px'}}>
                <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                    <div style={{width: '10px', height: '10px', borderRadius: '50%', background: waStatus === 'connected' ? '#25D366' : waStatus === 'qr_ready' ? '#f59e0b' : waStatus === 'error' ? '#ef4444' : '#6b7280'}}></div>
                    <span style={{fontSize: '13px', color: 'rgba(255,255,255,0.6)'}}>
                        Status: {waStatus === 'connected' ? 'Connected' : waStatus === 'qr_ready' ? 'Waiting for scan' : waStatus === 'initializing' ? 'Starting...' : waStatus === 'error' ? 'Unavailable' : 'Loading'}
                    </span>
                </div>
                <div style={{fontSize: '12px', color: 'rgba(255,255,255,0.4)'}}>
                    whatsapp-service
                </div>
            </div>
        </div>
    );
}

function ProtectedApp() {
    const [authenticated, setAuthenticated] = React.useState(isSessionValid());
    
    if (!authenticated && PASSWORD_ENABLED) {
        return <PasswordScreen onSuccess={() => setAuthenticated(true)} />;
    }
    
    return <App />;
}

ReactDOM.render(<ProtectedApp/>, document.getElementById("root"));
</script>
</body>
</html>








